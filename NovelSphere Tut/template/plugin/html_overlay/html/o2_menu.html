<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title></title>
<link rel="stylesheet" type="text/css" href="plugin/html_overlay/html/css/jquery-ui-o2custom.css">
<link rel="stylesheet" type="text/css" href="plugin/html_overlay/html/css/o2ui.css">
<script src="plugin/html_overlay/html/js/jquery-ui-o2custom.js"></script>
<script type="text/javascript" src="plugin/html_overlay/html/js/jquery.ui.touch-punch.min.js"></script>
<script type="text/javascript" src="plugin/html_overlay/html/js/jquery.mousewheel.min.js"></script>
</head>
<body>


<div id="dummy"></div>
<div id="html-overlay">
	<div id="confirm">
		<div id="confirmtxt">タイトルに戻りますか？</div>
		<div id="yesbtn" class="button btn_b"></div>
		<div id="nobtn" class="button btn_b"></div>
	</div>
	<div id="unclickable"></div>
	<div id="side-menu">
		<div id="buttons">
			<div id="save" class="button btn_a"></div>
			<div id="load" class="button btn_a"></div>
			<div id="config" class="button btn_a"></div>
			<div id="auto" class="button btn_b"></div>
			<div id="skip" class="button btn_b"></div>
			<div id="close" class="button"></div>
		</div>
	</div>
	<div id="contents">

		<div id="info-content" class="content">
			<div id="dialog"></div>
			<div id="footer">
				<div id="titlebtn" class="button"></div>
				<div id="infobtn" class="button"></div>
			</div>
		</div>

		<div id="save-content" class="content hide">
			<div id="slot-block">
				<ul>
				</ul>
			</div>
			<div id="pagenation">
				<ul>
				</ul>
			</div>
		</div>

		<div id="config-content" class="content hide">
			<div id="sound-config" class="block">
				<div id="bgm-vol" class="slider-box"><div class="o2slide"></div></div>
				<div id="se-vol" class="slider-box"><div class="o2slide"></div></div>
			</div>
			<div id="message-config" class="block">
				<div id="ch-speed" class="slider-box"><div class="o2slide"></div></div>
				<div id="auto-speed" class="slider-box"><div class="o2slide"></div></div>
			</div>
			<div id="default" class="button"></div>
		</div>

	</div>
</div>

<script>
	Overlay(function (callback, args) {

	// ===================================================
	// setting
	// ===================================================

		$('#dummy').hide();
		$("#html-overlay").hide();

		// -------------------------------------------------
		// 変数定義
		var dispWidth = 1920,
				dispHeight = 1080,
				canvasScale,
				canvasWidth,
				canvasHeight,
				widthScale,
				heightScale,
				scale,
				fadeTime = 250,
				scrollTime = 250,
				slotScroll = 0, // scroll値 = $('#slot-block ul').css('top')
				slotUlMargin = parseInt( $('#slot-block ul').css('margin-bottom') ), // 下端スロットの画面端からのマージンを取得
				pagenationMax = Math.ceil(o2ui.slot/4), // pagenation の max値を割り出す
				saveslot,	// callback(save, slot, redrawSlot) で、redrawSlot() に引数を渡せないので、一時的にセーブするスロット番号を保持する
				loadslot,
				currentDrawSlot = 0,
				slotOffsets = [],
				confirmFlag = undefined,
				// 必要最低限の使用画像のプリロード
				preloadImages = ['plugin/html_overlay/html/ui/'+o2ui.launchImage+'.png','plugin/html_overlay/html/ui/bg_menu.png','plugin/html_overlay/html/ui/bg_config_btn_default_hover.png', 'plugin/html_overlay/html/ui/icon_menu_auto_active.png', 'plugin/html_overlay/html/ui/icon_menu_auto_hover.png', 'plugin/html_overlay/html/ui/bg_menu_btn_a_active.png', 'plugin/html_overlay/html/ui/icon_menu_back_hover.png', 'plugin/html_overlay/html/ui/bg_menu_btn_a_hover.png', 'plugin/html_overlay/html/ui/icon_menu_config_active.png', 'plugin/html_overlay/html/ui/bg_menu_btn_b_active.png', 'plugin/html_overlay/html/ui/icon_menu_config_hover.png', 'plugin/html_overlay/html/ui/bg_menu_btn_b_hover.png', 'plugin/html_overlay/html/ui/icon_menu_load_active.png', 'plugin/html_overlay/html/ui/icon_menu_load_hover.png', 'plugin/html_overlay/html/ui/icon_menu_save_active.png', 'plugin/html_overlay/html/ui/icon_menu_save_hover.png', 'plugin/html_overlay/html/ui/icon_tutorial_btn_hover.png', 'plugin/html_overlay/html/ui/icon_menu_skip_active.png', 'plugin/html_overlay/html/ui/icon_menu_skip_hover.png'];

		// config メニュー用のオブジェクト生成
		configMenu = {
			resetToDefault : function(mode){
				if(mode === 'user'){
						var resetMode = this.userValues;
				}else{
						var resetMode = this.defaultValues;
						sf.__system.bgmGVolume = resetMode.bgmVolume;
						sf.__system.seGVolume = resetMode.seVolume;
						sf.__system.userChSpeed = config.chSpeeds;
						sf.__system.autoModePageWait = config.autoModePageWait;
				}
				$('#bgm-vol .o2slide').slider( 'value', resetMode.bgmVolume );
				$('#se-vol .o2slide').slider( 'value', resetMode.seVolume );
				$('#ch-speed .o2slide').slider( 'value', resetMode.chSpeed );
				$('#auto-speed .o2slide').slider( 'value', resetMode.autoModePageWait );
				$('.slider').each(function(){
						$(this).slider('instance').options.slide(null, {
								value: $(this).slider('value')
						});
				});
				o2.setBgmGVolume( resetMode.bgmVolume );
				o2.setSeGVolume( resetMode.seVolume );
				o2.reloadDelaySpeed();
			},
			defaultValues : {
				chSpeed : (o2ui.config.chspeed.max-config.chSpeeds),
				autoModePageWait : (o2ui.config.automode.max-config.autoModePageWait),
				bgmVolume : 1,
				seVolume : 1
			},
			userValues : {
				chSpeed : (o2ui.config.chspeed.max-sf.__system.userChSpeed+o2ui.config.chspeed.min),
				autoModePageWait : (o2ui.config.automode.max-sf.__system.autoModePageWait+o2ui.config.automode.min),
				bgmVolume : sf.__system.bgmGVolume,
				seVolume : sf.__system.seGVolume
			}
		}

		// event 判定用 スマホorタブレットなら touch イベント
		if (ev.ua.indexOf("iPhone") != -1 || ev.ua.indexOf("iPod") != -1 || ev.ua.indexOf("iPad") != -1 || ev.ua.indexOf("Android") != -1){
			var _event = {"agent":"sp", "click":"touchend", "scroll":"touchmove", "rclick":"doubletap"},
					_touch = {
						startX : 0,
						startY : 0,
						moveBeforeY : null,
						moveX : 0,
						moveY : 0,
						moveCapacity : 5,
						touchflag : false,
						doubleflag : false
					}
		}else{
			var _event = {"agent":"pc", "click":"click", "scroll":"mousewheel", "rclick":"contextmenu"};
		}

		// -------------------------------------------------
		// 最初に表示する画面の準備

		// launch_view が設定されている場合 (info ではない場合)
		if (o2ui.launchView != "info" || o2ui.launchView == "save" || o2ui.launchView == "load" || o2ui.launchView == "config"){
			if (o2ui.launchView == "load") {
				$(".content:not(#save-content)").addClass('hide').hide();
			}else{
				$(".content:not(#"+o2ui.launchView+"-content)").addClass('hide').hide();
			}
			$("#contents").hide();
			// load 画面は save 画面を使い回すので、いずれも #save-content を表示する
			if (o2ui.launchView == 'save' || o2ui.launchView == 'load'){
				$("#save-content").removeClass('hide');
			}else{
				$("#"+o2ui.launchView+"-content").removeClass('hide');
			}
			$("#"+o2ui.launchView).addClass('active');

		// launch_view が特に設定されていないか、info の場合
		}else{
			$("#save-content,#config-content,#contents").hide();
		}

		$("#dialog").css('background', 'url("plugin/html_overlay/html/ui/'+o2ui.launchImage+'.png") no-repeat center top, url("plugin/html_overlay/html/ui/dialog.png") no-repeat center center');
		if (o2ui.launchImageStatus == false){
			$("#dialog").hide();
		}

		if (String(o2ui.save) === "false"){
			$("#save").addClass('disable');
		}
		if (String(o2ui.load) === "false"){
			$("#load").addClass('disable');
		}
		if (String(o2ui.config.enabled) === "false"){
			$("#config").addClass('disable');
		}
		if (String(o2ui.automode) === "false"){
			$("#auto").addClass('disable');
		}else{
			if (String(o2.autoMode) === "true" && o2ui.automodeStatus){
				$("#auto").addClass('active');
			}
		}
		if (String(o2ui.skipmode) === "false"){
			$("#skip").addClass('disable');
		}else{
			if (o2.skipMode != 0 && o2ui.skipmodeStatus){
				$("#skip").addClass('active');
			}
		}
		if (String(o2ui.title.enabled) !== "false"){
			if (String(o2ui.title.status) === "true" || String(o2ui.backToTitle) === 'false'){
				$("#titlebtn").addClass('disable');
			}
		}else{
			$("#titlebtn").remove();
		}
		// o2ui.slot は 28 を上限とする
		if ( o2ui.slot > 28 ){
			o2ui.slot = 28;
			o2.warn('o2ui.slot の数値が上限を超えていたので 28 に設定されました');
		}

		$('#unclickable').hide();
		$('#confirm').hide();

		// -------------------------------------------------
		// scale 値の初期化
		scaleInit();
		// Events の設定より先にDOMを用意しておかないといけない（ .button へのイベントが設定できなくなる）
		drawSlots();
		// ノベルスフィアにログインしているかどうかチェックする
		checkNSLogin();

	// ===================================================
	// Functions
	// ===================================================
		// scale 値を初期化
		function scaleInit(){
			// canvas の表示領域に #main-wrapper を合わせるための scale 値を産出
			canvasScale = Math.min((innerWidth/config.scWidth),(innerHeight/config.scHeight));
			// 現在表示中の画面サイズ
			canvasWidth = config.scWidth * canvasScale,
			canvasHeight = config.scHeight * canvasScale;

			// mode が fixed の時（ノベルの画面に合わせる…はみ出ないモード）
			if (o2ui.launchSize == 'fixed'){
				widthScale = canvasWidth / dispWidth,
				heightScale = canvasHeight / dispHeight;
			// mode が default の時（ブラウザに合わせる…はみ出るモード）
			}else{
				widthScale = innerWidth / dispWidth,
				heightScale = innerHeight / dispHeight;
			}
			scale = Math.min(widthScale,heightScale);
		}

		// 画面サイズを設定
		function resizeElement(){
			scaleInit();

			var left = (innerWidth - dispWidth * scale) / 2,
					top = (innerHeight - dispHeight * scale) / 2,
					dummyWidth = Math.max(dispWidth * scale, canvasWidth)
					dummyHeight = Math.max(dispHeight * scale, canvasHeight);

			$('#dummy')
				.css('width', dummyWidth)
				.css('height', dummyHeight)
				.css('left', ((innerWidth-dummyWidth)/2) + 'px')
				.css('top', ((innerHeight-dummyHeight)/2) + 'px');

			$('#html-overlay')
				.css('transformOrigin','0% 0%')
				.css('transform','scale('+scale+')')
				.css('-webkit-transformOrigin','0% 0%')
				.css('-webkit-transform','scale('+scale+')')
				.css('-moz-transformOrigin','0% 0%')
				.css('-moz-transform','scale('+scale+')')
				.css('left', left + 'px')
				.css('top', top + 'px');

			$('#bgm-vol .o2slide').slider({scale: scale});
			$('#se-vol .o2slide').slider({scale: scale});
			$('#ch-speed .o2slide').slider({scale: scale});
			$('#auto-speed .o2slide').slider({scale: scale});

			// save / load 画面でリサイズしたら slot 遅延用に高さを再度計算
			if ($(".btn_a.active").attr("id") == 'save' || $(".btn_a.active").attr("id") == 'load'){
				slotImgInit(slotOffsets[0]);
			}

		}
		// -------------------------------------------------
		// ノベルスフィア ログインチェック
		// o2.serverStat.mode = 0 なら standalone mode
		// o2.serverStat.uid = -1 なら 未ログイン
		function checkNSLogin(){
			if (o2.serverStat.mode == 1){
				if (o2.serverStat.uid == -1){
					o2ui.login = false;
				}else{
					o2ui.login = true;
				}
			}else{
				o2ui.login = null;
			}
			return o2ui.login;
		}
	// ---------------------------------------------------
		// タッチイベント発火OKかどうか判断する
		function checkTouchEvent(){
			if (_event['agent'] == 'sp'){
				// console.log("checktouchevent touchflag:",_touch.touchflag)
				if (_touch.touchflag){
					return true;
				}else{
					return false;
				}
			}else{
				return true;
			}
		}

		// メニュー画面を閉じる
		function closeWindow(action){
			$('#contents').fadeOut(fadeTime*2);
			$('#dummy').fadeOut(fadeTime*2);
			$("#side-menu").animate({ left: "-528px"}, fadeTime*2, function() {
				$('#html-overlay').fadeOut(function(){
					$('#html-overlay').off();
					$('#slot-block').off();
					$('#pagenation li').off();
					$('.button').off();
					callback(action);
				});
			});
		}
		// ロードを伴いながら、メニュー画面を閉じる
		function closeWindowWithLoad(){
			$('#contents').fadeOut(fadeTime*2);
			$('#dummy').fadeOut(fadeTime*2);
			$("#side-menu").animate({ left: "-528px"}, fadeTime*2, function() {
				$('#html-overlay').fadeOut(function(){
					$('#html-overlay').off();
					$('#slot-block').off();
					$('#pagenation li').off();
					$('.button').off();
					callback('close');
				});
			});
		}
	// ---------------------------------------------------
		function dialogShow(text){
			o2ui.tmp.bgmgvolume = sf.__system.bgmGVolume;
			o2ui.tmp.segvolume = sf.__system.seGVolume;
			o2.setBgmGVolume(sf.__system.bgmGVolume/2);
			o2.setSeGVolume(sf.__system.seGVolume/2);
			var confirm = $('#confirm');
			$('#confirmtxt').html(text);
			$('#unclickable').fadeIn(fadeTime);
			confirm.show().animate({ top: (dispHeight-confirm.height())/2+20, opacity: 1 }, fadeTime, function(){
				$(this).animate({ top: (dispHeight-confirm.height())/2 }, fadeTime/2);
			});
		}
		function dialogHide(){
			o2.setBgmGVolume(o2ui.tmp.bgmgvolume);
			o2.setSeGVolume(o2ui.tmp.segvolume);
			var confirm = $('#confirm');
			confirm.animate({ top: (dispHeight-confirm.height())/2+20 }, fadeTime/2, function(){
				$(this).animate({ top: 100, opacity: 0 }, fadeTime, function(){
					$(this).hide();
				});
				$('#unclickable').fadeOut(fadeTime);
			});
		}
	// ---------------------------------------------------
		// セーブ＆ロード用のスロットを生成
		function drawSlots(){
			var slotTags = '',
					pagenation = '',
					tag = 0,
					page = 1,
					thumb = '',
					caption = '',
					date = '';

			// o2ui.slotの数に応じてslotを作成
			for (var i=0,c=0; i < o2ui.slot; i++,c++){

				// タグ番号生成
				tag = zerofill(i+1);

				// データ設定
				if (ev.save.snapshot[i]){
					thumb = ev.save.snapshot[i];
					date = stringFromDate(ev.save.date[i]);
					if (ev.save.caption[i] === ""){
						caption = "スロット"+(i+1);
					}else{
						caption = strLengthCheck(ev.save.caption[i]) > 31 ? (ev.save.caption[i]).slice(0,31)+'...' : ev.save.caption[i];
					}

				}else{
					thumb = 'plugin/html_overlay/html/ui/thumb_dummy.png';
					date = '----/--/-- --:--';
					caption = 'NO DATA';
				}

				// ページネーション設定
				if (c==4){
					c=0;
					page++;
				}

				// DOMを作成
				if (c==0){
					slotTags += '<li id="page'+page+'" ';
				}else{
					slotTags += '<li ';
				}
				slotTags += 'class="slot button page'+page+'" o2-slot="'+i+'"><div class="thumb-wrap"><img class="thumb lazy" data-src="'+thumb+'"></div><p class="tag">'+tag+'</p><p class="caption">'+caption+'</p><p class="date">'+date+'</p></li>';
			}

			$("#slot-block ul").append(slotTags);
			var snapWidth = 180/o2ui.snap.height*o2ui.snap.width;
			$(".thumb-wrap").css('width', snapWidth);

			// ページネーションが無い時だけ追加
			if ($("#pagenation li").length == 0){
				for (var i = 0; i < pagenationMax; i++) {
					pagenation += '<li class="page'+(i+1)+'"><div></div></li>';
				};
				$("#pagenation ul").append(pagenation);
				// pagenation page1 を active にする
				$('#pagenation li.page1').addClass('active');
			}
		}
	// ---------------------------------------------------
		// セーブスロットを描画し直す
    function redrawSlot () {
      var target = '#slot-block li[o2-slot='+saveslot+']';
      $(target+' .thumb-wrap').children('img.thumb').attr( 'src', ev.save.snapshot[saveslot] );
			if (ev.save.caption[saveslot] === ""){
				$(target).children('p.caption').html("スロット"+(Number(saveslot)+1));
			}else{
				$(target).children('p.caption').html( strLengthCheck(ev.save.caption[saveslot]) > 31 ? (ev.save.caption[saveslot]).slice(0,31)+'...' : ev.save.caption[saveslot] );
			}
      $(target).children('.date').html( stringFromDate(ev.save.date[saveslot]) );
    }

  	// セーブスロットのスクロール位置と pagenation を初期化
    function slotPosInit() {
    	scaleInit();
    	slotScroll = 0;
			$('#slot-block ul').css('top', '0px');
			$('#pagenation li.active').removeClass('active');
			$('#pagenation li.page1').addClass('active');
    }

  	// セーブスロットの縦位置を検出
    function slotImgInit(offset){
    	if (typeof offset === 'undefined'){
    		offset = 0;
    	}
    	slotOffsets = [];
    	// slot 画像随時読み込み
			if (slotOffsets.length < 1){
				$('img.lazy').each(function(index, el) {
					slotOffsets.push(($(this).offset().top*-1/scale)-offset);
				});
			}
    }

    // セーブスロットの遅延ロード
    // num ... 指定した番号のスロットまで一気にロード
    function slotLoad(num){
			if (typeof num !== 'undefined'){
				var indexMax = num;
				for (var i = currentDrawSlot; i < indexMax; i++) {
					if ($('img.lazy').eq(i).attr('data-src') != ''){
						$('img.lazy').eq(i).attr('src', $('img.lazy').eq(i).attr('data-src'));
						currentDrawSlot = i;
					}else{
						continue;
					}
				}
			}else{
				var indexMax = slotOffsets.length;
				for (var i = currentDrawSlot; i < indexMax; i++) {
					if (slotOffsets[i] >= slotScroll-(dispHeight) && $('img.lazy').eq(i).attr('data-src') != '' && currentDrawSlot < i){
						currentDrawSlot = i;
						$('img.lazy').eq(i).attr('src', $('img.lazy').eq(i).attr('data-src'));
					}else{
						if (currentDrawSlot == i){
							continue;
						}
						break;
					}
				}
			}
    }

	// ---------------------------------------------------
	// お役立ち系 function
	// ---------------------------------------------------
		// ゼロフィル
    function zerofill(num){
    	return ("0"+num).slice(-2);
    }
    // ev.save.date を日付の形式に変換
    function stringFromDate(date){
      function padding(digit){
        return digit < 10? "0"+digit : digit;
      }
      return date.getFullYear()+'/'+
          zerofill(date.getMonth()+1)+'/'+
          zerofill(date.getDate())+' '+
          zerofill(padding(date.getHours()))+':'+
          zerofill(padding(date.getMinutes()));
    }
    // ev.save.caption の文字数を全角分として調べる
    function strLengthCheck(caption){
			var len = 0,
					caption = escape(caption);
			for (var i = 0; i < caption.length; i++, len++) {
				if (caption.charAt(i) == '%'){
					if (caption.charAt(++i) == 'u'){
						i += 3;
						len ++;
					}
					i++;
				}
			}
			return Math.ceil(len.toString()/2);
		}
		// プリロード
		function preload(src){
		  var d = $.Deferred();
		  var img = new Image;
		  img.src= src;
		  img.onload = d.resolve
		  img.onerror = d.reject
		  return d.promise();
		}
		// 非同期プリロード
		function preload_images_paralell(srcs){
		  var dfds = srcs.map(function(src){return preload(src);});
		  return $.when.apply($, dfds);
		}

		// ns_checklogin 後に実行する内容
		function callbackOpenContent(action, beforeActive){
			if (o2ui.tmp.nscheck && typeof o2ui.tmp.nscheck !== 'undefined'){
				checkNSLogin();
				var action = o2ui.tmp.action;
				var beforeActive = o2ui.tmp.beforeActive;
			}else{
				o2ui.tmp.nscheck = null;
			}

			if ((o2ui.tmp.nscheck == true && o2ui.login == true)||(o2ui.tmp.nscheck == null && o2ui.login == null)){
				// すでに存在する空DOMを削除
				$("#slot-block ul").children().remove();
				slotScroll = 0;
				currentDrawSlot = 0;
				scaleInit();
				drawSlots();
				slotLoad(5);
			}

			if (o2ui.tmp.nscheck == true || o2ui.tmp.nscheck == null || action == 'config'){
				if (o2ui.login != false || action == 'config'){

					// load の時は save-content を使い回す
					if (action == 'load'){
						if (beforeActive == 'save'){
							$("#save-content").fadeOut(fadeTime,function(){
								slotPosInit();
							}).fadeIn(fadeTime, function(){
								slotImgInit();
							});
						}else{
							$(".content:not(#save-content)").addClass('hide').fadeOut(fadeTime, function(){
								slotPosInit();
								$("#save-content").removeClass('hide').delay(fadeTime).fadeIn(fadeTime, function(){
									slotImgInit();
								});
							});
						}
					}else if (action == 'save' && beforeActive == 'load'){
						$("#save-content").fadeOut(fadeTime,function(){
							slotPosInit()
						}).fadeIn(fadeTime, function(){
							slotImgInit();
						});
					}else{
						$(".content:not(#"+action+"-content)").addClass('hide').fadeOut(fadeTime, function(){
							if (action == 'save'){
								slotPosInit();
							}
							$("#"+action+"-content").removeClass('hide').delay(fadeTime).fadeIn(fadeTime, function(){
								slotImgInit();
							});
						});
					}
				}else{
					$('.btn_a.active').removeClass('active');
					$('.btn_a#'+beforeActive).addClass('active');
				}
			}

			if ((o2ui.tmp.nscheck == true && o2ui.login == true)||(o2ui.tmp.nscheck == null && o2ui.login == null)){
				o2ui.tmp.nscheck = null;
				destroyButtonEvent()
				createButtonEvent();
			}

		}

	// ===================================================
	// Events
	// ===================================================
		// window がリサイズされたら、htmlOverlayもリサイズ
		$(window).on('resize', resizeElement);
		// touchmove event を無効
		$(this).on('touchmove',function(e){
				e.preventDefault();
		});
		// double touch を無効
		var doubleTouchStartTimestamp = 0;
		$(this).bindFirst("touchstart", function (event) {
				var now = Date.now();
				if (doubleTouchStartTimestamp + 500 > now) {
						event.preventDefault();
				} else {
						doubleTouchStartTimestamp = now;
				}
		});

		function enableEvents(){
			// 右クリックでメニューを閉じる
			$('#html-overlay').on(_event['rclick'], function(event){
				closeWindow('close');
			});

		// ---------------------------------------------------
			// touch 系（スマホ）専用 Event
			// touch後、_touch.moveCapacity で設定した値以上指が動いたらクリックイベントは発動しない機構
			if (_event['agent'] == 'sp'){

				// タッチ開始時の座標検出
				$('#html-overlay').on('touchstart', function(event) {
					_touch.startX = event.originalEvent.changedTouches[0].pageX,
					_touch.startY = event.originalEvent.changedTouches[0].pageY;

					// まずはclickとみなす
					_touch.touchflag = true;
					// console.log("touchstart touchflag:",_touch.touchflag);

					// // Androidの二本指対応
					// if(event.originalEvent.changedTouches.length > 1){
					// 	console.log("touches:",event.originalEvent.changedTouches.length);
					// 	_touch.dobuleflag = true;
					// }
				});

				$('#html-overlay').on('touchend', function(event) {
					// タッチが終了したら、move前の値を初期化
					_touch.moveBeforeX = null;
					_touch.moveBeforeY = null;
					// console.log("touchend touchflag:",_touch.touchflag)

					// 二本指タップ成功したらウィンドウを閉じる
					if (_touch.doubleflag){
						closeWindow('close');
					}
					_touch.doubleflag = false;

				});

				$('#html-overlay').on('touchmove', function(event) {
					_touch.moveX = event.originalEvent.changedTouches[0].pageX;
					_touch.moveY = event.originalEvent.changedTouches[0].pageY;

					// touchstart -> 許容量以上moveした -> touchend で click とはみなさない
					if (Math.abs((_touch.moveX-_touch.startX)/scale) >= _touch.moveCapacity || Math.abs((_touch.moveY-_touch.startY)/scale) >= _touch.moveCapacity){
						_touch.touchflag = false;
						_touch.doubleflag = false;

					// touchstart -> 許容量以上moveしていない -> touchend で click とみなす
					}else{
						_touch.touchflag = true;
					}
					// console.log("touchmove capa over?:",Math.abs((_touch.moveX-_touch.startX)/scale))
					// console.log("touchmove touchflag:",_touch.touchflag)
					// console.log("double tap flag",_touch.doubleflag)
				});

				// iOS用 二本指タップ検出
				$('#html-overlay').on('gesturestart', function(event) {
					_touch.doubleflag = true;
					_touch.touchflag = true;
					// console.log("double tap start",_touch.doubleflag)
				});

				// 動かなければtrueのまま、gesture発動の場合は touchイベントは実行しない
				$('#html-overlay').on('gestureend', function(event) {
					_touch.touchflag = false;
					// console.log("double tap end",_touch.doubleflag)
				});

			}


			// スロット部分スクロール 独自実装
			$('#slot-block').on(_event['scroll'], function(event) {

				// スマホの場合はスクロール量を独自に割り出す
				if (_event['agent'] == 'sp'){
					_touch.moveBeforeY = _touch.moveBeforeY == null ? _touch.startY : _touch.moveY;
					_touch.moveY = event.originalEvent.changedTouches[0].pageY;
					deltaY = (_touch.moveBeforeY-_touch.moveY)*-1/scale;
					// console.log("touchmove! y: ",_touch.moveY," touchstart: y:",_touch.moveBeforeY," => deltaY:",deltaY);
				}else{
					var deltaY = event.deltaY;
				}

				// スクロール値を足す
				slotScroll += deltaY;
				// スクロール下限値を設定
				if (slotScroll >= 0){
					slotScroll = 0;
				// スクロール上限値を設定
				}else if (slotScroll <= ($('#slot-block ul').height()-dispHeight+slotUlMargin)*-1){
					slotScroll = ($('#slot-block ul').height()-dispHeight+slotUlMargin)*-1;
				}
				$('#slot-block ul').css('top', slotScroll + 'px');
				// pagenation 更新
				for (var i = 0; i < pagenationMax; i++) {
					// 下端まできたら pagenationMax を active にする
					if (slotScroll == ($('#slot-block ul').height()-dispHeight+slotUlMargin)*-1){
						$('#pagenation li.active').removeClass('active');
						$('#pagenation li.page'+pagenationMax).addClass('active');
						break;
					}else if (slotScroll >= $('#page'+(i+2)).position().top*-1/scale){
						$('#pagenation li.active').removeClass('active');
						$('#pagenation li.page'+(i+1)).addClass('active');
						break;
					}
				}

				slotLoad();

			});

		// ---------------------------------------------------
			// pagenation click イベント
			$('#pagenation li').on(_event['click'], function(event) {
				if (checkTouchEvent()){
					event.preventDefault();
					var _this = $(this),
							target = $(this).attr('class'),
							num = target.slice(-1),
							targetY = $('#'+target).position().top;
					// 押された tab がすでに active の場合は何もしない、そうでなければ active にする。
					if (!_this.hasClass('active')){
						$('#pagenation li.active').removeClass('active');
						_this.addClass('active');
					}
					// scroll イベント
					// target が #page7 (o2ui.slot で指定したスロット数に応じた最大値) の場合は、画面下端までスクロール
					if (target == 'page'+pagenationMax){
						targetPos = slotScroll = ($('#slot-block ul').height()-dispHeight+slotUlMargin)*-1;
					}else{
						// ※scale値を渡さないとずれる
						targetPos = slotScroll = targetY*-1/scale;
					}
					$('#slot-block ul').animate({'top': targetPos}, scrollTime);
				}

				slotLoad();

			});

			createButtonEvent();
		}
	// ---------------------------------------------------
		// ボタンの挙動は .button に紐付ける
		function createButtonEvent(){
			$('.button').on(_event['click'],function(){

				// どのボタンを押したかは #id で識別　showOverlay に返す値も #id
				var _this = $(this),
						action = _this.attr("id"),
						classname = _this.attr("class");

				// セーブ＆ロードスロットを押した場合
				if (_this.attr("o2-slot")){
					var slot = _this.attr("o2-slot");
				}
				// console.log("btn obj:",_this,"action:",action,"class:",classname,"slot:",slot);

		// * * *

				// スマホ用 イベントを実行して良いかのチェック
				if (checkTouchEvent()){

					// 押したボタンがサイドメニュー側にある場合
					if (_this.parents("#side-menu").length > 0){

						// close の場合は閉じる
						if (action == "close"){
							closeWindow(action);

						// close 以外の場合
						}else{

							// 押したボタンが .disable でない場合
							if (classname.indexOf("disable") == -1){
								// 押したボタンが .active でない場合
								if (classname.indexOf("active") == -1){

									// 前回 active だったものを取得
									var beforeActive = $(".btn_a.active").attr("id");

									// 他のボタンはactiveじゃなくする
									if (classname.indexOf("btn_a") != -1){
										$(".btn_a.active").removeClass('active');
									}else if (classname.indexOf("btn_b") != -1){
										$(".btn_b.active").removeClass('active');
									}

									// .active 付与
									_this.addClass('active');

									// auto, skip の場合はメニューを閉じる
									if (action == "auto" || action == "skip"){
										if (action == 'auto' ){
											o2ui.automodeStatus = o2ui.automodeStatus == false ? true : false;
											o2ui.skipmodeStatus = o2ui.automodeStatus == true ? false : o2ui.skipmodeStatus;
											if (o2.skipMode != 0){
												o2.skipMode = o2.SKIP_MODE_NONE;
											}
										}else if (action == 'skip'){
											o2ui.skipmodeStatus = o2ui.skipmodeStatus == false ? true : false;
											o2ui.automodeStatus = o2ui.skipmodeStatus == true ? false : o2ui.automodeStatus;
											if (o2.autoMode != false){
												o2.cancelAutoMode();
											}
										}
										closeWindow(action);

									// save, load, config の場合は画面切り替え
									}else{

										// standalone ではなく 未ログインなら nscheck
										if (o2ui.login != null && (action == 'load' || action == 'save')){
											if (o2ui.login == false){
												o2ui.tmp.nscheck = true;
												o2ui.tmp.action = action;
												o2ui.tmp.beforeActive = beforeActive;
												callback('nscheck', -1, callbackOpenContent);
											}else{
												o2ui.tmp.nscheck = null;
												callbackOpenContent(action, beforeActive);
											}
										}else{
											o2ui.tmp.nscheck = null;
											slotPosInit();
											slotImgInit();
											callbackOpenContent(action, beforeActive);
										}
									}

								// 押したボタンが .active の場合
								}else{
									if (classname.indexOf("btn_a") != -1){
										_this.removeClass('active');
										if (action == 'load'){
											$(".content#save-content").addClass('hide').fadeOut(fadeTime, function(){
												$("#info-content").removeClass('hide').fadeIn(fadeTime);
											});
										}else{
											$(".content#"+action+"-content").addClass('hide').fadeOut(fadeTime, function(){
												$("#info-content").removeClass('hide').fadeIn(fadeTime);
											});
										}
									}else{
										if (action == 'auto' ){
											o2ui.automodeStatus = false;
											o2.cancelAutoMode();
											$('#auto').removeClass('active');
										}else if (action == 'skip'){
											o2ui.skipmodeStatus = false;
											o2.skipMode = o2.SKIP_MODE_NONE
											$('#skip').removeClass('active');
										}
									}
								}
							}
						}

			// * * *

					// 押したボタンがコンテンツ側にある場合
					}else if (_this.parents("#contents").length > 0){

						// 押したボタンがセーブ＆ロードのスロットだった場合
						if (_this.parents("#slot-block").length > 0){

							// セーブとロード どちらが active かによって挙動を変える
							if ($("#save").hasClass('active')){
								saveslot = slot;
								if (typeof ev.save.date[slot] !== "undefined"){
									confirmFlag = 'save';
									dialogShow("データを上書きしてよろしいですか？");
								}else{
									callback('save', slot, redrawSlot);
								}

							}else if ($("#load").hasClass('active')){
								// save されていないなら何もしない
								if (typeof ev.save.date[slot] !== 'undefined'){
									loadslot = slot;
									if (String(o2ui.title.status) === 'false'){
									// 現在はタイトル画面ではないのでconfirmを表示
										confirmFlag = 'load';
										dialogShow("現在のデータは保存されません。<br>ロードしてよろしいですか？");
									}else{
										callback('load', slot, closeWindowWithLoad);
									}
								}
							}

						// それ以外
						}else{
							// infoボタン
							if (action == "infobtn"){
								if (o2ui.launchImageStatus) {
									o2ui.launchImageStatus = false;
								}else{
									o2ui.launchImageStatus = true;
								}
								$("#dialog").fadeToggle(fadeTime);
							// デフォルトに戻すボタン
							}else if (action == "default"){
								configMenu.resetToDefault();
							}else if (action == "titlebtn" && classname.indexOf("disable") == -1){
								confirmFlag = 'title';
								dialogShow("現在のデータは保存されません。<br>タイトルに戻りますか？");
							}
						}

					// 押したボタンがconfirmにある場合
					}else if (_this.parents("#confirm").length > 0){
						if (action == "yesbtn"){
							dialogHide();
							if (confirmFlag == 'title'){
								closeWindow('title');
							}else if (confirmFlag == 'save'){
								callback('save', saveslot, redrawSlot);
							}else if (confirmFlag == 'load'){
								callback('load', loadslot, closeWindowWithLoad);
							}
							confirmFlag = undefined;
						}else if (action == "nobtn"){
							dialogHide();
							confirmFlag = undefined;
						}
					}
				}
			});
		}
		function destroyButtonEvent(){
			$('.button').off(_event['click']);
		}


	// ===================================================
	// Main
	// ===================================================
		// 準備が完了したら実行
		$(document).ready(function() {

			// config のスライダー設定
			$('#bgm-vol .o2slide').slider({
					min : 0,
					max : 1,
					step : 0.01,
					slide : function(event, ui){
							// console.log("bgm vol Max:",1,"slider:",ui.value,"Min:",0);
							o2.setBgmGVolume( ui.value );
					},
					scale: scale,
					baseElement : $('#html-overlay')
			});
			$('#se-vol .o2slide').slider({
					min : 0,
					max : 1,
					step : 0.01,
					slide : function(event, ui){
							// console.log("se vol Max:",1,"slider:",ui.value,"Min:",0);
							o2.setSeGVolume( ui.value );
					},
					scale: scale,
					baseElement : $('#html-overlay')
			});
			$('#ch-speed .o2slide').slider({
					min : o2ui.config.chspeed.min,
					max : o2ui.config.chspeed.max,
					step : 1,
					slide : function(event, ui){
							sf.__system.userChSpeed = (o2ui.config.chspeed.max-ui.value+o2ui.config.chspeed.min);
							// console.log("chspeed Max:",o2ui.config.chspeed.max,"slider:",(o2ui.config.chspeed.max-ui.value+o2ui.config.chspeed.min),"Min:",o2ui.config.chspeed.min);
							o2.reloadDelaySpeed();
					},
					scale: scale,
					baseElement : $('#html-overlay')
			});
			$('#auto-speed .o2slide').slider({
					min : o2ui.config.automode.min,
					max : o2ui.config.automode.max,
					step : 1,
					slide : function(event, ui){
							sf.__system.autoModePageWait = (o2ui.config.automode.max-ui.value+o2ui.config.automode.min);
							// console.log("automode Max:",o2ui.config.automode.max,"slider:",(o2ui.config.automode.max-ui.value+o2ui.config.automode.min),"Min:",o2ui.config.automode.min);
							o2.reloadDelaySpeed();
					},
					scale: scale,
					baseElement : $('#html-overlay')
			});

			// configのスライダーを設定
			configMenu.resetToDefault('user');

			// 初期スロットのみ表示
			slotLoad(5);

			// メニューを表示
			resizeElement();

			$('#dummy').fadeIn(fadeTime*2);
			$('#html-overlay').show(function(){

				if (o2ui.login == false && (o2ui.launchView == 'save' || o2ui.launchView == 'load')){
					callback('nscheck', -1, function(){
						if (checkNSLogin()){
							fadeInContent();
						}else{
							closeWindow('close');
						}
					});
				}else{
					fadeInContent();
				}

				function fadeInContent(){
					$('#contents').fadeIn(fadeTime*2, function(){
						// フェードイン完了後に何か動作させる場合はここに記述
						if (o2ui.launchView == 'save' || o2ui.launchView == 'load'){
							slotPosInit();
							slotImgInit();
						}
					});
					$("#side-menu").animate({ left: "0px" }, fadeTime*2, function() {
						// スライド完了後に何か動作させる場合はここに記述
						enableEvents();
					});

					// 使用画像のプリロードを行う
					preload_images_paralell(preloadImages).done(function(){
					  // console.log('loading done');
					});
				}

			});

		});


	});
</script>
</body>
</html>