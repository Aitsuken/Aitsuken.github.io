"use strict";!function(){var r=function(t,o,i){this.value=t,this.duration=o,this.acceleration=i};r.fromString=function(t){var o=(t=t.replace("(","").replace(")","")).split(",");return 3==o.length?new r(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2])):null};var l=function(t){this.points=t,this.totalDuration=t.reduce(function(t,o){return t+o.duration},0)};l.prototype.getCurrentValue=function(t){if(!this.totalDuration)return 0;var o=Date.now()-t;o%=this.totalDuration;for(var i=0,n=1;n<this.points.length&&!(i+this.points[n].duration>o);n++)i+=this.points[n].duration;var e=this.points[n],a=this.points[n-1];e||(e=this.points[this.points.length-1]);var s=(o-i)/e.duration;return 1<e.acceleration?s=Math.pow(s,e.acceleration):e.acceleration<-1&&(s=1-s,s=1-(s=Math.pow(s,-e.acceleration))),a.value+(e.value-a.value)*s};var p={},u=function(){this.xMotion=null,this.yMotion=null,this.loopX=1,this.loopY=1};u.prototype.getXValue=function(t){return this.xMotion&&this.xMotion.points.length?this.xMotion.getCurrentValue(t):null},u.prototype.getYValue=function(t){return this.yMotion&&this.yMotion.points.length?this.yMotion.getCurrentValue(t):null},u.prototype.getLastX=function(){if(!this.xMotion||!this.xMotion.points.length)return null;var t=this.xMotion.points.length;return this.xMotion.points[t-1].value},u.prototype.getLastY=function(){if(!this.yMotion||!this.yMotion.points.length)return null;var t=this.yMotion.points.length;return this.yMotion.points[t-1].value},u.prototype.getXLoopCount=function(t){return this.xMotion.totalDuration?Math.floor((Date.now()-t)/this.xMotion.totalDuration):-1},u.prototype.getYLoopCount=function(t){return this.yMotion.totalDuration?Math.floor((Date.now()-t)/this.yMotion.totalDuration):-1};var s=[],h=function(t,o){this.beginning=Date.now(),this.data=t,this.layer=o,this.initX=o.rect.x,this.initY=o.rect.y,this.loopX=this.data.loopX,this.loopY=this.data.loopY,this.loopXCount=0,this.loopYCount=0,this.finish=!1};h.prototype.start=function(){this.beginning=Date.now(),this.animate()},h.prototype.stop=function(){var t=s.indexOf(this);-1<t&&s.splice(t,1),this.finish=!0},h.prototype.animate=function(){var t=this.data.getXLoopCount(this.beginning),o=this.data.getYLoopCount(this.beginning),i=-1==t||0!=this.loopX&&t>=this.loopX,n=-1==o||0!=this.loopY&&o>=this.loopY;if(this.loopXCount!=t&&(this.loopXCount<this.loopX||0==this.loopX)&&(this.loopXCount=t,this.initX+=this.data.getLastX(),i&&(this.layer.rect.x=this.initX)),this.loopYCount!=o&&(this.loopYCount<this.loopY||0==this.loopY)&&(this.loopYCount=o,this.initY+=this.data.getLastY(),n&&(this.layer.rect.y=this.initY)),i||(this.layer.rect.x=this.initX+this.data.getXValue(this.beginning)),n||(this.layer.rect.y=this.initY+this.data.getYValue(this.beginning)),this.finish||i&&n)this.stop(),$(this).trigger("stop");else{var e=this;renderer.animator.requestFrame(function(){e.animate()})}},Tag.actions.motion_define=new TagAction({rules:{name:{type:"STRING",required:!0},locatex:{type:"STRING",defaultValue:""},locatey:{type:"STRING",defaultValue:""},loop:{type:"INT",defaultValue:1},loopx:{type:"INT"},loopy:{type:"INT"}},action:function(t){var o=/\((-?[0-9,\s]+){3}\)/g,i=t.locatex.match(o);(i=i?i.map(function(t){return r.fromString(t)}):[]).unshift(new r(0,0,0));var n=new l(i),e=t.locatey.match(o);(e=e?e.map(function(t){return r.fromString(t)}):[]).unshift(new r(0,0,0));var a=new l(e),s=p[t.name];return s||(s=p[t.name]=new u),s.xMotion=n,s.yMotion=a,"loop"in t&&(s.loopX=s.loopY=t.loop),"loopx"in t&&(s.loopX=t.loopx),"loopy"in t&&(s.loopY=t.loopy),0}}),Tag.actions.motion_start=new TagAction({rules:{layer:{type:"LAYER",defaultValue:0},page:{type:/fore|back/,defaultValue:"fore"},name:{type:"STRING",required:!0},wait:{type:"BOOLEAN"},canskip:{type:"BOOLEAN"},loopx:{type:"INT"},loopy:{type:"INT"},ix:{type:"FLOAT"},iy:{type:"FLOAT"}},action:function(t){var o=t.layer[t.page],i=p[t.name],n=new h(i,o);if("loopx"in t&&(n.loopX=t.loopx),"loopy"in t&&(n.loopY=t.loopy),"ix"in t&&(n.initX=t.ix),"iy"in t&&(n.initY=t.iy),n.start(),s.push(n),t.wait){var e=this,a=!1;return $(n).one("stop",function(){a||e.done()}),t.canskip&&this.conductor.wait("click",function(){a=!0,n.stop()}),1}return 0}}),Tag.actions.motion_stop=new TagAction({rules:{layer:{type:"LAYER",defaultValue:0},page:{type:/fore|back/,defaultValue:"fore"},name:{type:"STRING",required:!0},lastpos:{type:"BOOLEAN",defaultValue:!0}},action:function(n){return s.forEach(function(t){if(t.data==p[n.name]&&t.layer==n.layer[n.page]&&(t.stop(),n.lastpos)){var o=t.data.getLastX(),i=t.data.getLastY();null!==o&&(t.layer.rect.x=o),null!==i&&(t.layer.rect.y=i)}}),0}})}();