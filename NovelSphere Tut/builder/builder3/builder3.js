var Builder3=function(){function g(f,p,h,l,j,i,w,x){var s={},i=y.readdirRSync(f),u=[],f=y.readdirRSync(c.join(f,"data")),m=[],r=RegExp(".*\\.("+h.join("|")+")$","i");i.filter(function(a){return d.statSync(a).isFile()&&r.test(a)}).forEach(function(a){u.push(a)});for(var E in f)m.push(c.basename(f[E]));setTimeout(function(){var f=function(t){var e=c.basename(u[t],c.extname(u[t])),n=c.extname(u[t]).substr(1),k=c.basename(u[t]),i="./"+l+"/",A=!0,q=!0,r=!1;if(""==e||""==n)A=q=!1;if(s[e]){var E=h.indexOf("extname"),
v=h.indexOf(c.extname(s[e]));E>v&&(A=!1)}s[k]&&(q=!1);q&&("sound"==l?n==b.SOUND[0]?!w&&-1==m.indexOf(e+"."+b.SOUND[1])&&(a.warn("\u30d3\u30eb\u30c9\u5143\u306b"+k+"\u306b\u5bfe\u5fdc\u3059\u308b\u30b5\u30a6\u30f3\u30c9\u30d5\u30a1\u30a4\u30eb"+e+"."+b.SOUND[1]+"\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093"),q=!1,exitFlg=!0):n==b.SOUND[1]&&(!w&&-1==m.indexOf(e+"."+b.SOUND[0])?-2==m.indexOf(e+"."+b.VIDEO[1])+m.indexOf(e+"."+b.VIDEO[2])?(a.warn("\u30d3\u30eb\u30c9\u5143\u306b"+k+"\u306b\u5bfe\u5fdc\u3059\u308bwebm/ogv\u30d3\u30c7\u30aa\u30d5\u30a1\u30a4\u30eb "+
e+"."+b.VIDEO[1]+" / "+e+"."+b.VIDEO[2]+" \u304b\u3001ogg\u30b5\u30a6\u30f3\u30c9\u30d5\u30a1\u30a4\u30eb"+e+"."+b.SOUND[0]+"\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093"),q=!1,exitFlg=!0,j.push(k)):r=!0:j.push(k)):"video"==l?n==b.VIDEO[0]?!w&&-1==j.indexOf(k)?(-1==m.indexOf(e+"."+b.VIDEO[1])&&(a.warn("\u30d3\u30eb\u30c9\u5143\u306b"+k+"\u306b\u5bfe\u5fdc\u3059\u308bogv\u30d3\u30c7\u30aa\u30d5\u30a1\u30a4\u30eb"+e+"."+b.VIDEO[1]+"\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093"),q=!1,exitFlg=
!0),-1==m.indexOf(e+"."+b.VIDEO[2])&&(a.warn("\u30d3\u30eb\u30c9\u5143\u306b"+k+"\u306b\u5bfe\u5fdc\u3059\u308bwebm\u30d3\u30c7\u30aa\u30d5\u30a1\u30a4\u30eb"+e+"."+b.VIDEO[2]+"\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093"),q=!1,exitFlg=!0)):r=!0:n==b.VIDEO[1]?(!w&&-1==m.indexOf(e+"."+b.VIDEO[0])&&(a.warn("\u30d3\u30eb\u30c9\u5143\u306b"+k+"\u306b\u5bfe\u5fdc\u3059\u308bmp4\u30d3\u30c7\u30aa\u30d5\u30a1\u30a4\u30eb"+e+"."+b.VIDEO[0]+"\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093"),q=!1,exitFlg=
!0),!w&&-1==m.indexOf(e+"."+b.VIDEO[2])&&(a.warn("\u30d3\u30eb\u30c9\u5143\u306b"+k+"\u306b\u5bfe\u5fdc\u3059\u308bwebm\u30d3\u30c7\u30aa\u30d5\u30a1\u30a4\u30eb"+e+"."+b.VIDEO[2]+"\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093"),q=!1,exitFlg=!0)):n==b.VIDEO[2]&&(!w&&-1==m.indexOf(e+"."+b.VIDEO[0])&&(a.warn("\u30d3\u30eb\u30c9\u5143\u306b"+k+"\u306b\u5bfe\u5fdc\u3059\u308bmp4\u30d3\u30c7\u30aa\u30d5\u30a1\u30a4\u30eb"+e+"."+b.VIDEO[0]+"\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093"),q=!1,exitFlg=
!0),!w&&-1==m.indexOf(e+"."+b.VIDEO[1])&&(a.warn("\u30d3\u30eb\u30c9\u5143\u306b"+k+"\u306b\u5bfe\u5fdc\u3059\u308bwebm\u30d3\u30c7\u30aa\u30d5\u30a1\u30a4\u30eb"+e+"."+b.VIDEO[1]+"\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093"),q=!1,exitFlg=!0)):"font"==l&&(n==b.FONT[0]?!w&&-1==m.indexOf(e+"."+b.FONT[1])&&(a.warn("\u30d3\u30eb\u30c9\u5143\u306b"+k+"\u306b\u5bfe\u5fdc\u3059\u308bttf\u30d5\u30a9\u30f3\u30c8\u30d5\u30a1\u30a4\u30eb"+e+"."+b.FONT[1]+"\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093"),
q=!1,exitFlg=!0):n==b.FONT[1]&&(!w&&-1==m.indexOf(e+"."+b.FONT[0]))&&(a.warn("\u30d3\u30eb\u30c9\u5143\u306b"+k+"\u306b\u5bfe\u5fdc\u3059\u308bwoff\u30d5\u30a9\u30f3\u30c8\u30d5\u30a1\u30a4\u30eb"+e+"."+b.FONT[0]+"\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093"),q=!1,exitFlg=!0)));A&&"image"==l&&(A&&(s[e.toLowerCase()]=i+k.toLowerCase()),q&&(s[k.toLowerCase()]=i+k.toLowerCase()));q&&"sound"==l&&q&&!r&&(s[e.toLowerCase()]=i+e.toLowerCase());"video"==l&&q&&!r&&(s[e.toLowerCase()]=i+e.toLowerCase());
"font"==l&&q&&(s[e.toLowerCase()]=i+e.toLowerCase());if(r)t<u.length?f(t+1):x(s);else if(q){var g=c.normalize(u[t]),e=c.join(p,l,k.toLowerCase());d.existsSync(e)?(n=z.inspect(d.statSync(u[t])).mtime,k=z.inspect(d.statSync(u[t])).mtime,n>k?y.copy(g,e,function(){a.message("\u4e0a\u66f8\u30b3\u30d4\u30fc:"+g);t<u.length?f(t+1):x(s)}):setTimeout(function(){a.message("\u30b3\u30d4\u30fc\u7701\u7565:"+g);t<u.length?f(t+1):x(s)},0)):y.copy(g,e,function(){a.message("\u65b0\u898f\u30b3\u30d4\u30fc:"+g);t<
u.length?f(t+1):x(s)})}else x(s)};0<u.length?f(0):x(s)},0)}this.log;var d=require("fs"),c=require("path"),z=require("util"),x=require("unorm"),J=require("adm-zip"),f,G=require("./nodejs/builder/builder.js"),K=require("./package.json"),a,y=require("./fsex.js"),h,B,H,i,F,j,I,C="./engines",b={IMAGE:["png","jpeg","jpg","gif"],SOUND:["ogg","mp4"],VIDEO:["mp4","ogv","webm"],FONT:["woff","ttf"]};this.run=function(d,b,c){i="undefined"===typeof module||require.main!==module;b?(a=b,f=d):(a=require("./log.js"),
f=require("commander"),f.option("-s, --splitfiles","splitfiles\u30e2\u30fc\u30c9\u3067\u30d3\u30eb\u30c9").option("-k, --kag3","KAG3\u4e92\u63db\u6587\u6cd5\u30e2\u30fc\u30c9\u3067\u30d3\u30eb\u30c9").option("-r, --release","\u30ea\u30ea\u30fc\u30b9\u30e2\u30fc\u30c9\u3067\u30d3\u30eb\u30c9").option("-x, --o2server","O\u2082 Server\u30e2\u30fc\u30c9\u3067\u30d3\u30eb\u30c9").option("-e, --engine [version]","\u6307\u5b9a\u3057\u305f\u30d0\u30fc\u30b8\u30e7\u30f3\u306eO\u2082 Engine\u3067\u30d3\u30eb\u30c9").option("-E, --engines [path]",
"O\u2082 Engine\u306e\u683c\u7d0d\u3055\u308c\u305f\u30d5\u30a9\u30eb\u30c0\u3092\u6307\u5b9a").option("-V, --version","\u30d0\u30fc\u30b8\u30e7\u30f3\u60c5\u5831\u3092\u8868\u793a").option("-f, --force","\u30d5\u30a1\u30a4\u30eb\u6574\u5408\u6027\u30c1\u30a7\u30c3\u30af\u3092\u884c\u308f\u306a\u3044\u3067\u30d3\u30eb\u30c9").option("-p, --package","\u30ce\u30d9\u30eb\u30b9\u30d5\u30a3\u30a2\u5411\u3051\u306b\u30d1\u30c3\u30b1\u30fc\u30b8\u30f3\u30b0").option("-w, --wrapper [version]","\u6307\u5b9a\u3057\u305f\u30d0\u30fc\u30b8\u30e7\u30f3\u306eO\u2082 Wrapper\u3067\u30d3\u30eb\u30c9").option("-W, --wrappers [path]",
"O\u2082 Wrapper\u306e\u683c\u7d0d\u3055\u308c\u305f\u30d5\u30a9\u30eb\u30c0\u3092\u6307\u5b9a").parse(process.argv));return!this.setupValidation(f.args,i)?!1:f.package?!this.execPackage()?!1:!0:!this.buildSetup()||!this.execCompile()||!this.execCopyAssets(c)?!1:!0};this.version=function(){return K.version};this.execGetNovelchan=function(){a.message("\u306e\u3079\u308b\u3061\u3083\u3093\u30ed\u30fc\u30c9")};this.setupValidation=function(b,p){if(2<b.length||2>b.length)if(a.error("\u5f15\u6570\u306e\u6570\u306b\u8aa4\u308a\u304c\u3042\u308a\u307e\u3059"),
p)return!1;if(!f.package){if(f.engines)if(!d.existsSync(f.engines)||!d.statSync(f.engines).isDirectory()){if(a.error("\u6307\u5b9a\u3055\u308c\u305fengines\u30d5\u30a9\u30eb\u30c0\u304c\u3042\u308a\u307e\u305b\u3093"),p)return!1}else C=f.engines;if(!d.existsSync(C)||!d.statSync(C).isDirectory())if(a.error("engines\u30d5\u30a9\u30eb\u30c0\u304c\u3042\u308a\u307e\u305b\u3093"),p)return!1;if(f.engine)H=f.engine;else if(a.error("\u30a8\u30f3\u30b8\u30f3\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u6307\u5b9a\u304c\u3042\u308a\u307e\u305b\u3093"),
p)return!1;B=c.join(C,H);if(!d.existsSync(B)||!d.statSync(B).isDirectory())if(a.error("\u6307\u5b9a\u3055\u308c\u305f\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30a8\u30f3\u30b8\u30f3\u304c\u3042\u308a\u307e\u305b\u3093"),p)return!1}j=c.normalize(f.args[0]+"/");h=f.package?c.normalize(f.args[1]):c.normalize(f.args[1]+"/");if(!d.existsSync(j)&&(a.error("\u30d3\u30eb\u30c9\u5143\u30d5\u30a9\u30eb\u30c0\u304c\u3042\u308a\u307e\u305b\u3093"),p)||!d.statSync(j).isDirectory()&&(a.error("\u6307\u5b9a\u3055\u308c\u305f\u30d3\u30eb\u30c9\u5143\u304c\u30d5\u30a9\u30eb\u30c0\u3067\u3042\u308a\u307e\u305b\u3093"),
p)||j==h&&(a.error("\u30d3\u30eb\u30c9\u5143\u3068\u30d3\u30eb\u30c9\u5148\u304c\u540c\u3058\u30d5\u30a9\u30eb\u30c0\u3067\u3059"),p)||-1!=j.indexOf(h)&&(a.error("\u30d3\u30eb\u30c9\u5143\u30d5\u30a9\u30eb\u30c0\u304c\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u306e\u5185\u90e8\u3067\u3059"),p)||-1!=h.indexOf(j)&&(a.error("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u304c\u30d3\u30eb\u30c9\u5143\u30d5\u30a9\u30eb\u30c0\u306e\u5185\u90e8\u3067\u3059"),p))return!1;F=d.readdirSync(j);var i=
[],l;for(l in F)i.push(F[l].toLowerCase());if(-1==i.indexOf("config.json")||!d.statSync(c.join(j,"config.json")).isFile())if(a.error("\u30d3\u30eb\u30c9\u5143\u30d5\u30a9\u30eb\u30c0\u306bconfig.json\u304c\u3042\u308a\u307e\u305b\u3093"),p)return!1;if(-1==i.indexOf("data")||!d.statSync(c.join(j,"data")).isDirectory())if(a.error("\u30d3\u30eb\u30c9\u5143\u30d5\u30a9\u30eb\u30c0\u306bdata\u30d5\u30a9\u30eb\u30c0\u304c\u3042\u308a\u307e\u305b\u3093"),p)return!1;return!0};this.execPackage=function(){a.message("\u30d1\u30c3\u30b1\u30fc\u30b8\u30f3\u30b0\u4e2d\u3067\u3059");
var b=new J;b.addLocalFolder(j);b.toBuffer(function(b){a.message("ZIP\u30d5\u30a1\u30a4\u30eb\u306e\u66f8\u304d\u51fa\u3057\u4e2d\u3067\u3059");d.writeFile(h,b,function(){a.end("\u30d1\u30c3\u30b1\u30fc\u30b8\u30f3\u30b0\u3092\u5b8c\u4e86\u3057\u307e\u3057\u305f");callback&&callback(null)})},function(){a.error("\u30d1\u30c3\u30b1\u30fc\u30b8\u30f3\u30b0\u306b\u5931\u6557\u3057\u307e\u3057\u305f");if(i)return!1},function(){},function(b){a.message("\u5727\u7e2e:"+b)});return!0};this.buildSetup=function(){if(!d.existsSync(h))try{return d.mkdirSync(h),
a.message("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f"),!0}catch(b){if(a.error("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u306e\u4f5c\u6210\u306b\u5931\u6557\u3057\u307e\u3057\u305f"),i)return!1}if(!d.statSync(h).isDirectory())return a.error("\u6307\u5b9a\u3055\u308c\u305f\u30d3\u30eb\u30c9\u5148\u306b\u30d5\u30a1\u30a4\u30eb\u304c\u5b58\u5728\u3057\u307e\u3059"),i?!1:!0;var f=d.readdirSync(h),c=[],j;for(j in f)c.push(f[j].toLowerCase());return-1==
c.indexOf("script.js")&&(a.error("\u6307\u5b9a\u3055\u308c\u305f\u30d3\u30eb\u30c9\u5148\u306b\u3059\u3067\u306b\u7121\u95a2\u4fc2\u306a\u30d5\u30a9\u30eb\u30c0\u304c\u5b58\u5728\u3057\u307e\u3059"),i)?!1:!0};this.execCopyAssets=function(A){var p=["image","sound","video","font"],D;for(D in p){var l=c.join(h,p[D]);if(d.existsSync(l)){if(d.statSync(l).isFile()&&(a.error("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u306e\u69cb\u9020\u304c\u4e88\u671f\u3055\u308c\u305f\u3082\u306e\u3068\u7570\u306a\u308a\u307e\u3059"),
i))return!1}else try{d.mkdirSync(l)}catch(z){if(a.error("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u306b\u5fc5\u8981\u306a\u30d5\u30a9\u30eb\u30c0\u306e\u4f5c\u6210\u306b\u5931\u6557\u3057\u307e\u3057\u305f"),i)return!1}}a.message("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u306b\u5fc5\u8981\u306a\u30d5\u30a9\u30eb\u30c0\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f");c.join(j,"data");var v=[];g(j,h,b.IMAGE,"image",v,!1,f.force,function(p){g(j,h,b.SOUND,"sound",v,!0,f.force,function(l){g(j,
h,b.VIDEO,"video",v,!0,f.force,function(s){g(j,h,b.FONT,"font",v,!0,f.force,function(b){a.message("\u30b9\u30c8\u30ec\u30fc\u30b8\u306e\u30b3\u30d4\u30fc\u3068\u30b9\u30c8\u30ec\u30fc\u30b8\u4e00\u89a7\u306e\u751f\u6210\u304c\u5b8c\u4e86\u3057\u307e\u3057\u305f");var m=["script.js","script.json","index.html"],r;for(r in m){var g=c.join(h,m[r]);d.existsSync(g)&&d.statSync(g).isFile()&&d.unlinkSync(g)}a.message("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u306e\u4e0d\u8981\u30d5\u30a1\u30a4\u30eb\u3092\u524a\u9664\u3057\u307e\u3057\u305f");
r=c.join(h,"engine");m=c.join(h,"plugin");if(d.existsSync(r))try{y.rmdirRSync(r),a.message("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u5185\u306e\u53e4\u3044O\u2082 Engine\u3092\u524a\u9664\u3057\u307e\u3057\u305f")}catch(v){a.message("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u5185\u306e\u53e4\u3044O\u2082 Engine\u306e\u524a\u9664\u306b\u5931\u6557\u3057\u307e\u3057\u305f")}if(d.existsSync(m))try{y.rmdirRSync(m),a.message("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u5185\u306e\u53e4\u3044\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u524a\u9664\u3057\u307e\u3057\u305f")}catch(t){a.message("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u5185\u306e\u53e4\u3044\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u524a\u9664\u306b\u5931\u6557\u3057\u307e\u3057\u305f")}g=
{imagelist:p,soundlist:l,videolist:s,fontlist:b};b=h;r=f.o2server;var e=I,n;for(n in g)e[n]=g[n];n=x.nfc(JSON.stringify(e));if(r)r="$(function(){getScripts('./script.json')})",g="script.js",d.writeFileSync(c.join(b,"script.json"),n),d.writeFileSync(c.join(b,g),r);else try{d.writeFileSync(c.join(b,"script.js"),"$(function(){initScripts("+n+")})")}catch(k){a.error("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u3078\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u66f8\u304d\u51fa\u3057\u306b\u5931\u6557\u3057\u307e\u3057\u305f")}a.message("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u306b\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u66f8\u304d\u51fa\u3057\u307e\u3057\u305f");
try{y.copyRSync(B,c.join(h,"engine")),d.renameSync(c.join(h,"engine","index.html"),c.join(h,"index.html")),a.message("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u306bO\u2082 Engine\u3092\u8a2d\u7f6e\u3057\u307e\u3057\u305f")}catch(D){if(a.error("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u3078\u306eO\u2082 Engine\u306e\u8a2d\u7f6e\u306b\u5931\u6557\u3057\u307e\u3057\u305f"),i)return!1}n=c.join(j,"plugin");if(d.existsSync(n))try{y.copyRSync(n,m),a.message("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u306b\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u8a2d\u7f6e\u3057\u307e\u3057\u305f")}catch(z){if(a.error("\u30d3\u30eb\u30c9\u5148\u30d5\u30a9\u30eb\u30c0\u3078\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u8a2d\u7f6e\u306b\u5931\u6557\u3057\u307e\u3057\u305f"),
i)return!1}a.end("\u30d3\u30eb\u30c9\u3092\u5b8c\u4e86\u3057\u307e\u3057\u305f");A&&A(null)})})})})};this.execCompile=function(){var b=[],h=/.*\.(ks|asd)$/i;y.readdirRSync(c.join(j,"data")).filter(function(a){return d.statSync(a).isFile()&&h.test(a)}).forEach(function(a){b.push(a)});var g=c.join(j,"config.json"),g=d.readFileSync(g);try{var l=JSON.parse(g.toString("utf8").replace(/^\uFEFF/,"").replace(/\/\*[\s\S]+?\*\//g,"").replace(/\/\/.*/g,""))}catch(x){if(a.error("config.json\u306e\u66f8\u5f0f\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093:\n"+
x),i)return!1}G.configure({legacy:f.kag3?!0:!1,release:f.release?!0:!1});try{var v=G.parseFiles(b)}catch(w){if(a.error("\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u30b3\u30f3\u30d1\u30a4\u30eb\u4e2d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f:\n"+w),i)return!1}if(0<v.warnings.length){a.warn("\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u30b3\u30f3\u30d1\u30a4\u30eb\u4e2d\u306b\u8b66\u544a\u304c\u767a\u751f\u3057\u307e\u3057\u305f:");for(var z in v.warnings)a.warn(v.warnings[z])}I={scripts:v.scripts,
config:l};a.message("\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u30b3\u30f3\u30d1\u30a4\u30eb\u3092\u5b8c\u4e86\u3057\u307e\u3057\u305f");return!0}},builder3=new Builder3;"undefined"!==typeof module&&require.main===module?builder3.run():(exports.build=function(g,d,c){var z={message:function(c){d(c,"normal",!1)},warn:function(c){d(c,"warn",!1)},error:function(g){d(g,"error",!0);c(g)},end:function(c){d(c,"normal",!0)}};setTimeout(function(){builder3.run(g,z,c)},300)},exports.getVersion=function(){return builder3.version()});
