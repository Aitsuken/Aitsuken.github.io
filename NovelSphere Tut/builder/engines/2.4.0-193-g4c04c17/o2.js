/*//////////////////////////////////////////////////////////////////////////////
O₂ Engine  -  version 2.4.0-193-g4c04c17
Date : 2020-02-01
Copyright ©2012-2020 Gengosha Inc. All rights reserved.
To use or redistribute this software, please read 
http://developer.novelsphere.jp/

This software includes undermentioned libraries.
The following license descriptions are NOT about the license of O₂ Engine itself.

*** jQuery ***
Copyright 2013 jQuery Foundation and other contributors
http://jquery.com/

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
//////////////////////////////////////////////////////////////////////////////*/
"use strict";var _get=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,r,n)}if("value"in i)return i.value;var a=i.get;return void 0!==a?a.call(n):void 0},_createClass=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function clone(e,t){if(e&&e.clone&&"function"==typeof e.clone)return e.clone();if(null==e||"object"!=(void 0===e?"undefined":_typeof(e))||/\[object HTML[A-Za-z]*Element\]/.test(Object.prototype.toString.apply(e))||/\[object Window\]/.test(Object.prototype.toString.apply(e)))return e;if(e instanceof Date){var r=new Date;return r.setTime(e.getTime()),r}if(e instanceof Array){for(var n=[],i=0,o=e.length;i<o;i++)n[i]=clone(e[i]);return n}if(e instanceof Object){var a=void 0;if(a=window[e.initializer]&&e instanceof window[e.initializer]?new window[e.initializer]:new e.constructor,t&&(a.originalReference=e),"function"==typeof a.importFrom)a.importFrom(e);else for(var s in e)e.hasOwnProperty(s)&&(a[s]=clone(e[s]));return a}throw new Error("[内部エラー] オブジェクトをコピーできません。この型はサポートされていません")}function mergeObj(e,t){for(var r in e)"object"!=_typeof(e[r])||null==t[r]?t[r]=e[r]:mergeObj(e[r],t[r]);return t}!function(p,x){var n,t,m=void 0===x?"undefined":_typeof(x),e=p.location,g=p.document,r=g.documentElement,i=p.jQuery,o=p.$,a={},s=[],c="2.0.0",y=s.concat,u=s.push,l=s.slice,h=s.indexOf,f=a.toString,v=a.hasOwnProperty,d=c.trim,be=function e(t,r){return new e.fn.init(t,r,n)},w=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,C=/\S+/g,T=/^(?:(<[\w\W]+>)[^>]*|#([\w-]*))$/,b=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,L=/^-ms-/,S=/-([\da-z])/gi,k=function(e,t){return t.toUpperCase()},A=function e(){g.removeEventListener("DOMContentLoaded",e,!1),p.removeEventListener("load",e,!1),be.ready()};function O(e){var t=e.length,r=be.type(e);return!be.isWindow(e)&&(!(1!==e.nodeType||!t)||("array"===r||"function"!==r&&(0===t||"number"==typeof t&&0<t&&t-1 in e)))}be.fn=be.prototype={jquery:c,constructor:be,init:function(e,t,r){var n,i;if(!e)return this;if("string"!=typeof e)return e.nodeType?(this.context=this[0]=e,this.length=1,this):be.isFunction(e)?r.ready(e):(e.selector!==x&&(this.selector=e.selector,this.context=e.context),be.makeArray(e,this));if(!(n="<"===e.charAt(0)&&">"===e.charAt(e.length-1)&&3<=e.length?[null,e,null]:T.exec(e))||!n[1]&&t)return!t||t.jquery?(t||r).find(e):this.constructor(t).find(e);if(n[1]){if(t=t instanceof be?t[0]:t,be.merge(this,be.parseHTML(n[1],t&&t.nodeType?t.ownerDocument||t:g,!0)),b.test(n[1])&&be.isPlainObject(t))for(n in t)be.isFunction(this[n])?this[n](t[n]):this.attr(n,t[n]);return this}return(i=g.getElementById(n[2]))&&i.parentNode&&(this.length=1,this[0]=i),this.context=g,this.selector=e,this},selector:"",length:0,toArray:function(){return l.call(this)},get:function(e){return null==e?this.toArray():e<0?this[this.length+e]:this[e]},pushStack:function(e){var t=be.merge(this.constructor(),e);return t.prevObject=this,t.context=this.context,t},each:function(e,t){return be.each(this,e,t)},ready:function(e){return be.ready.promise().done(e),this},slice:function(){return this.pushStack(l.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,r=+e+(e<0?t:0);return this.pushStack(0<=r&&r<t?[this[r]]:[])},map:function(r){return this.pushStack(be.map(this,function(e,t){return r.call(e,t,e)}))},end:function(){return this.prevObject||this.constructor(null)},push:u,sort:[].sort,splice:[].splice},be.fn.init.prototype=be.fn,be.extend=be.fn.extend=function(){var e,t,r,n,i,o,a=arguments[0]||{},s=1,c=arguments.length,u=!1;for("boolean"==typeof a&&(u=a,a=arguments[1]||{},s=2),"object"==(void 0===a?"undefined":_typeof(a))||be.isFunction(a)||(a={}),c===s&&(a=this,--s);s<c;s++)if(null!=(e=arguments[s]))for(t in e)r=a[t],a!==(n=e[t])&&(u&&n&&(be.isPlainObject(n)||(i=be.isArray(n)))?(o=i?(i=!1,r&&be.isArray(r)?r:[]):r&&be.isPlainObject(r)?r:{},a[t]=be.extend(u,o,n)):n!==x&&(a[t]=n));return a},be.extend({expando:"jQuery"+(c+Math.random()).replace(/\D/g,""),noConflict:function(e){return p.$===be&&(p.$=o),e&&p.jQuery===be&&(p.jQuery=i),be},isReady:!1,readyWait:1,holdReady:function(e){e?be.readyWait++:be.ready(!0)},ready:function(e){(!0===e?--be.readyWait:be.isReady)||((be.isReady=!0)!==e&&0<--be.readyWait||(t.resolveWith(g,[be]),be.fn.trigger&&be(g).trigger("ready").off("ready")))},isFunction:function(e){return"function"===be.type(e)},isArray:Array.isArray,isWindow:function(e){return null!=e&&e===e.window},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},type:function(e){return null==e?e+"":"object"==(void 0===e?"undefined":_typeof(e))||"function"==typeof e?a[f.call(e)]||"object":void 0===e?"undefined":_typeof(e)},isPlainObject:function(e){if("object"!==be.type(e)||e.nodeType||be.isWindow(e))return!1;try{if(e.constructor&&!v.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}return!0},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},error:function(e){throw Error(e)},parseHTML:function(e,t,r){if(!e||"string"!=typeof e)return null;"boolean"==typeof t&&(r=t,t=!1),t=t||g;var n=b.exec(e),i=!r&&[];return n?[t.createElement(n[1])]:(n=be.buildFragment([e],t,i),i&&be(i).remove(),be.merge([],n.childNodes))},parseJSON:JSON.parse,parseXML:function(e){var t;if(!e||"string"!=typeof e)return null;try{t=(new DOMParser).parseFromString(e,"text/xml")}catch(e){t=x}return(!t||t.getElementsByTagName("parsererror").length)&&be.error("Invalid XML: "+e),t},noop:function(){},globalEval:function(e){var t,r=eval;(e=be.trim(e))&&(1===e.indexOf("use strict")?((t=g.createElement("script")).text=e,g.head.appendChild(t).parentNode.removeChild(t)):r(e))},camelCase:function(e){return e.replace(L,"ms-").replace(S,k)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t,r){var n=0,i=e.length,o=O(e);if(r){if(o)for(;n<i&&!1!==t.apply(e[n],r);n++);else for(n in e)if(!1===t.apply(e[n],r))break}else if(o)for(;n<i&&!1!==t.call(e[n],n,e[n]);n++);else for(n in e)if(!1===t.call(e[n],n,e[n]))break;return e},trim:function(e){return null==e?"":d.call(e)},makeArray:function(e,t){var r=t||[];return null!=e&&(O(Object(e))?be.merge(r,"string"==typeof e?[e]:e):u.call(r,e)),r},inArray:function(e,t,r){return null==t?-1:h.call(t,e,r)},merge:function(e,t){var r=t.length,n=e.length,i=0;if("number"==typeof r)for(;i<r;i++)e[n++]=t[i];else for(;t[i]!==x;)e[n++]=t[i++];return e.length=n,e},grep:function(e,t,r){var n=[],i=0,o=e.length;for(r=!!r;i<o;i++)r!==!!t(e[i],i)&&n.push(e[i]);return n},map:function(e,t,r){var n,i=0,o=e.length,a=[];if(O(e))for(;i<o;i++)null!=(n=t(e[i],i,r))&&(a[a.length]=n);else for(i in e)null!=(n=t(e[i],i,r))&&(a[a.length]=n);return y.apply([],a)},guid:1,proxy:function(e,t){var r,n,i;return"string"==typeof t&&(r=e[t],t=e,e=r),be.isFunction(e)?(n=l.call(arguments,2),(i=function(){return e.apply(t||this,n.concat(l.call(arguments)))}).guid=e.guid=e.guid||be.guid++,i):x},access:function(e,t,r,n,i,o,a){var s=0,c=e.length,u=null==r;if("object"===be.type(r))for(s in i=!0,r)be.access(e,t,s,r[s],!0,o,a);else if(n!==x&&(i=!0,be.isFunction(n)||(a=!0),u&&(t=a?(t.call(e,n),null):(u=t,function(e,t,r){return u.call(be(e),r)})),t))for(;s<c;s++)t(e[s],r,a?n:n.call(e[s],s,t(e[s],r)));return i?e:u?t.call(e):c?t(e[0],r):o},now:Date.now,swap:function(e,t,r,n){var i,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];for(o in i=r.apply(e,n||[]),t)e.style[o]=a[o];return i}}),be.ready.promise=function(e){return t||(t=be.Deferred(),"complete"===g.readyState?setTimeout(be.ready):(g.addEventListener("DOMContentLoaded",A,!1),p.addEventListener("load",A,!1))),t.promise(e)},be.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(e,t){a["[object "+t+"]"]=t.toLowerCase()}),n=be(g),function(r,i){var e,b,L,o,t,p,x,u,g,C,n,y,m,a,s,v,w="sizzle"+-new Date,T=r.document,S={},k=0,h=0,c=ne(),l=ne(),f=ne(),d=!1,A=function(){return 0},O=void 0===i?"undefined":_typeof(i),_=[],E=_.pop,R=_.push,N=_.push,D=_.slice,I=_.indexOf||function(e){for(var t=0,r=this.length;t<r;t++)if(this[t]===e)return t;return-1},M="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",F="[\\x20\\t\\r\\n\\f]",B="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",P=B.replace("w","w#"),G="\\["+F+"*("+B+")"+F+"*(?:([*^$|!~]?=)"+F+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+P+")|)|)"+F+"*\\]",z=":("+B+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+G.replace(3,8)+")*)|.*)\\)|)",j=RegExp("^"+F+"+|((?:^|[^\\\\])(?:\\\\.)*)"+F+"+$","g"),V=RegExp("^"+F+"*,"+F+"*"),q=RegExp("^"+F+"*([>+~]|"+F+")"+F+"*"),$=RegExp(F+"*[+~]"),H=RegExp("="+F+"*([^\\]'\"]*)"+F+"*\\]","g"),K=RegExp(z),W=RegExp("^"+P+"$"),U={ID:RegExp("^#("+B+")"),CLASS:RegExp("^\\.("+B+")"),TAG:RegExp("^("+B.replace("w","w*")+")"),ATTR:RegExp("^"+G),PSEUDO:RegExp("^"+z),CHILD:RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+F+"*(even|odd|(([+-]|)(\\d*)n|)"+F+"*(?:([+-]|)"+F+"*(\\d+)|))"+F+"*\\)|)","i"),boolean:RegExp("^(?:"+M+")$","i"),needsContext:RegExp("^"+F+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+F+"*((?:-\\d)?\\d*)"+F+"*\\)|)(?=[^-]|$)","i")},Y=/^[^{]+\{\s*\[native \w/,X=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,J=/^(?:input|select|textarea|button)$/i,Z=/^h\d$/i,Q=/'|\\/g,ee=/\\([\da-fA-F]{1,6}[\x20\t\r\n\f]?|.)/g,te=function(e,t){var r="0x"+t-65536;return r!=r?t:r<0?String.fromCharCode(65536+r):String.fromCharCode(55296|r>>10,56320|1023&r)};try{N.apply(_=D.call(T.childNodes),T.childNodes),_[T.childNodes.length].nodeType}catch(e){N={apply:_.length?function(e,t){R.apply(e,D.call(t))}:function(e,t){for(var r=e.length,n=0;e[r++]=t[n++];);e.length=r-1}}}function re(e){return Y.test(e+"")}function ne(){var r,n=[];return r=function(e,t){return n.push(e+=" ")>L.cacheLength&&delete r[n.shift()],r[e]=t}}function ie(e){return e[w]=!0,e}function oe(e){var t=C.createElement("div");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function ae(e,t,r,n){var i,o,a,s,c,u,l,h,f,d;if((t?t.ownerDocument||t:T)!==C&&g(t),r=r||[],!e||"string"!=typeof e)return r;if(1!==(s=(t=t||C).nodeType)&&9!==s)return[];if(y&&!n){if(i=X.exec(e))if(a=i[1]){if(9===s){if(!(o=t.getElementById(a))||!o.parentNode)return r;if(o.id===a)return r.push(o),r}else if(t.ownerDocument&&(o=t.ownerDocument.getElementById(a))&&v(t,o)&&o.id===a)return r.push(o),r}else{if(i[2])return N.apply(r,t.getElementsByTagName(e)),r;if((a=i[3])&&S.getElementsByClassName&&t.getElementsByClassName)return N.apply(r,t.getElementsByClassName(a)),r}if(S.qsa&&(!m||!m.test(e))){if(h=l=w,f=t,d=9===s&&e,1===s&&"object"!==t.nodeName.toLowerCase()){for(u=de(e),(l=t.getAttribute("id"))?h=l.replace(Q,"\\$&"):t.setAttribute("id",h),h="[id='"+h+"'] ",c=u.length;c--;)u[c]=h+pe(u[c]);f=$.test(e)&&t.parentNode||t,d=u.join(",")}if(d)try{return N.apply(r,f.querySelectorAll(d)),r}catch(e){}finally{l||t.removeAttribute("id")}}}return function(e,t,r,n){var i,o,a,s,c,u=de(e);if(!n&&1===u.length){if(2<(o=u[0]=u[0].slice(0)).length&&"ID"===(a=o[0]).type&&9===t.nodeType&&y&&L.relative[o[1].type]){if(!(t=(L.find.ID(a.matches[0].replace(ee,te),t)||[])[0]))return r;e=e.slice(o.shift().value.length)}for(i=U.needsContext.test(e)?0:o.length;i--&&(a=o[i],!L.relative[s=a.type]);)if((c=L.find[s])&&(n=c(a.matches[0].replace(ee,te),$.test(o[0].type)&&t.parentNode||t))){if(o.splice(i,1),!(e=n.length&&pe(o)))return N.apply(r,n),r;break}}return p(e,u)(n,t,!y,r,$.test(e)),r}(e.replace(j,"$1"),t,r,n)}function se(e,t){var r=t&&e,n=r&&(~t.sourceIndex||1<<31)-(~e.sourceIndex||1<<31);if(n)return n;if(r)for(;r=r.nextSibling;)if(r===t)return-1;return e?1:-1}function ce(e,t,r){var n;return r?i:(n=e.getAttributeNode(t))&&n.specified?n.value:!0===e[t]?t.toLowerCase():null}function ue(e,t,r){return r?i:e.getAttribute(t,"type"===t.toLowerCase()?1:2)}function le(t){return function(e){return"input"===e.nodeName.toLowerCase()&&e.type===t}}function he(r){return function(e){var t=e.nodeName.toLowerCase();return("input"===t||"button"===t)&&e.type===r}}function fe(a){return ie(function(o){return o=+o,ie(function(e,t){for(var r,n=a([],e.length,o),i=n.length;i--;)e[r=n[i]]&&(e[r]=!(t[r]=e[r]))})})}for(e in t=ae.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return!!t&&"HTML"!==t.nodeName},g=ae.setDocument=function(e){var c=e?e.ownerDocument||e:T;return c!==C&&9===c.nodeType&&c.documentElement&&(n=(C=c).documentElement,y=!t(c),S.getElementsByTagName=oe(function(e){return e.appendChild(c.createComment("")),!e.getElementsByTagName("*").length}),S.attributes=oe(function(e){return e.className="i",!e.getAttribute("className")}),S.getElementsByClassName=oe(function(e){return e.innerHTML="<div class='a'></div><div class='a i'></div>",e.firstChild.className="i",2===e.getElementsByClassName("i").length}),S.sortDetached=oe(function(e){return 1&e.compareDocumentPosition(C.createElement("div"))}),S.getById=oe(function(e){return n.appendChild(e).id=w,!c.getElementsByName||!c.getElementsByName(w).length}),S.getById?(L.find.ID=function(e,t){if(_typeof(t.getElementById)!==O&&y){var r=t.getElementById(e);return r&&r.parentNode?[r]:[]}},L.filter.ID=function(e){var t=e.replace(ee,te);return function(e){return e.getAttribute("id")===t}}):(L.find.ID=function(e,t){if(_typeof(t.getElementById)!==O&&y){var r=t.getElementById(e);return r?r.id===e||_typeof(r.getAttributeNode)!==O&&r.getAttributeNode("id").value===e?[r]:i:[]}},L.filter.ID=function(e){var r=e.replace(ee,te);return function(e){var t=_typeof(e.getAttributeNode)!==O&&e.getAttributeNode("id");return t&&t.value===r}}),L.find.TAG=S.getElementsByTagName?function(e,t){return _typeof(t.getElementsByTagName)!==O?t.getElementsByTagName(e):i}:function(e,t){var r,n=[],i=0,o=t.getElementsByTagName(e);if("*"!==e)return o;for(;r=o[i++];)1===r.nodeType&&n.push(r);return n},L.find.CLASS=S.getElementsByClassName&&function(e,t){return _typeof(t.getElementsByClassName)!==O&&y?t.getElementsByClassName(e):i},a=[],m=[],(S.qsa=re(c.querySelectorAll))&&(oe(function(e){e.innerHTML="<select><option selected=''></option></select>",e.querySelectorAll("[selected]").length||m.push("\\["+F+"*(?:value|"+M+")"),e.querySelectorAll(":checked").length||m.push(":checked")}),oe(function(e){var t=C.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("t",""),e.querySelectorAll("[t^='']").length&&m.push("[*^$]="+F+"*(?:''|\"\")"),e.querySelectorAll(":enabled").length||m.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),m.push(",.*:")})),(S.matchesSelector=re(s=n.webkitMatchesSelector||n.mozMatchesSelector||n.oMatchesSelector||n.msMatchesSelector))&&oe(function(e){S.disconnectedMatch=s.call(e,"div"),s.call(e,"[s!='']:x"),a.push("!=",z)}),m=m.length&&RegExp(m.join("|")),a=a.length&&RegExp(a.join("|")),v=re(n.contains)||n.compareDocumentPosition?function(e,t){var r=9===e.nodeType?e.documentElement:e,n=t&&t.parentNode;return e===n||!(!n||1!==n.nodeType||!(r.contains?r.contains(n):e.compareDocumentPosition&&16&e.compareDocumentPosition(n)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},A=n.compareDocumentPosition?function(e,t){if(e===t)return d=!0,0;var r=t.compareDocumentPosition&&e.compareDocumentPosition&&e.compareDocumentPosition(t);return r?1&r||!S.sortDetached&&t.compareDocumentPosition(e)===r?e===c||v(T,e)?-1:t===c||v(T,t)?1:u?I.call(u,e)-I.call(u,t):0:4&r?-1:1:e.compareDocumentPosition?-1:1}:function(e,t){var r,n=0,i=e.parentNode,o=t.parentNode,a=[e],s=[t];if(e===t)return d=!0,0;if(!i||!o)return e===c?-1:t===c?1:i?-1:o?1:u?I.call(u,e)-I.call(u,t):0;if(i===o)return se(e,t);for(r=e;r=r.parentNode;)a.unshift(r);for(r=t;r=r.parentNode;)s.unshift(r);for(;a[n]===s[n];)n++;return n?se(a[n],s[n]):a[n]===T?-1:s[n]===T?1:0}),C},ae.matches=function(e,t){return ae(e,null,null,t)},ae.matchesSelector=function(e,t){if((e.ownerDocument||e)!==C&&g(e),t=t.replace(H,"='$1']"),!(!S.matchesSelector||!y||a&&a.test(t)||m&&m.test(t)))try{var r=s.call(e,t);if(r||S.disconnectedMatch||e.document&&11!==e.document.nodeType)return r}catch(e){}return 0<ae(t,C,null,[e]).length},ae.contains=function(e,t){return(e.ownerDocument||e)!==C&&g(e),v(e,t)},ae.attr=function(e,t){(e.ownerDocument||e)!==C&&g(e);var r=L.attrHandle[t.toLowerCase()],n=r&&r(e,t,!y);return n===i?S.attributes||!y?e.getAttribute(t):(n=e.getAttributeNode(t))&&n.specified?n.value:null:n},ae.error=function(e){throw Error("Syntax error, unrecognized expression: "+e)},ae.uniqueSort=function(e){var t,r=[],n=0,i=0;if(d=!S.detectDuplicates,u=!S.sortStable&&e.slice(0),e.sort(A),d){for(;t=e[i++];)t===e[i]&&(n=r.push(i));for(;n--;)e.splice(r[n],1)}return e},o=ae.getText=function(e){var t,r="",n=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)r+=o(e)}else if(3===i||4===i)return e.nodeValue}else for(;t=e[n];n++)r+=o(t);return r},L=ae.selectors={cacheLength:50,createPseudo:ie,match:U,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(ee,te),e[3]=(e[4]||e[5]||"").replace(ee,te),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||ae.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&ae.error(e[0]),e},PSEUDO:function(e){var t,r=!e[5]&&e[2];return U.CHILD.test(e[0])?null:(e[4]?e[2]=e[4]:r&&K.test(r)&&(t=de(r,!0))&&(t=r.indexOf(")",r.length-t)-r.length)&&(e[0]=e[0].slice(0,t),e[2]=r.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(ee,te).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=c[e+" "];return t||(t=RegExp("(^|"+F+")"+e+"("+F+"|$)"))&&c(e,function(e){return t.test("string"==typeof e.className&&e.className||_typeof(e.getAttribute)!==O&&e.getAttribute("class")||"")})},ATTR:function(r,n,i){return function(e){var t=ae.attr(e,r);return null==t?"!="===n:!n||(t+="","="===n?t===i:"!="===n?t!==i:"^="===n?i&&0===t.indexOf(i):"*="===n?i&&-1<t.indexOf(i):"$="===n?i&&t.slice(-i.length)===i:"~="===n?-1<(" "+t+" ").indexOf(i):"|="===n&&(t===i||t.slice(0,i.length+1)===i+"-"))}},CHILD:function(d,e,t,p,g){var y="nth"!==d.slice(0,3),m="last"!==d.slice(-4),v="of-type"===e;return 1===p&&0===g?function(e){return!!e.parentNode}:function(e,t,r){var n,i,o,a,s,c,u=y!=m?"nextSibling":"previousSibling",l=e.parentNode,h=v&&e.nodeName.toLowerCase(),f=!r&&!v;if(l){if(y){for(;u;){for(o=e;o=o[u];)if(v?o.nodeName.toLowerCase()===h:1===o.nodeType)return!1;c=u="only"===d&&!c&&"nextSibling"}return!0}if(c=[m?l.firstChild:l.lastChild],m&&f){for(s=(n=(i=l[w]||(l[w]={}))[d]||[])[0]===k&&n[1],a=n[0]===k&&n[2],o=s&&l.childNodes[s];o=++s&&o&&o[u]||(a=s=0)||c.pop();)if(1===o.nodeType&&++a&&o===e){i[d]=[k,s,a];break}}else if(f&&(n=(e[w]||(e[w]={}))[d])&&n[0]===k)a=n[1];else for(;(o=++s&&o&&o[u]||(a=s=0)||c.pop())&&((v?o.nodeName.toLowerCase()!==h:1!==o.nodeType)||!++a||(f&&((o[w]||(o[w]={}))[d]=[k,a]),o!==e)););return(a-=g)===p||0==a%p&&0<=a/p}}},PSEUDO:function(e,o){var t,a=L.pseudos[e]||L.setFilters[e.toLowerCase()]||ae.error("unsupported pseudo: "+e);return a[w]?a(o):1<a.length?(t=[e,e,"",o],L.setFilters.hasOwnProperty(e.toLowerCase())?ie(function(e,t){for(var r,n=a(e,o),i=n.length;i--;)e[r=I.call(e,n[i])]=!(t[r]=n[i])}):function(e){return a(e,0,t)}):a}},pseudos:{not:ie(function(e){var n=[],i=[],s=p(e.replace(j,"$1"));return s[w]?ie(function(e,t,r,n){for(var i,o=s(e,null,n,[]),a=e.length;a--;)(i=o[a])&&(e[a]=!(t[a]=i))}):function(e,t,r){return n[0]=e,s(n,null,r,i),!i.pop()}}),has:ie(function(t){return function(e){return 0<ae(t,e).length}}),contains:ie(function(t){return function(e){return-1<(e.textContent||e.innerText||o(e)).indexOf(t)}}),lang:ie(function(r){return W.test(r||"")||ae.error("unsupported lang: "+r),r=r.replace(ee,te).toLowerCase(),function(e){var t;do{if(t=y?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return(t=t.toLowerCase())===r||0===t.indexOf(r+"-")}while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var t=r.location&&r.location.hash;return t&&t.slice(1)===e.id},root:function(e){return e===n},focus:function(e){return e===C.activeElement&&(!C.hasFocus||C.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:function(e){return!1===e.disabled},disabled:function(e){return!0===e.disabled},checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if("@"<e.nodeName||3===e.nodeType||4===e.nodeType)return!1;return!0},parent:function(e){return!L.pseudos.empty(e)},header:function(e){return Z.test(e.nodeName)},input:function(e){return J.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||t.toLowerCase()===e.type)},first:fe(function(){return[0]}),last:fe(function(e,t){return[t-1]}),eq:fe(function(e,t,r){return[r<0?r+t:r]}),even:fe(function(e,t){for(var r=0;r<t;r+=2)e.push(r);return e}),odd:fe(function(e,t){for(var r=1;r<t;r+=2)e.push(r);return e}),lt:fe(function(e,t,r){for(var n=r<0?r+t:r;0<=--n;)e.push(n);return e}),gt:fe(function(e,t,r){for(var n=r<0?r+t:r;t>++n;)e.push(n);return e})}},{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})L.pseudos[e]=le(e);for(e in{submit:!0,reset:!0})L.pseudos[e]=he(e);function de(e,t){var r,n,i,o,a,s,c,u=l[e+" "];if(u)return t?0:u.slice(0);for(a=e,s=[],c=L.preFilter;a;){for(o in(!r||(n=V.exec(a)))&&(n&&(a=a.slice(n[0].length)||a),s.push(i=[])),r=!1,(n=q.exec(a))&&(r=n.shift(),i.push({value:r,type:n[0].replace(j," ")}),a=a.slice(r.length)),L.filter)!(n=U[o].exec(a))||c[o]&&!(n=c[o](n))||(r=n.shift(),i.push({value:r,type:o,matches:n}),a=a.slice(r.length));if(!r)break}return t?a.length:a?ae.error(e):l(e,s).slice(0)}function pe(e){for(var t=0,r=e.length,n="";t<r;t++)n+=e[t].value;return n}function ge(s,e,t){var c=e.dir,u=t&&"parentNode"===c,l=h++;return e.first?function(e,t,r){for(;e=e[c];)if(1===e.nodeType||u)return s(e,t,r)}:function(e,t,r){var n,i,o,a=k+" "+l;if(r){for(;e=e[c];)if((1===e.nodeType||u)&&s(e,t,r))return!0}else for(;e=e[c];)if(1===e.nodeType||u)if((i=(o=e[w]||(e[w]={}))[c])&&i[0]===a){if(!0===(n=i[1])||n===b)return!0===n}else if((i=o[c]=[a])[1]=s(e,t,r)||b,!0===i[1])return!0}}function ye(i){return 1<i.length?function(e,t,r){for(var n=i.length;n--;)if(!i[n](e,t,r))return!1;return!0}:i[0]}function me(e,t,r,n,i){for(var o,a=[],s=0,c=e.length,u=null!=t;s<c;s++)(o=e[s])&&(!r||r(o,n,i))&&(a.push(o),u&&t.push(s));return a}function ve(d,p,g,y,m,e){return y&&!y[w]&&(y=ve(y)),m&&!m[w]&&(m=ve(m,e)),ie(function(e,t,r,n){var i,o,a,s=[],c=[],u=t.length,l=e||function(e,t,r){for(var n=0,i=t.length;n<i;n++)ae(e,t[n],r);return r}(p||"*",r.nodeType?[r]:r,[]),h=!d||!e&&p?l:me(l,s,d,r,n),f=g?m||(e?d:u||y)?[]:t:h;if(g&&g(h,f,r,n),y)for(i=me(f,c),y(i,[],r,n),o=i.length;o--;)(a=i[o])&&(f[c[o]]=!(h[c[o]]=a));if(e){if(m||d){if(m){for(i=[],o=f.length;o--;)(a=f[o])&&i.push(h[o]=a);m(null,f=[],i,n)}for(o=f.length;o--;)(a=f[o])&&-1<(i=m?I.call(e,a):s[o])&&(e[i]=!(t[i]=a))}}else f=me(f===t?f.splice(u,f.length):f),m?m(null,t,f,n):N.apply(t,f)})}function we(e){for(var n,t,r,i=e.length,o=L.relative[e[0].type],a=o||L.relative[" "],s=o?1:0,c=ge(function(e){return e===n},a,!0),u=ge(function(e){return-1<I.call(n,e)},a,!0),l=[function(e,t,r){return!o&&(r||t!==x)||((n=t).nodeType?c(e,t,r):u(e,t,r))}];s<i;s++)if(t=L.relative[e[s].type])l=[ge(ye(l),t)];else{if((t=L.filter[e[s].type].apply(null,e[s].matches))[w]){for(r=++s;r<i&&!L.relative[e[r].type];r++);return ve(1<s&&ye(l),1<s&&pe(e.slice(0,s-1)).replace(j,"$1"),t,s<r&&we(e.slice(s,r)),r<i&&we(e=e.slice(r)),r<i&&pe(e))}l.push(t)}return ye(l)}function Te(){}p=ae.compile=function(e,t){var r,n=[],i=[],o=f[e+" "];if(!o){for(t||(t=de(e)),r=t.length;r--;)(o=we(t[r]))[w]?n.push(o):i.push(o);o=f(e,function(y,m){var v=0,w=0<m.length,T=0<y.length,e=function(e,t,r,n,i){var o,a,s,c=[],u=0,l="0",h=e&&[],f=null!=i,d=x,p=e||T&&L.find.TAG("*",i&&t.parentNode||t),g=k+=null==d?1:Math.random()||.1;for(f&&(x=t!==C&&t,b=v);null!=(o=p[l]);l++){if(T&&o){for(a=0;s=y[a++];)if(s(o,t,r)){n.push(o);break}f&&(k=g,b=++v)}w&&((o=!s&&o)&&u--,e&&h.push(o))}if(u+=l,w&&l!==u){for(a=0;s=m[a++];)s(h,c,t,r);if(e){if(0<u)for(;l--;)h[l]||c[l]||(c[l]=E.call(n));c=me(c)}N.apply(n,c),f&&!e&&0<c.length&&1<u+m.length&&ae.uniqueSort(n)}return f&&(k=g,x=d),h};return w?ie(e):e}(i,n))}return o},L.pseudos.nth=L.pseudos.eq,Te.prototype=L.filters=L.pseudos,L.setFilters=new Te,S.sortStable=w.split("").sort(A).join("")===w,g(),[0,0].sort(A),S.detectDuplicates=d,oe(function(e){if(e.innerHTML="<a href='#'></a>","#"!==e.firstChild.getAttribute("href"))for(var t="type|href|height|width".split("|"),r=t.length;r--;)L.attrHandle[t[r]]=ue}),oe(function(e){if(null!=e.getAttribute("disabled"))for(var t=M.split("|"),r=t.length;r--;)L.attrHandle[t[r]]=ce}),be.find=ae,be.expr=ae.selectors,be.expr[":"]=be.expr.pseudos,be.unique=ae.uniqueSort,be.text=ae.getText,be.isXMLDoc=ae.isXML,be.contains=ae.contains}(p);var _,E,R,N,D,I,M={};be.Callbacks=function(i){i="string"==typeof i?M[i]||function(e){var r=M[e]={};return be.each(e.match(C)||[],function(e,t){r[t]=!0}),r}(i):be.extend({},i);var r,n,o,a,s,c,u=[],l=!i.once&&[],h=function e(t){for(r=i.memory&&t,n=!0,c=a||0,a=0,s=u.length,o=!0;u&&c<s;c++)if(!1===u[c].apply(t[0],t[1])&&i.stopOnFalse){r=!1;break}o=!1,u&&(l?l.length&&e(l.shift()):r?u=[]:f.disable())},f={add:function(){if(u){var e=u.length;(function n(e){be.each(e,function(e,t){var r=be.type(t);"function"===r?i.unique&&f.has(t)||u.push(t):t&&t.length&&"string"!==r&&n(t)})})(arguments),o?s=u.length:r&&(a=e,h(r))}return this},remove:function(){return u&&be.each(arguments,function(e,t){for(var r;-1<(r=be.inArray(t,u,r));)u.splice(r,1),o&&(r<=s&&s--,r<=c&&c--)}),this},has:function(e){return e?-1<be.inArray(e,u):!(!u||!u.length)},empty:function(){return u=[],s=0,this},disable:function(){return u=l=r=x,this},disabled:function(){return!u},lock:function(){return l=x,r||f.disable(),this},locked:function(){return!l},fireWith:function(e,t){return t=[e,(t=t||[]).slice?t.slice():t],!u||n&&!l||(o?l.push(t):h(t)),this},fire:function(){return f.fireWith(this,arguments),this},fired:function(){return!!n}};return f},be.extend({Deferred:function(e){var a=[["resolve","done",be.Callbacks("once memory"),"resolved"],["reject","fail",be.Callbacks("once memory"),"rejected"],["notify","progress",be.Callbacks("memory")]],i="pending",s={state:function(){return i},always:function(){return c.done(arguments).fail(arguments),this},then:function(){var o=arguments;return be.Deferred(function(i){be.each(a,function(e,t){var r=t[0],n=be.isFunction(o[e])&&o[e];c[t[1]](function(){var e=n&&n.apply(this,arguments);e&&be.isFunction(e.promise)?e.promise().done(i.resolve).fail(i.reject).progress(i.notify):i[r+"With"](this===s?i.promise():this,n?[e]:arguments)})}),o=null}).promise()},promise:function(e){return null!=e?be.extend(e,s):s}},c={};return s.pipe=s.then,be.each(a,function(e,t){var r=t[2],n=t[3];s[t[1]]=r.add,n&&r.add(function(){i=n},a[1^e][2].disable,a[2][2].lock),c[t[0]]=function(){return c[t[0]+"With"](this===c?s:this,arguments),this},c[t[0]+"With"]=r.fireWith}),s.promise(c),e&&e.call(c,c),c},when:function(e){var i,t,r,n=0,o=l.call(arguments),a=o.length,s=1!==a||e&&be.isFunction(e.promise)?a:0,c=1===s?e:be.Deferred(),u=function(t,r,n){return function(e){r[t]=this,n[t]=1<arguments.length?l.call(arguments):e,n===i?c.notifyWith(r,n):--s||c.resolveWith(r,n)}};if(1<a)for(i=Array(a),t=Array(a),r=Array(a);n<a;n++)o[n]&&be.isFunction(o[n].promise)?o[n].promise().done(u(n,r,o)).fail(c.reject).progress(u(n,t,i)):--s;return s||c.resolveWith(r,o),c.promise()}}),be.support=(_={},E=g.createElement("input"),R=g.createDocumentFragment(),N=g.createElement("div"),D=g.createElement("select"),I=D.appendChild(g.createElement("option")),E.type&&(E.type="checkbox",_.checkOn=""!==E.value,_.optSelected=I.selected,_.reliableMarginRight=!0,_.boxSizingReliable=!0,_.pixelPosition=!1,E.checked=!0,_.noCloneChecked=E.cloneNode(!0).checked,D.disabled=!0,_.optDisabled=!I.disabled,(E=g.createElement("input")).value="t",E.type="radio",_.radioValue="t"===E.value,E.setAttribute("checked","t"),E.setAttribute("name","t"),R.appendChild(E),_.checkClone=R.cloneNode(!0).cloneNode(!0).lastChild.checked,_.focusinBubbles="onfocusin"in p,N.style.backgroundClip="content-box",N.cloneNode(!0).style.backgroundClip="",_.clearCloneStyle="content-box"===N.style.backgroundClip,be(function(){var e,t,r=g.getElementsByTagName("body")[0];r&&((e=g.createElement("div")).style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",r.appendChild(e).appendChild(N),N.innerHTML="",N.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%",be.swap(r,null!=r.style.zoom?{zoom:1}:{},function(){_.boxSizing=4===N.offsetWidth}),p.getComputedStyle&&(_.pixelPosition="1%"!==(p.getComputedStyle(N,null)||{}).top,_.boxSizingReliable="4px"===(p.getComputedStyle(N,null)||{width:"4px"}).width,(t=N.appendChild(g.createElement("div"))).style.cssText=N.style.cssText="padding:0;margin:0;border:0;display:block;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box",t.style.marginRight=t.style.width="0",N.style.width="1px",_.reliableMarginRight=!parseFloat((p.getComputedStyle(t,null)||{}).marginRight)),r.removeChild(e))})),_);var F,B,P=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,G=/([A-Z])/g;function z(){Object.defineProperty(this.cache={},0,{get:function(){return{}}}),this.expando=be.expando+Math.random()}function j(e,t,r){var n;if(r===x&&1===e.nodeType)if(n="data-"+t.replace(G,"-$1").toLowerCase(),"string"==typeof(r=e.getAttribute(n))){try{r="true"===r||"false"!==r&&("null"===r?null:+r+""===r?+r:P.test(r)?JSON.parse(r):r)}catch(e){}F.set(e,t,r)}else r=x;return r}z.uid=1,z.accepts=function(e){return!e.nodeType||(1===e.nodeType||9===e.nodeType)},z.prototype={key:function(t){if(!z.accepts(t))return 0;var r={},n=t[this.expando];if(!n){n=z.uid++;try{r[this.expando]={value:n},Object.defineProperties(t,r)}catch(e){r[this.expando]=n,be.extend(t,r)}}return this.cache[n]||(this.cache[n]={}),n},set:function(e,t,r){var n,i=this.key(e),o=this.cache[i];if("string"==typeof t)o[t]=r;else if(be.isEmptyObject(o))this.cache[i]=t;else for(n in t)o[n]=t[n]},get:function(e,t){var r=this.cache[this.key(e)];return t===x?r:r[t]},access:function(e,t,r){return t===x||t&&"string"==typeof t&&r===x?this.get(e,t):(this.set(e,t,r),r!==x?r:t)},remove:function(e,t){var r,n,i=this.key(e),o=this.cache[i];if(t===x)this.cache[i]={};else{r=(n=be.isArray(t)?t.concat(t.map(be.camelCase)):t in o?[t]:(n=be.camelCase(t))in o?[n]:n.match(C)||[]).length;for(;r--;)delete o[n[r]]}},hasData:function(e){return!be.isEmptyObject(this.cache[e[this.expando]]||{})},discard:function(e){delete this.cache[this.key(e)]}},F=new z,B=new z,be.extend({acceptData:z.accepts,hasData:function(e){return F.hasData(e)||B.hasData(e)},data:function(e,t,r){return F.access(e,t,r)},removeData:function(e,t){F.remove(e,t)},_data:function(e,t,r){return B.access(e,t,r)},_removeData:function(e,t){B.remove(e,t)}}),be.fn.extend({data:function(n,e){var t,r,i=this[0],o=0,a=null;if(n!==x)return"object"==(void 0===n?"undefined":_typeof(n))?this.each(function(){F.set(this,n)}):be.access(this,function(t){var e,r=be.camelCase(n);if(i&&t===x){if((e=F.get(i,n))!==x)return e;if((e=F.get(i,r))!==x)return e;if((e=j(i,r,x))!==x)return e}else this.each(function(){var e=F.get(this,r);F.set(this,r,t),-1!==n.indexOf("-")&&e!==x&&F.set(this,n,t)})},null,e,1<arguments.length,null,!0);if(this.length&&(a=F.get(i),1===i.nodeType&&!B.get(i,"hasDataAttrs"))){for(t=i.attributes;t.length>o;o++)0===(r=t[o].name).indexOf("data-")&&(r=be.camelCase(r.substring(5)),j(i,r,a[r]));B.set(i,"hasDataAttrs",!0)}return a},removeData:function(e){return this.each(function(){F.remove(this,e)})}}),be.extend({queue:function(e,t,r){var n;return e?(t=(t||"fx")+"queue",n=B.get(e,t),r&&(!n||be.isArray(r)?n=B.access(e,t,be.makeArray(r)):n.push(r)),n||[]):x},dequeue:function(e,t){t=t||"fx";var r=be.queue(e,t),n=r.length,i=r.shift(),o=be._queueHooks(e,t);"inprogress"===i&&(i=r.shift(),n--),(o.cur=i)&&("fx"===t&&r.unshift("inprogress"),delete o.stop,i.call(e,function(){be.dequeue(e,t)},o)),!n&&o&&o.empty.fire()},_queueHooks:function(e,t){var r=t+"queueHooks";return B.get(e,r)||B.access(e,r,{empty:be.Callbacks("once memory").add(function(){B.remove(e,[t+"queue",r])})})}}),be.fn.extend({queue:function(t,r){var e=2;return"string"!=typeof t&&(r=t,t="fx",e--),e>arguments.length?be.queue(this[0],t):r===x?this:this.each(function(){var e=be.queue(this,t,r);be._queueHooks(this,t),"fx"===t&&"inprogress"!==e[0]&&be.dequeue(this,t)})},dequeue:function(e){return this.each(function(){be.dequeue(this,e)})},delay:function(n,e){return n=be.fx&&be.fx.speeds[n]||n,e=e||"fx",this.queue(e,function(e,t){var r=setTimeout(e,n);t.stop=function(){clearTimeout(r)}})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var r,n=1,i=be.Deferred(),o=this,a=this.length,s=function(){--n||i.resolveWith(o,[o])};for("string"!=typeof e&&(t=e,e=x),e=e||"fx";a--;)(r=B.get(o[a],e+"queueHooks"))&&r.empty&&(n++,r.empty.add(s));return s(),i.promise(t)}});var V,q=/[\t\r\n]/g,$=/\r/g,H=/^(?:input|select|textarea|button)$/i;be.fn.extend({attr:function(e,t){return be.access(this,be.attr,e,t,1<arguments.length)},removeAttr:function(e){return this.each(function(){be.removeAttr(this,e)})},prop:function(e,t){return be.access(this,be.prop,e,t,1<arguments.length)},removeProp:function(e){return this.each(function(){delete this[be.propFix[e]||e]})},addClass:function(t){var e,r,n,i,o,a=0,s=this.length,c="string"==typeof t&&t;if(be.isFunction(t))return this.each(function(e){be(this).addClass(t.call(this,e,this.className))});if(c)for(e=(t||"").match(C)||[];a<s;a++)if(n=1===(r=this[a]).nodeType&&(r.className?(" "+r.className+" ").replace(q," "):" ")){for(o=0;i=e[o++];)n.indexOf(" "+i+" ")<0&&(n+=i+" ");r.className=be.trim(n)}return this},removeClass:function(t){var e,r,n,i,o,a=0,s=this.length,c=0===arguments.length||"string"==typeof t&&t;if(be.isFunction(t))return this.each(function(e){be(this).removeClass(t.call(this,e,this.className))});if(c)for(e=(t||"").match(C)||[];a<s;a++)if(n=1===(r=this[a]).nodeType&&(r.className?(" "+r.className+" ").replace(q," "):"")){for(o=0;i=e[o++];)for(;0<=n.indexOf(" "+i+" ");)n=n.replace(" "+i+" "," ");r.className=t?be.trim(n):""}return this},toggleClass:function(o,a){var s=void 0===o?"undefined":_typeof(o),c="boolean"==typeof a;return be.isFunction(o)?this.each(function(e){be(this).toggleClass(o.call(this,e,this.className,a),a)}):this.each(function(){if("string"===s)for(var e,t=0,r=be(this),n=a,i=o.match(C)||[];e=i[t++];)n=c?n:!r.hasClass(e),r[n?"addClass":"removeClass"](e);else(s===m||"boolean"===s)&&(this.className&&B.set(this,"__className__",this.className),this.className=this.className||!1===o?"":B.get(this,"__className__")||"")})},hasClass:function(e){for(var t=" "+e+" ",r=0,n=this.length;r<n;r++)if(1===this[r].nodeType&&0<=(" "+this[r].className+" ").replace(q," ").indexOf(t))return!0;return!1},val:function(n){var i,e,o,t=this[0];return arguments.length?(o=be.isFunction(n),this.each(function(e){var t,r=be(this);1===this.nodeType&&(null==(t=o?n.call(this,e,r.val()):n)?t="":"number"==typeof t?t+="":be.isArray(t)&&(t=be.map(t,function(e){return null==e?"":e+""})),(i=be.valHooks[this.type]||be.valHooks[this.nodeName.toLowerCase()])&&"set"in i&&i.set(this,t,"value")!==x||(this.value=t))})):t?(i=be.valHooks[t.type]||be.valHooks[t.nodeName.toLowerCase()])&&"get"in i&&(e=i.get(t,"value"))!==x?e:"string"==typeof(e=t.value)?e.replace($,""):null==e?"":e:void 0}}),be.extend({valHooks:{option:{get:function(e){var t=e.attributes.value;return!t||t.specified?e.value:e.text}},select:{get:function(e){for(var t,r,n=e.options,i=e.selectedIndex,o="select-one"===e.type||i<0,a=o?null:[],s=o?i+1:n.length,c=i<0?s:o?i:0;c<s;c++)if(!(!(r=n[c]).selected&&c!==i||(be.support.optDisabled?r.disabled:null!==r.getAttribute("disabled"))||r.parentNode.disabled&&be.nodeName(r.parentNode,"optgroup"))){if(t=be(r).val(),o)return t;a.push(t)}return a},set:function(e,t){for(var r,n,i=e.options,o=be.makeArray(t),a=i.length;a--;)((n=i[a]).selected=0<=be.inArray(be(n).val(),o))&&(r=!0);return r||(e.selectedIndex=-1),o}}},attr:function(e,t,r){var n,i,o=e.nodeType;if(e&&3!==o&&8!==o&&2!==o)return _typeof(e.getAttribute)===m?be.prop(e,t,r):(1===o&&be.isXMLDoc(e)||(t=t.toLowerCase(),n=be.attrHooks[t]||(be.expr.match.boolean.test(t)?V:void 0)),r===x?n&&"get"in n&&null!==(i=n.get(e,t))?i:null==(i=be.find.attr(e,t))?x:i:null!==r?n&&"set"in n&&(i=n.set(e,r,t))!==x?i:(e.setAttribute(t,r+""),r):(be.removeAttr(e,t),x))},removeAttr:function(e,t){var r,n,i=0,o=t&&t.match(C);if(o&&1===e.nodeType)for(;r=o[i++];)n=be.propFix[r]||r,be.expr.match.boolean.test(r)&&(e[n]=!1),e.removeAttribute(r)},attrHooks:{type:{set:function(e,t){if(!be.support.radioValue&&"radio"===t&&be.nodeName(e,"input")){var r=e.value;return e.setAttribute("type",t),r&&(e.value=r),t}}}},propFix:{for:"htmlFor",class:"className"},prop:function(e,t,r){var n,i,o=e.nodeType;if(e&&3!==o&&8!==o&&2!==o)return(1!==o||!be.isXMLDoc(e))&&(t=be.propFix[t]||t,i=be.propHooks[t]),r!==x?i&&"set"in i&&(n=i.set(e,r,t))!==x?n:e[t]=r:i&&"get"in i&&null!==(n=i.get(e,t))?n:e[t]},propHooks:{tabIndex:{get:function(e){return e.hasAttribute("tabindex")||H.test(e.nodeName)||e.href?e.tabIndex:-1}}}}),V={set:function(e,t,r){return!1===t?be.removeAttr(e,r):e.setAttribute(r,r),r}},be.each(be.expr.match.boolean.source.match(/\w+/g),function(e,t){var o=be.expr.attrHandle[t]||be.find.attr;be.expr.attrHandle[t]=function(e,t,r){var n=be.expr.attrHandle[t],i=r?x:(be.expr.attrHandle[t]=x)!=o(e,t,r)?t.toLowerCase():null;return be.expr.attrHandle[t]=n,i}}),be.support.optSelected||(be.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null}}),be.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){be.propFix[this.toLowerCase()]=this}),be.each(["radio","checkbox"],function(){be.valHooks[this]={set:function(e,t){return be.isArray(t)?e.checked=0<=be.inArray(be(e).val(),t):x}},be.support.checkOn||(be.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var K=/^key/,W=/^(?:mouse|contextmenu)|click/,U=/^(?:focusinfocus|focusoutblur)$/,Y=/^([^.]*)(?:\.(.+)|)$/;function X(){return!0}function J(){return!1}function Z(){try{return g.activeElement}catch(e){}}be.event={global:{},add:function(e,t,r,n,i){var o,a,s,c,u,l,h,f,d,p,g,y=B.get(e);if(y){for(r.handler&&(r=(o=r).handler,i=o.selector),r.guid||(r.guid=be.guid++),(c=y.events)||(c=y.events={}),(a=y.handle)||((a=y.handle=function(e){return(void 0===be?"undefined":_typeof(be))===m||e&&be.event.triggered===e.type?x:be.event.dispatch.apply(a.elem,arguments)}).elem=e),u=(t=(t||"").match(C)||[""]).length;u--;)d=g=(s=Y.exec(t[u])||[])[1],p=(s[2]||"").split(".").sort(),d&&(h=be.event.special[d]||{},d=(i?h.delegateType:h.bindType)||d,h=be.event.special[d]||{},l=be.extend({type:d,origType:g,data:n,handler:r,guid:r.guid,selector:i,needsContext:i&&be.expr.match.needsContext.test(i),namespace:p.join(".")},o),(f=c[d])||((f=c[d]=[]).delegateCount=0,h.setup&&!1!==h.setup.call(e,n,p,a)||e.addEventListener&&e.addEventListener(d,a,!1)),h.add&&(h.add.call(e,l),l.handler.guid||(l.handler.guid=r.guid)),i?f.splice(f.delegateCount++,0,l):f.push(l),be.event.global[d]=!0);e=null}},remove:function(e,t,r,n,i){var o,a,s,c,u,l,h,f,d,p,g,y=B.hasData(e)&&B.get(e);if(y&&(c=y.events)){for(u=(t=(t||"").match(C)||[""]).length;u--;)if(d=g=(s=Y.exec(t[u])||[])[1],p=(s[2]||"").split(".").sort(),d){for(h=be.event.special[d]||{},f=c[d=(n?h.delegateType:h.bindType)||d]||[],s=s[2]&&RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=f.length;o--;)l=f[o],!i&&g!==l.origType||r&&r.guid!==l.guid||s&&!s.test(l.namespace)||n&&n!==l.selector&&("**"!==n||!l.selector)||(f.splice(o,1),l.selector&&f.delegateCount--,h.remove&&h.remove.call(e,l));a&&!f.length&&(h.teardown&&!1!==h.teardown.call(e,p,y.handle)||be.removeEvent(e,d,y.handle),delete c[d])}else for(d in c)be.event.remove(e,d+t[u],r,n,!0);be.isEmptyObject(c)&&(delete y.handle,B.remove(e,"events"))}},trigger:function(e,t,r,n){var i,o,a,s,c,u,l,h=[r||g],f=v.call(e,"type")?e.type:e,d=v.call(e,"namespace")?e.namespace.split("."):[];if(o=a=r=r||g,3!==r.nodeType&&8!==r.nodeType&&!U.test(f+be.event.triggered)&&(0<=f.indexOf(".")&&(f=(d=f.split(".")).shift(),d.sort()),c=f.indexOf(":")<0&&"on"+f,(e=e[be.expando]?e:new be.Event(f,"object"==(void 0===e?"undefined":_typeof(e))&&e)).isTrigger=n?2:3,e.namespace=d.join("."),e.namespace_re=e.namespace?RegExp("(^|\\.)"+d.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=x,e.target||(e.target=r),t=null==t?[e]:be.makeArray(t,[e]),l=be.event.special[f]||{},n||!l.trigger||!1!==l.trigger.apply(r,t))){if(!n&&!l.noBubble&&!be.isWindow(r)){for(s=l.delegateType||f,U.test(s+f)||(o=o.parentNode);o;o=o.parentNode)h.push(o),a=o;a===(r.ownerDocument||g)&&h.push(a.defaultView||a.parentWindow||p)}for(i=0;(o=h[i++])&&!e.isPropagationStopped();)e.type=1<i?s:l.bindType||f,(u=(B.get(o,"events")||{})[e.type]&&B.get(o,"handle"))&&u.apply(o,t),(u=c&&o[c])&&be.acceptData(o)&&u.apply&&!1===u.apply(o,t)&&e.preventDefault();return e.type=f,n||e.isDefaultPrevented()||l._default&&!1!==l._default.apply(h.pop(),t)||!be.acceptData(r)||c&&be.isFunction(r[f])&&!be.isWindow(r)&&((a=r[c])&&(r[c]=null),r[be.event.triggered=f](),be.event.triggered=x,a&&(r[c]=a)),e.result}},dispatch:function(e){e=be.event.fix(e);var t,r,n,i,o,a=[],s=l.call(arguments),c=(B.get(this,"events")||{})[e.type]||[],u=be.event.special[e.type]||{};if((s[0]=e).delegateTarget=this,!u.preDispatch||!1!==u.preDispatch.call(this,e)){for(a=be.event.handlers.call(this,e,c),t=0;(i=a[t++])&&!e.isPropagationStopped();)for(e.currentTarget=i.elem,r=0;(o=i.handlers[r++])&&!e.isImmediatePropagationStopped();)(!e.namespace_re||e.namespace_re.test(o.namespace))&&(e.handleObj=o,e.data=o.data,(n=((be.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,s))!==x&&!1===(e.result=n)&&(e.preventDefault(),e.stopPropagation()));return u.postDispatch&&u.postDispatch.call(this,e),e.result}},handlers:function(e,t){var r,n,i,o,a=[],s=t.delegateCount,c=e.target;if(s&&c.nodeType&&(!e.button||"click"!==e.type))for(;c!==this;c=c.parentNode||this)if(!0!==c.disabled||"click"!==e.type){for(n=[],r=0;r<s;r++)n[i=(o=t[r]).selector+" "]===x&&(n[i]=o.needsContext?0<=be(i,this).index(c):be.find(i,this,null,[c]).length),n[i]&&n.push(o);n.length&&a.push({elem:c,handlers:n})}return t.length>s&&a.push({elem:this,handlers:t.slice(s)}),a},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){return null==e.which&&(e.which=null!=t.charCode?t.charCode:t.keyCode),e}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,t){var r,n,i,o=t.button;return null==e.pageX&&null!=t.clientX&&(n=(r=e.target.ownerDocument||g).documentElement,i=r.body,e.pageX=t.clientX+(n&&n.scrollLeft||i&&i.scrollLeft||0)-(n&&n.clientLeft||i&&i.clientLeft||0),e.pageY=t.clientY+(n&&n.scrollTop||i&&i.scrollTop||0)-(n&&n.clientTop||i&&i.clientTop||0)),e.which||o===x||(e.which=1&o?1:2&o?3:4&o?2:0),e}},fix:function(e){if(e[be.expando])return e;var t,r,n,i=e.type,o=e,a=this.fixHooks[i];for(a||(this.fixHooks[i]=a=W.test(i)?this.mouseHooks:K.test(i)?this.keyHooks:{}),n=a.props?this.props.concat(a.props):this.props,e=new be.Event(o),t=n.length;t--;)e[r=n[t]]=o[r];return 3===e.target.nodeType&&(e.target=e.target.parentNode),a.filter?a.filter(e,o):e},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==Z()&&this.focus?(this.focus(),!1):x},delegateType:"focusin"},blur:{trigger:function(){return this===Z()&&this.blur?(this.blur(),!1):x},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&be.nodeName(this,"input")?(this.click(),!1):x},_default:function(e){return be.nodeName(e.target,"a")}},beforeunload:{postDispatch:function(e){e.result!==x&&(e.originalEvent.returnValue=e.result)}}},simulate:function(e,t,r,n){var i=be.extend(new be.Event,r,{type:e,isSimulated:!0,originalEvent:{}});n?be.event.trigger(i,null,t):be.event.dispatch.call(t,i),i.isDefaultPrevented()&&r.preventDefault()}},be.removeEvent=function(e,t,r){e.removeEventListener&&e.removeEventListener(t,r,!1)},be.Event=function(e,t){return this instanceof be.Event?(e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||e.getPreventDefault&&e.getPreventDefault()?X:J):this.type=e,t&&be.extend(this,t),this.timeStamp=e&&e.timeStamp||be.now(),this[be.expando]=!0,x):new be.Event(e,t)},be.Event.prototype={isDefaultPrevented:J,isPropagationStopped:J,isImmediatePropagationStopped:J,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=X,e&&e.preventDefault&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=X,e&&e.stopPropagation&&e.stopPropagation()},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=X,this.stopPropagation()}},be.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(e,i){be.event.special[e]={delegateType:i,bindType:i,handle:function(e){var t,r=e.relatedTarget,n=e.handleObj;return(!r||r!==this&&!be.contains(this,r))&&(e.type=n.origType,t=n.handler.apply(this,arguments),e.type=i),t}}}),be.support.focusinBubbles||be.each({focus:"focusin",blur:"focusout"},function(e,t){var r=0,n=function(e){be.event.simulate(t,e.target,be.event.fix(e),!0)};be.event.special[t]={setup:function(){0==r++&&g.addEventListener(e,n,!0)},teardown:function(){0==--r&&g.removeEventListener(e,n,!0)}}}),be.fn.extend({on:function(e,t,r,n,i){var o,a;if("object"==(void 0===e?"undefined":_typeof(e))){for(a in"string"!=typeof t&&(r=r||t,t=x),e)this.on(a,t,r,e[a],i);return this}if(null==r&&null==n?(n=t,r=t=x):null==n&&("string"==typeof t?(n=r,r=x):(n=r,r=t,t=x)),!1===n)n=J;else if(!n)return this;return 1===i&&(o=n,(n=function(e){return be().off(e),o.apply(this,arguments)}).guid=o.guid||(o.guid=be.guid++)),this.each(function(){be.event.add(this,e,n,r,t)})},one:function(e,t,r,n){return this.on(e,t,r,n,1)},off:function(e,t,r){var n,i;if(e&&e.preventDefault&&e.handleObj)return n=e.handleObj,be(e.delegateTarget).off(n.namespace?n.origType+"."+n.namespace:n.origType,n.selector,n.handler),this;if("object"!=(void 0===e?"undefined":_typeof(e)))return(!1===t||"function"==typeof t)&&(r=t,t=x),!1===r&&(r=J),this.each(function(){be.event.remove(this,e,r,t)});for(i in e)this.off(i,t,e[i]);return this},trigger:function(e,t){return this.each(function(){be.event.trigger(e,t,this)})},triggerHandler:function(e,t){var r=this[0];return r?be.event.trigger(e,t,r,!0):x}});var Q=/^.[^:#\[\.,]*$/,ee=be.expr.match.needsContext,te={children:!0,contents:!0,next:!0,prev:!0};function re(e,t){for(;(e=e[t])&&1!==e.nodeType;);return e}function ne(e,r,n){if(be.isFunction(r))return be.grep(e,function(e,t){return!!r.call(e,t,e)!==n});if(r.nodeType)return be.grep(e,function(e){return e===r!==n});if("string"==typeof r){if(Q.test(r))return be.filter(r,e,n);r=be.filter(r,e)}return be.grep(e,function(e){return 0<=h.call(r,e)!==n})}be.fn.extend({find:function(e){var t,r,n,i=this.length;if("string"!=typeof e)return(t=this).pushStack(be(e).filter(function(){for(n=0;n<i;n++)if(be.contains(t[n],this))return!0}));for(r=[],n=0;n<i;n++)be.find(e,this[n],r);return(r=this.pushStack(1<i?be.unique(r):r)).selector=(this.selector?this.selector+" ":"")+e,r},has:function(e){var t=be(e,this),r=t.length;return this.filter(function(){for(var e=0;e<r;e++)if(be.contains(this,t[e]))return!0})},not:function(e){return this.pushStack(ne(this,e||[],!0))},filter:function(e){return this.pushStack(ne(this,e||[],!1))},is:function(e){return!!e&&("string"==typeof e?ee.test(e)?0<=be(e,this.context).index(this[0]):0<be.filter(e,this).length:0<this.filter(e).length)},closest:function(e,t){for(var r,n=0,i=this.length,o=[],a=ee.test(e)||"string"!=typeof e?be(e,t||this.context):0;n<i;n++)for(r=this[n];r&&r!==t;r=r.parentNode)if(r.nodeType<11&&(a?-1<a.index(r):1===r.nodeType&&be.find.matchesSelector(r,e))){r=o.push(r);break}return this.pushStack(1<o.length?be.unique(o):o)},index:function(e){return e?"string"==typeof e?h.call(be(e),this[0]):h.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){var r="string"==typeof e?be(e,t):be.makeArray(e&&e.nodeType?[e]:e),n=be.merge(this.get(),r);return this.pushStack(be.unique(n))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),be.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return be.dir(e,"parentNode")},parentsUntil:function(e,t,r){return be.dir(e,"parentNode",r)},next:function(e){return re(e,"nextSibling")},prev:function(e){return re(e,"previousSibling")},nextAll:function(e){return be.dir(e,"nextSibling")},prevAll:function(e){return be.dir(e,"previousSibling")},nextUntil:function(e,t,r){return be.dir(e,"nextSibling",r)},prevUntil:function(e,t,r){return be.dir(e,"previousSibling",r)},siblings:function(e){return be.sibling((e.parentNode||{}).firstChild,e)},children:function(e){return be.sibling(e.firstChild)},contents:function(e){return be.nodeName(e,"iframe")?e.contentDocument||e.contentWindow.document:be.merge([],e.childNodes)}},function(n,i){be.fn[n]=function(e,t){var r=be.map(this,i,e);return"Until"!==n.slice(-5)&&(t=e),t&&"string"==typeof t&&(r=be.filter(t,r)),1<this.length&&(te[n]||be.unique(r),"p"===n[0]&&r.reverse()),this.pushStack(r)}}),be.extend({filter:function(e,t,r){var n=t[0];return r&&(e=":not("+e+")"),1===t.length&&1===n.nodeType?be.find.matchesSelector(n,e)?[n]:[]:be.find.matches(e,be.grep(t,function(e){return 1===e.nodeType}))},dir:function(e,t,r){for(var n=[],i=r!==x;(e=e[t])&&9!==e.nodeType;)if(1===e.nodeType){if(i&&be(e).is(r))break;n.push(e)}return n},sibling:function(e,t){for(var r=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&r.push(e);return r}});var ie=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,oe=/<([\w:]+)/,ae=/<|&#?\w+;/,se=/<(?:script|style|link)/i,ce=/^(?:checkbox|radio)$/i,ue=/checked\s*(?:[^=]|=\s*.checked.)/i,le=/^$|\/(?:java|ecma)script/i,he=/^true\/(.*)/,fe=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,de={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function pe(e,t){return be.nodeName(e,"table")&&be.nodeName(1===t.nodeType?t:t.firstChild,"tr")?e.getElementsByTagName("tbody")[0]||e.appendChild(e.ownerDocument.createElement("tbody")):e}function ge(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function ye(e){var t=he.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function me(e,t){for(var r=e.length,n=0;n<r;n++)B.set(e[n],"globalEval",!t||B.get(t[n],"globalEval"))}function ve(e,t){var r,n,i,o,a,s,c,u;if(1===t.nodeType){if(B.hasData(e)&&(o=B.access(e),a=be.extend({},o),u=o.events,B.set(t,a),u))for(i in delete a.handle,a.events={},u)for(r=0,n=u[i].length;r<n;r++)be.event.add(t,i,u[i][r]);F.hasData(e)&&(s=F.access(e),c=be.extend({},s),F.set(t,c))}}function we(e,t){var r=e.getElementsByTagName?e.getElementsByTagName(t||"*"):e.querySelectorAll?e.querySelectorAll(t||"*"):[];return t===x||t&&be.nodeName(e,t)?be.merge([e],r):r}de.optgroup=de.option,de.tbody=de.tfoot=de.colgroup=de.caption=de.col=de.thead,de.th=de.td,be.fn.extend({text:function(e){return be.access(this,function(e){return e===x?be.text(this):this.empty().append((this[0]&&this[0].ownerDocument||g).createTextNode(e))},null,e,arguments.length)},append:function(){return this.domManip(arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||pe(this,e).appendChild(e)})},prepend:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=pe(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},remove:function(e,t){for(var r,n=e?be.filter(e,this):this,i=0;null!=(r=n[i]);i++)t||1!==r.nodeType||be.cleanData(we(r)),r.parentNode&&(t&&be.contains(r.ownerDocument,r)&&me(we(r,"script")),r.parentNode.removeChild(r));return this},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(be.cleanData(we(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return be.clone(this,e,t)})},html:function(e){return be.access(this,function(e){var t=this[0]||{},r=0,n=this.length;if(e===x&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!se.test(e)&&!de[(oe.exec(e)||["",""])[1].toLowerCase()]){e=e.replace(ie,"<$1></$2>");try{for(;r<n;r++)1===(t=this[r]||{}).nodeType&&(be.cleanData(we(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var n=be.map(this,function(e){return[e.nextSibling,e.parentNode]}),i=0;return this.domManip(arguments,function(e){var t=n[i++],r=n[i++];r&&(be(this).remove(),r.insertBefore(e,t))},!0),i?this:this.remove()},detach:function(e){return this.remove(e,!0)},domManip:function(r,n,i){r=y.apply([],r);var e,t,o,a,s,c,u=0,l=this.length,h=this,f=l-1,d=r[0],p=be.isFunction(d);if(p||!(l<=1||"string"!=typeof d||be.support.checkClone)&&ue.test(d))return this.each(function(e){var t=h.eq(e);p&&(r[0]=d.call(this,e,t.html())),t.domManip(r,n,i)});if(l&&(t=(e=be.buildFragment(r,this[0].ownerDocument,!1,!i&&this)).firstChild,1===e.childNodes.length&&(e=t),t)){for(a=(o=be.map(we(e,"script"),ge)).length;u<l;u++)s=e,u!==f&&(s=be.clone(s,!0,!0),a&&be.merge(o,we(s,"script"))),n.call(this[u],s,u);if(a)for(c=o[o.length-1].ownerDocument,be.map(o,ye),u=0;u<a;u++)s=o[u],le.test(s.type||"")&&!B.access(s,"globalEval")&&be.contains(c,s)&&(s.src?be._evalUrl(s.src):be.globalEval(s.textContent.replace(fe,"")))}return this}}),be.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,a){be.fn[e]=function(e){for(var t,r=[],n=be(e),i=n.length-1,o=0;o<=i;o++)t=o===i?this:this.clone(!0),be(n[o])[a](t),u.apply(r,t.get());return this.pushStack(r)}}),be.extend({clone:function(e,t,r){var n,i,o,a,s,c,u,l=e.cloneNode(!0),h=be.contains(e.ownerDocument,e);if(!(be.support.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||be.isXMLDoc(e)))for(a=we(l),n=0,i=(o=we(e)).length;n<i;n++)s=o[n],c=a[n],void 0,"input"===(u=c.nodeName.toLowerCase())&&ce.test(s.type)?c.checked=s.checked:("input"===u||"textarea"===u)&&(c.defaultValue=s.defaultValue);if(t)if(r)for(o=o||we(e),a=a||we(l),n=0,i=o.length;n<i;n++)ve(o[n],a[n]);else ve(e,l);return 0<(a=we(l,"script")).length&&me(a,!h&&we(e,"script")),l},buildFragment:function(e,t,r,n){for(var i,o,a,s,c,u,l=0,h=e.length,f=t.createDocumentFragment(),d=[];l<h;l++)if((i=e[l])||0===i)if("object"===be.type(i))be.merge(d,i.nodeType?[i]:i);else if(ae.test(i)){for(o=o||f.appendChild(t.createElement("div")),a=(oe.exec(i)||["",""])[1].toLowerCase(),s=de[a]||de._default,o.innerHTML=s[1]+i.replace(ie,"<$1></$2>")+s[2],u=s[0];u--;)o=o.firstChild;be.merge(d,o.childNodes),(o=f.firstChild).textContent=""}else d.push(t.createTextNode(i));for(f.textContent="",l=0;i=d[l++];)if((!n||-1===be.inArray(i,n))&&(c=be.contains(i.ownerDocument,i),o=we(f.appendChild(i),"script"),c&&me(o),r))for(u=0;i=o[u++];)le.test(i.type||"")&&r.push(i);return f},cleanData:function(e){for(var t,r,n,i=e.length,o=0,a=be.event.special;o<i;o++){if(r=e[o],be.acceptData(r)&&(t=B.access(r)))for(n in t.events)a[n]?be.event.remove(r,n):be.removeEvent(r,n,t.handle);F.discard(r),B.discard(r)}},_evalUrl:function(e){return be.ajax({url:e,type:"GET",dataType:"text",async:!1,global:!1,success:be.globalEval})}}),be.fn.extend({wrapAll:function(t){var e;return be.isFunction(t)?this.each(function(e){be(this).wrapAll(t.call(this,e))}):(this[0]&&(e=be(t,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&e.insertBefore(this[0]),e.map(function(){for(var e=this;e.firstElementChild;)e=e.firstElementChild;return e}).append(this)),this)},wrapInner:function(r){return be.isFunction(r)?this.each(function(e){be(this).wrapInner(r.call(this,e))}):this.each(function(){var e=be(this),t=e.contents();t.length?t.wrapAll(r):e.append(r)})},wrap:function(t){var r=be.isFunction(t);return this.each(function(e){be(this).wrapAll(r?t.call(this,e):t)})},unwrap:function(){return this.parent().each(function(){be.nodeName(this,"body")||be(this).replaceWith(this.childNodes)}).end()}});var Te,Le,xe=/^(none|table(?!-c[ea]).+)/,Ce=/^margin/,Se=RegExp("^("+w+")(.*)$","i"),ke=RegExp("^("+w+")(?!px)[a-z%]+$","i"),Ae=RegExp("^([+-])=("+w+")","i"),Oe={BODY:"block"},_e={position:"absolute",visibility:"hidden",display:"block"},Ee={letterSpacing:0,fontWeight:400},Re=["Top","Right","Bottom","Left"],Ne=["Webkit","O","Moz","ms"];function De(e,t){if(t in e)return t;for(var r=t.charAt(0).toUpperCase()+t.slice(1),n=t,i=Ne.length;i--;)if((t=Ne[i]+r)in e)return t;return n}function Ie(e,t){return e=t||e,"none"===be.css(e,"display")||!be.contains(e.ownerDocument,e)}function Me(e){return p.getComputedStyle(e,null)}function Fe(e,t){for(var r,n,i,o,a,s,c=[],u=0,l=e.length;u<l;u++)(n=e[u]).style&&(c[u]=B.get(n,"olddisplay"),r=n.style.display,t?(c[u]||"none"!==r||(n.style.display=""),""===n.style.display&&Ie(n)&&(c[u]=B.access(n,"olddisplay",(o=n.nodeName,s=a=void 0,a=g,(s=Oe[o])||("none"!==(s=ze(o,a))&&s||(Le=(Le||be("<iframe frameborder='0' width='0' height='0'/>").css("cssText","display:block !important")).appendTo(a.documentElement),(a=(Le[0].contentWindow||Le[0].contentDocument).document).write("<!doctype html><html><body>"),a.close(),s=ze(o,a),Le.detach()),Oe[o]=s),s)))):c[u]||(i=Ie(n),(r&&"none"!==r||!i)&&B.set(n,"olddisplay",i?r:be.css(n,"display"))));for(u=0;u<l;u++)(n=e[u]).style&&(t&&"none"!==n.style.display&&""!==n.style.display||(n.style.display=t?c[u]||"":"none"));return e}function Be(e,t,r){var n=Se.exec(t);return n?Math.max(0,n[1]-(r||0))+(n[2]||"px"):t}function Pe(e,t,r,n,i){for(var o=r===(n?"border":"content")?4:"width"===t?1:0,a=0;o<4;o+=2)"margin"===r&&(a+=be.css(e,r+Re[o],!0,i)),n?("content"===r&&(a-=be.css(e,"padding"+Re[o],!0,i)),"margin"!==r&&(a-=be.css(e,"border"+Re[o]+"Width",!0,i))):(a+=be.css(e,"padding"+Re[o],!0,i),"padding"!==r&&(a+=be.css(e,"border"+Re[o]+"Width",!0,i)));return a}function Ge(e,t,r){var n=!0,i="width"===t?e.offsetWidth:e.offsetHeight,o=Me(e),a=be.support.boxSizing&&"border-box"===be.css(e,"boxSizing",!1,o);if(i<=0||null==i){if(((i=Te(e,t,o))<0||null==i)&&(i=e.style[t]),ke.test(i))return i;n=a&&(be.support.boxSizingReliable||i===e.style[t]),i=parseFloat(i)||0}return i+Pe(e,t,r||(a?"border":"content"),n,o)+"px"}function ze(e,t){var r=be(t.createElement(e)).appendTo(t.body),n=be.css(r[0],"display");return r.remove(),n}be.fn.extend({css:function(e,t){return be.access(this,function(e,t,r){var n,i,o={},a=0;if(be.isArray(t)){for(n=Me(e),i=t.length;a<i;a++)o[t[a]]=be.css(e,t[a],!1,n);return o}return r!==x?be.style(e,t,r):be.css(e,t)},e,t,1<arguments.length)},show:function(){return Fe(this,!0)},hide:function(){return Fe(this)},toggle:function(e){var t="boolean"==typeof e;return this.each(function(){(t?e:Ie(this))?be(this).show():be(this).hide()})}}),be.extend({cssHooks:{opacity:{get:function(e,t){if(t){var r=Te(e,"opacity");return""===r?"1":r}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{float:"cssFloat"},style:function(e,t,r,n){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=be.camelCase(t),c=e.style;return t=be.cssProps[s]||(be.cssProps[s]=De(c,s)),a=be.cssHooks[t]||be.cssHooks[s],r===x?a&&"get"in a&&(i=a.get(e,!1,n))!==x?i:c[t]:("string"===(o=void 0===r?"undefined":_typeof(r))&&(i=Ae.exec(r))&&(r=(i[1]+1)*i[2]+parseFloat(be.css(e,t)),o="number"),null==r||"number"===o&&isNaN(r)||("number"!==o||be.cssNumber[s]||(r+="px"),be.support.clearCloneStyle||""!==r||0!==t.indexOf("background")||(c[t]="inherit"),a&&"set"in a&&(r=a.set(e,r,n))===x||(c[t]=r)),x)}},css:function(e,t,r,n){var i,o,a,s=be.camelCase(t);return t=be.cssProps[s]||(be.cssProps[s]=De(e.style,s)),(a=be.cssHooks[t]||be.cssHooks[s])&&"get"in a&&(i=a.get(e,!0,r)),i===x&&(i=Te(e,t,n)),"normal"===i&&t in Ee&&(i=Ee[t]),""===r||r?(o=parseFloat(i),!0===r||be.isNumeric(o)?o||0:i):i}}),Te=function(e,t,r){var n,i,o,a=r||Me(e),s=a?a.getPropertyValue(t)||a[t]:x,c=e.style;return a&&(""!==s||be.contains(e.ownerDocument,e)||(s=be.style(e,t)),ke.test(s)&&Ce.test(t)&&(n=c.width,i=c.minWidth,o=c.maxWidth,c.minWidth=c.maxWidth=c.width=s,s=a.width,c.width=n,c.minWidth=i,c.maxWidth=o)),s},be.each(["height","width"],function(e,i){be.cssHooks[i]={get:function(e,t,r){return t?0===e.offsetWidth&&xe.test(be.css(e,"display"))?be.swap(e,_e,function(){return Ge(e,i,r)}):Ge(e,i,r):x},set:function(e,t,r){var n=r&&Me(e);return Be(0,t,r?Pe(e,i,r,be.support.boxSizing&&"border-box"===be.css(e,"boxSizing",!1,n),n):0)}}}),be(function(){be.support.reliableMarginRight||(be.cssHooks.marginRight={get:function(e,t){return t?be.swap(e,{display:"inline-block"},Te,[e,"marginRight"]):x}}),!be.support.pixelPosition&&be.fn.position&&be.each(["top","left"],function(e,r){be.cssHooks[r]={get:function(e,t){return t?(t=Te(e,r),ke.test(t)?be(e).position()[r]+"px":t):x}}})}),be.expr&&be.expr.filters&&(be.expr.filters.hidden=function(e){return e.offsetWidth<=0&&e.offsetHeight<=0},be.expr.filters.visible=function(e){return!be.expr.filters.hidden(e)}),be.each({margin:"",padding:"",border:"Width"},function(i,o){be.cssHooks[i+o]={expand:function(e){for(var t=0,r={},n="string"==typeof e?e.split(" "):[e];t<4;t++)r[i+Re[t]+o]=n[t]||n[t-2]||n[0];return r}},Ce.test(i)||(be.cssHooks[i+o].set=Be)});var je=/%20/g,Ve=/\[\]$/,qe=/\r?\n/g,$e=/^(?:submit|button|image|reset|file)$/i,He=/^(?:input|select|textarea|keygen)/i;function Ke(r,e,n,i){var t;if(be.isArray(e))be.each(e,function(e,t){n||Ve.test(r)?i(r,t):Ke(r+"["+("object"==(void 0===t?"undefined":_typeof(t))?e:"")+"]",t,n,i)});else if(n||"object"!==be.type(e))i(r,e);else for(t in e)Ke(r+"["+t+"]",e[t],n,i)}be.fn.extend({serialize:function(){return be.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=be.prop(this,"elements");return e?be.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!be(this).is(":disabled")&&He.test(this.nodeName)&&!$e.test(e)&&(this.checked||!ce.test(e))}).map(function(e,t){var r=be(this).val();return null==r?null:be.isArray(r)?be.map(r,function(e){return{name:t.name,value:e.replace(qe,"\r\n")}}):{name:t.name,value:r.replace(qe,"\r\n")}}).get()}}),be.param=function(e,t){var r,n=[],i=function(e,t){t=be.isFunction(t)?t():null==t?"":t,n[n.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};if(t===x&&(t=be.ajaxSettings&&be.ajaxSettings.traditional),be.isArray(e)||e.jquery&&!be.isPlainObject(e))be.each(e,function(){i(this.name,this.value)});else for(r in e)Ke(r,e[r],t,i);return n.join("&").replace(je,"+")},be.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,r){be.fn[r]=function(e,t){return 0<arguments.length?this.on(r,null,e,t):this.trigger(r)}}),be.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)},bind:function(e,t,r){return this.on(e,null,t,r)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,r,n){return this.on(t,e,r,n)},undelegate:function(e,t,r){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",r)}});var We,Ue,Ye=be.now(),Xe=/\?/,Je=/#.*$/,Ze=/([?&])_=[^&]*/,Qe=/^(.*?):[ \t]*([^\r\n]*)$/gm,et=/^(?:GET|HEAD)$/,tt=/^\/\//,rt=/^([\w.+-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,nt=be.fn.load,it={},ot={},at="*/".concat("*");try{Ue=e.href}catch(e){(Ue=g.createElement("a")).href="",Ue=Ue.href}function st(o){return function(e,t){"string"!=typeof e&&(t=e,e="*");var r,n=0,i=e.toLowerCase().match(C)||[];if(be.isFunction(t))for(;r=i[n++];)"+"===r[0]?(r=r.slice(1)||"*",(o[r]=o[r]||[]).unshift(t)):(o[r]=o[r]||[]).push(t)}}function ct(t,i,o,a){var s={},c=t===ot;function u(e){var n;return s[e]=!0,be.each(t[e]||[],function(e,t){var r=t(i,o,a);return"string"!=typeof r||c||s[r]?c?!(n=r):x:(i.dataTypes.unshift(r),u(r),!1)}),n}return u(i.dataTypes[0])||!s["*"]&&u("*")}function ut(e,t){var r,n,i=be.ajaxSettings.flatOptions||{};for(r in t)t[r]!==x&&((i[r]?e:n||(n={}))[r]=t[r]);return n&&be.extend(!0,e,n),e}We=rt.exec(Ue.toLowerCase())||[],be.fn.load=function(e,t,r){if("string"!=typeof e&&nt)return nt.apply(this,arguments);var n,i,o,a=this,s=e.indexOf(" ");return 0<=s&&(n=e.slice(s),e=e.slice(0,s)),be.isFunction(t)?(r=t,t=x):t&&"object"==(void 0===t?"undefined":_typeof(t))&&(i="POST"),0<a.length&&be.ajax({url:e,type:i,dataType:"html",data:t}).done(function(e){o=arguments,a.html(n?be("<div>").append(be.parseHTML(e)).find(n):e)}).complete(r&&function(e,t){a.each(r,o||[e.responseText,t,e])}),this},be.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){be.fn[t]=function(e){return this.on(t,e)}}),be.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Ue,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(We[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":at,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":be.parseJSON,"text xml":be.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?ut(ut(e,be.ajaxSettings),t):ut(be.ajaxSettings,e)},ajaxPrefilter:st(it),ajaxTransport:st(ot),ajax:function(e,t){"object"==(void 0===e?"undefined":_typeof(e))&&(t=e,e=x),t=t||{};var l,h,f,r,d,n,p,i,g=be.ajaxSetup({},t),y=g.context||g,m=g.context&&(y.nodeType||y.jquery)?be(y):be.event,v=be.Deferred(),w=be.Callbacks("once memory"),T=g.statusCode||{},o={},a={},b=0,s="canceled",L={readyState:0,getResponseHeader:function(e){var t;if(2===b){if(!r)for(r={};t=Qe.exec(f);)r[t[1].toLowerCase()]=t[2];t=r[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return 2===b?f:null},setRequestHeader:function(e,t){var r=e.toLowerCase();return b||(e=a[r]=a[r]||e,o[e]=t),this},overrideMimeType:function(e){return b||(g.mimeType=e),this},statusCode:function(e){var t;if(e)if(b<2)for(t in e)T[t]=[T[t],e[t]];else L.always(e[L.status]);return this},abort:function(e){var t=e||s;return l&&l.abort(t),c(0,t),this}};if(v.promise(L).complete=w.add,L.success=L.done,L.error=L.fail,g.url=((e||g.url||Ue)+"").replace(Je,"").replace(tt,We[1]+"//"),g.type=t.method||t.type||g.method||g.type,g.dataTypes=be.trim(g.dataType||"*").toLowerCase().match(C)||[""],null==g.crossDomain&&(n=rt.exec(g.url.toLowerCase()),g.crossDomain=!(!n||n[1]===We[1]&&n[2]===We[2]&&(n[3]||("http:"===n[1]?"80":"443"))===(We[3]||("http:"===We[1]?"80":"443")))),g.data&&g.processData&&"string"!=typeof g.data&&(g.data=be.param(g.data,g.traditional)),ct(it,g,t,L),2===b)return L;for(i in(p=g.global)&&0==be.active++&&be.event.trigger("ajaxStart"),g.type=g.type.toUpperCase(),g.hasContent=!et.test(g.type),h=g.url,g.hasContent||(g.data&&(h=g.url+=(Xe.test(h)?"&":"?")+g.data,delete g.data),!1===g.cache&&(g.url=Ze.test(h)?h.replace(Ze,"$1_="+Ye++):h+(Xe.test(h)?"&":"?")+"_="+Ye++)),g.ifModified&&(be.lastModified[h]&&L.setRequestHeader("If-Modified-Since",be.lastModified[h]),be.etag[h]&&L.setRequestHeader("If-None-Match",be.etag[h])),(g.data&&g.hasContent&&!1!==g.contentType||t.contentType)&&L.setRequestHeader("Content-Type",g.contentType),L.setRequestHeader("Accept",g.dataTypes[0]&&g.accepts[g.dataTypes[0]]?g.accepts[g.dataTypes[0]]+("*"!==g.dataTypes[0]?", "+at+"; q=0.01":""):g.accepts["*"]),g.headers)L.setRequestHeader(i,g.headers[i]);if(g.beforeSend&&(!1===g.beforeSend.call(y,L,g)||2===b))return L.abort();for(i in s="abort",{success:1,error:1,complete:1})L[i](g[i]);if(l=ct(ot,g,t,L)){L.readyState=1,p&&m.trigger("ajaxSend",[L,g]),g.async&&0<g.timeout&&(d=setTimeout(function(){L.abort("timeout")},g.timeout));try{b=1,l.send(o,c)}catch(e){if(!(b<2))throw e;c(-1,e)}}else c(-1,"No Transport");function c(e,t,r,n){var i,o,a,s,c,u=t;2!==b&&(b=2,d&&clearTimeout(d),l=x,f=n||"",L.readyState=0<e?4:0,i=200<=e&&e<300||304===e,r&&(s=function(e,t,r){var n,i,o,a,s=e.contents,c=e.dataTypes;for(;"*"===c[0];)c.shift(),n===x&&(n=e.mimeType||t.getResponseHeader("Content-Type"));if(n)for(i in s)if(s[i]&&s[i].test(n)){c.unshift(i);break}if(c[0]in r)o=c[0];else{for(i in r){if(!c[0]||e.converters[i+" "+c[0]]){o=i;break}a||(a=i)}o=o||a}return o?(o!==c[0]&&c.unshift(o),r[o]):x}(g,L,r)),s=function(e,t,r,n){var i,o,a,s,c,u={},l=e.dataTypes.slice();if(l[1])for(a in e.converters)u[a.toLowerCase()]=e.converters[a];o=l.shift();for(;o;)if(e.responseFields[o]&&(r[e.responseFields[o]]=t),!c&&n&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),c=o,o=l.shift())if("*"===o)o=c;else if("*"!==c&&c!==o){if(!(a=u[c+" "+o]||u["* "+o]))for(i in u)if((s=i.split(" "))[1]===o&&(a=u[c+" "+s[0]]||u["* "+s[0]])){!0===a?a=u[i]:!0!==u[i]&&(o=s[0],l.unshift(s[1]));break}if(!0!==a)if(a&&e.throws)t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+c+" to "+o}}}return{state:"success",data:t}}(g,s,L,i),i?(g.ifModified&&((c=L.getResponseHeader("Last-Modified"))&&(be.lastModified[h]=c),(c=L.getResponseHeader("etag"))&&(be.etag[h]=c)),204===e?u="nocontent":304===e?u="notmodified":(u=s.state,o=s.data,i=!(a=s.error))):(a=u,(e||!u)&&(u="error",e<0&&(e=0))),L.status=e,L.statusText=(t||u)+"",i?v.resolveWith(y,[o,u,L]):v.rejectWith(y,[L,u,a]),L.statusCode(T),T=x,p&&m.trigger(i?"ajaxSuccess":"ajaxError",[L,g,i?o:a]),w.fireWith(y,[L,u]),p&&(m.trigger("ajaxComplete",[L,g]),--be.active||be.event.trigger("ajaxStop")))}return L},getJSON:function(e,t,r){return be.get(e,t,r,"json")},getScript:function(e,t){return be.get(e,x,t,"script")}}),be.each(["get","post"],function(e,i){be[i]=function(e,t,r,n){return be.isFunction(t)&&(n=n||r,r=t,t=x),be.ajax({url:e,type:i,dataType:n,data:t,success:r})}}),be.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(e){return be.globalEval(e),e}}}),be.ajaxPrefilter("script",function(e){e.cache===x&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),be.ajaxTransport("script",function(r){var n,i;if(r.crossDomain)return{send:function(e,t){n=be("<script>").prop({async:!0,charset:r.scriptCharset,src:r.url}).on("load error",i=function(e){n.remove(),i=null,e&&t("error"===e.type?404:200,e.type)}),g.head.appendChild(n[0])},abort:function(){i&&i()}}});var lt=[],ht=/(=)\?(?=&|$)|\?\?/;be.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=lt.pop()||be.expando+"_"+Ye++;return this[e]=!0,e}}),be.ajaxPrefilter("json jsonp",function(e,t,r){var n,i,o,a=!1!==e.jsonp&&(ht.test(e.url)?"url":"string"==typeof e.data&&!(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&ht.test(e.data)&&"data");return a||"jsonp"===e.dataTypes[0]?(n=e.jsonpCallback=be.isFunction(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,a?e[a]=e[a].replace(ht,"$1"+n):!1!==e.jsonp&&(e.url+=(Xe.test(e.url)?"&":"?")+e.jsonp+"="+n),e.converters["script json"]=function(){return o||be.error(n+" was not called"),o[0]},e.dataTypes[0]="json",i=p[n],p[n]=function(){o=arguments},r.always(function(){p[n]=i,e[n]&&(e.jsonpCallback=t.jsonpCallback,lt.push(n)),o&&be.isFunction(i)&&i(o[0]),o=i=x}),"script"):x}),be.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(e){}};var ft=be.ajaxSettings.xhr(),dt={0:200,1223:204},pt=0,gt={};p.ActiveXObject&&be(p).on("unload",function(){for(var e in gt)gt[e]();gt=x}),be.support.cors=!!ft&&"withCredentials"in ft,be.support.ajax=ft=!!ft,be.ajaxTransport(function(o){var a;return be.support.cors||ft&&!o.crossDomain?{send:function(e,t){var r,n,i=o.xhr();if(i.open(o.type,o.url,o.async,o.username,o.password),o.xhrFields)for(r in o.xhrFields)i[r]=o.xhrFields[r];for(r in o.mimeType&&i.overrideMimeType&&i.overrideMimeType(o.mimeType),o.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest"),e)i.setRequestHeader(r,e[r]);a=function(e){return function(){a&&(delete gt[n],a=i.onload=i.onerror=null,"abort"===e?i.abort():"error"===e?t(i.status||404,i.statusText):t(dt[i.status]||i.status,i.statusText,"string"==typeof i.responseText?{text:i.responseText}:x,i.getAllResponseHeaders()))}},i.onload=a(),i.onerror=a("error"),a=gt[n=pt++]=a("abort"),i.send(o.hasContent&&o.data||null)},abort:function(){a&&a()}}:x});var yt,mt,vt=/^(?:toggle|show|hide)$/,wt=RegExp("^(?:([+-])=|)("+w+")([a-z%]*)$","i"),Tt=/queueHooks$/,bt=[function(t,e,r){var n,i,o,a,s,c,u,l,h,f=this,d=t.style,p={},g=[],y=t.nodeType&&Ie(t);for(n in r.queue||(null==(l=be._queueHooks(t,"fx")).unqueued&&(l.unqueued=0,h=l.empty.fire,l.empty.fire=function(){l.unqueued||h()}),l.unqueued++,f.always(function(){f.always(function(){l.unqueued--,be.queue(t,"fx").length||l.empty.fire()})})),1===t.nodeType&&("height"in e||"width"in e)&&(r.overflow=[d.overflow,d.overflowX,d.overflowY],"inline"===be.css(t,"display")&&"none"===be.css(t,"float")&&(d.display="inline-block")),r.overflow&&(d.overflow="hidden",f.always(function(){d.overflow=r.overflow[0],d.overflowX=r.overflow[1],d.overflowY=r.overflow[2]})),s=B.get(t,"fxshow"),e)if(o=e[n],vt.exec(o)){if(delete e[n],c=c||"toggle"===o,o===(y?"hide":"show")){if("show"!==o||s===x||s[n]===x)continue;y=!0}g.push(n)}if(a=g.length){"hidden"in(s=B.get(t,"fxshow")||B.access(t,"fxshow",{}))&&(y=s.hidden),c&&(s.hidden=!y),y?be(t).show():f.done(function(){be(t).hide()}),f.done(function(){var e;for(e in B.remove(t,"fxshow"),p)be.style(t,e,p[e])});for(n=0;n<a;n++)i=g[n],u=f.createTween(i,y?s[i]:0),p[i]=s[i]||be.style(t,i),i in s||(s[i]=u.start,y&&(u.end=u.start,u.start="width"===i||"height"===i?1:0))}}],Lt={"*":[function(e,t){var r,n,i=this.createTween(e,t),o=wt.exec(t),a=i.cur(),s=+a||0,c=1,u=20;if(o){if(r=+o[2],"px"!==(n=o[3]||(be.cssNumber[e]?"":"px"))&&s)for(s=be.css(i.elem,e,!0)||r||1;s/=c=c||".5",be.style(i.elem,e,s+n),c!==(c=i.cur()/a)&&1!==c&&--u;);i.unit=n,i.start=s,i.end=o[1]?s+(o[1]+1)*r:r}return i}]};function xt(){return setTimeout(function(){yt=x}),yt=be.now()}function Ct(o,e,t){var r,a,n=0,i=bt.length,s=be.Deferred().always(function(){delete c.elem}),c=function(){if(a)return!1;for(var e=yt||xt(),t=Math.max(0,u.startTime+u.duration-e),r=1-(t/u.duration||0),n=0,i=u.tweens.length;n<i;n++)u.tweens[n].run(r);return s.notifyWith(o,[u,r,t]),r<1&&i?t:(s.resolveWith(o,[u]),!1)},u=s.promise({elem:o,props:be.extend({},e),opts:be.extend(!0,{specialEasing:{}},t),originalProperties:e,originalOptions:t,startTime:yt||xt(),duration:t.duration,tweens:[],createTween:function(e,t){var r=be.Tween(o,u.opts,e,t,u.opts.specialEasing[e]||u.opts.easing);return u.tweens.push(r),r},stop:function(e){var t=0,r=e?u.tweens.length:0;if(a)return this;for(a=!0;t<r;t++)u.tweens[t].run(1);return e?s.resolveWith(o,[u,e]):s.rejectWith(o,[u,e]),this}}),l=u.props;for(function(e,t){var r,n,i,o,a;for(r in e)if(n=be.camelCase(r),i=t[n],o=e[r],be.isArray(o)&&(i=o[1],o=e[r]=o[0]),r!==n&&(e[n]=o,delete e[r]),(a=be.cssHooks[n])&&"expand"in a)for(r in o=a.expand(o),delete e[n],o)r in e||(e[r]=o[r],t[r]=i);else t[n]=i}(l,u.opts.specialEasing);n<i;n++)if(r=bt[n].call(u,o,l,u.opts))return r;return function(o,e){be.each(e,function(e,t){for(var r=(Lt[e]||[]).concat(Lt["*"]),n=0,i=r.length;n<i;n++)if(r[n].call(o,e,t))return})}(u,l),be.isFunction(u.opts.start)&&u.opts.start.call(o,u),be.fx.timer(be.extend(c,{elem:o,anim:u,queue:u.opts.queue})),u.progress(u.opts.progress).done(u.opts.done,u.opts.complete).fail(u.opts.fail).always(u.opts.always)}function St(e,t,r,n,i){return new St.prototype.init(e,t,r,n,i)}function kt(e,t){var r,n={height:e},i=0;for(t=t?1:0;i<4;i+=2-t)n["margin"+(r=Re[i])]=n["padding"+r]=e;return t&&(n.opacity=n.width=e),n}function At(e){return be.isWindow(e)?e:9===e.nodeType&&e.defaultView}be.Animation=be.extend(Ct,{tweener:function(e,t){for(var r,n=0,i=(e=be.isFunction(e)?(t=e,["*"]):e.split(" ")).length;n<i;n++)r=e[n],Lt[r]=Lt[r]||[],Lt[r].unshift(t)},prefilter:function(e,t){t?bt.unshift(e):bt.push(e)}}),((be.Tween=St).prototype={constructor:St,init:function(e,t,r,n,i,o){this.elem=e,this.prop=r,this.easing=i||"swing",this.options=t,this.start=this.now=this.cur(),this.end=n,this.unit=o||(be.cssNumber[r]?"":"px")},cur:function(){var e=St.propHooks[this.prop];return e&&e.get?e.get(this):St.propHooks._default.get(this)},run:function(e){var t,r=St.propHooks[this.prop];return this.pos=t=this.options.duration?be.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),r&&r.set?r.set(this):St.propHooks._default.set(this),this}}).init.prototype=St.prototype,(St.propHooks={_default:{get:function(e){var t;return null==e.elem[e.prop]||e.elem.style&&null!=e.elem.style[e.prop]?(t=be.css(e.elem,e.prop,""))&&"auto"!==t?t:0:e.elem[e.prop]},set:function(e){be.fx.step[e.prop]?be.fx.step[e.prop](e):e.elem.style&&(null!=e.elem.style[be.cssProps[e.prop]]||be.cssHooks[e.prop])?be.style(e.elem,e.prop,e.now+e.unit):e.elem[e.prop]=e.now}}}).scrollTop=St.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},be.each(["toggle","show","hide"],function(e,n){var i=be.fn[n];be.fn[n]=function(e,t,r){return null==e||"boolean"==typeof e?i.apply(this,arguments):this.animate(kt(n,!0),e,t,r)}}),be.fn.extend({fadeTo:function(e,t,r,n){return this.filter(Ie).css("opacity",0).show().end().animate({opacity:t},e,r,n)},animate:function(r,e,t,n){var i=be.isEmptyObject(r),o=be.speed(e,t,n),a=function e(){var t=Ct(this,be.extend({},r),o);e.finish=function(){t.stop(!0)},(i||B.get(this,"finish"))&&t.stop(!0)};return a.finish=a,i||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(i,e,o){var a=function(e){var t=e.stop;delete e.stop,t(o)};return"string"!=typeof i&&(o=e,e=i,i=x),e&&!1!==i&&this.queue(i||"fx",[]),this.each(function(){var e=!0,t=null!=i&&i+"queueHooks",r=be.timers,n=B.get(this);if(t)n[t]&&n[t].stop&&a(n[t]);else for(t in n)n[t]&&n[t].stop&&Tt.test(t)&&a(n[t]);for(t=r.length;t--;)r[t].elem!==this||null!=i&&r[t].queue!==i||(r[t].anim.stop(o),e=!1,r.splice(t,1));(e||!o)&&be.dequeue(this,i)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var e,t=B.get(this),r=t[a+"queue"],n=t[a+"queueHooks"],i=be.timers,o=r?r.length:0;for(t.finish=!0,be.queue(this,a,[]),n&&n.cur&&n.cur.finish&&n.cur.finish.call(this),e=i.length;e--;)i[e].elem===this&&i[e].queue===a&&(i[e].anim.stop(!0),i.splice(e,1));for(e=0;e<o;e++)r[e]&&r[e].finish&&r[e].finish.call(this);delete t.finish})}}),be.each({slideDown:kt("show"),slideUp:kt("hide"),slideToggle:kt("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,n){be.fn[e]=function(e,t,r){return this.animate(n,e,t,r)}}),be.speed=function(e,t,r){var n=e&&"object"==(void 0===e?"undefined":_typeof(e))?be.extend({},e):{complete:r||!r&&t||be.isFunction(e)&&e,duration:e,easing:r&&t||t&&!be.isFunction(t)&&t};return n.duration=be.fx.off?0:"number"==typeof n.duration?n.duration:n.duration in be.fx.speeds?be.fx.speeds[n.duration]:be.fx.speeds._default,(null==n.queue||!0===n.queue)&&(n.queue="fx"),n.old=n.complete,n.complete=function(){be.isFunction(n.old)&&n.old.call(this),n.queue&&be.dequeue(this,n.queue)},n},be.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2}},be.timers=[],be.fx=St.prototype.init,be.fx.tick=function(){var e,t=be.timers,r=0;for(yt=be.now();t.length>r;r++)(e=t[r])()||t[r]!==e||t.splice(r--,1);t.length||be.fx.stop(),yt=x},be.fx.timer=function(e){e()&&be.timers.push(e)&&be.fx.start()},be.fx.interval=13,be.fx.start=function(){mt||(mt=setInterval(be.fx.tick,be.fx.interval))},be.fx.stop=function(){clearInterval(mt),mt=null},be.fx.speeds={slow:600,fast:200,_default:400},be.fx.step={},be.expr&&be.expr.filters&&(be.expr.filters.animated=function(t){return be.grep(be.timers,function(e){return t===e.elem}).length}),be.fn.offset=function(t){if(arguments.length)return t===x?this:this.each(function(e){be.offset.setOffset(this,t,e)});var e,r,n=this[0],i={top:0,left:0},o=n&&n.ownerDocument;return o?(e=o.documentElement,be.contains(e,n)?(_typeof(n.getBoundingClientRect)!==m&&(i=n.getBoundingClientRect()),r=At(o),{top:i.top+r.pageYOffset-e.clientTop,left:i.left+r.pageXOffset-e.clientLeft}):i):void 0},be.offset={setOffset:function(e,t,r){var n,i,o,a,s,c,u=be.css(e,"position"),l=be(e),h={};"static"===u&&(e.style.position="relative"),s=l.offset(),o=be.css(e,"top"),c=be.css(e,"left"),i=("absolute"===u||"fixed"===u)&&-1<(o+c).indexOf("auto")?(a=(n=l.position()).top,n.left):(a=parseFloat(o)||0,parseFloat(c)||0),be.isFunction(t)&&(t=t.call(e,r,s)),null!=t.top&&(h.top=t.top-s.top+a),null!=t.left&&(h.left=t.left-s.left+i),"using"in t?t.using.call(e,h):l.css(h)}},be.fn.extend({position:function(){if(this[0]){var e,t,r=this[0],n={top:0,left:0};return"fixed"===be.css(r,"position")?t=r.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),be.nodeName(e[0],"html")||(n=e.offset()),n.top+=be.css(e[0],"borderTopWidth",!0),n.left+=be.css(e[0],"borderLeftWidth",!0)),{top:t.top-n.top-be.css(r,"marginTop",!0),left:t.left-n.left-be.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent||r;e&&!be.nodeName(e,"html")&&"static"===be.css(e,"position");)e=e.offsetParent;return e||r})}}),be.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,i){var o="pageYOffset"===i;be.fn[t]=function(e){return be.access(this,function(e,t,r){var n=At(e);return r===x?n?n[i]:e[t]:(n?n.scrollTo(o?p.pageXOffset:r,o?r:p.pageYOffset):e[t]=r,x)},t,e,arguments.length,null)}}),be.each({Height:"height",Width:"width"},function(o,a){be.each({padding:"inner"+o,content:a,"":"outer"+o},function(n,e){be.fn[e]=function(e,t){var r=arguments.length&&(n||"boolean"!=typeof e),i=n||(!0===e||!0===t?"margin":"border");return be.access(this,function(e,t,r){var n;return be.isWindow(e)?e.document.documentElement["client"+o]:9===e.nodeType?(n=e.documentElement,Math.max(e.body["scroll"+o],n["scroll"+o],e.body["offset"+o],n["offset"+o],n["client"+o])):r===x?be.css(e,t,i):be.style(e,t,r,i)},a,r?e:x,r,null)}})}),be.fn.size=function(){return this.length},be.fn.andSelf=be.fn.addBack,"object"==("undefined"==typeof module?"undefined":_typeof(module))&&"object"==_typeof(module.exports)?module.exports=be:"function"==typeof define&&define.amd&&define("jquery",[],function(){return be}),"object"==(void 0===p?"undefined":_typeof(p))&&"object"==_typeof(p.document)&&(p.jQuery=p.$=be)}(window);var browser={isIE:-1!=navigator.userAgent.indexOf("MSIE"),isFirefox:-1!=navigator.userAgent.toLowerCase().indexOf("firefox"),isNativeApp:window.webkitNative,isIOs:!!navigator.userAgent.match(/(iPad|iPhone|iPod)/i),isAndroid:!!navigator.userAgent.match(/(android)/i),isNodeWebkit:"object"===("undefined"==typeof process?"undefined":_typeof(process))};browser.supportsMultipleAudio=function(){return!!browser.isNativeApp||!browser.isAndroid&&(!browser.isIOs||6<=(e=window.navigator.userAgent,t=e.indexOf("OS "),(-1<e.indexOf("iPhone")||-1<e.indexOf("iPad"))&&-1<t?Number(e.substr(t+3,3).replace("_",".")):-1));var e,t}(),browser.usesWebAudio=!(browser.supportsMultipleAudio||!window.AudioContext&&!window.webkitAudioContext),browser.usesAnimationLoopVideo=!(browser.isNativeApp||!browser.isIOs||null!=navigator.userAgent.match(/iPad/i)),Event.prototype.normalizedCoordinate=function(e){var t,r=document.getElementById("main-wrapper");return t=this.changedTouches?{x:(this.changedTouches[0].pageX-r.getBoundingClientRect().left)/scale+0,y:(this.changedTouches[0].pageY-r.getBoundingClientRect().top)/scale+0}:{x:(this.clientX-r.getBoundingClientRect().left)/scale+0,y:(this.clientY-r.getBoundingClientRect().top)/scale+0},e instanceof Layer&&(t=e.localLocation(t.x,t.y)),t};var scaleToFitPage,setPageScale,isFontLoaded,ResourceLoader,scale=1;function KeySpline(c,t,u,r){function l(e,t){return 1-3*t+3*e}function h(e,t){return 3*t-6*e}function f(e){return 3*e}function d(e,t,r){return((l(t,r)*e+h(t,r))*e+f(t))*e}this.get=function(e){return c==t&&u==r?e:d(function(e){for(var t=e,r=0;r<4;++r){var n=(o=t,3*l(a=c,s=u)*o*o+2*h(a,s)*o+f(a));if(0==n)return t;var i=d(t,c,u)-e;t-=i/n}var o,a,s;return t}(e),t,r)}}function B_Spline_Generator(c){var e=c.length,u=e-1,l=e+2,h=(e+1)/100;return function(e){var t,r,n,i=h*(e=e<0?0:100<e?100:e)-1,o={x:0,y:0},a=void 0,s=void 0;for(a=-2;a<l;a++)r=i-a,t=(r=Math.abs(r))<1?(r*(n=r*r*3)-2*n+4)/6:r<2?(n=r-2)*n*n/-6:0,s=a<0?0:u<a?u:a,o.x+=c[s][0]*t,o.y+=c[s][1]*t;return o}}function supportCssProperty(e){"string"==typeof e&&(e=[e]);for(var t=0;t<e.length;t++){var r=e[t],n=document.body;if("string"!=typeof n.style[r]&&"string"!=typeof n.style["Webkit"+r.substring(0,1).toUpperCase()+r.substring(1)]&&"string"!=typeof n.style["Moz"+r.substring(0,1).toUpperCase()+r.substring(1)]&&"string"!=typeof n.style["O"+r.substring(0,1).toUpperCase()+r.substring(1)])return!1}return!0}function hexToRgb(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function componentToHex(e){var t=e.toString(16);return 1==t.length?"0"+t:t}function rgbToHex(e,t,r){return"#"+componentToHex(e)+componentToHex(t)+componentToHex(r)}function wheelDistance(e){e||(e=event);var t=0,r=0,n=e.wheelDelta,i=e.detail;return i?r=n?0<n/i/40*i?1:-1:e.deltaX||e.deltaY?(t=e.deltaX,e.deltaY):-i/3:e.wheelDeltaX||e.wheelDeltaY?(r=e.wheelDeltaY/120,t=e.wheelDeltaX/120):r=e.deltaX||e.deltaY?(t=-e.deltaX/3,-e.deltaY/3):n/120,"DOMMouseScroll"==e.type?(r*=40,t*=40):browser.isIE||(r*=10,t*=10),{x:t,y:r}}function multiplyMatrix(e,t){for(var r=e.length,n=e[0].length,i=t[0].length,o=[],a=0;a<r;a++){o[a]=[];for(var s=0;s<i;s++){for(var c=0,u=0;u<n;u++)c+=e[a][u]*t[u][s];o[a][s]=c}}return o}function layerToPageAndLayerNumber(e){for(var t=0;t<o2.foreLayers.messageLayers.length;t++){if(e==o2.foreLayers.messageLayers[t])return{page:"fore",layer:t}}for(var r=0;r<o2.backLayers.messageLayers.length;r++){if(e==o2.backLayers.messageLayers[r])return{page:"back",layer:r}}}!function(){var s,c;function u(){if(s)return s;var e=window,t=document,r=t.documentElement,n=t.getElementsByTagName("body")[0];return{width:e.innerWidth||r.clientWidth||n.clientWidth,height:e.innerHeight||r.clientHeight||n.clientHeight}}setPageScale=function(e){scale!=e&&(scale=e,$("#main-wrapper").css("transformOrigin","0% 0%").css("transform","scale("+scale+")"))},scaleToFitPage=function(e,t){var r;if(e<=-1||t<=-1?s=void 0:e&&t&&(r=s={width:e,height:t}),!r){if(r=u(),c&&c.width==r.width&&c.height==r.height)return;var n=document.body;n.style.overflow="hidden",browser.isIOs&&window==window.top?n.style.height=2*r.height+"px":n.style.height=r.height+"px",window.scrollTo(0,0),r=u()}var i=(c=r).width/config.scWidth,o=r.height/config.scHeight,a=Math.min(i,o);return setPageScale(a),$("#main-wrapper").css("top",(r.height-config.scHeight*a)/2+"px").css("left",(r.width-config.scWidth*a)/2+"px"),this}}(),function(){browser.isAndroid&&(window.requestAnimationFrame=function(e){return window.setTimeout(e,1e3/60)});for(var o=0,a=Date.now(),e=["ms","moz","webkit","o"],t=0;t<e.length&&!window.requestAnimationFrame;++t)window.requestAnimationFrame=window[e[t]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[t]+"CancelAnimationFrame"]||window[e[t]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,t){var r=(new Date).getTime(),n=Math.max(0,16-(r-o)),i=window.setTimeout(function(){return e(r-a)},n);return o=r+n,i}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),function(){if(window.chrome){var u=CanvasRenderingContext2D.prototype.fillText;CanvasRenderingContext2D.prototype.fillText=function(e,t,r,n){if(-1==e.indexOf("　"))return u.apply(this,arguments);for(var i=e.split(""),o=t,a=0;a<i.length;a++){var s=i[a],c=this.measureText(s).width;if(n<t+c-o)break;u.call(this,s,t,r),t+=c}}}}(),Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!=typeof this)throw new TypeError("[内部エラー] Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),r=this,n=function(){},i=function(){return r.apply(this instanceof n&&e?this:e,t.concat(Array.prototype.slice.call(arguments)))};return n.prototype=this.prototype,i.prototype=new n,i}),$(function(){$.fn.bindFirst=function(r,e){return this.on(r,e),this.each(function(){var e=$._data(this,"events")[r.split(".")[0]];if(e){var t=e.pop();e.splice(0,0,t)}}),this}}),function(){var c=null,u=null,l={};isFontLoaded=function(e){c||(c=document.createElement("canvas"),u=c.getContext("2d"));for(var t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",r=["monospace","sans-serif","serif"],n=0,i=r.length;n<i;n++){var o=r[n],a=l[o];a||(u.font="72px "+o,a=l[o]=u.measureText(t).width);var s=l[e];if(s||(u.font="72px "+e+","+o,s=u.measureText(t).width),a!=s)return l[e]=s,!0}return!1}}(),function(){var i={},o=[],a={};var s=function(e,t,r){var n=$.Deferred();return r||(r="video"==t?document.createElement("video"):new Audio),$(r).on("canplaythrough stalled suspend",function(){$(this).off(),n.resolve(r)}),$(r).on("error",function(){$(this).off(),n.reject()}),r.autoplay=!1,r.src="",r.src=e,r.load(),setTimeout(function(){n.reject()},1e4),n.promise()},c=function(r,n,e){var i=$.Deferred(),o=0;if(n){var t;t=setTimeout(function(){return Renderer.showLoadingSign()},3e3),i.always(function(){clearTimeout(t),Renderer.hideLoadingSign()})}return function t(){e().done(function(e){return i.resolve(e)}).fail(function(e){(browser.isIOs||browser.isAndroid)&&!navigator.onLine||o<r?(setTimeout(t,100),o++,n&&Renderer.showLoadingSign()):n?(Renderer.hideLoadingSign(),Renderer.showServerError(function(){o=0,n&&Renderer.showLoadingSign(),t()})):i.reject(e)})}(),i};ResourceLoader={getAudioExtension:function(){var e=function(){var n=new Audio,i=void 0;function e(e,t){if(!i){var r=n.canPlayType(e);"maybe"!==r&&"probably"!==r||(i=t)}}return browser.isNodeWebkit&&e("audio/ogg","ogg"),e("audio/mp4","mp4"),e("audio/ogg","ogg"),e("audio/mp3","mp3"),e("audio/wav","wav"),i||"ogg"}();return ResourceLoader.getAudioExtension=function(){return e},e},getVideoExtension:function(){var e=function(){var e=document.createElement("video");return"maybe"==e.canPlayType("video/webm")?"webm":"maybe"==e.canPlayType("video/mp4")?"mp4":"maybe"==e.canPlayType("video/ogg")?"ogv":void 0}();return ResourceLoader.getVideoExtension=function(){return e},e},loadImage:function(t){var e=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];"data:"!=t.substr(0,5)&&(t=t.toLowerCase());var r=t;if(t in o2.imageList)t=o2.imageList[t];else if("data:"!=t.substr(0,5))return o2.error("ストレージに"+r+"が見つかりません"),$.Deferred().reject();if(t in a)return a[t].promise();if(t in i)return ev.lastimage.width=i[t].width,ev.lastimage.height=i[t].height,$.Deferred().resolve(i[t]);var n=c(10,e,function(){return function(e){var t=$.Deferred(),r=new Image;$(r).on("readystatechange load",function(e){$(this).off(),r.complete||4==r.readyState||"complete"==r.readyState?t.resolve(r):$(r).trigger("error")}),$(r).on("error",function(e){$(this).off(),t.reject(e)});var n=setTimeout(function(){$(r).trigger("error")},1e4);return t.always(function(){clearTimeout(n)}),$(r).attr("src",e),t.promise()}(t)});return(a[t]=n).done(function(e){!function(e,t){if(-1!=config.numImageCache){var r=o.indexOf(e);if(-1!=r&&o.splice(r,1),o.push(e),i[e]=t,o.length>config.numImageCache){var n=o.length-config.numImageCache;o.splice(0,n).forEach(function(e){delete i[e]})}}else i[e]=t}(t,e),e.originalURL=r,ev.lastimage.width=e.width,ev.lastimage.height=e.height}),n.promise()},getFullAudioPath:function(e){e=e.toLowerCase();var t=o2.soundList[e];if(t)return t+"."+ResourceLoader.getAudioExtension()},loadAudio:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,n=this.getFullAudioPath(e);return n?c(3,t,function(){return function(e,t){return s(e,"audio",t)}(n,r)}).promise():(o2.error("ストレージに"+e+" が見つかりません"),$.Deferred().reject())},loadAudioBuffer:function(e,r){var t=this,n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],i=this.getFullAudioPath(e);return i?c(3,n,function(){return t.loadBuffer(i).then(function(e){var t=$.Deferred();return r.decodeAudioData(e,function(e){return t.resolve(e)},function(e){return t.reject(e)}),t})}):(o2.error("Audio not found, "+e),$.Deferred().reject())},loadVideo:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(!((e=e.toLowerCase())in o2.videoList))throw"ムービーストレージ "+e+" が存在しません";return e=o2.videoList[e],c(3,t,function(){return function(e,t){return s(e,"video",t)}(e+"."+ResourceLoader.getVideoExtension(),r)}).promise()},loadFont:function(e,t){var r=e,n=$.Deferred();if(-1!==e.indexOf(",")){var i=e.split(/\s*,\s*/g).map(function(e){return e=e.replace('"',""),ResourceLoader.loadFont(e)});return $.when.apply($,i)}if(isFontLoaded(r))return n.resolve();if(!((e=e.toLowerCase())in o2.fontList))return n.resolve();e=o2.fontList[e],$("head").prepend('<style type="text/css">@font-face {font-family: "'+r+'";src: url("'+e+'.ttf"),     url("'+e+'.woff");}</style>');var o,a,s=$("<div />").css({"font-family":r,height:0,width:0,opacity:0,margin:0}).html(".").appendTo($("body"));setTimeout(function e(){isFontLoaded(r)?n.resolve():setTimeout(e,100)},100);return t&&(o=setTimeout(function(){Renderer.showLoadingSign()},3e3),a=setTimeout(function(){n.reject()},1e4)),n.always(function(){clearTimeout(o),clearTimeout(a),Renderer.hideLoadingSign(),s.remove()}),n.promise()},loadBuffer:function(e){var t=$.Deferred(),r=new XMLHttpRequest;return r.open("GET",e,!0),r.responseType="arraybuffer",$(r).one("load",function(){return t.resolve(r.response)}),$(r).one("error",function(){return t.reject()}),r.send(),t}}}();var Conductor=function r(e){if(this.waitTag={},this.file,this.lineNumber=-1,this.currentTag,this.oneShotStackDepth=0,this.paused=!1,this.tagActions={},this.stack=[],this.queue=[],this.status=r.STATUS_STOP,this.callStack=[],this.macroStack=[],this.macros={},this.ifStack=[],this.callbackVarsStack=[],e&&(e.file&&this.setFile(e.file),e.label)){"*"==e.label.charAt(0)&&(e.label=e.label.substring(1));var t=this.file.getLabelTag(e.label);t&&this.setTag(t)}var n=this;this.queue.push=function(e){if(e instanceof Tag){var t=Array.prototype.push.apply(this,arguments);return"click"in n.waitTag?n.trigger("click"):n.status==r.STATUS_STOP&&n.oneShot(),t}}};Conductor.STATUS_STOP=0,Conductor.STATUS_PREPARE_TAG=1,Conductor.STATUS_RUN=2,Conductor.STATUS_WAIT=3,Conductor.prototype.toJSON=function(){var e={currentTag:this.currentTag,stack:this.queue,ifStack:this.ifStack};return config.saveMode==o2.SAVE_MODE_O2KAG&&(e.macroStack=this.macroStack,e.callStack=this.callStack),e},Conductor.prototype.importFromSaveData=function(r){var n=this;if(this.waitTag={},this.callStack=r.callStack||[],delete r.callStack,this.clearMacroStack(),this.clearIfStack(),this.clearStack(),r.currentTag){var e=r.currentTag.restore();return $.when(e).then(function(e){return n.setTag(e,!0),delete r.currentTag,Object.prototype.importFromSaveData.call(n,r)})}var t=KAGFiles(r.file);return $.when(t).then(function(e){var t=e.lines[r.lineNumber];return n.setTag(t,!0),Object.prototype.importFromSaveData.call(n,r)})},Conductor.prototype.importFrom=function(e){throw"【内部エラー】コンダクターはコピーできません。"},Conductor.prototype.getTagAction=function(e){return this.tagActions[e]||Tag.actions[e]},Conductor.prototype.run=function(){var e=this;if(!this.paused){if(this.waitTag={},this.queue.length)this.currentTag=this.queue.shift();else{var t=this.file.lines[this.lineNumber];if(this.currentTag=t,!this.currentTag){var r=new Tag("s");return void this.queue.push(r)}var n=this.currentTag.originalLineNumber||this.currentTag.lineNumber,i="ファイル: "+this.file.filename+" / ";i+="行:"+n+" / ",void 0!==this.currentTag.originalCharNumber&&(i+="文字:"+this.currentTag.originalCharNumber+" / "),i+="タグ: ",i+=this.macroStack.map(function(e){return e.displayName()}).concat([this.currentTag.tagName]).join(" > "),this.callStack.length&&(i+="\ncall stack: ",i+=this.callStack.map(function(e){var t=e.originalLineNumber||e.line;return e.file.filename+":"+(t-1)+" : call"}).join(" > ")),o2.log(i),this.lineNumber++,this.currentTag.file.recentlyUsed()}if((this.currentTag.conductor=this).isMacro(this.currentTag))this.jumpIntoMacro(this.currentTag);else if(this.shouldMacroEnd())this.jumpOutOfMacro();else{this.status=Conductor.STATUS_PREPARE_TAG;var o=this.currentTag.run();void 0===o&&(o=0),delete this.currentTag.conductor,0===o&&(this.status=Conductor.STATUS_RUN),$(this).trigger("running",[o]),0==o?($(this).trigger("ran",[o]),this.oneShotStackDepth++,this.oneShot()):1==o?(this.oneShotStackDepth=0,this.wait(this.currentTag.tagName),this.wait("*",function(){$(e).trigger("ran",[o])})):2==o&&(this.oneShotStackDepth=0,this.status=Conductor.STATUS_STOP,$(this).trigger("ran",[o]))}}},Conductor.prototype.setFile=function(e){this.setTag(e.line(0))},Conductor.prototype.setTag=function(e,t){e.file?(this.file=e.file,this.lineNumber=e.lineNumber,t&&this.lineNumber++):this.queue.push(e)},Conductor.prototype.getNextTag=function(e){if(!e)return this.queue.length?this.queue[0]:this.file.lines[this.lineNumber];for(var t=this.upComingTags(),r=0;r<t.length;r++)if(t[r].tagName==e)return t[r]},Conductor.prototype.upComingTags=function(){return this.queue.concat(this.file.lines.slice(this.lineNumber))},Conductor.prototype.oneShot=function(){var e=this;this.clearingOneShotStack||(this.oneShotStackDepth<5e3?this.run():(setTimeout(function(){delete e.clearingOneShotStack,e.oneShotStackDepth=0,e.run()}),this.clearingOneShotStack=!0))},Conductor.prototype.isCurrentRead=function(){return!0},Conductor.prototype.pause=function(){this.paused=!0},Conductor.prototype.resume=function(){this.paused=!1},function(){function l(){if(currentConductor.macroStack.length){var e=currentConductor.macroStack[currentConductor.macroStack.length-1];window.mp=e.args}else window.mp={}}Conductor.prototype.isMacro=function(e){return e instanceof Tag&&(e=e.tagName),e in this.macros},Conductor.prototype.jumpIntoMacro=function(e){var t=this,r=void 0,n={};if(e instanceof Tag){var i=e;if(!(r=this.macros[i.tagName]))throw"登録されていないマクロ "+i.tagName+" が呼び出されました";(n=i.argsForAction()).tagname=i.tagName}else r=this.macros[e];var o=this.getNextTag(),a=void 0;o?a=o.toRestorable():a=new Tag("s").toRestorable();var s=new Macro({definition:r,returnTag:a,args:n});if("endmacro"===a.tagName){var c=this.macroStack.pop(),u=c.displayName();s.returnTag=c.returnTag,s.displayName=function(){return u+" > "+Macro.prototype.displayName.apply(this,arguments)}}this.macroStack.push(s),l(),this.wait("jumpIntoMacro"),$.when(r.startTag.restore()).done(function(e){t.setTag(e),t.trigger("jumpIntoMacro")})},Conductor.prototype.shouldMacroEnd=function(){return!!this.macroStack.length&&"endmacro"==this.currentTag.tagName},Conductor.prototype.jumpOutOfMacro=function(){var t=this,e=this.macroStack.pop();if(l(),e){this.wait("jumpOutOfMacro");var r=e.returnTag.restore();$.when(r).then(function(e){t.setTag(e),$(t).trigger("ran",[0]),t.trigger("jumpOutOfMacro")})}else this.oneShot()},Conductor.prototype.clearMacroStack=function(){this.macroStack=[],l()};var e=Conductor.prototype.importFromSaveData;Conductor.prototype.importFromSaveData=function(){return e.apply(this,arguments).done(function(){l()})}}(),Conductor.prototype.clearIfStack=function(){this.ifStack=[]},Conductor.prototype.clearStack=function(){this.stack.forEach(function(e){e.exitScope()}),this.stack=[]},Conductor.prototype.reset=function(){this.queue.splice(0,this.queue.length),this.status=Conductor.STATUS_STOP,this.callStack=[],this.macros={},this.clearMacroStack(),this.clearIfStack(),this.clearStack()},Conductor.prototype.wait=function(e,t){this.status=Conductor.STATUS_WAIT,e instanceof Tag&&(e=e.tagName),e in this.waitTag||(this.waitTag[e]=[]),t&&this.waitTag[e].push(t)},Conductor.prototype.trigger=function(e){if(this.status===Conductor.STATUS_PREPARE_TAG&&0==Object.keys(this.waitTag).length)return!1;var t=[],r=!1;e instanceof Tag&&(e=e.tagName),e in this.waitTag?(r=!0,t=t.concat(this.waitTag[e])):"click"==e&&0==Object.keys(this.waitTag).length&&this.status!=Conductor.STATUS_STOP&&(r=!0),r&&this.waitTag["*"]&&(t=t.concat(this.waitTag["*"]));for(var n=0;n<t.length;n++)t[n]();return!!r&&(this.oneShot(),!0)};var MacroDefinition=function(e){e&&(this.name=e.name,this.startTag=e.startTag)};MacroDefinition.prototype.macroCreated=function(e){},MacroDefinition.prototype.importFromSaveData=function(e){this.name=e.name,this.startTag=e.startTag};var Macro=function(e){e&&(this.definition=e.definition,this.returnTag=e.returnTag,this.args=e.args,this.definition.macroCreated(this))};Macro.prototype.initializer="Macro",Macro.prototype.importFromSaveData=function(e){return this.returnTag=e.returnTag,delete e.returnTag,Object.prototype.importFromSaveData.apply(this,arguments)},Macro.prototype.displayName=function(){return this.definition.name};var KAGFiles,KAGFile,PartialFile,SubRoutineConductor=function(){Conductor.call(this),Object.defineProperty(this,"macros",{get:function(){return conductor.macros},set:function(){}})};SubRoutineConductor.prototype=Object.create(Conductor.prototype),SubRoutineConductor.prototype.getTagAction=function(e){return SubRoutineConductor.tagActions=SubRoutineConductor.tagActions||{return:new TagAction({rules:Tag.actions.return.rules,action:function(e){if(0!=this.conductor.callStack.length)return Tag.actions.return.action.call(this,e);if(currentConductor=conductor,o2.skipMode=o2.SKIP_MODE_NONE,e.storage||e.target){var t=new Tag("jump",e);currentConductor.queue.push(t)}return 2}}),label:new TagAction({action:function(e){return config.saveMode==o2.SAVE_MODE_KAG3&&e.caption?(this.error("サブルーチン内にセーブ可能なラベルを置くことはできません"),0):Tag.actions.label.action.call(this,e)}}),o2_savestat:new TagAction({action:function(e){return config.saveMode==o2.SAVE_MODE_O2KAG&&this.error("サブルーチン内にo2_savestatタグを置くことはできません"),0}})},SubRoutineConductor.tagActions[e]||Conductor.prototype.getTagAction.apply(this,arguments)},function(){var i={},o=[],n=1/0,a={};(KAGFiles=function e(t,r){if(t=t.toLowerCase(),null!=r)return o.push(t),i[t]=r,e.ensureFileLimit(),r;if(t in i){var n=i[t];return n.recentlyUsed(),n}if(t in a)return $.get(a[t],null,null,"json").then(function(e){return KAGFile.create(t,e)});throw t+"というファイルが見つからない"}).setupManifest=function(e){for(var t in n=config.numScriptCache,e)a[t.toLowerCase()]=e[t].toLowerCase()},KAGFiles.ensureFileLimit=function(){if(!(o.length<=n))for(var e=function(){var e=[conductor,extraConductor];return e=e.concat(o2.foreLayers.baseLayer.animationConductors,o2.backLayers.baseLayer.animationConductors),e=[].concat.apply(e,o2.foreLayers.imageLayers.map(function(e){return e.animationConductors})),e=[].concat.apply(e,o2.backLayers.imageLayers.map(function(e){return e.animationConductors})),o2.glyphLayer.animationConductors[0]instanceof AnimationConductor&&e.push(o2.glyphLayer.animationConductors[0]),e}().filter(function(e){return null!=e}).map(function(e){return e.file}),t=0;t<o.length&&o.length>n;){var r=o[t];-1===e.indexOf(i[r])&&r in a?(o.splice(t,1),delete i[r]):t++}},KAGFiles.reset=function(){i={},a={},n=1/0,o=[]},KAGFiles.isFileInMemory=function(e){return e in i},KAGFiles.isFileExist=function(e){return e in i||e in a},(KAGFile=function(e,t){this.filename=e.toLowerCase(),this.lines=[],this.labels=[],t||KAGFiles(e,this);var r=this;this.lines.push=function(e){return e.file=r,e.lineNumber=this.length,"label"==e.tagName&&r.labels.push(e),Array.prototype.push.apply(this,arguments)}}).create=function(e,t){for(var r=new KAGFile(e),n=0;n<t.length;n++){var i=t[n],o=new Tag(i[o2.config.scriptTagNameKey],i[o2.config.scriptTagArgsKey],i[o2.config.scriptTagCallbackArgsKey]);r.lines.push(o),void 0!==i[o2.config.scriptTagLineKey]&&(o.originalLineNumber=i[o2.config.scriptTagLineKey]),void 0!==i[o2.config.scriptTagCharKey]&&(o.originalCharNumber=i[o2.config.scriptTagCharKey])}return r},KAGFile.prototype.recentlyUsed=function(){var e=o.indexOf(this.filename);-1!=e&&o.splice(e,1),o.push(this.filename),KAGFiles.ensureFileLimit()},KAGFile.prototype.clone=function(){return this},KAGFile.prototype.line=function(e){return this.lines[e]},KAGFile.prototype.getLabelTag=function(e){for(var t=0;t<this.labels.length;t++)if(this.labels[t].args.name==e)return this.labels[t];return null},KAGFile.prototype.basename=function(){var e=this.filename.split(".");return e.pop(),e.join(".")},KAGFile.prototype.toRestorable=function(){return{filename:this.filename,initializer:"KAGFile"}},KAGFile.restore=function(e){return KAGFiles(e.filename)},(PartialFile=function(e,t,r){this.originalFile=e,this.filename=e.filename+"(virtual:"+t+"~"+r+")",this.start=t,this.end=r;var n=this;this.lines=e.lines.slice(t,r+1).map(function(e,t){var r=Object.create(e);return r.file=n,r.lineNumber=t,r})}).prototype=Object.create(KAGFile.prototype),PartialFile.prototype.getLabelTag=function(e){return this.originalFile.getLabelTag(e)},PartialFile.prototype.toRestorable=function(){return{originalFile:this.originalFile.toRestorable(),start:this.start,end:this.end,initializer:"PartialFile"}},PartialFile.restore=function(t){return $.when(t.originalFile.restore()).then(function(e){return new PartialFile(e,t.start,t.end)})}}();var Rect=function e(){if(4==arguments.length)return new e({x:arguments[0],y:arguments[1],width:arguments[2],height:arguments[3]});if(1==arguments.length&&"object"===_typeof(arguments[0])){for(var t in arguments[0])if(this[t]=arguments[0][t],isNaN(this[t]))throw t+"はnumberじゃないです"}else this.x=this.y=this.width=this.height=0};Rect.prototype.initializer="Rect",Rect.prototype.isEqual=function(e){return e.x==this.x&&e.y==this.y&&e.width==this.width&&e.height==this.height},Rect.prototype.isZero=function(){return this.isEqual(new Rect(0,0,0,0))},Rect.prototype.coverCoordinate=function(e,t){return e>=this.x&&e<this.x+this.width&&t>this.y&&t<this.y+this.height},Rect.prototype.extend=function(e){0!=this.width&&0!=this.height||$.extend(this,e);var t=Math.min(e.x,this.x),r=Math.min(e.y,this.y),n=Math.max(e.x+e.width,this.x+this.width),i=Math.max(e.y+e.height,this.y+this.height);this.x=t,this.y=r,this.width=n-t,this.height=i-r},Rect.prototype.intersect=function(e){if(e.x+e.width>this.x&&e.x<this.x+this.width&&e.y+e.height>this.y&&e.y<this.y+this.height){var t=Math.max(this.x,e.x),r=Math.max(this.y,e.y),n=Math.min(this.x+this.width,e.x+e.width),i=Math.min(this.y+this.height,e.y+e.height);return new Rect({x:t,y:r,width:n-t,height:i-r})}return!1},Rect.prototype.round=function(){this.x=~~(.5+this.x),this.y=~~(.5+this.y),this.width=~~(.5+this.width),this.height=~~(.5+this.height)};var Drawable=function(e){this.rect=clone(e)||new Rect,this.needRedraw=!0,this.partialDraw=!1};Drawable.prototype.initializer="Drawable",Drawable.prototype.objectToBeSerialized=function(e){switch(e){case"needRedraw":case"partialDraw":return}return this[e]},Drawable.prototype.importFrom=function(e){this.rect=clone(e.rect),this.transform=clone(e.transform)},Drawable.prototype.drawOnContext=function(e,t){},Drawable.prototype.frame=function(){return this.rect},Drawable.prototype.canDrawPartial=function(){return!1};var DrawableCanvas=function(e){Drawable.call(this,e),this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.setRect(),this.ctx.textBaseline="top"};DrawableCanvas.prototype=new Drawable,DrawableCanvas.prototype.initializer="DrawableCanvas",DrawableCanvas.prototype.objectToBeSerialized=function(e){switch(e){case"canvas":case"ctx":return}return this[e]},DrawableCanvas.prototype.importFromSaveData=function(){var e=this;return Drawable.prototype.importFromSaveData.apply(this,arguments).done(function(){return e.setRect()})},DrawableCanvas.prototype.canDrawPartial=function(){return!0},DrawableCanvas.prototype.setRect=function(e){e&&(this.rect=e),this.canvas.width=this.rect.width,this.canvas.height=this.rect.height},DrawableCanvas.prototype.clone=function(){var e=new DrawableCanvas;return e.importFrom(this),e.canvas.width=this.rect.width,e.canvas.height=this.rect.height,e.ctx.drawImage(this.canvas,0,0),e},DrawableCanvas.prototype.drawOnContext=function(e,t){if(t){var r=t.intersect(this.rect);e.drawImage(this.canvas,r.x-this.rect.x,r.y-this.rect.y,r.width,r.height,r.x,r.y,r.width,r.height)}else e.drawImage(this.canvas,this.rect.x,this.rect.y,this.rect.width,this.rect.height)};var DrawableSolidColor=function(e){Drawable.call(this,e),this.color="#000000",this.opacity=1};DrawableSolidColor.prototype=new Drawable,DrawableSolidColor.prototype.initializer="DrawableSolidColor",DrawableSolidColor.prototype.canDrawPartial=function(){return!0},DrawableSolidColor.prototype.drawOnContext=function(e,t){t=t?t.intersect(this.rect):this.rect,e.save(),e.globalAlpha=this.opacity,e.fillStyle=this.color,e.fillRect(t.x,t.y,t.width,t.height),e.restore()},DrawableSolidColor.prototype.importFrom=function(e){e instanceof DrawableSolidColor&&(this.color=e.color,this.opacity=e.opacity)};var DrawableImage=function(e,t,r){if(Drawable.call(this),null==e)throw"image needed";null==t&&(t=0),null==r&&(r=0),Drawable.call(this,new Rect(t,r,e.width,e.height)),this.image=e,this.cacheEnabled=!0,this.reuseCanvas=!1,this.cacheCanvas,this.options={}};DrawableImage.defaultOptions={grayscale:!1,key:void 0,rGamma:1,gGamma:1,bGamma:1,rFloor:0,gFloor:0,bFloor:0,rCeil:255,gCeil:255,bCeil:255,tintColor:"#ff0000",tintOpacity:0,shadow:"#000000",shadowOpacity:200,shadowX:10,shadowY:10,shadowBlur:3,clipLeft:void 0,clipTop:void 0,clipWidth:void 0,clipHeight:void 0,flipUD:!1,flipLR:!1,visible:!0,opacity:1,blurX:0,blurY:0,blurMode:"linear"},DrawableImage.prototype=new Drawable,DrawableImage.prototype.initializer="DrawableImage",DrawableImage.prototype.objectToBeSerialized=function(e){switch(e){case"options":var t={};for(var r in this.options)DrawableImage.defaultOptions.hasOwnProperty(r)&&this.options[r]==DrawableImage.defaultOptions[r]||(t[r]=this.options[r]);return t;case"image":if(this.image.originalURL)return this.image.originalURL;case"cacheCanvas":return}return this[e]},DrawableImage.restore=function(r){return $.when(ResourceLoader.loadImage(r.image,!0)).then(function(e){var t=new DrawableImage(e);return t.importFromSaveData(r).then(function(){return t})})},DrawableImage.prototype.importFromSaveData=function(e){var t=this;return $.when($.when(e.rect.restore()).then(function(e){t.rect=e}),$.when(e.options.restore()).then(function(e){t.options=e}))},DrawableImage.prototype.canDrawPartial=function(){return!0},DrawableImage.prototype.clone=function(){var e=new DrawableImage(this.image);return e.importFrom(this),this.cacheCanvas&&(e.cacheCanvas=document.createElement("canvas"),e.cacheCanvas.width=this.cacheCanvas.width,e.cacheCanvas.height=this.cacheCanvas.height,e.cacheCanvas.getContext("2d").drawImage(this.cacheCanvas,0,0)),e},DrawableImage.prototype.importFrom=function(e){this.options=clone(e.options),this.rect=clone(e.rect)},DrawableImage.prototype.drawOnContext=function(e,t){var n=this;t||(t=this.rect);var i=0,o=0,a=this.rect.width,s=this.rect.height;this.options.clipLeft&&(i+=this.options.clipLeft,a-=this.options.clipLeft),this.options.clipTop&&(o+=this.options.clipTop,s-=this.options.clipTop),this.options.clipWidth&&(a=this.options.clipWidth),this.options.clipHeight&&(s=this.options.clipHeight);var r=t.intersect(new Rect({x:this.rect.x,y:this.rect.y,width:a,height:s}));if(r&&(r=r.intersect(new Rect({x:0,y:0,width:e.canvas.width,height:e.canvas.height})))){var c=this.image;if(!this.cacheCanvas||!this.cacheEnabled){for(var u,l,h=function e(t){switch(t){case"canvas":return $(c).is("canvas")||(n.cacheCanvas||(n.cacheCanvas=document.createElement("canvas")),n.cacheCanvas.width=a,n.cacheCanvas.height=s,(u=n.cacheCanvas.getContext("2d")).drawImage(c,i,o,a,s,0,0,a,s),o=i=0,c=n.cacheCanvas),l&&(u.putImageData(l,0,0),l=null),c;case"imageData":if(l)return l;var r=e("canvas");return l=r.getContext("2d").getImageData(0,0,c.width,c.height);default:o2.error("ソースタイプが間違ってます。")}},f=0;f<DrawableImage.effects.length;f++)DrawableImage.effects[f](h,this.options);l&&h("canvas")}e.save(),"opacity"in this.options&&(e.globalAlpha=this.options.opacity),e.drawImage(c,r.x-this.rect.x+i,r.y-this.rect.y+o,r.width,r.height,r.x,r.y,r.width,r.height),e.restore(),this.cacheEnabled&&this.reuseCanvas||(this.cacheCanvas=null)}},DrawableImage.effects=[function(e,t){if(t.flipLR){var r=e("canvas"),n=document.createElement("canvas");n.width=r.width,n.height=r.height;var i=n.getContext("2d");i.translate(r.width,0),i.scale(-1,1),i.drawImage(r,0,0);var o=r.getContext("2d");o.clearRect(0,0,r.width,r.height),o.drawImage(n,0,0)}},function(e,t){if(t.flipUD){var r=e("canvas"),n=document.createElement("canvas");n.width=r.width,n.height=r.height;var i=n.getContext("2d");i.translate(0,r.height),i.scale(1,-1),i.drawImage(r,0,0);var o=r.getContext("2d");o.clearRect(0,0,r.width,r.height),o.drawImage(n,0,0)}},function(e,t){if(t.key){var r=t.key,n=e("imageData"),i=n.data;if("adapt"===t.key){for(var o={},a=0,s=4*n.width;a<s;a+=4){var c=rgbToHex(i[a],i[a+1],i[a+2]);o[c]=(o[c]||0)+1}var u=void 0,l=0;for(var h in o){var f=o[h];l<f&&(l=f,u=h)}r=u}for(var d=0,p=i.length;d<p;d+=4){rgbToHex(i[d],i[d+1],i[d+2])===r&&(i[d+3]=0)}}},function(e,t){if(t.grayscale)for(var r=e("imageData").data,n=0,i=r.length;n<i;n+=4){var o=.34*r[n]+.5*r[n+1]+.16*r[n+2];r[n]=o,r[n+1]=o,r[n+2]=o}},function(e,t){var r=t.rGamma;if("rGamma"in t&&1!=r){var n=e("imageData").data;r=1/r;for(var i=0,o=n.length;i<o;i+=4)n[i]=255*Math.pow(n[i]/255,r)}},function(e,t){var r=t.gGamma;if("gGamma"in t&&1!=r){var n=e("imageData").data;r=1/r;for(var i=0,o=n.length;i<o;i+=4)n[i+1]=255*Math.pow(n[i+1]/255,r)}},function(e,t){var r=t.bGamma;if("bGamma"in t&&1!=r){var n=e("imageData").data;r=1/r;for(var i=0,o=n.length;i<o;i+=4)n[i+2]=255*Math.pow(n[i+2]/255,r)}},function(e,t){if("rFloor"in t||"rCeil"in t){var r="rFloor"in t?t.rFloor:0,n="rCeil"in t?t.rCeil:255,i=n-r;if(0!==r||255!==n)for(var o=e("imageData").data,a=0,s=o.length;a<s;a+=4)o[a]=o[a]/255*i+r}},function(e,t){if("gFloor"in t||"gCeil"in t){var r="gFloor"in t?t.gFloor:0,n="gCeil"in t?t.gCeil:255,i=n-r;if(0!==r||255!==n)for(var o=e("imageData").data,a=0,s=o.length;a<s;a+=4)o[a+1]=o[a+1]/255*i+r}},function(e,t){if("bFloor"in t||"bCeil"in t){var r="bFloor"in t?t.bFloor:0,n="gCeil"in t?t.bCeil:255,i=n-r;if(0!==r||255!==n)for(var o=e("imageData").data,a=0,s=o.length;a<s;a+=4)o[a+2]=o[a+2]/255*i+r}},function(e,t){if(t.tintColor&&t.tintOpacity){var r=e("canvas"),n=r.getContext("2d");n.save(),n.globalAlpha=t.tintOpacity,n.globalCompositeOperation="source-atop",n.fillStyle=t.tintColor,n.fillRect(0,0,r.width,r.height),n.restore()}},function(e,t){if(t.blurX||t.blurY){var r=e("canvas"),n=r.getContext("2d"),i=document.createElement("canvas"),o=i.getContext("2d");i.width=r.width,i.height=r.height;var a=(t.blurX||0)+1,s=(t.blurY||0)+1;if("linear"==t.blurMode){for(var c=0;c<a;c++){o.globalAlpha=1-c/a;var u=(a-c)/2*(c%2?-1:1);o.drawImage(r,u,0)}n.save(),n.clearRect(0,0,r.width,r.height);for(var l=0;l<s;l++){n.globalAlpha=1-l/s;var h=(s-l)/2*(l%2?-1:1);n.drawImage(i,0,h)}n.restore()}else{for(var f=n.getImageData(0,0,r.width,r.height),d=0,p=255,g=f.data,y=g.length-1;0<y;)d<g[y]&&(d=g[y]),p>g[y]&&(p=g[y]),y-=4;for(g=f=null,o.globalAlpha=1/a,y=0;y<a;y++)o.drawImage(r,y-a/2,0);for(n.save(),n.clearRect(0,0,r.width,r.height),n.globalAlpha=1/s,y=0;y<s;y++)n.drawImage(i,0,y-s/2);n.restore();var m=n.getImageData(0,0,r.width,r.height),v=m.data,w=0,T=255;for(y=v.length-1;0<y;)w<v[y]&&(w=v[y]),T>v[y]&&(T=v[y]),y-=4;var b=d-p,L=w-T;for(y=v.length-1;0<y;){var x=p+b*((v[y]-T)/L);v[y]=x,y-=4}n.putImageData(m,0,0)}}}];var Renderer=function(){this.animator=new Animator(this),this.foreLayers=[],this.backLayers=[],this.foreCanvas=document.createElement("canvas"),this.foreCtx=this.foreCanvas.getContext("2d"),this.backCanvas=document.createElement("canvas"),this.backCtx=this.backCanvas.getContext("2d"),this.xShift=0,this.yShift=0,this.foreCanvas.width=this.backCanvas.width=config.scWidth,this.foreCanvas.height=this.backCanvas.height=config.scHeight,this.renderBackCanvas=!1,this.transForeCanvas,this.transBackCanvas,this.transCanvas};Renderer.prototype={render:function(){this.foreCtx.clearRect(0,0,this.foreCanvas.width,this.foreCanvas.height),this.renderBackCanvas&&this.backCtx.clearRect(0,0,this.backCanvas.width,this.backCanvas.height),this.foreCtx.save(),this.foreCtx.translate(this.xShift,this.yShift);for(var e=!1,t=0;t<this.foreLayers.length;t++){var r=this.foreLayers[t],n=r.getCorrespondingLayer();if(r.flush(),n.flush(),r.transTag){this.transForeCanvas||(this.transForeCanvas=document.createElement("canvas"),this.transBackCanvas=document.createElement("canvas"),this.transCanvas=document.createElement("canvas"),this.transForeCanvas.width=this.transBackCanvas.width=this.transCanvas.width=this.foreCanvas.width,this.transForeCanvas.height=this.transBackCanvas.height=this.transCanvas.height=this.foreCanvas.height);var i=this.transForeCanvas.getContext("2d"),o=this.transBackCanvas.getContext("2d");i.clearRect(0,0,this.transForeCanvas.width,this.transForeCanvas.height),o.clearRect(0,0,this.transBackCanvas.width,this.transBackCanvas.height),o.drawImage(this.foreCanvas,0,0),n.drawOnContext(o),i.drawImage(this.foreCanvas,0,0),r.drawOnContext(i),r.transTag.method.transit.call(r.transTag,r.transTag.transArgs,this.transForeCanvas,this.transBackCanvas,this.transCanvas),this.foreCtx.drawImage(this.transCanvas,0,0,this.transCanvas.width,this.transCanvas.height)}else r.drawOnContext(this.foreCtx),this.renderBackCanvas&&(e=!0,n.drawOnContext(this.backCtx))}o2.historyLayer.visible&&(o2.historyLayer.flush(),o2.historyLayer.drawOnContext(this.foreCtx)),this.foreCtx.restore(),$(this.foreCanvas).trigger("draw"),e&&$(this.backCanvas).trigger("draw")}},Renderer.showLoadingSign=function(){$("#loading").show()},Renderer.hideLoadingSign=function(){$("#loading").hide()},Renderer.showServerError=function(e){$("#error").show(),$("#retryButton").one("click",function(){Renderer.hideServerError(),e()})},Renderer.hideServerError=function(){$("#error").hide()},Renderer.askForLogin=function(){var r=$.Deferred();return o2.serverStat.mode!=o2.SERVER_MODE_O2SERVER?r.resolve():-1!=o2.serverStat.uid?r.resolve():($("#login-box iframe").one("load",function(){$("#login-box").fadeIn()}).attr("src",o2.serverStat.userServer+"/auth/login_box"),$(window).one("message",function(e){var t=e.originalEvent;"login/cancel"==t.data?(Renderer.closeLoginBox(),r.reject()):"login/success"==t.data&&(Renderer.closeLoginBox(),$.getScript(o2.serverStat.userServer+"/js?id="+config.gameID).then(function(){return loadSystemStateFromServer()}).then(function(){saveCurrentSystemState(),$(o2).trigger("loginbox.loggedin")}).done(function(){r.resolve()}).fail(function(){r.reject()}))}),r.promise())},Renderer.closeLoginBox=function(){$("#login-box").fadeOut("fast",function(){$("#login-box iframe").attr("src","")}),scaleToFitPage()};var Animator=function(e){this.renderer=e,this.animationRequests=[],this.nextCallTimestamp=void 0,this.timeoutId=void 0,this.animationRequestId=void 0};Animator.prototype={requestFrame:function(e,t){null==t&&(t=0),e||(e=function(){});var r=Date.now()+t;!this.isPaused&&(r<this.nextCallTimestamp||null==this.nextCallTimestamp)&&(clearTimeout(this.timeoutId),cancelAnimationFrame(this.animationRequestId),0<t?this.timeoutId=setTimeout(this.animationLoopCalled.bind(this),t):this.animationRequestId=requestAnimationFrame(this.animationLoopCalled.bind(this)),this.nextCallTimestamp=r),this.animationRequests.push({callback:e,begin:r})},animationLoopCalled:function(){window.meter&&window.meter.tickStart(),this.nextCallTimestamp=void 0,this.timeoutId=void 0,this.animationRequestId=void 0;var e=this.animationRequests;this.animationRequests=[];for(var t=[],r=0;r<e.length;r++){var n=e[r];0<n.begin-Date.now()?t.push(n):"function"==typeof n.callback&&n.callback()}for(var i=0;i<t.length;i++){var o=t[i],a=o.begin-Date.now();this.requestFrame(o.callback,a)}this.renderer.render(),window.meter&&window.meter.tick()},isPaused:!1,pause:function(){this.isPaused||(this.isPaused=!0,void 0!==this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),void 0!==this.animationRequestId&&(cancelAnimationFrame(this.animationRequestId),this.animationRequestId=void 0),this.nextCallTimestamp=void 0)},resume:function(){this.isPaused&&(this.isPaused=!1,this.animationRequests.length&&this.requestFrame())}};var Layer=function(e){Drawable.call(this,e),this.rect.width||(this.rect.width=config.scWidth),this.rect.height||(this.rect.height=config.scHeight),Object.defineProperty(this,"canvas",{get:function(){return this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=this.rect.width,this._canvas.height=this.rect.height),this._canvas},set:function(e){this._canvas=e}}),Object.defineProperty(this,"ctx",{get:function(){return this.canvas.getContext("2d")}}),this.stackedClearRect=new Rect,this.requestedFrame=!1,this.visible=!0,this.opacity=1,this.rotation=0,this.scaleX=1,this.scaleY=1,this.transformOrigin={x:0,y:0},this.cachedTransform={},this.index=0,this.userInteractionEnabled=!0,this.transTag=void 0,this.moveTag=void 0};Layer.prototype=new Drawable,Layer.prototype.initializer="Layer",Layer.prototype.objectToBeSerialized=function(e){switch(e){case"canvas":case"_canvas":case"ctx":case"cachedTransform":case"transTag":case"moveTag":case"stackedClearRect":case"requestedFrame":case"needRedraw":case"partialDraw":return}return this[e]},Layer.prototype.importFromSaveData=function(e){var t=this;return e.scale&&(this.scaleX=this.scaleY=e.scale,delete e.scale),this.stopTransition(),Drawable.prototype.importFromSaveData.call(this,e).done(function(){t.setRect()})},Layer.prototype.importFrom=function(e){this.rect=clone(e.rect),this.visible=e.visible,this.opacity=e.opacity,this.canvas.width=e.canvas.width,this.canvas.height=e.canvas.height,this.redrawRect(),this.transTag=void 0,this.rotation=e.rotation,this.scaleX=e.scaleX,this.scaleY=e.scaleY,this.transformOrigin=clone(e.transformOrigin),this.cachedTransform={},this.index=e.index},Layer.prototype.destroy=function(){this._canvas=null},Layer.prototype.getCorrespondingLayer=function(){var e=o2.allForeLayers().indexOf(this);return-1!=e?o2.allBackLayers()[e]:-1!=(e=o2.allBackLayers().indexOf(this))?o2.allForeLayers()[e]:void 0},Layer.prototype.setRect=function(e){e&&(e.width&&e.height||o2.error("width/heightは0です"),this.rect=e),this.canvas.width=this.rect.width,this.canvas.height=this.rect.height},Layer.prototype.transformMatrix=function(){if(this.cachedTransform.x==this.rect.x&&this.cachedTransform.y==this.rect.y&&this.cachedTransform.rotation==this.rotation&&this.cachedTransform.scaleX==this.scaleX&&this.cachedTransform.scaleY==this.scaleY&&this.cachedTransform.originX==this.transformOrigin.x&&this.cachedTransform.originY==this.transformOrigin.y&&null!=this.cachedTransform.matrix)return this.cachedTransform.matrix;var e=[[1,0,0],[0,1,0],[0,0,1]];return e=multiplyMatrix(e,[[1,0,this.rect.x+this.transformOrigin.x],[0,1,this.rect.y+this.transformOrigin.y],[0,0,1]]),0!=this.rotation&&(e=multiplyMatrix(e,[[Math.cos(this.rotation),Math.sin(this.rotation),0],[-Math.sin(this.rotation),Math.cos(this.rotation),0],[0,0,1]])),1==this.scaleX&&1==this.scaleY||(e=multiplyMatrix(e,[[this.scaleX,0,0],[0,this.scaleY,0],[0,0,1]])),this.cachedTransform.x=this.rect.x,this.cachedTransform.y=this.rect.y,this.cachedTransform.rotation=this.rotation,this.cachedTransform.scaleX=this.scaleX,this.cachedTransform.scaleY=this.scaleY,this.cachedTransform.originX=this.transformOrigin.x,this.cachedTransform.originY=this.transformOrigin.y,this.cachedTransform.matrix=e,this.cachedTransform.inverted=void 0,e},Layer.prototype.localLocation=function(e,t){var r=this.cachedTransform.inverted;if(!r){var n=this.transformMatrix(),i=[[n[0][0],n[0][1]],[n[1][0],n[1][1]]],o=i[0][0]*i[1][1]-i[0][1]*i[1][0],a=[[i[1][1]/o,i[0][1]/-o],[i[1][0]/-o,i[0][0]/o]],s=multiplyMatrix(a,[[n[0][2]],[n[1][2]]]);s=[[-s[0][0]],[-s[1][0]]],r=[[a[0][0],a[0][1],s[0][0]],[a[1][0],a[1][1],s[1][0]],[0,0,1]],this.cachedTransform.inverted=r}var c=multiplyMatrix(r,[[e],[t],[1]]);return{x:c[0][0]+this.transformOrigin.x,y:c[1][0]+this.transformOrigin.y}},Layer.prototype.transit=function(e){"function"==typeof(this.transTag=e).method.prepare&&e.method.prepare.call(e,e.transArgs)},Layer.prototype.isTransiting=function(){return null!=this.transTag},Layer.prototype.stopTransition=function(){this.transTag&&(this.transTag.end=!0,"function"==typeof this.transTag.method.teardown&&this.transTag.method.teardown.call(this.transTag),this.importFrom(this.transTag.transArgs.layer.back),this.transTag=void 0)},Layer.prototype.drawOnContext=function(e){if(this.visible){e.save();var t=this.transformMatrix();e.transform(t[0][0],t[1][0],t[0][1],t[1][1],t[0][2],t[1][2]),e.globalAlpha=this.opacity,e.drawImage(this.canvas,-this.transformOrigin.x,-this.transformOrigin.y,this.rect.width,this.rect.height),e.restore()}},Layer.prototype.children=function(){return[]},Layer.prototype.mousedown=function(){return!!this.userInteractionEnabled},Layer.prototype.mousemove=function(){return!!this.userInteractionEnabled},Layer.prototype.mouseup=function(){return!!this.userInteractionEnabled},Layer.prototype.draw=function(e){e.needRedraw=!0,this.requestedFrame||(renderer.animator.requestFrame(),this.requestedFrame=!0)},Layer.prototype.redrawRect=function(e){e||(e=new Rect(0,0,this.rect.width,this.rect.height)),this.stackedClearRect.extend(e),this.requestedFrame||(renderer.animator.requestFrame(),this.requestedFrame=!0)},Layer.prototype.flush=function(){if(!this.requestedFrame)return!1;for(var e=this.children();;){for(var t=!1,r=e.length-1;0<=r;r--){var n=e[r];n.needRedraw||n.frame().intersect(this.stackedClearRect)&&(n.canDrawPartial()?n.partialDraw=!0:this.stackedClearRect.extend(n.frame()),t=n.needRedraw=!0)}if(!t)break}this.stackedClearRect.round(),this.ctx.clearRect(this.stackedClearRect.x,this.stackedClearRect.y,this.stackedClearRect.width,this.stackedClearRect.height);for(var i=this.stackedClearRect.isZero(),o=0;o<e.length;o++){var a=e[o];a.needRedraw&&(!i&&a.partialDraw?a.drawOnContext(this.ctx,this.stackedClearRect):a.drawOnContext(this.ctx),a.needRedraw=!1,a.partialDraw=!1)}return this.stackedClearRect=new Rect,!(this.requestedFrame=!1)};var ImageLayer=function(){Layer.call(this),this.images=[],this.animationConductors=[],this.animationChildren=[],this.videos=[]};(window.ImageLayer=ImageLayer).prototype=Object.create(Layer.prototype),ImageLayer.prototype.initializer="ImageLayer",ImageLayer.prototype.children=function(){return this.images.concat(this.animationChildren,this.videos)},ImageLayer.prototype.importFrom=function(e){for(var t in Layer.prototype.importFrom.apply(this,arguments),this.clearImage(),this.images=clone(e.images),this.clearAnimationConductors(),e.animationConductors){var r=clone(e.animationConductors[t]);this.addAnimationConductor(r,t)}},ImageLayer.prototype.objectToBeSerialized=function(e){if(("animationConductors"!=e||this.animationConductors.length)&&"animationChildren"!=e&&"videos"!=e)return Layer.prototype.objectToBeSerialized.apply(this,arguments)},ImageLayer.prototype.importFromSaveData=function(n){this.images=[],this.videos=[],this.animationConductors.forEach(function(e){e.stop()}),this.animationConductors=[];for(var i=this,e=[],t=0;t<n.images.length;t++){var r=n.images[t];!function(t){e.push($.when(r.restore()).done(function(e){i.images[t]=e}))}(t)}return delete n.images,$.when.apply($,e).then(function(){o2.log("イメージのロードを完了しました")}).then(function(){var r=[];if(i.clearAnimationConductors(),"animationConductors"in n)for(var e=0;e<n.animationConductors.length;e++){var t=n.animationConductors[e];null!==t&&function(t,e){r.push($.when(e.restore()).done(function(e){i.addAnimationConductor(e,t),e.run()}))}(e,t)}return delete n.animationConductors,$.when.apply($,r)}).then(function(){return Layer.prototype.importFromSaveData.call(i,n)}).then(function(){return i.redrawRect(),i})},ImageLayer.prototype.loadImage=function(e,r,t){var n=this;return r=r||{},ResourceLoader.loadImage(e,!t).then(function(e){n.clearImage(),n.clearAnimationConductors();var t=new DrawableImage(e,0,0);return t.options=r,n.addImage(t),n.rect.width=t.rect.width,n.rect.height=t.rect.height,n.setRect(),t})},ImageLayer.prototype.addImage=function(e){this.images.push(e),this.draw(e)},ImageLayer.prototype.clearImage=function(){for(var e=0;e<this.images.length;e++)this.redrawRect(this.images[e].rect);this.images=[]},ImageLayer.prototype.getImageRect=function(t){var e=void 0;if("number"==typeof t?e=this.images[t]:"string"==typeof t?e=this.images.filter(function(e){return e.image.originalURL==t})[0]:"function"==typeof t&&(e=this.images.filter(t)[0]),e)return e.rect},ImageLayer.prototype.addAnimationConductor=function(e,t){t in this.animationConductors||((e.layer=this).animationConductors[t]=e)},ImageLayer.prototype.clearAnimationConductors=function(){this.animationConductors.forEach(function(e){e.stop()}),this.animationConductors=[]};var BaseLayer=function(){ImageLayer.call(this),this.backgroundSolid=new DrawableSolidColor,this.backgroundSolid.rect=new Rect(0,0,this.rect.width,this.rect.height),this.backgroundSolid.color=config.backgroundColor};BaseLayer.prototype=Object.create(ImageLayer.prototype),BaseLayer.prototype.initializer="BaseLayer",BaseLayer.prototype.children=function(){return[this.backgroundSolid].concat(this.images,this.animationChildren)};var GlyphLayer=function(){ImageLayer.call(this),this.triedLoadCurrentAnimationFile=!1,this.parentLayer=void 0};GlyphLayer.prototype=Object.create(ImageLayer.prototype),GlyphLayer.prototype.initializer="GlyphLayer",GlyphLayer.prototype.objectToBeSerialized=function(e){switch(e){case"parentLayer":case"triedLoadCurrentAnimationFile":return}return ImageLayer.prototype.objectToBeSerialized.apply(this,arguments)},GlyphLayer.prototype.importFromSaveData=function(){return ImageLayer.prototype.importFromSaveData.apply(this,arguments)},GlyphLayer.prototype.redrawRect=function(){this.requestedFrame=!0,this.parentLayer&&this.parentLayer.redrawRect(this.rect),ImageLayer.prototype.redrawRect.apply(this,arguments)},GlyphLayer.prototype.draw=function(){this.requestedFrame=!0,this.parentLayer&&this.parentLayer.redrawRect(this.rect),ImageLayer.prototype.draw.apply(this,arguments)},GlyphLayer.prototype.drawOnContext=function(){this.flush(),ImageLayer.prototype.drawOnContext.apply(this,arguments)},GlyphLayer.prototype.showOnLayer=function(e,t){var r=this,n=t+".asd";return this.parentLayer=e,$.when(r.images.length&&r.images[0].image.originalURL===t?void 0:(r.triedLoadCurrentAnimationFile=!1,r.loadImage(t))).then(function(){if(r.animationConductors.length&&r.animationConductors[0].file.filename==n)return r.visible=!0,r.animationConductors[0].status==Conductor.STATUS_STOP&&r.animationConductors[0].oneShot(),"loaded";if(!r.triedLoadCurrentAnimationFile){var e;try{e=KAGFiles(n)}catch(e){}return e}}).then(function(e){if("loaded"!==e)if(r.triedLoadCurrentAnimationFile=!0,e){var t=new AnimationConductor({file:e});r.addAnimationConductor(t,0),t.run(),r.visible=!0}else o2.warn(n+"が見つからないです。")})},GlyphLayer.prototype.hide=function(){this.visible&&(this.visible=!1,this.redrawRect(),this.animationConductors.length&&this.animationConductors[0].status!==Conductor.STATUS_STOP&&(this.animationConductors[0].status=Conductor.STATUS_STOP,this.animationConductors[0].queue.push(new Tag("s"))))};var TextProperties=function(e){Drawable.call(this),this.text=e,this.rubyText,this.styles={opacity:1,size:20,face:"Arial",visible:!1,shadowBlur:5,vertical:void 0,shadowOffsetX:0,shadowOffsetY:0},this.useCanvasCache=!1,this.canvas};TextProperties.prototype=new Drawable,TextProperties.prototype.initializer="TextProperties",TextProperties.prototype.importFrom=function(e){Drawable.prototype.importFrom.call(this,e),this.text=e.text,this.rubyText=e.rubyText,this.styles=clone(e.styles),this.useCanvasCache=e.useCanvasCache},TextProperties.prototype.objectToBeSerialized=function(e){switch(e){case"canvas":return}return this[e]},TextProperties.prototype.drawOnContext=function(e){if(this.styles.visible&&0!=this.styles.opacity){if(this.useCanvasCache){var t=this.frame();if(!this.canvas){this.canvas=document.createElement("canvas"),this.canvas.width=t.width,this.canvas.height=t.height;var r=this.canvas.getContext("2d");r.textBaseline="top";var n=this.rect.x-t.x,i=this.rect.y-t.y;this.useCanvasCache=!1;var o=this.rect,a=this.styles.opacity;this.styles.opacity=1,this.rect=new Rect(n,i,this.rect.width,this.rect.height),this.drawOnContext(r),this.rect=o,this.styles.opacity=a,this.useCanvasCache=!0}return e.save(),e.globalAlpha=this.styles.opacity,e.drawImage(this.canvas,t.x,t.y,this.canvas.width,this.canvas.height),void e.restore()}e.save();var s=this.styles.color;if(e.fillStyle!=s&&(e.fillStyle=s),this.styles.shadow?(e.shadowColor=this.styles.shadowColor,e.shadowBlur=this.styles.shadowBlur,e.shadowOffsetX=this.styles.shadowOffsetX,e.shadowOffsetY=this.styles.shadowOffsetY):e.shadowBlur=0,e.globalAlpha!=this.styles.opacity&&(e.globalAlpha=this.styles.opacity),this.styles.vertical)this.fillTextVertical(e);else{var c;if(this.rubyText){c=this.rubyFont(),e.font!=c&&(e.font=c);var u=this.measureRuby(e),l=(this.rect.width-u.width)/2;this.styles.edge&&(e.lineJoin="round",e.lineWidth=this.styles.size/5,e.strokeStyle=this.styles.edgeColor,e.strokeText(this.rubyText,this.rect.x+l,this.rect.y-u.height-this.styles.rubyOffset)),e.fillText(this.rubyText,this.rect.x+l,this.rect.y-u.height-this.styles.rubyOffset)}c=this.font(),e.font!=c&&(e.font=c),this.styles.edge&&(e.lineJoin="round",e.lineWidth=this.styles.size/5,e.strokeStyle=this.styles.edgeColor,e.strokeText(this.text,this.rect.x,this.rect.y)),browser.isFirefox&&e.translate(0,.2*this.styles.size),e.fillText(this.text,this.rect.x,this.rect.y)}e.restore()}},TextProperties.prototype.clearCache=function(){this.canvas&&($(this.canvas).remove(),this.canvas=void 0)},TextProperties.prototype.frame=function(){var e=0;this.styles.edge&&(e+=.2*this.styles.size);var t=new Rect({x:this.rect.x-e,y:this.rect.y-e,width:this.rect.width+2*e,height:this.rect.height+2*e});if(t.y-=.1*this.styles.size,t.height+=.2*this.styles.size,this.styles.shadow){var r=new Rect({x:t.x-this.styles.shadowBlur,y:t.y-this.styles.shadowBlur,width:t.width+2*this.styles.shadowBlur,height:t.height+2*this.styles.shadowBlur});r.x+=this.styles.shadowOffsetX,r.y+=this.styles.shadowOffsetY,t.extend(r)}if((browser.isIOs||browser.isAndroid)&&(t.height+=5),this.rubyText){var n,i=this.measureRuby();if(this.styles.vertical){var o=(this.rect.height-i.height)/2;n=new Rect({x:this.rect.x+this.rect.width+this.styles.rubyOffset,y:this.rect.y+o-10,width:i.width,height:i.height+10})}else{var a=(this.rect.width-i.width)/2;n=new Rect({x:this.rect.x+a,y:this.rect.y-this.styles.rubySize+this.styles.rubyOffset-10,width:i.width,height:i.height+10})}this.styles.edge&&(n.x-=.1*i.width,n.y-=.1*i.height,n.width+=.2*i.width,n.height+=.2*i.height),t.extend(n)}return this.styles.italic&&(t.width+=10),t},TextProperties.prototype.font=function(){var e="";return this.styles.italic&&(e+="italic "),this.styles.bold&&(e+="bold "),e+=this.styles.size+"px ",e+=this.styles.face,e+=" , Arial"},TextProperties.prototype.rubyFont=function(){return this.styles.rubySize+"px "+this.styles.face},TextProperties.prototype.measure=function(e){e.save();var t=this.font();if(e.font!=t&&(e.font=t),this.styles.vertical)r=this.measureVertical(e,this.text);else{var r=e.measureText(this.text);r.height=this.styles.size}return e.restore(),r},TextProperties.prototype.measureRuby=function(e){e||(e=o2.currentMessageLayer.ctx),e.save();var t=this.rubyFont();if(this.font!=t&&(e.font=t),this.styles.vertical)r=this.measureVertical(e,this.rubyText,this.styles.rubySize);else{var r=e.measureText(this.rubyText);r.height=this.styles.rubySize}return e.restore(),r},function(){function u(e,t,r,n,i){var o=r*Math.PI/180,a=Math.cos(o),s=Math.sin(o);return[[e*a,t*s],[-e*s,t*a],[e*(a*n-s*i),t*(s*n+a*i)]]}var l={"《":"︽","》":"︾","(":"︵","（":"︵",")":"︶","）":"︶","{":"︷","｛":"︷","}":"︸","｝":"︸","【":"︻","】":"︼","＜":"︿","<":"︿","＞":"﹀",">":"﹀","「":"﹁","」":"﹂","『":"﹃","』":"﹄","〔":"︹","〕":"︺"},h=["、","。","．"],f="ぁぃぅぇぉっゃゅょゎヵヶ",d="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ;:.s~〜… ＇─│┌┐┘└├┬┤┴┼━┃┏┓┛┗┣┳┫┻╋┠┯┨┷┿┝┰┥┸╂".split(""),p=["ー","―","～"];function g(e,t,r,n,i){var o=e.measureText(t),a=i||this.styles.size,s=this.styles.size;t in l&&(t=l[t]);var c="";return-1!=h.indexOf(t)?c="offsetTopRight":-1!=f.indexOf(t)?c="offsetRight":-1!=d.indexOf(t)?(r+=s,n-=a,c="rotate90"):-1!=p.indexOf(t)&&(r+=s,n-=a,c="reflect45"),e.save(),function(e,t){e.setTransform(t[0][0],t[0][1],t[1][0],t[1][1],t[2][0],t[2][1])}(e,function(e,t,r,n,i){switch(e){case"rotate90":return u(1,1,90,-t+r+i,-t-r);case"reflect45":return u(1,-1,270,-t+r+n,t-r-i);case"offsetTopRight":return u(1,1,0,.625*n,-.625*i);case"offsetRight":return u(1,1,0,.125*n,-.125*i);default:return[[1,0],[0,1],[0,0]]}}(c,r,n,o.width,a)),this.styles.edge&&(e.lineJoin="round",e.lineWidth=o/5,e.strokeStyle=this.styles.edgeColor,e.strokeText(t,r,n)),e.fillText(t,r,n),e.restore(),"rotate90"==c?o.width:a}TextProperties.prototype.measureVertical=function(e,t,r){for(var n=t.split(""),i=0,o=0,a=0;a<n.length;a++){var s=n[a],c={width:e.measureText(s).width,height:r||this.styles.size};if(-1!=d.indexOf(s)){var u=c.height;c.height=c.width,c.width=u}o+=c.height,i<c.width&&(i=c.width)}return{width:i,height:o}},TextProperties.prototype.fillTextVertical=function(e){var t=this.text.split(""),r=this.rect.y,n=this.font();e.font!=n&&(e.font=n),e.save();for(var i=0;i<t.length;i++){var o=t[i];r+=g.call(this,e,o,this.rect.x,r)}if(e.restore(),this.rubyText){n=this.rubyFont(),e.font!=n&&(e.font=n);var a=this.measureRuby(e),s=(this.rect.height-a.height)/2,c=this.rubyText.split("");r=this.rect.y+s;for(var u=0;u<c.length;u++){var l=c[u];r+=g.call(this,e,l,this.rect.x+this.rect.width+this.styles.rubyOffset,r,this.styles.rubySize)}}}}(),TextProperties.prototype.calculateSize=function(e){var t=this.measure(e);return this.rect.width=t.width,this.rect.height=t.height,t},TextProperties.prototype.isEqual=function(e){if(!(e instanceof TextProperties))return!1;if(!this.frame().isEqual(e.frame()))return!1;for(var t in this.styles)if(this.styles[t]!=e.styles[t])return!1;return!0};var Button=function e(t,r,n){DrawableImage.call(this,t,r,n),this.cacheEnabled=!1,this.state=e.STATE_NORMAL};Button.prototype=Object.create(DrawableImage.prototype),Button.prototype.initializer="Button",Button.STATE_NORMAL=0,Button.STATE_HOVER=1,Button.STATE_DOWN=2,Button.STATE_DISABLE=3,Button.prototype.click=function(e,t,r){this.state=Button.STATE_HOVER},Button.prototype.enter=function(e,t,r){this.state=Button.STATE_HOVER},Button.prototype.leave=function(e,t,r){this.state=Button.STATE_NORMAL},Button.prototype.mousemove=function(e,t,r){},Button.prototype.mousedown=function(e,t,r){this.state=Button.STATE_DOWN},Button.prototype.cancel=function(){this.state=Button.STATE_NORMAL},Button.prototype.clone=function(){var e=new Button(this.image);return e.importFrom(this),e},Button.restore=function(r){return $.when(ResourceLoader.loadImage(r.image,!0)).then(function(e){var t=new Button(e);return t.importFromSaveData(r),t})};var Link=function(e){DrawableSolidColor.call(this),this.color=config.messageLayerDefaultLinkColor||"#0000ff",this.opacity=config.messageLayerDefaultLinkOpacity,this.hovering,this.textsProperties=[],this.rects=[],this.vertical=!1,this.messageLayer};Link.prototype=Object.create(DrawableSolidColor.prototype),Link.prototype.initializer="Link",Link.restore=function(e){return(new Link).importFromSaveData()},Link.prototype.objectToBeSerialized=function(e){switch(e){case"messageLayer":return}return this[e]},Link.prototype.importFrom=function(e){DrawableSolidColor.prototype.importFrom.call(this,e),this.vertical=e.vertical,e.messageLayer?this.textsProperties=e.textsProperties.map(function(e){return e}):this.textsProperties=clone(e.textsProperties),this.refreshRects()},Link.prototype.isHovering=function(e,t){for(var r=0;r<this.rects.length;r++)if(this.rects[r].coverCoordinate(e,t))return!0;return!1},Link.prototype.drawOnContext=function(e,t){if(this.hovering){for(var r=this.rect,n=0;n<this.rects.length;n++)this.rect=this.rects[n],DrawableSolidColor.prototype.drawOnContext.call(this,e);this.rect=r}},Link.prototype.addTextProperties=function(e){e instanceof Array?this.textsProperties=this.textsProperties.concat(e):this.textsProperties.push(e),this.refreshRects()},Link.prototype.refreshRects=function(){var e;this.rects=[],this.rect=new Rect;for(var t=0;t<this.textsProperties.length;t++){var r=this.textsProperties[t].frame();e||(e=new Rect),e.extend(r),(t==this.textsProperties.length-1||this.textsProperties[t+1].frame().y!=r.y&&!this.vertical||this.textsProperties[t+1].frame().x!=r.x&&this.vertical)&&(this.rects.push(e),this.rect.extend(e),e=void 0)}},Link.prototype.click=function(e,t,r){},Link.prototype.enter=function(e,t,r){},Link.prototype.leave=function(e,t,r){};var MessageLayer=function e(t){Layer.call(this,t||new Rect({x:config.messageLayerCurrentPositionX,y:config.messageLayerCurrentPositionY,width:config.messageLayerCurrentWidth,height:config.messageLayerCurrentHeight})),this.frameImage,this.frameSolid=new DrawableSolidColor(new Rect(0,0,this.rect.width,this.rect.height)),this.frameSolid.color=config.messageLayerColor||"#000",this.frameSolid.opacity=config.messageLayerOpacity,this.visible=!1,this.opacity=1,this.margin={top:config.messageLayerMarginT||20,right:config.messageLayerMarginR||20,bottom:config.messageLayerMarginB||20,left:config.messageLayerMarginL||20},this.textsProperties=[],this.vertical=config.messageLayerVertical,this.textCursor={x:0,y:0},this.align="left",this.delaySpeed=config.chSpeeds||20,this.ctx.textBaseline="top",this.defaultFont=e.defaults.defaultFont(),this.defaultStyle=e.defaults.defaultStyle(),this.font=clone(this.defaultFont),this.style=clone(this.defaultStyle),ResourceLoader.loadFont(this.defaultFont.face),ResourceLoader.loadFont(this.font.face),this.glyphOptions=e.defaults.glyphOptions(),this.textCustomizers=["baseTextCustomizer","alignTextCustomizer"],this.isDrawingText=!1,this.buttons=[],this.routineButtons=[],this.links=[],this.images=[],this.lastLineSize=0,this.resetCursor();var r=this;$(o2).on("init",function(){$(conductor).on("running",function(){r.refreshRoutineButtons(void 0,void 0)})})};MessageLayer.prototype=Object.create(Layer.prototype),MessageLayer.prototype.initializer="MessageLayer",MessageLayer.defaults={defaultFont:function(){return{size:config.messageLayerDefaultFontSize||20,face:config.messageLayerDefaultFontFace||"Arial",color:config.messageLayerDefaultFontColor||"#000000",rubySize:config.messageLayerDefaultRubySize||10,rubyOffset:config.messageLayerDefaultRubyOffset||0,shadow:config.messageLayerDefaultShadow,shadowColor:config.messageLayerDefaultShadowColor||"#999999",shadowBlur:config.messageLayerDefaultShadowBlur,shadowOffsetX:config.messageLayerDefaultShadowOffsetX,shadowOffsetY:config.messageLayerDefaultShadowOffsetY,edge:config.messageLayerDefaultEdge,edgeColor:config.messageLayerDefaultEdgeColor||"#00ff00",bold:config.messageLayerDefaultFontBold,italic:config.messageLayerDefaultFontItalic}},font:function(){return this.defaultFont()},defaultStyle:function(){return{lineSpacing:Number(config.messageLayerDefaultStyleLineSpacing)||0,pitch:Number(config.messageLayerDefaultStylePitch)||0,lineSize:0,align:"left",autoReturn:config.messageLayerDefaultAutoReturn,kinsoku:MessageLayer.KINSOKU_BURASAGARI,kinsokuBolChar:" 。．、，」』）〉】》］〕”｝’〟？！⁇‼⁈⁉",kinsokuEolChar:"「『（〈【《［〔“｛‘〝",kinsokuBurasagariChar:"。．、，"}},style:function(){return this.defaultStyle()},glyphOptions:function(){return{line:config.messageLayerDefaultGlyphLine,page:config.messageLayerDefaultGlyphPage,fixed:config.messageLayerDefaultGlyphFixed,x:config.messageLayerDefaultGlyphX,y:config.messageLayerDefaultGlyphY}}},MessageLayer.prototype.objectToBeSerialized=function(e){switch(e){case"textsProperties":case"links":case"glyphLayer":case"isDrawingText":return}if(-1==["buttons","routineButtons","images"].indexOf(e)||this[e].length){if(MessageLayer.defaults.hasOwnProperty(e)){var t=MessageLayer.defaults[e]();if(!t)return;var r={};for(var n in this[e])this[e][n]!=t[n]&&(r[n]=this[e][n]);return r}return Layer.prototype.objectToBeSerialized.call(this,e)}},MessageLayer.prototype.importFromSaveData=function(e){var t=this;this.buttons=[];var r=[];if(e.buttons){for(var n=0;n<e.buttons.length;n++){var i=e.buttons[n];r.push($.when(i.restore()).done(function(e){t.addButton(e)}))}delete e.buttons}if(this.images=[],e.images)for(var o=0;o<e.images.length;o++){var a=e.images[o];r.push($.when(a.restore()).done(function(e){t.images.push(e)}))}if(delete e.images,this.links=[],e.links)for(var s=0;s<e.links.length;s++){var c=e.links[s];r.push($.when(c.restore()).done(function(e){t.addLink(e)}))}return delete e.links,this.textCustomizers=[],this.textsProperties=[],r.push(Layer.prototype.importFromSaveData.call(this,e)),e.font.face&&r.push(ResourceLoader.loadFont(e.font.face)),e.defaultFont.face&&r.push(ResourceLoader.loadFont(e.defaultFont.face)),$.when.apply($,r).then(function(){return t.setRect(t.rect),t.redrawRect(),t})},MessageLayer.KINSOKU_NONE=0,MessageLayer.KINSOKU_OIDASHI=1,MessageLayer.KINSOKU_BURASAGARI=2,MessageLayer.prototype.children=function(){var e=[];return this.frameImage?e.push(this.frameImage):e.push(this.frameSolid),e=e.concat(this.textsProperties,this.links,this.images,this.buttons,this.routineButtons),this.glyphLayer&&e.push(this.glyphLayer),e},MessageLayer.prototype.importFrom=function(e){if(!(e instanceof MessageLayer))throw"[内部エラー] otherLayerはMessageLayerではありません";Layer.prototype.importFrom.call(this,e);var t=["frameImage","frameSolid","margin","textsProperties","vertical","lineWidth","textCursor","align","delaySpeed","defaultFont","defaultStyle","font","style","textCustomizers","buttons","images","routineButtons"];(function(){if(this.isDrawingText){var e=t.indexOf("textsProperties");e<0||t.splice(e,1)}}).call(this);for(var r=0;r<t.length;r++){var n=t[r];this[n]=clone(e[n])}this.links=[];for(var i=this,o=0;o<e.links.length;o++){var a=e.links[o],s=clone(a);s.textsProperties=a.textsProperties.map(function(e){var t=a.messageLayer.textsProperties.indexOf(e);if(-1!=t)return i.textsProperties[t]}),this.addLink(s)}this.setRect(clone(e.rect),!0)},MessageLayer.prototype.mousemove=function(e){if(!this.visible)return!1;if(!Layer.prototype.mousemove.apply(this,arguments))return!1;var t=!1,r=e.originalEvent.normalizedCoordinate(this);return this.refreshRoutineButtons(r.x,r.y)&&(t=!0),this.refreshButtons(r.x,r.y)&&(t=!0),this.refreshLinks(r.x,r.y)&&(t=!0),t},MessageLayer.prototype.mouseup=function(e){if(!this.visible)return!1;if(!Layer.prototype.mousedown.apply(this,arguments))return!1;for(var t=e.originalEvent.normalizedCoordinate(this),r=this.buttons.length-1;0<=r;r--){var n=this.buttons[r];if(!n.rect.coverCoordinate(t.x,t.y)&&n.state==Button.STATE_DOWN)return n.leave(t.x,t.y,this),this.redrawRect(n.rect),!0}for(var i=this.routineButtons.length-1;0<=i;i--){var o=this.routineButtons[i];if(o.rect.coverCoordinate(t.x,t.y)&&o.state!=Button.STATE_DISABLE)return o.click(t.x,t.y,this),o.state=Button.STATE_HOVER,this.redrawRect(o.rect),!0}for(var a=this.buttons.length-1;0<=a;a--){var s=this.buttons[a];if(s.rect.coverCoordinate(t.x,t.y))return s.click(t.x,t.y,this),s.state=Button.STATE_HOVER,this.redrawRect(s.rect),!0}for(var c=this.links.length-1;0<=c;c--){var u=this.links[c];if(u.isHovering(t.x,t.y))return u.click(t.x,t.y,this),!0}return!1},MessageLayer.prototype.mousedown=function(e){if(!this.visible)return!1;if(!Layer.prototype.mousedown.apply(this,arguments))return!1;for(var t=e.originalEvent.normalizedCoordinate(this),r=this.routineButtons.length-1;0<=r;r--){var n=this.routineButtons[r];if(n.rect.coverCoordinate(t.x,t.y)&&n.state!=Button.STATE_DISABLE)return n.mousedown(t.x,t.y,this),this.redrawRect(n.rect),!0}for(var i=this.buttons.length-1;0<=i;i--){var o=this.buttons[i];if(o.rect.coverCoordinate(t.x,t.y))return o.mousedown(t.x,t.y,this),this.redrawRect(o.rect),!0}return!1},MessageLayer.prototype.touchcancel=function(){for(var e=this.routineButtons.length-1;0<=e;e--){this.routineButtons[e].cancel()}for(var t=this.buttons.length-1;0<=t;t--){this.buttons[t].cancel()}},MessageLayer.prototype.setRect=function(e,t){e||(e=this.rect),e.width&&e.height||o2.error("width/heightは0です");var r=this.rect.width!=e.width||this.rect.height!=e.height||this.canvas.width!=e.width||this.canvas.height!=e.height;r&&(this.canvas.width=e.width,this.canvas.height=e.height),this.ctx.textBaseline="top",this.rect=e,this.frameSolid.rect.width=e.width,this.frameSolid.rect.height=e.height,(r||t)&&this.redrawRect()},MessageLayer.prototype.resetCursor=function(){this.vertical?this.textCursor={x:this.rect.width-this.margin.right-this.style.lineSpacing,y:this.margin.top}:this.textCursor={x:this.margin.left,y:this.margin.top+this.style.lineSpacing}},MessageLayer.prototype.linebreak=function(){var e=this.lastLineSize||Math.max(this.style.lineSize,this.font.size);this.vertical?(this.textCursor.y=this.margin.top,this.textCursor.x-=this.style.lineSpacing+e):(this.textCursor.x=this.margin.left,this.textCursor.y+=this.style.lineSpacing+e)};var TextCustomizer=function(){function n(e,t,r){_classCallCheck(this,n)}return _createClass(n,[{key:"perform",value:function(){throw"Subclass should be overriding TextCustomizer.perform"}},{key:"isAnimation",get:function(){return!1}},{key:"disableCache",get:function(){return!1}},{key:"isEnded",get:function(){return!0}},{key:"timePassed",set:function(e){this._timePassed=e},get:function(){return this._timePassed}}]),n}();MessageLayer.textCustomizers={baseTextCustomizer:function(e){function i(e,t,r){_classCallCheck(this,i);var n=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,t,r));return n.newTexts=r,n.oldTexts=t,n.textLayer=e,n.delay=e.delaySpeed,n.posCache=null,n}return _inherits(i,TextCustomizer),_createClass(i,[{key:"getPositions",value:function(d){var p=this.textLayer;return this.posCache?this.posCache:this.posCache=function(){var n,e=[],i=p.textCursor.x,o=p.textCursor.y,a=0,s=0,t=void 0;for(n=0;n<d.length;n++){var r=d[n];r.rect.isZero()&&(void 0===r.styles.vertical&&(r.styles.vertical=p.vertical))}for(n=0;n<d.length;n++){var c=d[n];if(c.rect.isZero()){if(null==t){p.vertical?(a=Math.max(a,p.style.lineSize),p.lastLineSize=a):(s=Math.max(s,p.style.lineSize),p.lastLineSize=s);var u=t=function(){for(var e=p.vertical?o:i,t=n;t<d.length;t++){var r=d[t].measure(p.ctx);if(p.vertical){if(e+=r.height+p.style.pitch,r.width>a&&(a=r.width,p.lastLineSize=a),e>p.rect.height-p.margin.bottom&&p.style.autoReturn)return t}else if(r.height>s&&(s=r.height,p.lastLineSize=s),(e+=r.width+p.style.pitch)>p.rect.width-p.margin.right&&p.style.autoReturn)return t}return-1}();if(-1!=t){var l=d[t],h=d[t+1];if(p.style.kinsoku!=MessageLayer.KINSOKU_BURASAGARI||-1==p.style.kinsokuBurasagariChar.indexOf(l.text)||h&&-1!=p.style.kinsokuBolChar.indexOf(h.text)){if(p.style.kinsoku!=MessageLayer.KINSOKU_NONE)for(;-1!=p.style.kinsokuBolChar.indexOf(d[t].text)||d[t-1]&&-1!=p.style.kinsokuEolChar.indexOf(d[t-1].text);)if(--t<=n){t=u;break}}else h?t++:t=-1}}var f=c.measure(p.ctx);if(t===n)if(p.vertical){if(!(o<=p.margin.top)){o=p.margin.top,i-=a+p.style.lineSpacing,t=void(a=0),n--;continue}t++}else{if(!(i<=p.margin.left)){i=p.margin.left,o+=s+p.style.lineSpacing,t=void(s=0),n--;continue}t++}p.vertical?e[n]={x:i-a+(a-f.width)/2,y:o,width:f.width,height:f.height}:e[n]={x:i,y:o+s-f.height,width:f.width,height:f.height},c.rect=new Rect(e[n]),p.vertical?o+=f.height+p.style.pitch:i+=f.width+p.style.pitch}}return e}()}},{key:"perform",value:function(){var r=this,e=this.newTexts,n=this.oldTexts.concat(e),t=this.getPositions(n);e.forEach(function(e,t){r.timePassed/r.delay>=t&&(e.styles.visible||(e.styles.visible=!0,e.needRedraw=!0))}),t.forEach(function(e,t){n[t].rect=new Rect(e)})}},{key:"isAnimation",get:function(){return!1}},{key:"isEnded",get:function(){return this.timePassed/this.delay>=this.newTexts.length}}]),i}(),alignTextCustomizer:function(e){function i(e,t,r){_classCallCheck(this,i);var n=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,t,r));return n.textLayer=e,n.oldTexts=t,n.newTexts=r,n}return _inherits(i,TextCustomizer),_createClass(i,[{key:"perform",value:function(){var e=this.textLayer,t=this.oldTexts,r=this.newTexts,n=t.concat(r),i=e.style.align;if(e.vertical){if("center"!=e.style.align&&"bottom"!=e.style.align)return}else if("left"==e.style.align)return;if(e.vertical)for(var o=0,a=0;a<n.length;a++){var s=n[a];if(a>=n.length-1||s.rect.y>n[a+1].rect.y){for(var c=0,u=o;u<=a;u++)n[u].styles.visible&&(c+=n[u].rect.height+e.style.pitch);c-=e.style.pitch;var l=0,h=e.rect.height-e.margin.top-e.margin.bottom;"center"==i?l=(h-c)/2:"bottom"==i&&(l=h-c);for(var f=o;f<=a;f++)n[f].styles.visible&&(n[f].rect.y=l,n[f].needRedraw=!0,l+=n[f].rect.height+e.style.pitch);o=a+1}}else for(var d=0,p=0;p<n.length;p++){var g=n[p];if(p>=n.length-1||g.rect.x>n[p+1].rect.x){for(var y=0,m=d;m<=p;m++)n[m].styles.visible&&(y+=n[m].rect.width+e.style.pitch);var v=0,w=e.rect.width-e.margin.left-e.margin.right;"center"==i?v=(w-y)/2+e.margin.left:"right"==i&&(v=w-y+e.margin.left);for(var T=d;T<=p;T++)n[T].styles.visible&&(n[T].rect.x=v,n[T].needRedraw=!0,v+=n[T].rect.width+e.style.pitch);d=p+1}}}}]),i}()},MessageLayer.prototype.drawText=function(e,s){this.isDrawingText=!0;var r=this;"string"==typeof e&&(e=e.split(""));for(var n=this.textsProperties.slice(),i=e.map(function(e){if(e instanceof TextProperties)return e;var t=new TextProperties(e);return $.extend(t.styles,clone(r.font)),t}),t=0;t<i.length;t++)this.textsProperties.push(i[t]);var c=!1,o=!1,u=this.textCustomizers.map(function(e){if("function"==typeof(e=MessageLayer.textCustomizers[e])){var t=new e(this,n,i);return!c&&t.isAnimation&&(c=!0),c=c||t.isAnimation||!1,o=o||t.disableCache||!1,t}o2.error(e+"はtextCustomizerではないです。")},this);!o&&(c||0<=["center","right","bottom"].indexOf(this.style.align))&&this.textsProperties.forEach(function(e){e.useCanvasCache=!0});var l=Date.now();(function e(){for(var t=!0,r=Date.now()-l,n=0;n<u.length;n++){var i=u[n];i.timePassed=r,(o2.skipMode||0==this.delaySpeed)&&(i.timePassed=1/0),i.perform(),!1===i.isEnded&&(t=!1)}this.redrawRect();for(var o=0;o<this.links.length;o++)this.links[o].refreshRects();if(t){var a=this.textsProperties[this.textsProperties.length-1];a&&(this.vertical?this.textCursor={x:a.rect.x+a.rect.width+(this.lastLineSize-a.rect.width)/2,y:a.rect.y+a.rect.height}:this.textCursor={x:a.rect.x+a.rect.width,y:a.rect.y+a.rect.height-this.lastLineSize}),this.isDrawingText=!1,"function"==typeof s&&setTimeout(s.bind(this),0),u.forEach(function(e){"function"==typeof e.destroy&&e.destroy()})}else renderer.animator.requestFrame(e.bind(this),c?0:this.delaySpeed)}).call(this)},MessageLayer.prototype.measureText=function(e){return"string"==typeof e&&(e=new TextProperties(e),$.extend(e.styles,clone(this.font))),e.measure(this.ctx)},MessageLayer.prototype.refreshButtons=function(e,t){for(var r=!1,n=this.buttons.length-1;0<=n;n--){var i=this.buttons[n],o=i.rect.coverCoordinate(e,t);this.drawButton(i,o,e,t),(o||i.state==Button.STATE_DOWN)&&(r=!0,i.mousemove(e,t,this))}return r},MessageLayer.prototype.drawButton=function(e,t,r,n){t&&e.state==Button.STATE_NORMAL?(e.enter(r,n,this),this.redrawRect(e.rect)):t||e.state!=Button.STATE_HOVER||(e.leave(r,n,this),this.redrawRect(e.rect))},MessageLayer.prototype.addButton=function(e){this.buttons.push(e),this.draw(e)},MessageLayer.prototype.refreshRoutineButtons=function(e,t){var r=!1,n=[],i=currentConductor.currentTag;if(i){for(var o=-1!=["p","l","s"].indexOf(i.tagName),a=this.routineButtons.length-1;0<=a;a--){var s=this.routineButtons[a],c=!(!e||!t)&&s.rect.coverCoordinate(e,t);c?n.push(s):this.drawRoutineButton(s,c,o,e,t),c&&o&&s.enabled&&(r=!0)}for(var u=0;u<n.length;u++){var l=n[u];this.drawRoutineButton(l,!0,o,e,t)}return r}},MessageLayer.prototype.drawRoutineButton=function(e,t,r,n,i){var o=Button.STATE_NORMAL;r?t?(o=Button.STATE_HOVER,e.state!=Button.STATE_HOVER&&(e.enter(n,i,this),this.redrawRect(e.rect))):(o=Button.STATE_NORMAL,e.state==Button.STATE_HOVER&&(e.leave(n,i,this),this.redrawRect(e.rect))):o=Button.STATE_DISABLE,e.state!=o&&(e.state=o,this.redrawRect(e.rect))},MessageLayer.prototype.addRoutineButton=function(e){this.routineButtons.push(e),this.draw(e)},MessageLayer.prototype.refreshLinks=function(e,t){for(var r=!1,n=this.links.length-1;0<=n;n--){var i=this.links[n],o=i.isHovering(e,t);this.drawLink(i,o,e,t),o&&(r=!0)}return r},MessageLayer.prototype.drawLink=function(e,t,r,n){t&&!e.hovering?(e.enter(r,n,this),e.hovering=!0,e.visible=!0,this.draw(e)):!t&&e.hovering&&(e.leave(r,n,this),e.hovering=!1,e.visible=!1,this.redrawRect(e.rect))},MessageLayer.prototype.addLink=function(e){e.vertical=this.vertical,(e.messageLayer=this).links.push(e)},MessageLayer.prototype.addButtonLinkImages=function(){for(var e=0;e<this.buttons.length;e++){var t=this.buttons[e],r=new DrawableCanvas(t.rect);t.rect.x=t.rect.y=0,t.drawOnContext(r.ctx),this.images.push(r),this.redrawRect(r.rect)}for(var n=0;n<this.links.length;n++){var i=this.links[n];if(i.visible&&i.hovering)for(var o=0;o<i.rects.length;o++){var a=i.rects[o],s=new DrawableSolidColor(a);s.importFrom(i),this.images.push(s),this.redrawRect(s.rect)}}},MessageLayer.prototype.showGlyphLayer=function(e,t){t=t||"line",this.glyphLayer=e;var r=this,n="line"===t?this.glyphOptions.line:this.glyphOptions.page;this.glyphLayer.showOnLayer(this,n).done(function(){r.glyphOptions.fixed?(e.rect.x=r.glyphOptions.x,e.rect.y=r.glyphOptions.y):r.vertical?(e.rect.x=r.textCursor.x-e.rect.width,e.rect.y=r.textCursor.y):(e.rect.x=r.textCursor.x,e.rect.y=r.textCursor.y+Math.max(r.style.lineSize,r.font.size)-e.rect.height),r.redrawRect(e.rect)})},MessageLayer.prototype.hideGlyphLayer=function(){this.glyphLayer&&this.glyphLayer.hide(),this.glyphLayer=void 0},MessageLayer.prototype.resetFrameSize=function(){this.frameSolid.rect.width=this.rect.width,this.frameSolid.rect.height=this.rect.height},MessageLayer.prototype.setFrameImage=function(e){if(null!=e&&!(e instanceof Drawable))throw"[内部エラー] imageはdrawableではありません";this.frameImage?this.redrawRect(this.frameImage.frame()):this.redrawRect(this.rect),this.frameImage=e,this.frameImage&&this.redrawRect(this.frameImage.rect)},MessageLayer.prototype.resetMessageLayer=function(){for(var e=this.buttons.length-1;0<=e;e--)this.redrawRect(this.buttons[e].frame());for(var t=this.textsProperties.length-1;0<=t;t--)this.redrawRect(this.textsProperties[t].frame());this.buttons=[],this.routineButtons=[],this.images=[],this.links=[],this.textsProperties=[],this.font=clone(this.defaultFont),this.style=clone(this.defaultStyle),this.resetCursor(),this.resetFrameSize(),this.redrawRect()};var Sound=function(e){this.filepath,this.isPlaying=!1,this.volume=1,this.volumePercentage=1,this.loop=!1,this.pan=0,this.loadDefer,this.audio=new Audio,this.fadeDefer,this.fadeStatus,"string"==typeof e&&this.setFile(e)};Sound.prototype.objectToBeSerialized=function(e){switch(e){case"audio":case"loadDefer":return}return this[e]},Sound.prototype.importFromSaveData=function(e){var t=this;this.filepath=void 0,this.stop();var r=e.fadeStatus;return delete e.fadeStatus,Object.prototype.importFromSaveData.call(this,e).then(function(){if(r||t.stopFade(),t.filepath){var e=t.setFile(t.filepath);return t.isPlaying&&t.loop&&t.play(),r&&t.fade(r),e}})},Sound.prototype.setFile=function(e){this.filepath=e;var t=this;return this.loadDefer=ResourceLoader.loadAudio(e,!0,this.audio),this.loadDefer.done(function(e){t.setVolume(t.volume),$(e).off(),$(e).on("ended",function(){t.loop?(e.currentTime=0,t.play()):(t.isPlaying=!1,$(t).trigger("ended"))})}),this.loadDefer},Sound.prototype.play=function(e){if(browser.supportsMultipleAudio||this==o2.prioritySound){if(this.stopFade(),e&&this.setFile(e),this.isPlaying=!0,this.loadDefer)return this.loadDefer=this.loadDefer.then(function(t){return $.when(t.play()).then(function(e){return t})});o2.warn("サウンドファイルが指定されていない状態で再生を行おうとしました")}else o2.warn("再生しようとしていますが、config.AudioChannelとは違いますのでしなかった")},Sound.prototype.pause=function(){return this.isPlaying=!1,this.loadDefer?this.loadDefer=this.loadDefer.then(function(t){return $.when(t.pause()).then(function(e){return t})}):$.Deferred().resolve()},Sound.prototype.stop=function(){var t=this;return this.isPlaying=!1,this.loadDefer?(this.pause().then(function(e){return $(t).trigger("ended")}),this.setTime(0)):$.Deferred().resolve()},Sound.prototype.setTime=function(r){return this.loadDefer?this.loadDefer=this.loadDefer.then(function(t){try{t.currentTime=r/1e3}catch(e){$(t).one("loadedmetadata",function(){t.currentTime=r/1e3})}return t}):$.Deferred().resolve()},Sound.prototype.setVolume=function(e){var t=this;if(!(e<0||1<e))return this.volume=e,this.loadDefer?this.loadDefer=this.loadDefer.then(function(e){return e.volume=t.volume*t.volumePercentage,e}):$.Deferred().resolve();o2.error("ボリュームの指定が不正です")},Sound.prototype.setLoop=function(e){this.loop=e},Sound.prototype.setPan=function(e){this.pan=e},Sound.prototype.fade=function(e){var t=this;if(!e)return this.fadeStatus?this.fadeStatus.defer:void 0;if(this.fadeStatus){var r=this.fadeStatus.defer.then(function(){return t.fade(e)});return this.stopFade(),r}if("fromVolume"in e||(e.fromVolume=this.volume),"toVolume"in e||(e.toVolume=this.volume),!this.loadDefer)return o2.log("サウンドファイルを指定されていない状態でフェード処理を行おうとしました"),$.Deferred().resolve();var n=this.fadeStatus=new SoundFade(this,e),i=this.fadeStatus.defer.then(function(){return delete t.fadeStatus});return this.loadDefer=this.loadDefer.then(function(e){return t.fadeStatus===n&&n.start(),e}),i},Sound.prototype.stopFade=function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];return this.fadeStatus?this.fadeStatus.stop(e):$.Deferred().resolve()},Sound.prototype.dummyLoad=function(){this.audio.src="x",this.audio.load()};var SoundFade=function(e,t){this.sound=e,this.fromVolume=1,this.toVolume=0,this.duration=1e3,this.finalVolume=void 0,this.stopAfterFade=!1,t&&$.extend(this,t),this.duration=this.duration||1,this.intervalId,this.defer=$.Deferred()};SoundFade.prototype.initializer="SoundFade",SoundFade.prototype.start=function(){var r=Date.now();function e(){var e=(Date.now()-r)/this.duration;1<e&&(e=1);var t=this.fromVolume+(this.toVolume-this.fromVolume)*e;this.sound.setVolume(t),1<=e&&this.stop()}this.intervalId=setInterval(e.bind(this),1e3/60),e.call(this)},SoundFade.prototype.stop=function(){var e=this,t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];return clearInterval(this.intervalId),t&&(void 0!==this.finalVolume?this.sound.setVolume(this.finalVolume):this.sound.setVolume(this.toVolume)),this.stopAfterFade?this.sound.stop().then(function(){return e.defer.resolve()}):this.defer.resolve(),this.defer},SoundFade.prototype.toJSON=function(){return{fromVolume:this.fromVolume,toVolume:this.toVolume,duration:this.duration,finalVolume:this.finalVolume,stopAfterFade:this.stopAfterFade}};var Tag,TagAction,WebAudioSound=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));e.audio=null,e.source,e.playStartTime=null,e.pausedAtTime=null;var t=n.getAudioContext();return e.gain=t.createGain(),e.gain.connect(t.destination),e}return _inherits(n,Sound),_createClass(n,null,[{key:"getAudioContext",value:function(){var e=window.AudioContext||window.webkitAudioContext;if(!e)return null;var t=new e;return n.getAudioContext=function(){return t},t}}]),_createClass(n,[{key:"objectToBeSerialized",value:function(e){switch(e){case"source":case"playStartTime":case"pausedAtTime":case"gain":return}return _get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"objectToBeSerialized",this).call(this,e)}},{key:"setFile",value:function(e){return this.filepath=e,this.source=null,this.loadDefer=ResourceLoader.loadAudioBuffer(e,n.getAudioContext(),!0),this.loadDefer}},{key:"play",value:function(t){var r=this;return this.isPlaying?this.stop().then(function(e){return r.play(t)}):(this.stopFade(),t&&this.setFile(t),this.isPlaying=!0,this.loadDefer?(this.loadDefer.done(function(e){var t=n.getAudioContext();r.source=t.createBufferSource(),r.source.buffer=e,r.source.loop=r.loop,r.source.connect(r.gain),null!==r.pausedAtTime?(r.source.start(t.currentTime,r.pausedAtTime/1e3),r.playStartTime=Date.now()-r.pausedAtTime):(r.source.start(t.currentTime),r.playStartTime=Date.now()),r.pausedAtTime=null,$(r.source).on("ended",function(){r.isPlaying=!1,$(r).trigger("ended")})}),this.loadDefer):(o2.warn("サウンドファイルが指定されていない状態で再生を行おうとしました"),$.Deferred().resolve()))}},{key:"pause",value:function(){var e=this.playStartTime;return this.stop(),this.pausedAtTime=Date.now()-e,$.Deferred().resolve()}},{key:"stop",value:function(){var t=this;return this.isPlaying=!1,this.pausedAtTime=null,this.playStartTime=null,this.loadDefer?this.loadDefer.done(function(e){t.source&&(t.source.stop(),t.source.disconnect(),$(t.source).trigger("ended"),t.source=null)}):$.Deferred().resolve()}},{key:"setTime",value:function(e){return this.stop(),this.pausedAtTime=e,this.play()}},{key:"setVolume",value:function(e){return this.volume=e,this.gain.gain.value=this.volume*this.volumePercentage,$.Deferred().resolve()}},{key:"setLoop",value:function(t){var r=this;this.loop=t,this.loadDefer&&this.loadDefer.then(function(e){r.source&&(r.source.loop=t)})}},{key:"dummyLoad",value:function(){var e=n.getAudioContext(),t=e.createBuffer(1,1,22050),r=e.createBufferSource();r.buffer=t,r.connect(e.destination),r.start()}},{key:"initializer",get:function(){return"WebAudioSound"}}]),n}();(Tag=function(e,t,r){this.file,this.tagName=e,this.args=t||{},r&&(this.callbackArgs=r),this.scopeVars,this.lineNumber,this.originalLineNumber,this.originalCharNumber,this.conductor}).prototype.getAction=function(e){return this.conductor&&"function"==typeof this.conductor.getTagAction?this.conductor.getTagAction(e):Tag.actions[e]},Tag.prototype.isOpen=function(){return null!=this.callbackArgs},Tag.prototype.isClose=function(){return"/"===this.tagName},Tag.prototype.getOpenTag=function(){if(this.isClose()&&this.file){if(this.openTag)return this.openTag;var e=function(){for(var e=1,t=this.lineNumber-1;0<t;t--){var r=this.file.lines[t];if(r.isClose()?e++:r.isOpen()&&e--,0==e)return(r.closeTag=this).openTag=r}}.call(this),t=this.conductor.stack[this.conductor.stack.length-1];if(e&&t&&e.isPrototypeOf(t))return t;throw"something wrong in stack"}},Tag.prototype.getCloseTag=function(){if(this.isOpen()&&this.file)for(var e=this.conductor.upComingTags(),t=1,r=0;r<e.length;r++){var n=e[r];if(n.isOpen()?t++:n.isClose()&&t--,0==t)return(n.openTag=this).getCloseTag=function(){return n},n}},Tag.prototype.getCallbackFile=function(){var e=this.getCloseTag();if(e){var t=new PartialFile(this.file,this.lineNumber+1,e.lineNumber-1);return this.getCallbackFile=function(){return t},t}},Tag.prototype.makeScopeVars=function(e){if(e instanceof Array){for(var t={},r=0;r<this.callbackArgs.length;r++)t[this.callbackArgs[r]]=e[r];return t}},Tag.prototype.setScopeVars=function(e){if(this.isOpen()){var t=this.conductor.callbackVarsStack.indexOf(this.scopeVars);e instanceof Array?this.scopeVars=this.makeScopeVars(e):this.scopeVars=e,-1==t?this.conductor.callbackVarsStack.push(this.scopeVars):this.conductor.callbackVarsStack[t]=this.scopeVars}},Tag.prototype.keepStack=function(){throw"keepStackはclose tagのみ使える"},Tag.prototype.flattenCurrentScope=function(r){if(!this.conductor)return{};var n={};return this.conductor.callbackVarsStack.forEach(function(e){for(var t in e)r&&!r(t,e[t])||(n[t]=e[t])}),n},Tag.prototype.exitScope=function(){if(this.isOpen()){var e=this.getAction(this.tagName);if(e){var t=e.exitScope;"function"==typeof t&&t.call(this)}}},Tag.prototype.jumpToTag=function(t,e){for(var r=this.conductor.stack.length-1;0<=r;r--){var n=this.conductor.stack[r];if(n===t||t.isPrototypeOf(n)||n.getCloseTag()===t&&!e)break;if(n.getCallbackFile().lines.some(function(e){return e===t||t.isPrototypeOf(e)||e.isPrototypeOf(t)}))break;n.exitScope(),this.conductor.stack.pop(),n.scopeVars&&this.conductor.callbackVarsStack.pop()}this.conductor.setTag(t,e)},Tag.prototype.run=function(){var e=this.tagName,t=this.getAction(e);if(this.isClose()){var r=this.conductor.stack[this.conductor.stack.length-1];if(!r)return void this.error("open tagが見つかりません");if(e=r.tagName,!(t=this.getAction(e)))return;var n=t.closeAction,i=0,o=!0;if("function"==typeof n){var a=Object.create(this);a.keepStack=function(){o=!1},i=n.call(a,r)}return o&&(r.exitScope(),this.conductor.stack.pop(),r.scopeVars&&this.conductor.callbackVarsStack.pop()),i}if(t){var s=Object.create(this);if(s.conductor=this.conductor,"o2_cond"in this.args)if(!Tag.validators.RUNNABLE.call(s,this.normalizedArg(this.args.o2_cond))())return 0;var c=s.argsForAction();if(this.isOpen()){s.conductor.stack.push(s);var u=this.getCloseTag();this.conductor.setTag(u)}return t.action.call(s,c)}this.warn("タグハンドラが見つかりません"),this.isOpen()&&this.conductor.setTag(this.getCloseTag(),!0)},Tag.prototype.preload=function(){var e=this.getAction(this.tagName);if(e&&"function"==typeof e.preload){var t=this.validate(this.args);return e.preload.call(this,t)}},Tag.prototype.normalizedArgs=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.args,t=this.getAction(this.tagName);for(var r in e=clone(e)){if(t){var n=t.rules;n&&(r in n||"o2_cond"===r||"*"==r||this.warn(r+"という未知の属性があります"))}if("*"!==r)e[r]=this.normalizedArg(e[r]);else for(var i in window.mp)window.mp.hasOwnProperty(i)&&(e[i]=window.mp[i])}return e},Tag.prototype.normalizedArg=function(t){if("string"!=typeof t)return t;switch(t.charAt(0)){case"&":t=t.substring(1),t=this.eval(t);break;case"%":var e=(t=t.substring(1)).split("|"),r=this.conductor.macroStack[this.conductor.macroStack.length-1];t=void 0!==r.args[e[0]]?r.args[e[0]]:e[1];break;case"$":if(/[\-\+\/\\\*()"'\s|&{:}!=><\[\]\;\?]/.test(t))t=this.eval(t);else{for(var n=(t=t.substring(1)).split("."),i=n[0],o=this.conductor.callbackVarsStack.length-1;0<=o;o--){var a=this.conductor.callbackVarsStack[o];if(i in a){t=a[i],n.shift();break}}o<0?t=void 0:n.forEach(function(e){e in t&&(t=t[e])})}}return t},Tag.prototype.argsForAction=function(){return this.validate(this.normalizedArgs(this.args))},Tag.prototype.validate=function(e){var t=clone(e||{}),r=this.getAction(this.tagName);if(!r)return e;var n=r.rules;if(!n)return e;for(var i in n){var o=this.validateArg(i,e[i]);void 0!==o&&(t[i]=o)}return t},Tag.prototype.validateArg=function(t,e){var r=this.getAction(this.tagName);if(!r)return e;var n=r.rules;if(!n)return e;var i=!!n[t].required,o=n[t];if(i&&void 0===e)throw new Tag.Errors.TagError(this,!1,new Tag.Errors.MissingAttribute(t));if(void 0===e&&"defaultValue"in o&&(e="function"==typeof o.defaultValue?o.defaultValue():o.defaultValue),o.type&&void 0!==e){var a=!1;if("allowString"in o&&"string"==typeof e&&(a=-1!==o.allowString.indexOf(e)),!a)if(o.type in Tag.validators)try{e=Tag.validators[o.type].call(this,e)}catch(e){throw new Tag.Errors.TagError(this,!1,new Tag.Errors.AttributeError(t,e))}else if(o.type instanceof RegExp&&("string"!=typeof e&&(e=String(e)),!o.type.test(e)))throw new Tag.Errors.TagError(this,!1,new Tag.Errors.AttributeError(t,new Tag.Errors.TypeMismatch(o.type.toString())))}return e},Tag.validators={STRING:function(e){return String(e)},BOOLEAN:function(e){if("boolean"==typeof e)return e;if("string"==typeof e){if("true"===e||"1"===e)return!0;if("false"===e||"0"===e)return!1}else if("number"==typeof e){if(0===e)return!1;if(1===e)return!0}throw new Tag.Errors.TypeMismatch("boolean")},INT:function(e){if(isNaN(parseFloat(e))||!isFinite(e))throw new Tag.Errors.TypeMismatch("int");return parseInt(e)},FLOAT:function(e){if(isNaN(parseFloat(e))||!isFinite(e))throw new Tag.Errors.TypeMismatch("float");return parseFloat(e)},LAYER:function(e){if("base"===e)return{fore:o2.foreLayers.baseLayer,back:o2.backLayers.baseLayer};if("object"===(void 0===e?"undefined":_typeof(e))&&e.fore instanceof Layer&&e.back instanceof Layer)return e;try{return Tag.validators.MESSAGE_LAYER(e)}catch(e){}try{return Tag.validators.IMAGE_LAYER(e)}catch(e){}throw new Tag.Errors.LayerNotFound(e)},IMAGE_LAYER:function(e){if("base"===e)return{fore:o2.foreLayers.baseLayer,back:o2.backLayers.baseLayer};if("object"===(void 0===e?"undefined":_typeof(e))&&e.fore instanceof ImageLayer&&e.back instanceof ImageLayer)return e;var t=Number(e);if(isNaN(t))throw new Tag.Errors.TypeMismatch("number");if(!(t in o2.foreLayers.imageLayers))throw new Tag.Errors.ImageLayerNotFound(t);return{fore:o2.foreLayers.imageLayers[t],back:o2.backLayers.imageLayers[t]}},MESSAGE_LAYER:function(e){var t;if(e.toString().match(/^message$/i))return o2.currentMessageLayer;if(t=e.toString().match(/^message(\d+)$/i)){var r=Number(t[1]);if(o2.foreLayers.messageLayers[r])return{fore:o2.foreLayers.messageLayers[r],back:o2.backLayers.messageLayers[r]}}else if("object"===(void 0===e?"undefined":_typeof(e))&&e.fore instanceof MessageLayer&&e.back instanceof MessageLayer)return e;throw new Tag.Errors.MessageLayerNotFound(e)},COLOR:function(e){var t=/0x([0-9a-fA-F]{6})/.exec(e);if(null==t)throw new Tag.Errors.TypeMismatch("color");return"#"+t[1]},TIME:function(e){if("number"==typeof e)return e;if("-1"==e.indexOf(":")){var t=parseFloat(e);if(isNaN(t))throw new Tag.Errors.TypeMismatch("time");return t}var r=e.split(":"),n=0,i=0,o=0,a=0;if(4==r.length)n=parseFloat(r[0]),i=parseFloat(r[1]),o=parseFloat(r[2]),a=r[3];else if(3==r.length)i=parseFloat(r[0]),o=parseFloat(r[1]),a=parseFloat(r[2]);else if(2==r.length)i=parseFloat(r[0]),o=parseFloat(r[1]);else{if(1!=r.length)throw new Tag.Errors.TypeMismatch("time");a=parseFloat(e)/10}if(isNaN(n)||isNaN(i)||isNaN(o)||isNaN(a))throw new Tag.Errors.TypeMismatch("time");return 60*n*60*1e3+60*i*1e3+1e3*o+10*a},OBJECT:function(e){if(null==e||"object"!==(void 0===e?"undefined":_typeof(e)))throw new Tag.Errors.TypeMismatch("object");return e},RUNNABLE:function(e){var t=this;if("function"==typeof e){var r=this.flattenCurrentScope();return function(){e(r)}}if("string"==typeof e)return function(){return t.eval(e)};throw new Tag.Errors.TypeMismatch("stringかfunction")},IMAGE:function(e){var t=Tag.validators.STRING(e);if("data:"===t.substr(0,5))return t;if(t.toLowerCase()in o2.imageList)return t;throw new Tag.Errors.InvalidImageResource(t)},SOUND:function(e){var t=Tag.validators.STRING(e);if(t.toLowerCase()in o2.soundList)return t;throw new Tag.Errors.InvalidSoundResource(t)},VIDEO:function(e){var t=Tag.validators.STRING(e);if(t.toLowerCase()in o2.videoList)return t;throw new Tag.Errors.InvalidVideoResource(t)},FONT:function(e){var t=Tag.validators.STRING(e);if(t.toLowerCase()in o2.fontList)return t;throw new Tag.Errors.InvalidFontResource(t)},SCENARIO:function(e){var t=Tag.validators.STRING(e);if(KAGFiles.isFileExist(t.toLowerCase()))return t;throw new Tag.Errors.InvalidScenarioResource(t)}},Tag.prototype.eval=function(e){var t=this.flattenCurrentScope();return"function"==typeof e?e(t):(e=Object.keys(t).map(function(e){return"var $"+e+" = Tag.tempScopeObj['"+e+"'];"}).join("\n")+e,Tag.tempScopeObj=t,e=(0,eval)(e),delete Tag.tempScopeObj,e)},Tag.actions={},Tag.prototype.done=function(e){e?this.conductor.wait(this,e):this.conductor&&this.conductor.trigger(this)},Tag.prototype.error=function(e,t){var r=new Tag.Errors.TagError(this,t);if(!t)throw r;console.warn(r)},Tag.prototype.warn=function(e){this.error(e,!0)},Tag.prototype.clone=function(){return this},Tag.prototype.toJSON=function(){return config.saveMode==o2.SAVE_MODE_KAG3?{file:this.file.toRestorable(),label:this.args.name,initializer:"Tag"}:this.toRestorable()},Tag.prototype.toRestorable=function(){var e={initializer:"Tag"};return this.file&&(e.file=this.file.toRestorable()),void 0!==this.lineNumber&&(e.line=this.lineNumber),e.file||(e.tagName=this.tagName,e.args=this.args),void 0!==this.originalLineNumber&&(e.originalLineNumber=this.originalLineNumber),this.callbackArgs&&(e.callbackArgs=this.callbackArgs),e},Tag.restore=function(t){return"file"in t&&"line"in t?$.when(t.file.restore()).then(function(e){return e.lines[t.line]}):"file"in t&&"label"in t?$.when(t.file.restore()).then(function(e){return e.getLabelTag(t.label)}):"tagName"in t?new Tag(t.tagName,t.args,t.callbackArgs):(o2.error("タグを復元できない",t),{})},TagAction=function(e){for(var t in this.action=function(){},e)this[t]=e[t]},Tag.Errors={TagError:function(){function n(e,t,r){_classCallCheck(this,n),this.tag=e,this.isWarn=t,this.subError=r}return _createClass(n,[{key:"toString",value:function(){var e="エラー: ";return this.isWarn&&(e="警告: "),this.tag.file&&(e+="ファイル: "+this.tag.file.filename+" / "),void 0!==this.tag.originalLineNumber?e+="行: "+this.tag.originalLineNumber+" / ":void 0!==this.tag.lineNumber&&(e+="行: "+this.tag.lineNumber+" / "),e+="タグ: "+this.tag.tagName+" ",this.subError&&(e+=this.subError.toString()),e}}]),n}(),AttributeError:function(){function r(e,t){_classCallCheck(this,r),this.attribute=e,this.subError=t}return _createClass(r,[{key:"toString",value:function(){return"属性 "+this.attribute+" にエラー："+this.subError.toString()}}]),r}(),TypeMismatch:function(){function t(e){_classCallCheck(this,t),this.expected=e}return _createClass(t,[{key:"toString",value:function(){return this.expected+"型ではありません"}}]),t}(),MissingAttribute:function(){function t(e){_classCallCheck(this,t),this.expected=e}return _createClass(t,[{key:"toString",value:function(){return"必須の属性 "+this.expected+" が指定されていません"}}]),t}(),LayerNotFound:function(){function t(e){_classCallCheck(this,t),this.expected=e}return _createClass(t,[{key:"toString",value:function(){return"指定されたレイヤ"+this.expected+"が見つかりません"}}]),t}(),ImageLayerNotFound:function(){function t(e){_classCallCheck(this,t),this.expected=e}return _createClass(t,[{key:"toString",value:function(){return"イメージレイヤ "+this.expected+" は存在しません"}}]),t}(),MessageLayerNotFound:function(){function t(e){_classCallCheck(this,t),this.expected=e}return _createClass(t,[{key:"toString",value:function(){return"メッセージレイヤ "+this.expected+" は存在しません"}}]),t}(),InvalidImageResource:function(){function t(e){_classCallCheck(this,t),this.expected=e}return _createClass(t,[{key:"toString",value:function(){return"有効な画像リソースではありません"}}]),t}(),InvalidSoundResource:function(){function t(e){_classCallCheck(this,t),this.expected=e}return _createClass(t,[{key:"toString",value:function(){return"有効な音声リソースではありません"}}]),t}(),InvalidVideoResource:function(){function t(e){_classCallCheck(this,t),this.expected=e}return _createClass(t,[{key:"toString",value:function(){return"有効な映像リソースではありません"}}]),t}(),InvalidFontResource:function(){function t(e){_classCallCheck(this,t),this.expected=e}return _createClass(t,[{key:"toString",value:function(){return"有効なフォントリソースではありません"}}]),t}(),InvalidScenarioResource:function(){function t(e){_classCallCheck(this,t),this.expected=e}return _createClass(t,[{key:"toString",value:function(){return"有効なシナリオリソースではありません"}}]),t}()};var DynamicMacroDefinition=function(e){function n(e,t){_classCallCheck(this,n);var r=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,{name:e}));return r.makeTags=t,r.lastArgs={},r}return _inherits(n,MacroDefinition),_createClass(n,[{key:"macroCreated",value:function(e){this.lastArgs=e.args}},{key:"startTag",get:function(){var e=this.makeTags(this.lastArgs);return this.lastArgs={},new n.File(this.name,e).lines[0].toRestorable()},set:function(e){}}]),n}();DynamicMacroDefinition.prototype.initializer="DynamicMacroDefinition",DynamicMacroDefinition.File=function(e){function n(e,t){_classCallCheck(this,n);var r=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,"Dynamic["+e+"]",!0));return r.macroName=e,t.forEach(function(e){return r.lines.push(e)}),r.lines.push(new Tag("endmacro")),r}return _inherits(n,KAGFile),_createClass(n,[{key:"toRestorable",value:function(){var r=this;return{tags:this.lines.map(function(e){e.file=void 0;var t=e.toRestorable();return e.file=r,t}),macroName:this.macroName,initializer:"DynamicMacroDefinition.File"}}}],[{key:"restore",value:function(t){return $.when(t.tags.map(function(e){return e.restore()})).then(function(e){return new DynamicMacroDefinition.File(t.macroName,e)})}}]),n}();var GestureRecognizer=function e(t){for(var r in t)this[r]=t[r];this.state=e.STATE.POSSIBLE,this.mutualExclusive=!0};GestureRecognizer.STATE={NONE:0,POSSIBLE:1,SATISIFIED:2,CANCELLED:3},GestureRecognizer.prototype.start=function(){},GestureRecognizer.prototype.move=function(){},GestureRecognizer.prototype.end=function(){},GestureRecognizer.prototype.cancel=function(){},GestureRecognizer.prototype.satisified=function(){this.manager&&this.manager.satisified(this)},GestureRecognizer.prototype.failed=function(){this.manager&&this.manager.failed(this)},GestureRecognizer.prototype.shouldCancelOtherRecognizer=function(e){return this.mutualExclusive},GestureRecognizer.prototype.shouldBeCancelled=function(e){return!0},GestureRecognizer.accumulateRecognizer=function(o,a,s,c,r){function n(e,t){var r=e.x-u.startLocation.x,n=e.y-u.startLocation.y;if(t){var i=function(e){return 0<=e&&e<=1};if((i(r/o)||i(r/a))&&(i(n/s)||i(n/c)))return!0}return(null==s||s<n)&&(null==c||n<c)&&(null==o||o<r)&&(null==a||r<a)}var u=new GestureRecognizer({startLocation:void 0,start:function(e){var t=e.originalEvent.normalizedCoordinate();u.startLocation=t,u.state=GestureRecognizer.STATE.POSSIBLE},move:function(e){if(u.startLocation){var t=e.originalEvent.normalizedCoordinate();n(t,!0)?n(t)&&(u.satisified(),r(),u.startLocation=void 0):u.cancel()}else u.cancel()},end:function(e){u.startLocation?n(e.originalEvent.normalizedCoordinate())?(u.satisified(),r()):u.cancel():u.cancel()},cancel:function(){u.startLocation=void 0,u.failed()}});return u},GestureRecognizer.basicRecognizer=function(i,o){var a=new GestureRecognizer({startLocation:void 0,start:function(e){a.startLocation=e.originalEvent.normalizedCoordinate(),"absolute"==i?o("start",a.startLocation.x,a.startLocation.y):"delta"==i&&o("start",0,0),a.state=GestureRecognizer.STATE.POSSIBLE},move:function(e){if(a.startLocation){var t=e.originalEvent.normalizedCoordinate(),r=t.x-a.startLocation.x,n=t.y-a.startLocation.y;"absolute"==i?o("move",t.x,t.y):"delta"==i&&o("move",r,n)}},end:function(e){if(a.startLocation){var t=e.originalEvent.normalizedCoordinate(),r=t.x-a.startLocation.x,n=t.y-a.startLocation.y;"absolute"==i?o("end",t.x,t.y):"delta"==i&&o("end",r,n),a.satisified(),a.startLocation=void 0}},cancel:function(){a.startLocation=void 0,a.failed()}});return a};var GestureManager={isProcessingEvent:!(GestureRecognizer.longTapRecognizer=function(t,i,r){var o=new GestureRecognizer({startDate:void 0,startLocation:void 0,timer:void 0,start:function(e){o.startDate=Date.now(),o.startLocation=e.originalEvent.normalizedCoordinate(),o.state=GestureRecognizer.STATE.POSSIBLE,clearTimeout(o.timer),o.timer=setTimeout(function(){o.startDate=void 0,o.startLocation=void 0,o.timer=void 0,o.satisified(),r()},t)},move:function(e){if(o.startLocation){var t=e.originalEvent.normalizedCoordinate(),r=t.x-o.startLocation.x,n=t.y-o.startLocation.y;(i<r||i<n)&&o.cancel()}},end:function(e){o.cancel()},cancel:function(){o.startDate=void 0,o.startLocation=void 0,clearTimeout(o.timer),o.timer=void 0,o.failed()}});return o}),recognizers:[],addRecognizer:function(e){(e.manager=this).recognizers.push(e)},removeRecognizer:function(e){var t=this.recognizers.indexOf(e);-1!=t&&this.recognizers.splice(t,1)},satisified:function(e){e.state=GestureRecognizer.STATE.SATISIFIED;for(var t=0;t<this.recognizers.length;t++){var r=this.recognizers[t];r!=e&&(e.shouldCancelOtherRecognizer(r)&&r.shouldBeCancelled(e)&&r.cancel())}},failed:function(e){e.state=GestureRecognizer.STATE.CANCELLED},resetIfPossible:function(){if(!this.recognizers.filter(function(e){return e.state==GestureRecognizer.STATE.POSSIBLE}).length)for(var e=0;e<this.recognizers.length;e++){this.recognizers[e].state=GestureRecognizer.STATE.NONE}},eventHandlers:{start:function(e){GestureManager.isProcessingEvent=!0;for(var t=GestureManager.recognizers.length-1;0<=t;t--){var r=GestureManager.recognizers[t];r.state!=GestureRecognizer.STATE.CANCELLED&&r.start(e)}GestureManager.isProcessingEvent=!1},move:function(e){GestureManager.isProcessingEvent=!0;for(var t=GestureManager.recognizers.length-1;0<=t;t--){var r=GestureManager.recognizers[t];r.state!=GestureRecognizer.STATE.CANCELLED&&r.move(e)}GestureManager.isProcessingEvent=!1},end:function(e){GestureManager.isProcessingEvent=!0;for(var t=GestureManager.recognizers.length-1;0<=t;t--){var r=GestureManager.recognizers[t];r.state!=GestureRecognizer.STATE.CANCELLED&&r.end(e)}GestureManager.isProcessingEvent=!1,GestureManager.resetIfPossible()},cancel:function(e){GestureManager.isProcessingEvent=!0;for(var t=GestureManager.recognizers.length-1;0<=t;t--){GestureManager.recognizers[t].cancel(e)}GestureManager.isProcessingEvent=!1,GestureManager.resetIfPossible()}}};function setupEventHandlers(){var t,r;$("body").on("touchend",function(){window.scrollTo(0,0),scaleToFitPage()}),$(o2).on("click",function(){o2.autoMode?o2.cancelAutoMode():o2.skipMode>o2.SKIP_MODE_CLICK&&o2.skipMode<=o2.SKIP_MODE_STOP&&(o2.skipMode=o2.SKIP_MODE_NONE),o2.hideGlyph(),currentConductor.trigger("click")}),$("body").on("touchstart mousedown",function(e){GestureManager.eventHandlers.start(e)}).on("touchmove mousemove",function(e){GestureManager.eventHandlers.move(e)}).on("touchend mouseup",function(e){GestureManager.eventHandlers.end(e)}).on("touchcancel mouseleave",function(e){GestureManager.eventHandlers.cancel(e)});var e=new GestureRecognizer({numberOfTouches:0,maxNumberOfTouches:0,common:function(e,t){if(t&&(t.preventDefault(),ev.cursorLocation=t.originalEvent.normalizedCoordinate()),o2.historyLayer.visible)return t&&3==t.which?o2.historyLayer.hide("up",!1):o2.historyLayer[e]&&o2.historyLayer[e](t)?o2.setCursorStyle("pointer"):o2.setCursorStyle("default"),!0;if(t&&3!=t.which)for(var r=o2.foreLayers.messageLayers.length-1;0<=r;r--){var n=o2.foreLayers.messageLayers[r];if(n[e]&&n[e](t))return t.stopImmediatePropagation(),o2.setCursorStyle("pointer"),!0}return o2.setCursorStyle("default"),!1},start:function(e){e.originalEvent.touches&&(this.numberOfTouches=e.originalEvent.touches.length,this.numberOfTouches>this.maxNumberOfTouches&&(this.maxNumberOfTouches=this.numberOfTouches)),this.state=GestureRecognizer.STATE.POSSIBLE,this.common("mousedown",e)},move:function(e){this.common("mousemove",e)},end:function(e){e.originalEvent.touches&&(this.numberOfTouches=e.originalEvent.touches.length),2==this.maxNumberOfTouches&&(e.which=3),this.common("mouseup",e)||0==this.numberOfTouches&&(3==e.which||2==this.maxNumberOfTouches?$(o2).trigger("rclick"):$(o2).trigger("click")),this.numberOfTouches<=0&&(this.numberOfTouches=0,this.maxNumberOfTouches=0,this.state=GestureRecognizer.STATE.CANCELLED)},cancel:function(){this.numberOfTouches=0,this.maxNumberOfTouches=0,this.failed(),this.common("cancel")}});GestureManager.addRecognizer(e);var n=new GestureRecognizer({start:function(e){this.state=GestureRecognizer.STATE.POSSIBLE,e.originalEvent.touches&&3==e.originalEvent.touches.length&&(this.satisified(),o2.historyLayer.visible||o2.skipToStopForcibly())},move:function(e){},end:function(e){e.originalEvent.touches&&e.originalEvent.touches.length<3&&this.state==GestureRecognizer.STATE.SATISIFIED&&(o2.skipMode=o2.SKIP_MODE_NONE),e.originalEvent.touches&&e.originalEvent.touches.length<=0?this.cancel():e.originalEvent.touches||this.cancel()},cancel:function(e){this.failed()}});GestureManager.addRecognizer(n);var i=GestureRecognizer.accumulateRecognizer(-20,20,100,void 0,function(){o2.historyLayer.visible||o2.historyLayer.vertical||o2.historyLayer.touchmoved({x:0,y:30})}),o=GestureRecognizer.accumulateRecognizer(void 0,0,-20,20,function(){!o2.historyLayer.visible&&o2.historyLayer.vertical&&o2.historyLayer.touchmoved({x:-30,y:0})}),a=i.satisified;i.satisified=function(){if(!o2.historyLayer.visible&&!o2.historyLayer.vertical)return a.apply(this,arguments)},o.satisified=function(){if(!o2.historyLayer.visible&&o2.historyLayer.vertical)return a.apply(this,arguments)},GestureManager.addRecognizer(i),GestureManager.addRecognizer(o),i.shouldCancelOtherRecognizer=o.shouldCancelOtherRecognizer=function(e){return e!=s};var s=GestureRecognizer.basicRecognizer("absolute",function(e,t,r){o2.historyLayer.visible&&(s.lastPoint&&o2.historyLayer.touchmoved({x:t-s.lastPoint.x,y:r-s.lastPoint.y}),s.lastPoint="end"==e?void 0:{x:t,y:r})});s.mutualExclusive=!1,GestureManager.addRecognizer(s),$("body").on("keydown",function(e){if("keyCode"in e)switch(e.keyCode){case 37:o2.historyLayer.scrolled({x:30,y:0});break;case 38:o2.historyLayer.scrolled({x:0,y:30});break;case 39:o2.historyLayer.scrolled({x:-30,y:0});break;case 40:o2.historyLayer.visible&&o2.historyLayer.scrolled({x:0,y:-30});break;case 13:r?o2.skipMode||o2.skipToStopForcibly():(r=!0,o2.historyLayer.visible||$(o2).trigger("click"));break;case 17:if(t)return;if(o2.historyLayer.visible)return;t=!0,o2.skipToStopForcibly()}}),$("body").on("keyup",function(e){if("keyCode"in e)switch(e.keyCode){case 17:t=!1,o2.skipMode=o2.SKIP_MODE_NONE;break;case 13:r=!1,o2.skipMode=o2.SKIP_MODE_NONE}}),$("body").on("mousewheel DOMMouseScroll wheel",function(e){e.preventDefault();var t=wheelDistance(e.originalEvent);o2.historyLayer.scrolled(t)}),$("body").on("touchstart touchmove touchend touchcancel",function(e){"button"!=e.target.type&&e.preventDefault()}),$("body").on("contextmenu",function(e){e.preventDefault()})}var HistoryRecord=function(){};HistoryRecord.prototype.toDrawable=function(e,t){return null},HistoryRecord.String=function(e){HistoryRecord.call(this),this.text=e},HistoryRecord.String.prototype=Object.create(HistoryRecord.prototype),HistoryRecord.String.prototype.initializer="HistoryRecord.String",HistoryRecord.String.prototype.toDrawable=function(r){return this.text.split("").map(function(e){var t=new TextProperties(e);return $.extend(t.styles,r.layer.font),t})};var HistoryCell=function(){this.records=[],this.controller=void 0,this.sizeCache=void 0};HistoryCell.prototype={initializer:"HistoryCell",records:[],objectToBeSerialized:function(e){switch(e){case"initializer":case"records":return this[e]}}},HistoryCell.PageBreakPrototype=function(){},HistoryCell.PageBreakPrototype.prototype=Object.create(HistoryCell.prototype),HistoryCell.PageBreakPrototype.prototype.toJSON=function(){return{initializer:"HistoryCell.PageBreakPrototype"}},HistoryCell.PageBreakPrototype.restore=function(){return HistoryCell.PageBreak},HistoryCell.PageBreak=new HistoryCell.PageBreakPrototype;var HistoryCellController=function(e,t){DrawableCanvas.call(this),this.cell=e,this.layer=t,this.needPrepare=!0,this.drawables=[],this.needRedrawChildren=!1,this.prepareDrawables(),this.drawChildren()};HistoryCellController.prototype=Object.create(DrawableCanvas.prototype),HistoryCellController.prototype.prepareDrawables=function(){this.needPrepare=!1;for(var e=[],t=0,r=this.cell.records.length;t<r;t++){var n=this.cell.records[t].toDrawable(this,e);n instanceof Drawable?e.push(n):n instanceof Array&&e.push.apply(e,n)}var i=(this.drawables=e).filter(function(e){return e instanceof TextProperties}),o=new MessageLayer.textCustomizers.baseTextCustomizer(this.layer,[],i);o.timePassed=1/0,o.perform();for(var a=i.length-1;0<=a;a--){var s=i[a];this.layer.vertical?s.rect.x+=this.layer.margin.right:s.rect.x-=this.layer.margin.left,s.rect.y-=this.layer.margin.top}if(this.layer.vertical)for(var c=i.reduce(function(e,t){return Math.min(t.rect.x,e)},1/0),u=0;u<i.length;u++)i[u].rect.x-=c;for(var l=0;l<e.length;l++){var h=e[l];h instanceof Link&&h.refreshRects()}this.cell.sizeCache={width:e.reduce(function(e,t){var r=t.frame();return Math.max(r.x+r.width,e)},0),height:e.reduce(function(e,t){var r=t.frame();return Math.max(r.y+r.height,e)},0)}},HistoryCellController.prototype.mousemove=function(e){var t=!1;if(this.rect.coverCoordinate(e.x,e.y))for(var r=e.x-this.rect.x,n=e.y-this.rect.y,i=0;i<this.drawables.length;i++){var o=this.drawables[i];if(o instanceof Link)o.isHovering(r,n)?(t=!0,o.hovering||(o.hovering=!0,this.needRedrawChildren=!0,this.layer.redrawRect(this.rect))):o.hovering&&(o.hovering=!1,this.needRedrawChildren=!0,this.layer.redrawRect(this.rect));else if(o instanceof Button){var a=o.rect.coverCoordinate(r,n);a&&o.state==Button.STATE_NORMAL?(o.enter(r,n,this),this.needRedrawChildren=!0,this.layer.redrawRect(this.rect)):a||o.state!=Button.STATE_HOVER||(o.leave(r,n,this),this.needRedrawChildren=!0,this.layer.redrawRect(this.rect))}}else for(var s=0;s<this.drawables.length;s++){var c=this.drawables[s];c instanceof Link&&c.hovering?(c.hovering=!1,this.needRedrawChildren=!0,this.layer.redrawRect(this.rect)):c instanceof Button&&c.state==Button.STATE_HOVER&&(c.leave(r,n,this),this.needRedrawChildren=!0,this.layer.redrawRect(this.rect))}return t},HistoryCellController.prototype.mouseup=function(e){var t=!1;if(this.rect.coverCoordinate(e.x,e.y))for(var r=e.x-this.rect.x,n=e.y-this.rect.y,i=0;i<this.drawables.length;i++){var o=this.drawables[i];o instanceof Link?o.isHovering(r,n)&&(t=!0,o.click()):o instanceof Button&&o.rect.coverCoordinate(r,n)&&(t=!0,o.state=Button.STATE_HOVER,o.click())}return t},HistoryCellController.prototype.drawChildren=function(){this.rect.width=this.cell.sizeCache.width,this.rect.height=this.cell.sizeCache.height,this.setRect(),this.ctx.clearRect(0,0,this.rect.width,this.rect.height),this.ctx.textBaseline="top";for(var e=0;e<this.drawables.length;e++){this.drawables[e].drawOnContext(this.ctx)}},HistoryCellController.prototype.drawOnContext=function(e){this.needRedrawChildren&&this.drawChildren(),e.save(),this.drawables.length&&DrawableCanvas.prototype.drawOnContext.apply(this,arguments),e.restore()};var HistoryRecorder=function(e){this.options={enabled:!0,output:!0,repage:config.historyLayerEverypage},this.layer,this.cells=[],this.currentPage=0,this.pageCount=0,this.lineCount=0};HistoryRecorder.prototype.objectToBeSerialized=function(e){switch(e){case"layer":return}if(config.historyLayerStoreState||"cells"!==e&&"pageCount"!==e&&"lineCount"!==e)return this[e]},HistoryRecorder.prototype.importFromSaveData=function(e){this.clearAllRecords(),Object.prototype.importFromSaveData.call(this,e)},HistoryRecorder.prototype.add=function(e){if(this.options.output){if(!(e instanceof HistoryRecord))throw"history recordじゃないです";this.cells.length&&this.cells[this.cells.length-1]!==HistoryCell.PageBreak||this.addCell();var t=this.cells.length-1;this.cells[t].records.push(e),this.lineCount++,this.ensureHistoryLimit()}},HistoryRecorder.prototype.addCell=function(e){if(this.options.output){var t=this.cells.length-1;if(this.cells.length&&!this.cells[t].records.length&&this.cells[t]!=HistoryCell.PageBreak){if(!e)return;this.cells[t].records.push(new HistoryRecord.String(" "))}this.cells.push(new HistoryCell)}},HistoryRecorder.prototype.addPage=function(){if(this.options.output){var e=this.cells.length-1;this.cells[e]&&this.cells[e]!==HistoryCell.PageBreak&&(this.cells[e].records.length?this.cells.push(HistoryCell.PageBreak):(this.cells[e]=HistoryCell.PageBreak,this.addCell()),this.pageCount++,this.ensureHistoryLimit())}},HistoryRecorder.prototype.ensureHistoryLimit=function(){var e=config.historyLayerMaxPages||100,t=config.historyLayerMaxLines||1e3;if(this.pageCount>e){var r=this.cells.indexOf(HistoryCell.PageBreak);this.cells.splice(0,r+1)}if(this.lineCount>t){var n=this.cells.shift();return this.lineCount-=n.records.length,this.cells[0]===HistoryCell.PageBreak&&this.cells.shift(),n}},HistoryRecorder.prototype.clearAllRecords=function(){this.cells=[],this.pageCount=0,this.lineCount=0,this.currentPage=0};var HistoryLayer=function(){var t=this;MessageLayer.call(this),this.frameSolid.opacity=.5,this.visible=!1,this.font.shadow=!1,this.font.edge=!1,this.font.size=36,this.recorder=new HistoryRecorder(this),this.contentOffset={x:0,y:0},this.visibleCellController=[],this.backgroundStay=config.historyLayerFrameFixed,this.animating=!1,this.animationOffset={x:0,y:0},this.animationContentOpacity=1,this.defaultFont.size=config.historyLayerFontHeight,this.defaultFont.face=config.historyLayerFontFace,this.defaultFont.color=config.historyLayerFontColor,this.defaultFont.shadow=config.historyLayerShadow,this.defaultFont.shadowColor=config.historyLayerShadowColor,this.defaultFont.shadowBlur=config.historyLayerShadowBlur,this.defaultFont.shadowOffsetX=config.historyLayerShadowOffsetX,this.defaultFont.shadowOffsetY=config.historyLayerShadowOffsetY,this.defaultFont.bold=config.historyLayerFontBold,this.defaultFont.edge=config.historyLayerEdge,this.defaultFont.edgeColor=config.historyLayerEdgeColor,this.font=clone(this.defaultFont),this.style.lineSize=config.historyLayerLineHeight,this.style.lineSpacing=0,this.frameSolid.color=config.historyLayerColor,this.frameSolid.opacity=config.historyLayerOpacity,config.historyLayerFrame&&ResourceLoader.loadImage(config.historyLayerFrame,!1).done(function(e){return t.frameImage=new DrawableImage(e,0,0)}),this.margin={top:config.historyLayerMarginT,right:config.historyLayerMarginR,bottom:config.historyLayerMarginB,left:config.historyLayerMarginL},setTimeout(function(){return t.setRect({x:config.historyLayerCurrentPositionX,y:config.historyLayerCurrentPositionY,width:config.historyLayerCurrentWidth,height:config.historyLayerCurrentHeight})}),this.resetCursor(),this.originalGlyphShown=!1};HistoryLayer.prototype=Object.create(MessageLayer.prototype),HistoryLayer.prototype.objectToBeSerialized=function(e){switch(e){case"animating":case"textsProperties":case"buttons":case"links":case"images":case"visibleCellController":return;case"recorder":case"contentOffset":return this[e];case"visible":return!1}return MessageLayer.prototype.objectToBeSerialized.call(this,e)},HistoryLayer.prototype.importFromSaveData=function(e){return Layer.prototype.importFromSaveData.call(this,e)},HistoryLayer.prototype.drawOnContext=function(){Layer.prototype.drawOnContext.apply(this,arguments)},HistoryLayer.prototype.reloadVertical=function(){"auto"==config.historyLayerVertical?this.vertical=o2.currentMessageLayer.vertical:"true"==config.historyLayerVertical||1==config.historyLayerVertical?this.vertical=!0:this.vertical=!1,this.resetCursor()},HistoryLayer.prototype.mousemove=function(e){if(!this.visible)return!1;for(var t=!1,r=e.originalEvent.normalizedCoordinate(this),n=0;n<this.visibleCellController.length;n++){this.visibleCellController[n].mousemove(r)&&(t=!0)}return t||(t=MessageLayer.prototype.mousemove.apply(this,arguments)),t},HistoryLayer.prototype.mouseup=function(e){if(!this.visible)return!1;for(var t=!1,r=e.originalEvent.normalizedCoordinate(this),n=0;n<this.visibleCellController.length;n++){this.visibleCellController[n].mouseup(r)&&(t=!0)}return t||(t=MessageLayer.prototype.mouseup.apply(this,arguments)),t},HistoryLayer.prototype.touchmoved=function(e){this.vertical?this.scrolled({x:e.x,y:0}):this.scrolled({x:0,y:e.y})},HistoryLayer.prototype.scrolled=function(t){if(!this.animating){if(this.reloadVertical(),this.vertical){if(!this.visible&&t.x<0){if(!(-1!=["p","l","s"].indexOf(currentConductor.currentTag.tagName)))return;return void this.resetAndShow()}var e=this.visibleCellController[0],r=this.visibleCellController[this.visibleCellController.length-1],n=!0;if(!this.visibleCellController.length||e.rect.x+t.x>this.margin.left||e.rect.x+e.rect.width+t.x<this.margin.left||r.rect.x+r.rect.width+t.x<this.rect.width-this.margin.right||r.rect.x+t.x>this.rect.width-this.margin.right){if(this.visibleCellController.length){if(e.rect.x+t.x>this.margin.left&&0<t.x){var i=this.recorder.cells.indexOf(e.cell),o=this.recorder.cells[i+1];o&&(o.records.length||o==HistoryCell.PageBreak)||(n=!1,this.contentOffset.x=0,this.hide("right",!1)),o&&o===HistoryCell.PageBreak&&(n=!1,this.newerPage("right"))}if(e.rect.x,e.rect.width,t.x,this.margin.left,r.rect.x+r.rect.width+t.x<this.rect.width-this.margin.right&&t.x<0){var a=this.recorder.cells.indexOf(r.cell),s=this.recorder.cells[a-1];if(!s)return n=!1,this.contentOffset.x-=this.rect.width-this.margin.right-(r.rect.x+r.rect.width),void(this.visibleCellController=this.childrenAtContentOffset(this.contentOffset));s&&s===HistoryCell.PageBreak&&(n=!1,this.olderPage("left"))}r.rect.x,t.x,this.rect.width,this.margin.right}n&&(this.contentOffset.x-=t.x,this.visibleCellController=this.childrenAtContentOffset(this.contentOffset))}else this.contentOffset.x-=t.x,this.visibleCellController.forEach(function(e){e.rect.x+=t.x}),renderer.animator.requestFrame()}else{if(!this.visible&&0<t.y){if(!(-1!=["p","l","s"].indexOf(currentConductor.currentTag.tagName)))return;return void this.resetAndShow()}var c=this.visibleCellController[0],u=this.visibleCellController[this.visibleCellController.length-1],l=!0;if(!this.visibleCellController.length||c.rect.y+c.rect.height+t.y<this.rect.height-this.margin.bottom||c.rect.y+t.y>this.rect.height-this.margin.bottom||u.rect.y+t.y>this.margin.top||u.rect.y+u.rect.height+t.y<this.margin.top){if(this.visibleCellController.length){if(c.rect.y+c.rect.height+t.y<this.rect.height-this.margin.bottom&&t.y<0){var h=this.recorder.cells.indexOf(c.cell),f=this.recorder.cells[h+1];f&&(f.records.length||f==HistoryCell.PageBreak)||(l=!1,this.contentOffset.y=0,this.hide("up",!1)),f&&f===HistoryCell.PageBreak&&(l=!1,this.newerPage())}if(c.rect.y,t.y,this.rect.height,this.margin.bottom,u.rect.y+t.y>this.margin.top&&0<t.y){var d=this.recorder.cells.indexOf(u.cell),p=this.recorder.cells[d-1];if(!p)return l=!1,this.contentOffset.y+=this.margin.top-u.rect.y,void(this.visibleCellController=this.childrenAtContentOffset(this.contentOffset));p&&p===HistoryCell.PageBreak&&(l=!1,this.olderPage())}u.rect.y,u.rect.height,t.y,this.margin.top}l&&(this.contentOffset.y+=t.y,this.visibleCellController=this.childrenAtContentOffset(this.contentOffset))}else this.contentOffset.y+=t.y,this.visibleCellController.forEach(function(e){e.rect.y+=t.y}),renderer.animator.requestFrame()}this.redrawRect()}},HistoryLayer.prototype.scrollToPageEnd=function(){this.scrolled({x:-this.contentOffset.x,y:-this.contentOffset.y}),this.redrawRect()},HistoryLayer.prototype.show=function(e,r){o2.skipMode=o2.SKIP_MODE_NONE,o2.cancelAutoMode(),void 0===r&&(r=this.backgroundStay),this.reloadVertical();var n=$.Deferred();if(this.animating||!this.recorder.options.enabled||!this.recorder.cells.length)return n.reject(),n.promise();this.animating=!0,this.visible=!0;var i=this,o=Date.now(),a=config.historyLayerCurrentPositionX,s=config.historyLayerCurrentPositionY,c=0,u=300;switch(e){case"left":c=300,u=0;break;case"right":c=-300,u=0;break;case"down":u=-300,c=0}r?this.animationContentOpacity=0:this.opacity=0;var l=new KeySpline(.08,.44,.42,.93);return renderer.animator.requestFrame(function e(){var t=(Date.now()-o)/500;1<=t?(t=1,i.animating=!1,n.resolve()):renderer.animator.requestFrame(e),t=l.get(t),r?(i.animationContentOpacity=t,i.animationOffset.x=c*(1-t),i.animationOffset.y=u*(1-t),i.redrawRect()):(i.opacity=t,i.rect.x=a+c*(1-t),i.rect.y=s+u*(1-t))}),this.redrawRect(),n.promise()},HistoryLayer.prototype.resetAndShow=function(){return this.scrollToPageEnd(),this.vertical?(this.contentOffset.x=0,this.visibleCellController=this.childrenAtContentOffset(this.contentOffset),this.show("left",!1)):(this.contentOffset.y=0,this.visibleCellController=this.childrenAtContentOffset(this.contentOffset),this.show("down",!1))},HistoryLayer.prototype.hide=function(e,r){void 0===r&&(r=this.backgroundStay),this.animating=!0;var n=this,i=Date.now(),o=this.rect.x,a=this.rect.y,s=this.vertical?300:0,c=this.vertical?0:-300;switch(e){case"left":s=-300,c=0;break;case"right":s=300,c=0;break;case"down":c=300,s=0}var u=$.Deferred(),l=new KeySpline(.45,0,.97,.65);return renderer.animator.requestFrame(function e(){var t=(Date.now()-i)/500;if(1<=t)return t=1,n.animating=!1,n.visible=!1,n.textsProperties=[],r?(n.animationContentOpacity=1,n.animationOffset.x=0,n.animationOffset.y=0,n.redrawRect()):(n.rect.x=o,n.rect.y=a,n.opacity=0),void u.resolve();renderer.animator.requestFrame(e),t=l.get(t),r?(n.animationContentOpacity=1-t,n.animationOffset.x=s*t,n.animationOffset.y=c*t,n.redrawRect()):(n.opacity=1-t,n.rect.x=o+s*t,n.rect.y=a+c*t)}),this.redrawRect(),u.promise()},function(){function e(o){return function(e,t,r){if(e instanceof HistoryCell&&(e=this.recorder.cells.indexOf(e)),void 0===t?t=this.recorder.cells.length-1:t instanceof HistoryCell&&(t=this.recorder.cells.indexOf(t)),t<e)throw"start cannot be larger than end";if(!this.recorder.cells[e]||!this.recorder.cells[t])throw"statr or end doesnt exist";for(var n=0,i=e;i<=t;i++)i==e&&r||i==t&&r||(n+=this.recorder.cells[i].sizeCache[o]);return n}}HistoryLayer.prototype.heightBetweenCells=e("height"),HistoryLayer.prototype.widthBetweenCells=e("width")}(),HistoryLayer.prototype.olderPage=function(e){e||(e="down");var t=this;if(this.vertical){var r=this.visibleCellController[this.visibleCellController.length-1].cell,n=this.widthBetweenCells(r);this.hide(e).done(function(){t.contentOffset.x=n,t.visibleCellController=t.childrenAtContentOffset(t.contentOffset),t.show(e)})}else{var i=this.visibleCellController[this.visibleCellController.length-1].cell,o=this.heightBetweenCells(i);this.hide(e).done(function(){t.contentOffset.y=o,t.visibleCellController=t.childrenAtContentOffset(t.contentOffset),t.show(e)})}},HistoryLayer.prototype.newerPage=function(e){e||(e="up");var t=this,r=t.visibleCellController[0],n=this.recorder.cells.indexOf(r.cell)+2;if(this.vertical){for(var i=this.widthBetweenCells(n)-(this.rect.width-this.margin.left-this.margin.right),o=n;o<this.recorder.cells.length&&this.recorder.cells[o]!=HistoryCell.PageBreak;o++)n=o;var a=this.widthBetweenCells(n),s=Math.max(a,i);this.hide(e).done(function(){t.contentOffset.x=s,t.visibleCellController=t.childrenAtContentOffset(t.contentOffset),t.show(e)})}else{for(var c=this.heightBetweenCells(n)-(this.rect.height-this.margin.top-this.margin.bottom),u=n;u<this.recorder.cells.length&&this.recorder.cells[u]!=HistoryCell.PageBreak;u++)n=u;var l=this.heightBetweenCells(n),h=Math.max(l,c);this.hide(e).done(function(){t.contentOffset.y=h,t.visibleCellController=t.childrenAtContentOffset(t.contentOffset),t.show(e)})}},HistoryLayer.prototype.children=function(){return MessageLayer.prototype.children.apply(this,arguments).concat(this.visibleCellController)},HistoryLayer.prototype.childrenAtContentOffset=function(e){if(e||(e=this.contentOffset),this.vertical){for(var t=0,r=[],n=!1,i=this.recorder.cells.length-1;0<=i;i--){var o=this.recorder.cells[i];if(o.sizeCache&&0!=o.sizeCache.width||(o.controller=new HistoryCellController(o,this)),(t+=o.sizeCache.width)>e.x&&t-o.sizeCache.width<this.rect.width-this.margin.right-this.margin.left+e.x){if(o.controller||(o.controller=new HistoryCellController(o,this)),o.controller.rect=new Rect({x:this.margin.left+(t-o.sizeCache.width)-e.x,y:this.margin.top,width:o.sizeCache.width,height:o.sizeCache.height}),o!=HistoryCell.PageBreak)r.push(o.controller);else if(r.length){n=!(o.controller=null);break}}else o.controller&&(o.controller=null)}if(!n&&r.length&&r[r.length-1].rect.x+r[r.length-1].rect.width<this.rect.width-this.margin.right&&(n=!0),n){var a=r[r.length-1],s=this.rect.width-this.margin.right-(a.rect.x+a.rect.width);r.forEach(function(e){e.rect.x+=s})}return r}for(var c=0,u=[],l=!1,h=this.recorder.cells.length-1;0<=h;h--){var f=this.recorder.cells[h];if(f.sizeCache&&0!=f.sizeCache.height||(f.controller=new HistoryCellController(f,this)),(c+=f.sizeCache.height)>e.y&&c-f.sizeCache.height<this.rect.height-this.margin.top-this.margin.bottom+e.y){if(f.controller||(f.controller=new HistoryCellController(f,this)),f.controller.rect=new Rect({x:this.margin.left,y:this.rect.height-this.margin.bottom-c+e.y,width:f.sizeCache.width,height:f.sizeCache.height}),f==HistoryCell.PageBreak){l=!(f.controller=null);break}u.push(f.controller)}else f.controller&&(f.controller=null)}if(!l&&u.length&&u[u.length-1].rect.y>this.margin.top&&(l=!0),l){var d=u[u.length-1].rect.y-this.margin.top;u.forEach(function(e){e.rect.y-=d})}return u},HistoryLayer.prototype.flush=function(){if(this.requestedFrame){this.requestedFrame=!1,this.stackedClearRect=new Rect,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.backgroundStay||this.ctx.translate(this.animationOffset.x,this.animationOffset.y);for(var e=this.children(),t=0;t<e.length;t++){var r=e[t];if(-1!=this.visibleCellController.indexOf(r))break;r.drawOnContext(this.ctx)}for(this.backgroundStay&&(this.ctx.translate(this.animationOffset.x,this.animationOffset.y),this.ctx.globalAlpha=this.animationContentOpacity),this.ctx.beginPath(),this.ctx.rect(this.margin.left,this.margin.top,this.rect.width-this.margin.left-this.margin.right,this.rect.height-this.margin.top-this.margin.bottom),this.ctx.clip();t<e.length;){e[t].drawOnContext(this.ctx),t++}this.ctx.restore(),this.resetCursor()}};var AnimationConductor=function(e){Conductor.call(this,e),this.layer,this.cellImage,this.canvas,this.isLooping=!1,e&&(this.startingLabelName=e.label),this.nextTagTime,this.shouldStop};AnimationConductor.prototype=Object.create(Conductor.prototype),AnimationConductor.prototype.initializer="AnimationConductor",AnimationConductor.prototype.importFrom=function(e){var t=this;if(this.waitTag=clone(e.waitTag),this.setTag(e.currentTag),this.queue=clone(e.queue),this.status=e.status,this.callStack=clone(e.callStack),this.macroStack=clone(e.macroStack),this.macros=clone(e.macros),this.ifStack=clone(e.ifStack),this.layer=e.layer,e.cellImage&&(this.cellImage=clone(e.cellImage)),e.canvas&&(this.canvas=clone(e.canvas)),this.shouldStop=e.shouldStop,e.status!=Conductor.STATUS_STOP)if("wait"==e.currentTag.tagName){this.currentTag=e.currentTag,this.setTag(e.currentTag,!0);var r=(e.nextTagTime||Date.now())-Date.now();setTimeout(function(){return t.run()},r)}else this.run()},AnimationConductor.prototype.toJSON=function(){if(this.layer&&0==this.layer.animationConductors.indexOf(this)||!this.canvas||this.isLooping)return{initializer:"AnimationConductor",file:this.file.filename,lineNumber:0,startingLabelName:this.startingLabelName}},AnimationConductor.restore=function(t){return $.when(KAGFiles(t.file)).then(function(e){return new AnimationConductor({file:e,label:t.startingLabelName})})},AnimationConductor.prototype.run=function(){var e=o2.debugLevel;o2.debugLevel=0,Conductor.prototype.run.apply(this,arguments),o2.debugLevel=e},AnimationConductor.prototype.addChildToLayer=function(){return!!this.canvas&&(-1==this.layer.animationChildren.indexOf(this.canvas)&&this.layer.animationChildren.push(this.canvas),!0)},AnimationConductor.prototype.removeChildFromLayer=function(){var e=this.layer.animationChildren.indexOf(this.canvas);0<=e&&this.layer.animationChildren.splice(e,1)},AnimationConductor.prototype.wait=function(e,t){Conductor.prototype.wait.call(this,e)},AnimationConductor.prototype.stop=function(){this.removeChildFromLayer(),this.status!==Conductor.STATUS_STOP&&this.queue.push(new Tag("s"))},AnimationConductor.prototype.stopUntilHome=function(){this.shouldStop=!0},AnimationConductor.prototype.getTagAction=function(e){return AnimationConductor.tagActions||(AnimationConductor.tagActions={loadcell:new TagAction({rules:{storage:{type:"STRING"}},action:function(e){var t,r,n=this;try{r=this.conductor.layer.images[0],t=e.storage||r.image.originalURL+"_a"}catch(e){this.error("レイヤは画像がないです。")}return ResourceLoader.loadImage(t,!1).done(function(t){setTimeout(function(){var e=new DrawableImage(t,0,0);e.cacheEnabled=!1,e.reuseCanvas=!0,n.conductor.cellImage=e,n.conductor.canvas=new DrawableCanvas(r.rect),n.done()})}),1}}),copy:new TagAction({rules:{dx:{type:"INT",required:!0},dy:{type:"INT",required:!0},sx:{type:"INT",required:!0},sy:{type:"INT",required:!0},sw:{type:"INT",required:!0},sh:{type:"INT",required:!0}},action:function(e){this.conductor.addChildToLayer()||this.error("loadcellしていない状態でcopyタグを使おうとしてます");var t=this.conductor.canvas,r=t.canvas.getContext("2d"),n=this.conductor.cellImage;return n.options.clipLeft=e.sx,n.options.clipTop=e.sy,n.options.clipWidth=e.sw,n.options.clipHeight=e.sh,n.rect=new Rect({x:e.dx,y:e.dy,width:e.sw,height:e.sh}),t.ctx.clearRect(n.rect.x,n.rect.y,n.rect.width,n.rect.height),n.drawOnContext(r),this.conductor.layer.redrawRect(this.conductor.canvas.rect),0}}),clip:new TagAction({rules:{left:{type:"INT",required:!0},top:{type:"INT",required:!0}},action:function(e){if(!this.conductor.layer.images[0])return 0;var t=this.conductor.layer.images[0];return t.options.clipLeft=e.left,t.options.clipTop=e.top,t.cacheEnabled=!1,t.cacheCanvas=void 0,this.conductor.layer.redrawRect(t.rect),0}}),wait:new TagAction({rules:{time:{type:"INT",required:!0}},action:function(e){var t=this;return this.conductor.nextTagTime=Date.now()+e.time,setTimeout(function(){delete t.conductor.nextTagTime,t.done()},e.time),1}}),label:new TagAction({rules:{name:{type:"STRING"}},action:function(e){return 0}}),loop:new TagAction({action:function(){return this.conductor.isLooping=!0,0}}),home:new TagAction({action:function(){return this.conductor.shouldStop?2:0}}),s:new TagAction({action:function(){return 2}})},["jump","macro","endmacro","erasemacro","if","else","elsif","endif","ignore","endignore","eval","o2_iscript"].forEach(function(e){AnimationConductor.tagActions[e]=Tag.actions[e]})),AnimationConductor.tagActions[e]||Conductor.prototype.getTagAction.apply(this,arguments)},Tag.actions.s=new TagAction({action:function(){return this.conductor!=conductor&&this.conductor!=extraConductor||(o2.skipMode=o2.SKIP_MODE_NONE,o2.reloadDelaySpeed()),2}}),function(){var u=["text","ch","hch","emb","ruby"];Tag.actions.text=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(e){var t=this,r=this.conductor.getNextTag();if(o2.currentMessageLayer.stackedTextsProperties||(o2.currentMessageLayer.stackedTextsProperties=[]),e.text.split("").forEach(function(e){var t=new TextProperties(e);$.extend(t.styles,clone(o2.currentMessageLayer.font)),o2.currentMessageLayer.currentRubyText&&(t.rubyText=o2.currentMessageLayer.currentRubyText,delete o2.currentMessageLayer.currentRubyText),o2.currentMessageLayer.stackedTextsProperties.push(t)}),r&&-1!=u.indexOf(r.tagName))return 0;function n(){o2.skipMode=o2.SKIP_MODE_CLICK,$(o2).off("click",n)}var i=new HistoryRecord.String(o2.currentMessageLayer.stackedTextsProperties.map(function(e){return e.text}).join(""));o2.historyLayer.recorder.add(i);var o=!1,a=!1,s=function(){o&&a&&($(o2).off("click",n),t.done())};if(o2.currentMessageLayerWithBack){var c=clone(o2.currentMessageLayer.stackedTextsProperties);o2.currentMessageLayer.getCorrespondingLayer().drawText(c,function(){a=!0,s()})}else a=!0;return o2.currentMessageLayer.drawText(o2.currentMessageLayer.stackedTextsProperties,function(){o=!0,s()}),delete o2.currentMessageLayer.stackedTextsProperties,o2.clickSkipEnabled&&$(o2).on("click",n),1}}),Tag.actions.ch=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(e){var t=this.conductor.getNextTag();o2.currentMessageLayer.stackedTextsProperties||(o2.currentMessageLayer.stackedTextsProperties=[]);var r=new TextProperties(e.text);if($.extend(r.styles,clone(o2.currentMessageLayer.font)),o2.currentMessageLayer.currentRubyText&&(r.rubyText=o2.currentMessageLayer.currentRubyText,delete o2.currentMessageLayer.currentRubyText),o2.currentMessageLayer.stackedTextsProperties.push(r),t&&-1!=u.indexOf(t.tagName))return 0;var n=new HistoryRecord.String(o2.currentMessageLayer.stackedTextsProperties.map(function(e){return e.text}).join(""));o2.historyLayer.recorder.add(n);var i=this;(o2.currentMessageLayer.drawText(o2.currentMessageLayer.stackedTextsProperties,function(){i.done()}),o2.currentMessageLayerWithBack)&&o2.currentMessageLayer.getCorrespondingLayer().drawText(clone(o2.currentMessageLayer.stackedTextsProperties));return delete o2.currentMessageLayer.stackedTextsProperties,1}}),Tag.actions.hch=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(e){o2.currentMessageLayer.vertical||this.warn("hchタグは縦書きの状態でしか実行できません");var t=this.conductor.getNextTag();o2.currentMessageLayer.stackedTextsProperties||(o2.currentMessageLayer.stackedTextsProperties=[]);var r=new TextProperties(e.text);if($.extend(r.styles,clone(o2.currentMessageLayer.font)),r.styles.vertical=!1,o2.currentMessageLayer.currentRubyText&&(r.rubyText=o2.currentMessageLayer.currentRubyText,delete o2.currentMessageLayer.currentRubyText),o2.currentMessageLayer.stackedTextsProperties.push(r),t&&-1!=u.indexOf(t.tagName))return 0;var n=new HistoryRecord.String(o2.currentMessageLayer.stackedTextsProperties.map(function(e){return e.text}).join(""));o2.historyLayer.recorder.add(n);var i=this;(o2.currentMessageLayer.drawText(o2.currentMessageLayer.stackedTextsProperties,function(){i.done()}),o2.currentMessageLayerWithBack)&&o2.currentMessageLayer.getCorrespondingLayer().drawText(clone(o2.currentMessageLayer.stackedTextsProperties));return delete o2.currentMessageLayer.stackedTextsProperties,1}}),Tag.actions.emb=new TagAction({rules:{o2_exp:{type:"RUNNABLE",required:!0}},action:function(e){var t=e.o2_exp(),r=new Tag("text",{text:t});return this.conductor.queue.push(r),0}})}(),Tag.actions.ruby=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(e){return o2.currentMessageLayer.currentRubyText=e.text,o2.currentMessageLayerWithBack&&(o2.currentMessageLayer.getCorrespondingLayer().currentRubyText=e.text),0}}),Tag.actions.cm=new TagAction({action:function(e){for(var t=o2.foreLayers.messageLayers.concat(o2.backLayers.messageLayers),r=t.length-1;0<=r;r--){t[r].resetMessageLayer()}return o2.historyLayer.recorder.options.repage&&o2.historyLayer.recorder.addPage(),0}}),Tag.actions.ct=new TagAction({action:function(e){return new Tag("cm").run(),o2.currentMessageLayer=o2.foreLayers.messageLayers[0],o2.currentMessageLayerWithBack=!1,o2.historyLayer.recorder.options.repage&&o2.historyLayer.recorder.addPage(),0}}),Tag.actions.er=new TagAction({action:function(e){return o2.currentMessageLayer.resetMessageLayer(),o2.currentMessageLayerWithBack&&o2.currentMessageLayer.getCorrespondingLayer().resetMessageLayer(),o2.historyLayer.recorder.options.repage&&o2.historyLayer.recorder.addPage(),0}}),Tag.actions.current=new TagAction({rules:{layer:{type:"MESSAGE_LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},withback:{type:"BOOLEAN"}},action:function(e){var t=e.layer[e.page];return o2.currentMessageLayer=t,"withback"in e&&(o2.currentMessageLayerWithBack=e.withback),0}}),Tag.actions.position=new TagAction({rules:{layer:{type:"MESSAGE_LAYER"},page:{type:/fore|back/},left:{type:"INT"},top:{type:"INT"},width:{type:"INT"},height:{type:"INT"},frame:{type:"STRING"},color:{type:"COLOR"},opacity:{type:"FLOAT"},marginl:{type:"INT"},margint:{type:"INT"},marginr:{type:"INT"},marginb:{type:"INT"},vertical:{type:"BOOLEAN"},visible:{type:"BOOLEAN"}},action:function(e){var r,t=!1,n=clone((r=e.layer&&e.page?e.layer[e.page]:o2.currentMessageLayer).rect);if("left"in e&&(n.x=e.left),"top"in e&&(n.y=e.top),"width"in e&&(n.width=e.width),"height"in e&&(n.height=e.height),r.setRect(n),"frame"in e)if(""===e.frame)r.setFrameImage();else{var i=this;ResourceLoader.loadImage(e.frame,!0).done(function(e){var t=new DrawableImage(e);r.setFrameImage(t)}).always(function(){setTimeout(function(){renderer.animator.requestFrame(),"visible"in e&&r.visible!=e.visible&&(r.visible=e.visible),i.done()})}),t=!0}return"color"in e&&(r.frameSolid.color=e.color),"opacity"in e&&(r.frameSolid.opacity=e.opacity/255),"marginl"in e&&(r.margin.left=e.marginl),"margint"in e&&(r.margin.top=e.margint),"marginr"in e&&(r.margin.right=e.marginr),"marginb"in e&&(r.margin.bottom=e.marginb),"vertical"in e&&(r.vertical=e.vertical),r.resetMessageLayer(),t?1:("visible"in e&&r.visible!=e.visible&&(r.visible=e.visible),renderer.animator.requestFrame(),0)}}),Tag.actions.delay=new TagAction({rules:{speed:{type:"INT",required:!0,allowString:["user","nowait"]}},action:function(e){"nowait"===e.speed?(sf.__system.chSpeed=0,sf.__system.useUserChSpeed=!1):"user"===e.speed?sf.__system.useUserChSpeed=!0:(sf.__system.chSpeed=parseFloat(e.speed),sf.__system.useUserChSpeed=!1),o2.reloadDelaySpeed()}}),Tag.actions.wc=new TagAction({rules:{time:{type:"INT",required:!0}},action:function(e){var t=e.time*o2.currentMessageLayer.delaySpeed,r=this;return setTimeout(function(){r.done()},t),1}}),function(){var e=void 0;Tag.actions.nowait=new TagAction({action:function(){return e=o2.currentMessageLayer.delaySpeed,o2.currentMessageLayer.delaySpeed=0}}),Tag.actions.endnowait=new TagAction({action:function(){return o2.currentMessageLayer.delaySpeed=e,0}})}(),Tag.actions.deffont=new TagAction({rules:{size:{type:"INT"},face:{type:"FONT"},color:{type:"COLOR"},rubysize:{type:"INT"},rubyoffset:{type:"INT"},edge:{type:"BOOLEAN"},edgecolor:{type:"COLOR"},bold:{type:"BOOLEAN"},o2_shadow:{type:"BOOLEAN"},o2_shadowcolor:{type:"COLOR"},o2_shadowblur:{type:"INT"},o2_shadowoffsetx:{type:"INT"},o2_shadowoffsety:{type:"INT"}},action:function(e){var t=o2.currentMessageLayer,r={rubysize:"rubySize",rubyoffset:"rubyOffset",edgecolor:"edgeColor",shadowcolor:"shadowColor",o2_shadow:"shadow",o2_shadowcolor:"shadowColor",o2_shadowblur:"shadowBlur",o2_shadowoffsetx:"shadowOffsetX",o2_shadowoffsety:"shadowOffsetY"};for(var n in e){var i=r[n]||n;t.defaultFont[i]=e[n],o2.currentMessageLayerWithBack&&(t.getCorrespondingLayer().defaultFont[i]=e[n])}if(e.face){var o=this;return ResourceLoader.loadFont(e.face,!0).always(function(){setTimeout(function(){o.done()})}),1}return 0}}),Tag.actions.font=new TagAction({rules:{size:{type:"INT",allowString:["default"]},face:{type:"FONT"},color:{type:"COLOR",allowString:["default"]},italic:{type:"BOOLEAN",allowString:["default"]},rubysize:{type:"INT",allowString:["default"]},rubyoffset:{type:"INT",allowString:["default"]},edge:{type:"BOOLEAN",allowString:["default"]},edgecolor:{type:"COLOR",allowString:["default"]},bold:{type:"BOOLEAN",allowString:["default"]},o2_shadow:{type:"BOOLEAN"},o2_shadowcolor:{type:"COLOR"},o2_shadowblur:{type:"INT"},o2_shadowoffsetx:{type:"INT"},o2_shadowoffsety:{type:"INT"}},action:function(e){var t={rubysize:"rubySize",rubyoffset:"rubyOffset",edgecolor:"edgeColor",shadowcolor:"shadowColor",o2_shadow:"shadow",o2_shadowcolor:"shadowColor",o2_shadowblur:"shadowBlur",o2_shadowoffsetx:"shadowOffsetX",o2_shadowoffsety:"shadowOffsetY"};for(var r in e){var n=t[r]||r;"default"===e[r]&&(e[r]=o2.currentMessageLayer.deffont[n]),o2.currentMessageLayer.font[n]=e[r],o2.currentMessageLayerWithBack&&(o2.currentMessageLayer.getCorrespondingLayer().font[n]=e[r])}if(e.face){var i=this;return ResourceLoader.loadFont(e.face,!0).always(function(){setTimeout(function(){i.done()})}),1}return 0}}),Tag.actions.resetfont=new TagAction({action:function(e){if(o2.currentMessageLayer.font=clone(o2.currentMessageLayer.defaultFont),o2.currentMessageLayerWithBack){var t=o2.currentMessageLayer.getCorrespondingLayer();t.font=clone(t.defaultFont)}}}),Tag.actions.defstyle=new TagAction({rules:{linespacing:{type:"INT"},pitch:{type:"INT"},linesize:{type:"INT"},o2_kinsoku:{type:/none|oidashi|burasagari-oidashi/},o2_kinsoku_bol_char:{type:"STRING"},o2_kinsoku_eol_char:{type:"STRING"},o2_kinsoku_burasagari_char:{type:"STRING"}},action:function(e){var t={linespacing:"lineSpacing",linesize:"lineSize",o2_kinsoku:"kinsoku",o2_kinsoku_bol_char:"kinsokuBolChar",o2_kinsoku_eol_char:"kinsokuEolChar",o2_kinsoku_burasagari_char:"kinsokuBurasagariChar",toback:{type:"BOOLEAN"}};if(o2.currentMessageLayerWithBack&&!e.toback){var r=clone(e);r.toback=!0;var n=new Tag("defstyle",r);this.conductor.queue.push(n)}var i=o2.currentMessageLayer;for(var o in e.toback&&(i=i.getCorrespondingLayer()),e){var a=t[o]||o;i.defaultStyle[a]=e[o]}if("o2_kinsoku"in e)switch(e.o2_kinsoku){case"none":i.defaultStyle.kinsoku=MessageLayer.KINSOKU_NONE;break;case"oidashi":i.defaultStyle.kinsoku=MessageLayer.KINSOKU_OIDASHI;break;case"burasagari-oidashi":i.defaultStyle.kinsoku=MessageLayer.KINSOKU_BURASAGARI}return 0}}),Tag.actions.style=new TagAction({rules:{align:{type:/left|center|right|top|center|bottom|default/},linespacing:{type:"INT"},pitch:{type:"INT"},linesize:{type:"INT",allowString:["default"]},autoreturn:{type:"BOOLEAN",allowString:["default"]},o2_kinsoku:{type:/none|oidashi|burasagari-oidashi/},o2_kinsoku_bol_char:{type:"STRING"},o2_kinsoku_eol_char:{type:"STRING"},o2_kinsoku_burasagari_char:{type:"STRING"},toback:{type:"BOOLEAN"}},action:function(e){if(o2.currentMessageLayerWithBack&&!e.toback){var t=clone(e);t.toback=!0;var r=new Tag("style",t);this.conductor.queue.push(r)}var n=o2.currentMessageLayer;e.toback&&(n=n.getCorrespondingLayer()),"align"in e&&("default"==e.align?n.vertical?n.style.align="top":n.style.align="left":n.style.align=e.align),"linespacing"in e&&(n.vertical?n.textCursor.x-=e.linespacing-n.style.lineSpacing:n.textCursor.y+=e.linespacing-n.style.lineSpacing,n.style.lineSpacing=e.linespacing),"pitch"in e&&(n.style.pitch=e.pitch),"linesize"in e&&("default"==e.linesize?n.style.lineSize=-1:n.style.lineSize=e.linesize),"autoreturn"in e&&("default"==e.autoreturn&&(e.autoreturn=n.defaultStyle.autoReturn),n.style.autoReturn=e.autoreturn);var i={o2_kinsoku_bol_char:"kinsokuBolChar",o2_kinsoku_eol_char:"kinsokuEolChar",o2_kinsoku_burasagari_char:"kinsokuBurasagariChar"};for(var o in e)o in i&&(n.style[i[o]]=e[o]);if("o2_kinsoku"in e)switch(e.o2_kinsoku){case"none":n.style.kinsoku=MessageLayer.KINSOKU_NONE;break;case"oidashi":n.style.kinsoku=MessageLayer.KINSOKU_OIDASHI;break;case"burasagari-oidashi":n.style.kinsoku=MessageLayer.KINSOKU_BURASAGARI}}}),Tag.actions.resetstyle=new TagAction({rules:{toback:{type:"BOOLEAN"}},action:function(e){if(o2.currentMessageLayerWithBack&&!e.toback){var t=clone(e);t.toback=!0;var r=new Tag("resetstyle",t);this.conductor.queue.push(r)}var n=o2.currentMessageLayer;e.toback&&(n=n.getCorrespondingLayer()),n.vertical?n.textCursor.x-=o2.currentMessageLayer.defaultStyle.lineSpacing-o2.currentMessageLayer.style.lineSpacing:n.textCursor.y+=o2.currentMessageLayer.defaultStyle.lineSpacing-o2.currentMessageLayer.style.lineSpacing,n.style=clone(n.defaultStyle)}}),Tag.actions.locate=new TagAction({rules:{x:{type:"INT"},y:{type:"INT"},toback:{type:"BOOLEAN"}},action:function(e){if(o2.currentMessageLayerWithBack&&!e.toback){var t=clone(e);t.toback=!0;var r=new Tag("locate",t);this.conductor.queue.push(r)}var n=o2.currentMessageLayer;return e.toback&&(n=n.getCorrespondingLayer()),"x"in e&&(n.textCursor.x=e.x+n.margin.left,n.vertical&&(n.textCursor.x-=n.style.lineSpacing)),"y"in e&&(n.textCursor.y=e.y+n.margin.top,n.vertical||(n.textCursor.y+=n.style.lineSpacing)),0}}),Tag.actions.r=new TagAction({action:function(){return o2.currentMessageLayer.linebreak(),o2.currentMessageLayerWithBack&&o2.currentMessageLayer.getCorrespondingLayer().linebreak(),o2.historyLayer.recorder.addCell(!0),0}}),function(){var r=void 0;Tag.actions.indent=new TagAction({action:function(){var e=o2.currentMessageLayer;return e.margin.vertical?(r=e.margin.top,e.margin.top=e.textCursor.y):(r=e.margin.left,e.margin.left=e.textCursor.x),0}}),Tag.actions.endindent=new TagAction({action:function(){var e=o2.currentMessageLayer,t=e.margin.vertical;return void 0===r&&o2.error("indentタグを先に実行してください"),t?e.margin.top=r:e.margin.left=r,0}})}(),Tag.actions.p=new TagAction({action:function(e){if(o2.historyLayer.recorder.addCell(!0),o2.autoMode){var t=this,r=o2.cancelAutoMode,n=setTimeout(function(){t.conductor===currentConductor&&(o2.cancelAutoMode=r,t.done())},sf.__system.autoModePageWait);return o2.cancelAutoMode=function(){return clearTimeout(n),t.conductor.wait("click"),(o2.cancelAutoMode=r).apply(this,arguments)},1}return o2.skipMode<=o2.SKIP_MODE_PAGE&&(o2.skipMode=o2.SKIP_MODE_NONE),o2.skipMode?0:(o2.showGlyph("page"),this.conductor.wait("click",function(){o2.hideGlyph()}),1)}}),Tag.actions.l=new TagAction({action:function(){var e=this.conductor.isCurrentRead();if(config.chNonStopToPageBreak||config.ch2ndNonStopToPageBreak&&e)return 0;if(o2.autoMode){var t=this,r=o2.cancelAutoMode,n=setTimeout(function(){t.conductor===currentConductor&&(o2.cancelAutoMode=r,t.done())},sf.__system.autoModeLineWait);return o2.cancelAutoMode=function(){return clearTimeout(n),o2.showGlyph("line"),t.conductor.wait("click"),(o2.cancelAutoMode=r).apply(this,arguments)},1}return o2.skipMode<=o2.SKIP_MODE_CLICK&&(o2.skipMode=o2.SKIP_MODE_NONE),o2.skipMode?0:(o2.showGlyph("line"),this.conductor.wait("click",function(){o2.hideGlyph()}),1)}}),Tag.actions.button=new TagAction({rules:{graphic:{type:"IMAGE",required:!0},graphickey:{type:"COLOR",allowString:["adapt"]},storage:{type:"SCENARIO"},target:{type:"STRING"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_exp:{type:"STRING"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"}},action:function(a){var s=this;return ResourceLoader.loadImage(a.graphic).done(function(o){setTimeout(function(){var e=o2.currentMessageLayer,t=e.textCursor,r=t.x,n=t.y;e.vertical?r-=e.style.lineSpacing:n-=e.style.lineSpacing;var i=new KAGButton(o,r,n);i.importFromKAGArgs(a),e.addButton(i),o2.currentMessageLayerWithBack&&e.getCorrespondingLayer().addButton(clone(i)),s.done()})}),1}});var KAGLink,KAGButton=function(e,t,r){Button.call(this,e,t,r),this.rect.width=Math.floor(this.rect.width/3),this.options.clipLeft=0,this.options.clipWidth=this.rect.width,this.tagArgs};KAGButton.prototype=Object.create(Button.prototype),KAGButton.prototype.initializer="KAGButton",KAGButton.prototype.clone=function(){var e=new KAGButton(this.image);return e.importFrom(this),e},KAGButton.prototype.drawOnContext=function(e,t){switch(this.state){case Button.STATE_HOVER:this.options.clipLeft=2*this.rect.width;break;case Button.STATE_DOWN:this.options.clipLeft=this.rect.width;break;case Button.STATE_NORMAL:default:this.options.clipLeft=0}Button.prototype.drawOnContext.apply(this,arguments)},KAGButton.prototype.importFromKAGArgs=function(i){i&&(this.tagArgs=clone(i),this.click=function(e,t,r){if(Button.prototype.click.apply(this,arguments),i.o2_exp&&(0,eval)(i.o2_exp),i.o2_url&&window.open(i.o2_url,i.o2_urltarget),i.storage||i.target){var n=new Tag("jump",{storage:i.storage,target:i.target});currentConductor.queue.push(n)}r.addButtonLinkImages(),r.buttons=[],r.links=[]},i.o2_onenter&&(this.enter=function(){Button.prototype.enter.apply(this,arguments),(0,eval)(i.o2_onenter)}),i.o2_onleave&&(this.leave=function(){Button.prototype.leave.apply(this,arguments),(0,eval)(i.o2_onleave)}))},KAGButton.prototype.importFrom=function(e){Button.prototype.importFrom.call(this,e),this.importFromKAGArgs(e.tagArgs)},KAGButton.prototype.importFromSaveData=function(e){Button.prototype.importFromSaveData.call(this,e),this.importFromKAGArgs(e.tagArgs)},KAGButton.prototype.toJSON=function(){var e=Button.prototype.toJSON.call(this);return e.tagArgs=this.tagArgs,e},KAGButton.restore=function(r){return $.when(ResourceLoader.loadImage(r.image,!0)).then(function(e){var t=new KAGButton(e);return t.importFromSaveData(r),t})},function(){(KAGLink=function(){Link.call(this),this.tagArgs}).prototype=Object.create(Link.prototype),KAGLink.prototype.initializer="KAGLink",KAGLink.restore=function(e){var t=new KAGLink;return t.importFromKAGArgs(e.tagArgs),delete e.tagArgs,Link.prototype.importFromSaveData(e),t},KAGLink.prototype.importFrom=function(e){Link.prototype.importFrom.call(this,e),this.importFromKAGArgs(e.tagArgs)},KAGLink.prototype.importFromKAGArgs=function(i){this.tagArgs=i,this.click=function(e,t,r){if(Link.prototype.click.apply(this,arguments),"o2_exp"in i&&(0,eval)(i.o2_exp),"o2_url"in i&&window.open(i.o2_url,i.o2_urltarget),i.target||i.storage){var n=new Tag("jump",{target:this.tagArgs.target,storage:this.tagArgs.storage});currentConductor.queue.push(n)}r.addButtonLinkImages(),r.buttons=[],r.links=[]},"o2_onenter"in i&&(this.enter=function(){Link.prototype.enter.apply(this,arguments),(0,eval)(i.o2_onenter)}),"o2_onleave"in i&&(this.leave=function(){Link.prototype.leave.apply(this,arguments),(0,eval)(i.o2_onleave)})};var a=0,s={};Tag.actions.link=new TagAction({rules:{storage:{type:"SCENARIO"},target:{type:"STRING"},color:{type:"COLOR"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"},o2_exp:{type:"STRING"}},action:function(e){return a=o2.currentMessageLayer.textsProperties.length,s=e,0}}),Tag.actions.endlink=new TagAction({action:function(e){var t=new KAGLink;t.importFromKAGArgs(s),t.vertical=o2.currentMessageLayer.vertical;for(var r=a;r<o2.currentMessageLayer.textsProperties.length;r++)t.addTextProperties(o2.currentMessageLayer.textsProperties[r]);if(o2.currentMessageLayer.addLink(t),o2.currentMessageLayerWithBack){var n=o2.currentMessageLayer.getCorrespondingLayer(),i=new KAGLink;i.importFromKAGArgs(s),i.vertical=n.vertical;for(var o=a;o<n.textsProperties.length;o++)i.addTextProperties(n.textsProperties[o]);n.addLink(i)}return 0}})}(),Tag.actions.image=new TagAction({rules:{storage:{type:"IMAGE",required:!0},layer:{type:"IMAGE_LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},key:{type:"COLOR",allowString:["adapt"]},grayscale:{type:"BOOLEAN"},rgamma:{type:"FLOAT"},ggamma:{type:"FLOAT"},bgamma:{type:"FLOAT"},rfloor:{type:"INT"},gfloor:{type:"INT"},bfloor:{type:"INT"},rceil:{type:"INT"},gceil:{type:"INT"},bceil:{type:"INT"},mcolor:{type:"COLOR"},mopacity:{type:"INT"},shadow:{type:"COLOR"},shadowopacity:{type:"INT",defaultValue:200},shadowx:{type:"INT",defaultValue:10},shadowy:{type:"INT",defaultValue:10},shadowblur:{type:"FLOAT",defaultValue:3},clipleft:{type:"INT"},cliptop:{type:"INT"},clipwidth:{type:"INT"},clipheight:{type:"INT"},flipud:{type:"BOOLEAN"},fliplr:{type:"BOOLEAN"},visible:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"},pos:{type:/left|left_center|center|right_center|right|l|lc|c|rc|r/},opacity:{type:"INT"},allowfail:{type:"BOOLEAN",defaultValue:!1},o2_zoom:{type:/[0-9]+(:[0-9]+)?/},o2_rotate:{type:"FLOAT"},o2_orx:{type:"FLOAT"},o2_ory:{type:"FLOAT"},o2_blur:{type:"INT"},o2_blurx:{type:"INT"},o2_blury:{type:"INT"},o2_blurmode:{type:/linear|constantalpha/}},preload:function(e){ResourceLoader.loadImage(e.storage,!1)},action:function(i){var o=this,a=i.layer[i.page],s={grayscale:!1,rGamma:1,gGamma:1,bGamma:1,rFloor:0,gFloor:0,bFloor:0,rCeil:255,gCeil:255,bCeil:255,tintColor:"#ff0000",tintOpacity:0,shadow:"#000000",shadowOpacity:200,shadowX:10,shadowY:10,shadowBlur:3,clipLeft:void 0,clipTop:void 0,clipWidth:void 0,clipHeight:void 0,flipUD:!1,flipLR:!1,visible:!0,opacity:255,blurX:0,blurY:0,blurMode:"linear"},e={rgamma:"rGamma",ggamma:"gGamma",bgamma:"bGamma",rfloor:"rFloor",gfloor:"gFloor",bfloor:"bFloor",rceil:"rCeil",gceil:"gCeil",bceil:"bCeil",mcolor:"tintColor",mopacity:"tintOpacity",shadowopacity:"shadowOpacity",shadowx:"shadowX",shadowy:"shadowY",shadowblur:"shadowBlur",clipleft:"clipLeft",cliptop:"clipTop",clipwidth:"clipWidth",clipheight:"clipHeight",flipud:"flipUD",fliplr:"flipLR",o2_blurx:"blurX",o2_blury:"blurY",o2_blurmode:"blurMode"};for(var t in i){if(-1==["storage","layer","page","allowfail","left","top","pos","o2_zoom","o2_rotate","o2_orx","o2_ory"].indexOf(t))s[e[t]||t]=i[t]}return a.loadImage(i.storage,s,i.allowfail).fail(function(){o.error("イメージファイル "+i.storage+" をロードできません")}).then(function(e){if("opacity"in s&&(a.opacity=s.opacity/255,s.opacity=1),"visible"in s&&(a.visible=s.visible,s.visible=!0),"shadowOpacity"in s&&(s.shadowOpacity/=255),"tintOpacity"in s&&(s.tintOpacity/=255),"o2_blur"in i&&("o2_blurx"in i||(s.blurX=i.o2_blur),"o2_blury"in i||(s.blurY=i.o2_blur)),"pos"in i){switch(i.pos){case"left":case"l":a.rect.x=config.scPositionX_left-e.rect.width/2;break;case"left_center":case"lc":a.rect.x=config.scPositionX_left_center-e.rect.width/2;break;case"center":case"c":a.rect.x=config.scPositionX_center-e.rect.width/2;break;case"right_center":case"rc":a.rect.x=config.scPositionX_right_center-e.rect.width/2;break;case"right":case"r":a.rect.x=config.scPositionX_right-e.rect.width/2}a.rect.y=config.scHeight-e.rect.height}else"left"in i&&(a.rect.x=i.left),"top"in i&&(a.rect.y=i.top);if(a.rect.width=Math.max(config.scWidth,e.rect.width),a.rect.height=Math.max(config.scHeight,e.rect.height),a.setRect(),"o2_zoom"in i){var t=1,r=1,n=i.o2_zoom.split(":");if(2<=n.length?(t=parseFloat(n[0]),r=parseFloat(n[1])):t=r=parseFloat(n[0]),isNaN(t)||isNaN(r))return o.error("o2_zoomが正しくありません。"),0;a.scaleX=t/100,a.scaleY=r/100}"o2_rotate"in i&&(a.rotation=i.o2_rotate/180*Math.PI),a.transformOrigin.x="o2_orx"in i?i.o2_orx:e.rect.width/2,a.transformOrigin.y="o2_ory"in i?i.o2_ory:e.rect.height/2}).then(function(){try{return KAGFiles(i.storage+".asd")}catch(e){return $.Deferred().reject()}}).then(function(e){var t=new AnimationConductor({file:e});a.addAnimationConductor(t,0),t.run()}).always(function(){setTimeout(function(){o.done()})}),1}}),Tag.actions.pimage=new TagAction({rules:{storage:{type:"IMAGE",required:!0},layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},allowfail:{type:"BOOLEAN",defaultValue:!1},dx:{type:"INT",required:!0},dy:{type:"INT",required:!0},sx:{type:"INT",defaultValue:0},sy:{type:"INT",defaultValue:0},sw:{type:"INT"},sh:{type:"INT"},opacity:{type:"INT"},o2_grayscale:{type:"BOOLEAN",defaultValue:!1},o2_rgamma:{type:"FLOAT"},o2_ggamma:{type:"FLOAT"},o2_bgamma:{type:"FLOAT"},o2_rfloor:{type:"INT"},o2_gfloor:{type:"INT"},o2_bfloor:{type:"INT"},o2_rceil:{type:"INT"},o2_gceil:{type:"INT"},o2_bceil:{type:"INT"},o2_mcolor:{type:"COLOR"},o2_mopacity:{type:"INT"}},action:function(o){var a=this;return ResourceLoader.loadImage(o.storage,!o.allowfail).done(function(e){var t=o.layer[o.page],r=new DrawableImage(e,o.dx,o.dy),n={sx:"clipLeft",sy:"clipTop",sw:"clipWidth",sh:"clipHeight",opacity:"opacity",o2_grayscale:"grayscale",o2_rgamma:"rGamma",o2_ggamma:"gGamma",o2_bgamma:"bGamma",o2_rfloor:"rFloor",o2_gfloor:"gFloor",o2_bfloor:"bFloor",o2_rceil:"rCeil",o2_gceil:"gCeil",o2_bceil:"bCeil",o2_mcolor:"tintColor",o2_mopacity:"tintOpacity"};for(var i in n)i in o&&(r.options[n[i]]=o[i]);"opacity"in r.options&&(r.options.opacity/=255),"tintOpacity"in r.options&&(r.options.tintOpacity/=255),t.addImage(r),setTimeout(a.done.bind(a))}),1}}),Tag.actions.freeimage=new TagAction({rules:{layer:{type:"IMAGE_LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"}},action:function(e){return e.layer[e.page].clearImage(),e.layer[e.page].clearAnimationConductors(),0}}),Tag.actions.backlay=new TagAction({rules:{layer:{type:"LAYER"}},action:function(n){var i=this;return renderer.animator.requestFrame(function(){if(n.layer)n.layer.back.importFrom(n.layer.fore);else for(var e=o2.allForeLayers(),t=o2.allBackLayers(),r=0;r<e.length;r++)t[r].importFrom(e[r]);i.done()}),1}}),Tag.actions.copylay=new TagAction({rules:{srclayer:{type:"LAYER",required:!0},destlayer:{type:"LAYER",required:!0},srcpage:{type:/fore|back/,defaultValue:"fore"},destpage:{type:/fore|back/,defaultValue:"fore"}},action:function(e){var t=e.srclayer[e.srcpage],r=e.destlayer[e.destpage];if(t.initializer!=r.initializer)throw"srclayerとdestlayerに異なる種類のレイヤを指定することはできません";return r.importFrom(t),0}}),Tag.actions.o2_forelay=new TagAction({rules:{layer:{type:"LAYER"}},action:function(n){var i=this;return renderer.animator.requestFrame(function(){if(n.layer)n.layer.fore.importFrom(n.layer.back);else for(var e=o2.allForeLayers(),t=o2.allBackLayers(),r=0;r<e.length;r++)e[r].importFrom(t[r]);i.done()}),1}}),Tag.actions.layopt=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},visible:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"},opacity:{type:"INT"},autohide:{type:"BOOLEAN"},index:{type:"INT"},o2_zoom:{type:/[0-9]+(:[0-9]+)?/},o2_rotate:{type:"FLOAT"},o2_orx:{type:"FLOAT"},o2_ory:{type:"FLOAT"},o2_frameopacity:{type:"INT"},o2_userinteraction:{type:"BOOLEAN"}},action:function(e){var t=e.layer[e.page];if("visible"in e&&(t.visible=e.visible),"left"in e&&(t.rect.x=e.left),"top"in e&&(t.rect.y=e.top),"opacity"in e&&(t.opacity=e.opacity/255),"autohide"in e)if(e.autohide)-1==o2.extraAutoHideLayers.indexOf(t)&&o2.extraAutoHideLayers.push(t);else{var r=o2.extraAutoHideLayers.indexOf(t);-1!=r&&o2.extraAutoHideLayers.splice(r,1)}if("index"in e&&(t.index=e.index,o2.refreshRendererLayers()),"o2_zoom"in e){var n=1,i=1,o=e.o2_zoom.split(":");if(2<=o.length?(n=parseFloat(o[0]),i=parseFloat(o[1])):n=i=parseFloat(o[0]),isNaN(n)||isNaN(i))return this.error("o2_zoomが正しくありません。"),0;t.scaleX=n/100,t.scaleY=i/100}return"o2_rotate"in e&&(t.rotation=e.o2_rotate/180*Math.PI),"o2_orx"in e&&(t.transformOrigin.x=e.o2_orx),"o2_ory"in e&&(t.transformOrigin.y=e.o2_ory),"o2_frameopacity"in e&&(t instanceof MessageLayer?t.frameImage?(t.frameImage.options.opacity=e.o2_frameopacity/255,t.redrawRect(t.frameImage.rect)):(t.frameSolid.opacity=e.o2_frameopacity/255,t.redrawRect(t.frameSolid.rect)):this.error("メッセージレイヤー以外のレイヤーにo2_frameopacityを指定できないです")),"o2_userinteraction"in e&&(t.userInteractionEnabled=e.o2_userinteraction),renderer.animator.requestFrame(),0}}),Tag.actions.laycount=new TagAction({rules:{layers:{type:"INT"},messages:{type:"INT"}},action:function(e){if("layers"in e)if(e.layers>o2.foreLayers.imageLayers.length)for(var t=o2.foreLayers.imageLayers.length;t<e.layers;t++)o2.foreLayers.imageLayers.push(new ImageLayer),o2.backLayers.imageLayers.push(new ImageLayer);else if(e.layers<o2.foreLayers.imageLayers.length){var r=o2.foreLayers.imageLayers.length-e.layers;o2.foreLayers.imageLayers.splice(-r,r).concat(o2.backLayers.imageLayers.splice(-r,r)).forEach(function(e){e.destroy()})}if("messages"in e)if(e.messages>o2.foreLayers.messageLayers.length)for(var n=o2.foreLayers.messageLayers.length;n<e.messages;n++)o2.foreLayers.messageLayers.push(new MessageLayer),o2.backLayers.messageLayers.push(new MessageLayer);else if(e.messages<o2.foreLayers.messageLayers.length){var i=o2.foreLayers.messageLayers.length-e.messages;o2.foreLayers.messageLayers.splice(-i,i).concat(o2.backLayers.messageLayers.splice(-i,i)).forEach(function(e){e.destroy()})}return o2.resetLayersIndex(),o2.refreshRendererLayers(),renderer.animator.requestFrame(),0}}),Tag.actions.trans=new TagAction({rules:{time:{type:"INT",required:!0},layer:{type:"LAYER",defaultValue:"base"},children:{type:"BOOLEAN",defaultValue:!0},method:{type:"STRING",defaultValue:"crossfade"}},action:function(r){this.end=!1,this.transArgs=r,this.method=Tag.actions.trans.methods[r.method],this.method||this.error(r.method+" というメソッドは存在しません"),"canRun"in this.method&&!this.method.canRun()&&(this.method=Tag.actions.trans.methods.crossfade);var n=this,e=!1;function t(){if(!this.end)if(e)$.when(Tag.actions.trans.stopAllTransitions()).done(function(){Tag.actions.trans.runningTag=n;var e=$("#main-wrapper");n.container=$("<div />"),n.container.css({position:"absolute",width:e.width()+"px",height:e.height()+"px"}),e.append(n.container),n.container.append([renderer.foreCanvas,renderer.backCanvas]),n.method.transitAllLayers.call(n,r,renderer.backCanvas,renderer.foreCanvas,n.container),renderer.animator.requestFrame(function(){n.end||i()},r.time)});else{r.layer.fore.transit(this);var t=Date.now();!function e(){n.end||(Date.now()-t<r.time?renderer.animator.requestFrame(e):i())}()}}function i(){n.end||(n.end=!0,e?$.when(Tag.actions.trans.stopAllTransitions()).done(function(){n.done()}):(r.layer.fore.stopTransition(),n.done()))}return r.layer.fore==o2.foreLayers.baseLayer&&r.children&&(e=!0),this.method.transit||e||this.error("メソッド "+r.method+" を実行するにはlayer属性にbase、children属性にtrueを指定する必要があります"),renderer.renderBackCanvas=!0,"function"==typeof this.method.preload?this.method.preload.call(this,r).done(function(){renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){t.call(n),n.done()})})}):renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){t.call(n),n.done()})}),1},stopAllTransitions:function(){for(var e,t=o2.allForeLayers(),r=o2.allBackLayers(),n=0;n<t.length;n++)t[n].stopTransition();if(Tag.actions.trans.runningTag){var i=$.Deferred();renderer.renderBackCanvas=!1;for(var o=0;o<t.length;o++)t[o].importFrom(r[o]);return o2.refreshRendererLayers(),e=Tag.actions.trans.runningTag,renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){"function"==typeof e.method.teardownAllLayers&&e.method.teardownAllLayers.call(e,e.transArgs,renderer.backCanvas,renderer.foreCanvas,e.container),$(renderer.backCanvas).detach(),e.container&&(e.container.remove(),delete e.container),$("#main-wrapper").append(renderer.foreCanvas),i.resolve()})}),e.end=!0,Tag.actions.trans.runningTag=void 0,$(o2).trigger("transEnd"),i.promise()}},methods:{}});var IfStatus,TransMethod=function(a){for(var e in a)this[e]=a[e];a.transitAllLayers||(this.transitAllLayers=function(t,r,n,e){$(r).hide(),$(n).hide(),this.transCanvas=document.createElement("canvas"),this.transCanvas.width=n.width,this.transCanvas.height=r.height,$(this.transCanvas).css({position:"absolute",x:0,y:0}),$(e).append(this.transCanvas),a.prepare.call(this,t);var i=Date.now(),o=this;!function e(){o.end||(Date.now()-i<t.time&&renderer.animator.requestFrame(e),a.transit.call(o,t,n,r,o.transCanvas))}()},this.teardownAllLayers=function(e,t,r,n){"function"==typeof a.teardown&&a.teardown.call(this),$(t).show(),$(r).show(),$(this.transCanvas).remove(),this.transCanvas=null})};Tag.actions.stoptrans=new TagAction({action:function(){var e=this;return $.when(Tag.actions.trans.stopAllTransitions()).done(function(){setTimeout(function(){e.done()})}),1}}),Tag.actions.wt=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!0}},action:function(e){var t=o2.allForeLayers(),r=!0;if(Tag.actions.trans.runningTag)r=!1;else for(var n=t.length-1;0<=n;n--)if(t[n].isTransiting()){r=!1;break}if(r)return 0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode){var i=this;return $.when(Tag.actions.trans.stopAllTransitions()).done(function(){setTimeout(function(){i.done()})}),1}this.conductor.wait("click",function(){Tag.actions.trans.stopAllTransitions()})}return this.conductor.wait("trans"),1}}),Tag.actions.trans.methods.crossfade=new TransMethod({prepare:function(e){this.beginning=Date.now()},transit:function(e,t,r,n){var i=n.getContext("2d"),o=(Date.now()-this.beginning)/e.time;(1<=o||this.end)&&(o=1),i.save(),i.clearRect(0,0,n.width,n.height),i.globalAlpha=1,i.drawImage(t,0,0),i.globalAlpha=o,i.drawImage(r,0,0),i.restore()},teardown:function(){delete this.beginning},transitAllLayers:function(r,n,e,t){var i=this,o=Date.now();if(e.style.zIndex=1,n.style.zIndex=2,supportCssProperty("animationName")){var a="@-webkit-keyframes fade { \n0% { \n opacity: 0; \n} 100% { \n opacity: 1; \n}} \n";a+=a.replace(/-webkit-/g,"-moz-")+a.replace(/-webkit-/g,"-o-")+a.replace(/-webkit-/g,"");var s=document.createTextNode(a);this.cssTag=document.createElement("style"),this.cssTag.type="text/css",this.cssTag.appendChild(s),document.getElementsByTagName("head")[0].appendChild(this.cssTag),$(n).css("opacity",0),renderer.animator.requestFrame(function(){$(n).css({"animation-duration":r.time+"ms","animation-timing-function":r.timing_function||"linear","animation-name":"fade"})})}else{renderer.animator.requestFrame(function e(){var t=(Date.now()-o)/r.time;i.end||renderer.animator.requestFrame(e),n.style.opacity=t})}},teardownAllLayers:function(e,t,r,n){if(this.end=!0,this.cssTag)try{document.getElementsByTagName("head")[0].removeChild(this.cssTag)}catch(e){}$(t).css({opacity:1,"animation-duration":"","animation-timing-function":"","animation-name":""})}}),$.extend(Tag.actions.trans.rules,{from:{type:/left|top|right|bottom/,defaultValue:"left"},stay:{type:/stayfore|stayback|nostay/,defaultValue:"nostay"},o2_timing_function:{type:"STRING",defaultValue:"linear"}}),Tag.actions.trans.methods.scroll=new TransMethod({prepare:function(e){if(this.beginning=Date.now(),-1!=e.o2_timing_function.indexOf("cubic-bezier")){var t=e.o2_timing_function.replace("cubic-bezier","");if(4!=(t=(t=(t=t.replace("(","")).replace(")","")).split(",").map(function(e){return parseFloat(e)})).length)throw"o2_timing_function属性のフォーマットが正しくありません";this.timingFunction=new KeySpline(t[0],t[1],t[2],t[3])}else switch(e.o2_timing_function){case"ease":this.timingFunction=new KeySpline(.25,.1,.25,1);break;case"ease-in":this.timingFunction=new KeySpline(.42,0,1,1);break;case"ease-out":this.timingFunction=new KeySpline(0,0,.58,1);break;case"ease-in-out":this.timingFunction=new KeySpline(.42,0,.58,1);break;default:this.timingFunction=new KeySpline(0,0,1,1)}},transit:function(e,t,r,n){var i=(Date.now()-this.beginning)/e.time,o=n.getContext("2d");i=this.timingFunction.get(i),o.clearRect(0,0,n.width,n.height);var a=0,s=0;if("stayback"!=e.stay)switch(e.from){case"top":s=n.height*i;break;case"right":a=-1*t.width*i;break;case"bottom":s=-1*t.height*i;break;default:a=n.width*i}o.drawImage(t,a,s,t.width,t.height);var c=r.height,u=r.width,l=0,h=0;if("stayfore"==e.stay)switch(a=s=0,e.from){case"top":c*=i;break;case"right":u*=i,a=l=(1-i)*r.width;break;case"bottom":c*=i,s=h=(1-i)*r.height;break;default:u*=i}else switch(e.from){case"top":s=r.height*(i-1);break;case"right":a=n.width*(1-i);break;case"bottom":s=(1-i)*n.height;break;default:a=r.width*(i-1)}0<u*c&&o.drawImage(r,l,h,u,c,a,s,u,c)},teardown:function(){delete this.beginning,delete this.timingFunction}}),$.extend(Tag.actions.trans.rules,{vague:{type:"INT",defaultValue:64},rule:{type:"IMAGE"},liveview:{type:"BOOLEAN",allowString:["auto"],defaultValue:"auto"},opaque:{type:"BOOLEAN",defaultValue:!0}}),Tag.actions.trans.methods.universal=new TransMethod({preload:function(r){var t=this;if(!("rule"in r))throw"rule属性は必須です";return this.liveview=function(){if(!0===r.liveview)return!0;var e;if("auto"==r.liveview)for(var t in e=r.layer.fore==o2.foreLayers.baseLayer?o2.allLayers():r.layer)if(e[t].moveTag)return!0;return!1}(),ResourceLoader.loadImage(r.rule).done(function(e){return t.maskImage=e})},supportsArrayBuffer:window.ArrayBuffer&&window.Uint8Array&&window.Uint32Array,isLittleEndian:function(){if(!window.ArrayBuffer||!window.Uint8Array||!window.Uint32Array)return!1;var e=new ArrayBuffer(4),t=new Uint32Array(e),r=new Uint8Array(e);if(t[0]=3735928559,239==r[0])return!0;if(222==r[0])return!1;throw new Error("unknown endianness")}(),prepare:function(e){this.beginning=Date.now(),this.maskCanvas=document.createElement("canvas"),this.maskCanvas.width=this.maskImage.width,this.maskCanvas.height=this.maskImage.height,this.maskContext=this.maskCanvas.getContext("2d"),this.maskContext.drawImage(this.maskImage,0,0),this.maskData=this.maskContext.getImageData(0,0,this.maskCanvas.width,this.maskCanvas.height)},transit:function(e,t,r,n){var i,o,a=(Date.now()-this.beginning)/e.time;if(1<a&&(a=1),!this.liveview&&this.beforeBitmap&&this.afterBitmap)i=this.beforeBitmap,o=this.afterBitmap;else{var s=t.getContext("2d"),c=r.getContext("2d"),u=s.getImageData(0,0,t.width,t.height);o=c.getImageData(0,0,r.width,r.height).data,i=u.data,this.liveview||(this.beforeBitmap=i,this.afterBitmap=o)}var l=e.vague,h=l+(l+255)*-a,f=this.maskData.data,d=n.getContext("2d"),p=d.createImageData(n.width,n.height),g=p.data;if(e.opaque&&Tag.actions.trans.methods.universal.supportsArrayBuffer&&o.buffer){this.maskCopyingCanvas?this.maskCopyingContext.clearRect(0,0,this.maskCopyingCanvas.width,this.maskCopyingCanvas.height):(this.maskCopyingCanvas=document.createElement("canvas"),this.maskCopyingCanvas.width=this.maskCanvas.width,this.maskCopyingCanvas.height=this.maskCanvas.height,this.maskCopyingContext=this.maskCopyingCanvas.getContext("2d"));var y=new Uint32Array(o.buffer),m=new Uint32Array(g.buffer);if(this.maskCanvas.width==n.width&&this.maskCanvas.height==n.height)if(Tag.actions.trans.methods.universal.isLittleEndian)for(var v=0,w=y.length;v<w;v++){var T=1-(f[v<<2]+h)/l;T=255*(1<T?1:T<0?0:T),m[v]=16777215&y[v]|(0|T)<<24}else for(var b=0,L=y.length;b<L;b++){var x=1-(f[b<<2]+h)/l;x=255*(1<x?1:x<0?0:x),m[b]=4294967040&y[b]|0|x}else{var C=n.width,S=this.maskCanvas.width,k=this.maskCanvas.height;if(Tag.actions.trans.methods.universal.isLittleEndian)for(var A=0,O=y.length;A<O;A++){var _=1-(f[A%S+Math.floor(A/C)%k*S<<2]+h)/l;_=255*(1<_?1:_<0?0:_),m[A]=16777215&y[A]|(0|_)<<24}else for(var E=0,R=y.length;E<R;E++){var N=1-(f[E<<2]+h)/l;N=255*(1<N?1:N<0?0:N),m[E]=4294967040&y[E]|0|N}}this.maskCopyingContext.putImageData(p,0,0),d.drawImage(t,0,0),d.drawImage(this.maskCopyingCanvas,0,0)}else{if(this.maskCanvas.width==n.width&&this.maskCanvas.height==n.height)for(var D=0,I=g.length;D<I;D+=4){var M=1-(f[D]+h)/l;M=Math.max(0,Math.min(1,M)),g[D]=i[D]+(o[D]-i[D])*M,g[D+1]=i[D+1]+(o[D+1]-i[D+1])*M,g[D+2]=i[D+2]+(o[D+2]-i[D+2])*M,g[D+3]=255}else for(var F=n.width,B=this.maskCanvas.width,P=this.maskCanvas.height,G=0,z=g.length;G<z;G+=4){var j=1-(f[4*(G/4%B+Math.floor(G/4/F)%P*B)]+h)/l;j=Math.max(0,Math.min(1,j)),g[G]=i[G]+(o[G]-i[G])*j,g[G+1]=i[G+1]+(o[G+1]-i[G+1])*j,g[G+2]=i[G+2]+(o[G+2]-i[G+2])*j,g[G+3]=255}d.putImageData(p,0,0)}},teardown:function(){delete this.beginning,delete this.maskCanvas,delete this.maskContext,delete this.maskData,delete this.maskImage,delete this.maskCopyingCanvas,delete this.maskCopyingContext}}),Tag.actions.move=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},spline:{type:"BOOLEAN"},time:{type:"INT",required:!0},delay:{type:"INT"},path:{type:"STRING"},accel:{type:"INT",defaultValue:0},o2_path:{type:"STRING"},o2_orx:{type:"FLOAT"},o2_ory:{type:"FLOAT"},o2_omit:{type:"STRING"},o2_override:{type:"BOOLEAN",defaultValue:!0}},action:function(e){var d=this,p=e.time,g=e.layer[e.page];if("o2_orx"in e&&(g.transformOrigin.x=e.o2_orx),"o2_ory"in e&&(g.transformOrigin.y=e.o2_ory),!("path"in e||"o2_path"in e))return this.error("path属性かo2_path属性のいずれかは必須です"),0;var t=function(e,t,r,n,i,o){this.x=e,this.y=t,this.opacity=r,this.zoomX=n,this.zoomY=i,this.rotation=o},y=[],r=e.path;"o2_path"in e&&(r=e.o2_path);var n=r.match(/\((-?[0-9,\s:]+)*\)/g);null==n&&this.error("path属性のフォーマットが正しくありません");var m,v={};"o2_omit"in e&&e.o2_omit.replace(/\s/g,"").split(",").forEach(function(e){v[e]=1}),y.push(new t(g.rect.x,g.rect.y,g.opacity,g.scaleX,g.scaleY,g.rotation));for(var i=0;i<n.length;i++){var o=n[i];o=(o=o.replace("(","").replace(")","")).split(",");var a=new t,s=parseFloat(o[0]);isNaN(s)?a.x=y[y.length-1].x:a.x=s;var c=parseFloat(o[1]);isNaN(c)?a.y=y[y.length-1].y:a.y=c;var u=parseFloat(o[2]);isNaN(u)?a.opacity=y[y.length-1].opacity:a.opacity=u/255;var l=[];if(3<o.length){if(r==e.path)return this.error("path属性に4つ以上のパラメータを指定することはできません"),0;l=o[3].split(":")}2==l.length?(a.zoomX=parseFloat(l[0])/100||y[y.length-1].zoomX,a.zoomY=parseFloat(l[1])/100||y[y.length-1].zoomY):(a.zoomX=parseFloat(l[0])/100||y[y.length-1].zoomX,a.zoomY=parseFloat(l[0])/100||y[y.length-1].zoomY);var h=parseFloat(o[4]);isNaN(h)?a.rotation=y[y.length-1].rotation:a.rotation=h/180*Math.PI,y.push(a)}p=e.time*(y.length-1),m=e.accel<-1?new KeySpline(.08,.44,.42,.93):1<e.accel?new KeySpline(.45,0,.97,.65):new KeySpline(0,0,1,1);var f=function(){g.moveTag&&e.o2_override&&(g.moveTag.end=!0),g.moveTag=this;var h=void 0;e.spline&&2<=y.length&&(h=B_Spline_Generator(y.map(function(e){return[e.x,e.y]})));var f=Date.now();renderer.animator.requestFrame(function e(){var t=(Date.now()-f)/p,r=1/(y.length-1);if(1<=t||d.end){t=1;var n=y[y.length-1];return v.x||(g.rect.x=n.x),v.y||(g.rect.y=n.y),v.opacity||(g.opacity=n.opacity),v.scaleX||(g.scaleX=n.zoomX),v.scaleY||(g.scaleY=n.zoomY),v.rotation||(g.rotation=n.rotation),$(o2).off("transEnd",w),w=null,d.end=!1,g.moveTag==d&&delete g.moveTag,void $(d).trigger("ended")}renderer.animator.requestFrame(e),t=m.get(t);var i=(y.length-1)*t,o=Math.floor(i),a=o+1,s=t/r-o;a>=y.length&&(a=y.length-1);var c,u=y[o],l=y[a];c=h?h(100*t):{x:u.x+(l.x-u.x)*s,y:u.y+(l.y-u.y)*s},v.x||(g.rect.x=c.x),v.y||(g.rect.y=c.y),v.opacity||(g.opacity=u.opacity+(l.opacity-u.opacity)*s),v.scaleX||(g.scaleX=u.zoomX+(l.zoomX-u.zoomX)*s),v.scaleY||(g.scaleY=u.zoomY+(l.zoomY-u.zoomY)*s),v.rotation||(g.rotation=u.rotation+(l.rotation-u.rotation)*s)})},w=function(){g.moveTag==d&&delete g.moveTag,(g=g.getCorrespondingLayer()).moveTag=d};return $(o2).on("transEnd",w),e.delay?setTimeout(f.bind(this),e.delay):f.call(this),0}}),Tag.actions.stopmove=new TagAction({rules:{o2_layer:{type:"LAYER"},o2_page:{type:/fore|back/,defaultValue:"fore"}},action:function(e){for(var t,r=(t=e.o2_layer?[e.o2_layer[e.o2_page]]:o2.allLayers()).length-1;0<=r;r--)t[r].moveTag&&(t[r].moveTag.end=!0);return 0}}),Tag.actions.wm=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!0},o2_layer:{type:"LAYER"},o2_page:{type:/fore|back/,defaultValue:"fore"}},action:function(e){var t=this,r=(e.o2_layer?[e.o2_layer[e.o2_page]]:o2.allLayers()).filter(function(e){return e.moveTag&&!e.moveTag.end});if(!(0<r.length))return 0;function n(){r.forEach(function(e){e.moveTag.end=!0})}if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return n(),0;this.conductor.wait("click",n)}function i(){r.forEach(function(e){$(e.moveTag).off("ended",i),t.done()})}return r.forEach(function(e){$(e.moveTag).one("ended",i)}),1}}),function(){var p=!1,g=!1;Tag.actions.quake=new TagAction({rules:{time:{type:"INT",required:!0},hmax:{type:"INT",defaultValue:10},vmax:{type:"INT",defaultValue:10}},action:function(l){var h=Date.now(),t=Math.ceil(l.time/50),f=[],d=this;if(p)return g=!0,renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){e(),d.done()})}),1;function e(){p=!0;for(var e=0;e<t;e++)f.push({x:Math.floor(Math.random()*l.hmax*2)-l.hmax,y:Math.floor(Math.random()*l.vmax*2)-l.vmax});f.push({x:0,y:0}),renderer.animator.requestFrame(function e(){var t=Date.now()-h,r=1/(f.length-1),n=t/l.time;1<n||g?(g=p=!(n=1),d.done()):renderer.animator.requestFrame(e);var i=(f.length-1)*n,o=Math.floor(i),a=o+1,s=n/r-o;a>=f.length&&(a=f.length-1);var c=f[o],u=f[a];renderer.xShift=c.x+(u.x-c.x)*s,renderer.yShift=c.y+(u.y-c.y)*s})}return e(),0}}),Tag.actions.stopquake=new TagAction({rules:{},action:function(e){return p&&(g=!0),0}}),Tag.actions.wq=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){if(!p)return 0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return g=!0,0;this.conductor.wait("click",function(){g=!0})}return this.conductor.wait("quake"),1}})}(),Tag.actions.label=new TagAction({rules:{name:{type:"STRING",required:!0},caption:{type:"STRING"}},action:function(e){if(this.conductor!=conductor)return 0;if(conductor.stack.length)return this.error("[->]のタグ内にラベルを置いてはいけないです。"),0;if(o2.reloadDelaySpeed(),o2.skipMode!=o2.SKIP_MODE_UNREAD||this.conductor.isCurrentRead()||(o2.skipMode=o2.SKIP_MODE_NONE),"caption"in e&&config.saveMode==o2.SAVE_MODE_KAG3){if(currentConductor.macroStack.length)return this.error("セーブモードがkag3モードの場合、ラベルをマクロの中に置いてはいけない。"),0;""!=e.caption?saveCurrentState(e.caption):saveCurrentState()}return 0}}),Tag.actions.jump=new TagAction({rules:{storage:{type:"SCENARIO"},target:{type:"STRING"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},disable_clear_stack:{type:"BOOLEAN",defaultValue:!1}},action:function(r){"o2_url"in r&&window.open(r.o2_url,r.o2_urltarget);var e,n,i=this;if(r.storage)e=KAGFiles(r.storage);else if(this.conductor.macroStack.length){var t=this.conductor.macroStack[this.conductor.macroStack.length-1];e=$.when(t.returnTag.restore()).then(function(e){return e.file})}else e=this.conductor.file;function o(e){if(e||i.error("シナリオファイル "+r.storage+" が見つかりません"),r.target){var t=r.target;"*"==t.charAt(0)&&(t=t.substring(1)),(n=e.getLabelTag(t))||i.error("ラベル "+t+" が見つかりません")}else n=e.lines[0];i.jumpToTag(n),r.disable_clear_stack||(i.conductor.clearIfStack(),i.conductor.clearMacroStack(),i.conductor.clearStack())}return e instanceof KAGFile?(o(e),0):($.when(e).then(function(e){o(e),i.done()}),1)}}),Tag.actions.call=new TagAction({rules:{storage:{type:"SCENARIO"},target:{type:"STRING"}},action:function(e){var t=this.conductor.getNextTag();if(!t){var r=new Tag("jump",e);return this.conductor.queue.push(r),0}t=t.toRestorable(),this.conductor.callStack.push(t),(e=this.normalizedArgs()).disable_clear_stack=!0;var n=new Tag("jump",e);return this.conductor.queue.push(n),0}}),Tag.actions.return=new TagAction({rules:{storage:{type:"SCENARIO"},target:{type:"STRING"}},action:function(e){var t=this.conductor.callStack.pop();if(t||this.error("サブルーチン外でreturnタグを実行することはできません"),t=t.restore(),(e=this.normalizedArgs()).disable_clear_stack=!0,e.storage||e.target){var r=new Tag("jump",e);return this.conductor.queue.push(r),0}if(t instanceof Tag)return this.jumpToTag(t),0;var n=this;return $.when(t).then(function(e){setTimeout(function(){n.jumpToTag(e),n.done()})}),1}}),Tag.actions.macro=new TagAction({rules:{name:{type:"STRING",required:!0},requiredAttrs:{type:"STRING"},optionalAttrs:{type:"STRING"}},action:function(e){var t=new MacroDefinition({name:e.name.toLowerCase(),startTag:this.conductor.getNextTag().toRestorable()});this.conductor.macros[e.name.toLowerCase()]=t;var r=this.conductor.getNextTag("endmacro");return r||this.error("endmacroタグが見つかりません"),this.conductor.setTag(r,!0),0}}),Tag.actions.endmacro=new TagAction({action:function(e){return 0}}),Tag.actions.erasemacro=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(e){return delete this.conductor.macros[e.name],0}}),Tag.actions.seopt=new TagAction({rules:{buf:{type:"INT",defaultValue:0},volume:{type:"INT"},gvolume:{type:"INT"},pan:{type:"INT",defaultValue:0}},action:function(e){var t=o2.se[e.buf],r=Math.max(-100,Math.min(100,e.pan/100));return t?(t.stopFade(),"volume"in e&&t.setVolume(e.volume/100),"pan"in e&&t.setPan(r),"gvolume"in e&&o2.setSeGVolume(e.gvolume/100)):this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0}}),Tag.actions.playse=new TagAction({rules:{buf:{type:"INT",defaultValue:0},storage:{type:"SOUND",required:!0},loop:{type:"BOOLEAN",defaultValue:!1},o2_start:{type:"TIME"},o2_block:{type:"BOOLEAN"}},action:function(e){var t=o2.se[e.buf];if(!t)return this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0;t.setLoop(e.loop),t.play(e.storage),"o2_start"in e&&t.setTime(e.o2_start);var r=this;return e.o2_block?(t.loadDefer.done(function(){setTimeout(function(){r.done()})}),1):0}}),Tag.actions.stopse=new TagAction({rules:{buf:{type:"INT",defaultValue:0}},action:function(e){var t=o2.se[e.buf];return t?t.stop():this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0}}),Tag.actions.fadese=new TagAction({rules:{buf:{type:"INT",defaultValue:0},volume:{type:"INT",required:!0},time:{type:"INT",required:!0}},action:function(e){var t=o2.se[e.buf];return t?t.fade({toVolume:e.volume/100,duration:e.time}):this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0}}),Tag.actions.fadeinse=new TagAction({rules:{buf:{type:"INT",defaultValue:0},storage:{type:"SOUND",required:!0},time:{type:"INT",required:!0},loop:{type:"BOOLEAN",defaultValue:!1},o2_start:{type:"TIME"},o2_volume:{type:"INT"},o2_block:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=o2.se[e.buf];if(!t)return this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0;if(t.stopFade(),t.isPlaying)return this.warn(e.buf+"はすでに再生してます。"),0;t.setLoop(e.loop),t.play(e.storage),"o2_start"in e&&t.setTime(e.o2_start),"o2_volume"in e&&t.setVolume(e.o2_volume/100),t.fade({fromVolume:0,duration:e.time});var r=this;return e.o2_block?(t.loadDefer.done(function(){setTimeout(function(){r.done()})}),1):0}}),Tag.actions.fadeoutse=new TagAction({rules:{buf:{type:"INT",defaultValue:0},time:{type:"INT",required:!0}},action:function(e){var t=o2.se[e.buf];return t?(t.stopFade(),t.isPlaying?t.fade({toVolume:0,duration:e.time,stopAfterFade:!0,finalVolume:0}):this.warn(e.buf+"は再生してないです。"),0):(this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0)}}),Tag.actions.wf=new TagAction({rules:{buf:{type:"INT",defaultValue:0},canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=this,r=o2.se[e.buf];if(!r)return this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0;var n=r.fade(),i=!1;if(!n)return 0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return r.stopFade(),0;this.conductor.wait("click",function(){i=!0,r.stopFade()})}return n.done(function(){i||setTimeout(function(){t.done()})}),1}}),Tag.actions.ws=new TagAction({rules:{buf:{type:"INT",defaultValue:0},canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=o2.se[e.buf];if(!t)return this.warn(e.buf+"という存在しないバッファ番号が指定されたため、このタグは無視されました"),0;if(!t.isPlaying)return o2.warn("効果音は再生されてないから、このタグは無視されました"),0;if(t.loop)return o2.warn("効果音のループ再生中に再生終了を待つことはできないため、このタグは無視されました"),0;var r=this,n=!1;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return t.stop(),0;this.conductor.wait("click",function(){n=!0,t.stop()})}return $(t).one("ended",function(){n||setTimeout(function(){r.done()})}),1}}),Tag.actions.bgmopt=new TagAction({rules:{volume:{type:"INT"},gvolume:{type:"INT"}},action:function(e){var t=o2.bgm;return t.stopFade(),"volume"in e&&t.setVolume(e.volume/100),"gvolume"in e&&o2.setBgmGVolume(e.gvolume/100),0}}),Tag.actions.playbgm=new TagAction({rules:{storage:{type:"SOUND",required:!0},loop:{type:"BOOLEAN",defaultValue:!0},o2_start:{type:"TIME"},o2_block:{type:"BOOLEAN"}},action:function(e){var t=this,r=o2.bgm;return r.stopFade(),r.setLoop(e.loop),r.play(e.storage),"o2_start"in e&&r.setTime(e.o2_start),e.o2_block?(r.loadDefer.done(function(){return setTimeout(function(){return t.done()})}),1):0}}),Tag.actions.pausebgm=new TagAction({action:function(){return o2.bgm.pause(),0}}),Tag.actions.resumebgm=new TagAction({action:function(){return o2.bgm.play(),0}}),Tag.actions.stopbgm=new TagAction({action:function(e){return o2.bgm.stop(),0}}),Tag.actions.fadebgm=new TagAction({rules:{volume:{type:"INT",required:!0},time:{type:"INT",required:!0}},action:function(e){return o2.bgm.fade({toVolume:e.volume/100,duration:e.time}),0}}),Tag.actions.fadeinbgm=new TagAction({rules:{storage:{type:"SOUND",required:!0},time:{type:"INT",required:!0},loop:{type:"BOOLEAN",defaultValue:!0},o2_start:{type:"TIME"},o2_volume:{type:"INT"},o2_block:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=o2.bgm;if(t.stopFade(),t.isPlaying)return this.warn("BGMはすでに再生してます。"),0;t.setLoop(e.loop),t.play(e.storage),"o2_start"in e&&t.setTime(e.o2_start),"o2_volume"in e&&t.setVolume(e.o2_volume/100),t.fade({fromVolume:0,duration:e.time});var r=this;return e.o2_block?(t.loadDefer.done(function(e){return setTimeout(function(e){return r.done()})}),1):0}}),Tag.actions.fadeoutbgm=new TagAction({rules:{time:{type:"INT",required:!0}},action:function(e){var t=o2.bgm;if(t.stopFade(),!t.isPlaying)return this.warn("BGMは再生してないです。"),0;var r=t.volume;return t.fadeStatus&&void 0!==t.fadeStatus.finalVolume&&(r=t.fadeStatus.finalVolume),t.fade({toVolume:0,duration:e.time,stopAfterFade:!0,finalVolume:r}),0}}),Tag.actions.fadepausebgm=new TagAction({rules:{time:{type:"INT",required:!0}},action:function(e){var t=o2.bgm;t.stopFade();var r=t.fade({toVolume:0,duration:e.time});return r&&r.done(function(){return t.pause()}),0}}),Tag.actions.xchgbgm=new TagAction({rules:{storage:{type:"SOUND",required:!0},loop:{type:"BOOLEAN",defaultValue:!0},time:{type:"INT",required:!0},overlap:{type:"INT",defaultValue:0},volume:{type:"INT"},o2_start:{type:"TIME"}},action:function(e){var t,r=this;if(t="volume"in e?e.volume/100:o2.bgm.volume,!browser.supportsMultipleAudio&&o2.prioritySound==o2.bgm)return o2.bgm.stop(),o2.bgm.setFile(e.storage).done(function(){setTimeout(function(){o2.bgm.setLoop(e.loop),o2.bgm.play(),o2.bgm.setVolume(t),"o2_start"in e&&o2.bgm.setTime(e.o2_start),r.done()})}),1;var n=browser.usesWebAudio?new WebAudioSound:new Sound,i=o2.bgm;return n.setFile(e.storage).done(function(){o2.bgm=n,i.fade({toVolume:0,duration:e.time,id:"old",stopAfterFade:!0}),setTimeout(function(){n.play(),"o2_start"in e&&n.setTime(e.o2_start),n.fade({fromVolume:0,toVolume:t,duration:e.time})},e.time-e.overlap),setTimeout(function(){return r.done()})}),n.setLoop(e.loop),1}}),Tag.actions.wb=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=this,r=o2.bgm,n=r.fade();if(!n)return 0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return r.stopFade(),0;this.conductor.wait("click",function(){return r.stopFade()})}return n.done(function(e){return setTimeout(function(e){return t.done()})}),1}}),Tag.actions.wl=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=this,r=o2.bgm;if(!r.isPlaying||r.loop)return o2.warn("BGMのループ再生中に再生終了を待つことはできないため、このタグは無視されました"),0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return r.stop(),0;this.conductor.wait("click",function(){return r.stop()})}return $(r).one("ended",function(e){return setTimeout(function(e){return t.done()})}),1}}),function(){function o(e,t){t||(t=currentConductor);var r=t.upComingTags(),n=0;"string"==typeof e&&(e=[e]);for(var i=0;i<r.length;i++){var o=r[i];if(0===n&&-1!==e.indexOf(o.tagName))return o;"if"===o.tagName&&n++,"endif"===o.tagName&&n--}}IfStatus=function(){this.conditionFulfilled=!1},Tag.actions.if=Tag.actions.ignore=new TagAction({rules:{o2_exp:{type:"RUNNABLE",required:!0}},action:function(e){var t=new IfStatus;this.conductor.ifStack.push(t);try{t.conditionFulfilled=e.o2_exp()}catch(e){t.conditionFulfilled=!1}if("ignore"===this.tagName&&(t.conditionFulfilled=!t.conditionFulfilled),!t.conditionFulfilled){var r=o(["else","elsif","endif","endignore"],this.conductor);r&&this.conductor.setTag(r)}return 0}}),Tag.actions.else=new TagAction({action:function(e){var t=this.conductor.ifStack[this.conductor.ifStack.length-1];if(!t)return 0;if(t.conditionFulfilled){var r=o(["endif","endignore"],this.conductor);r&&this.conductor.setTag(r)}return 0}}),Tag.actions.elsif=new TagAction({rules:{o2_exp:{type:"RUNNABLE",required:!0}},action:function(e){var t=this.conductor.ifStack[this.conductor.ifStack.length-1],r=!1;if(!t)return 0;if(t.conditionFulfilled)r=!0;else{var n;try{n=e.o2_exp()}catch(e){n=!1}n?t.conditionFulfilled=!0:r=!0}if(r){var i=o(["else","elsif","endif","endignore"],this.conductor);i&&this.conductor.setTag(i)}return 0}}),Tag.actions.endif=Tag.actions.endignore=new TagAction({action:function(e){return this.conductor.ifStack.pop(),0}}),Tag.actions.switch=new TagAction({rules:{val:{type:"STRING"}},action:function(t){this.value=t.val;var r=!1;return this.originalCase=this.conductor.tagActions.case,this.conductor.tagActions.case=new TagAction({rules:{val:{type:"STRING"}},action:function(e){e.val==t.val&&(r=!0,this.conductor.setTag(this,!0))}}),this.originalDefault=this.conductor.tagActions.default,this.conductor.tagActions.default=new TagAction({action:function(){r||this.conductor.setTag(this,!0)}}),this.conductor.setTag(this,!0),0},exitScope:function(){this.conductor.tagActions.case=this.originalCase,this.conductor.tagActions.default=this.originalDefault},closeAction:function(e){return 0}}),Tag.actions.foreach=new TagAction({rules:{val:{type:"OBJECT"},from:{type:"NUMBER",defaultValue:0},to:{type:"NUMBER"}},action:function(t){if(!("to"in t||"val"in t))return this.error("valかtoを指定してください。"),0;if(null!=t.val&&"object"===_typeof(t.val)&&("to"in t||0!=t.from))return this.error("valがobjectの時、to/fromを使えない"),0;var r;if("val"in t&&(t.val instanceof Array&&!("to"in t)||null!=t.val&&"object"===_typeof(t.val))&&(r=Object.keys(t.val),t.to=r.length-1),this.loopStatus={index:t.from,shouldLoop:function(){return this.index<=t.to},getValues:function(){if(t.val instanceof Array)return[t.val[this.index],this.index];if("object"!==_typeof(t.val))return[this.index];var e=r[this.index];return[e,t.val[e]]},next:function(){this.index++}},this.loopStatus.shouldLoop()){var e=this.loopStatus.getValues();this.setScopeVars(e),this.conductor.setTag(this,!0)}return 0},exitScope:function(){delete this.loopStatus},closeAction:function(e){var t=e.loopStatus;return t.next(),t.shouldLoop()&&(e.setScopeVars(t.getValues()),this.conductor.setTag(e,!0),this.keepStack()),0}})}(),function(){var n=void 0;Tag.actions.wait=new TagAction({rules:{time:{type:"TIME",required:!0},mode:{type:/normal|until/,defaultValue:"normal"},canskip:{type:"BOOLEAN",defaultValue:!0}},action:function(e){var t=this;if("until"===e.mode&&(e.time=n+e.time-Date.now(),e.time<=0))return 0;var r=setTimeout(function(){return t.done()},e.time);if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return clearTimeout(r),0;this.conductor.wait("click",function(){clearTimeout(r)})}return 1}}),Tag.actions.resetwait=new TagAction({action:function(e){return n=Date.now(),0}})}(),Tag.actions.waitclick=new TagAction({action:function(e){return this.conductor.wait("click",function(){o2.skipMode=o2.SKIP_MODE_NONE}),1}}),Tag.actions.clickskip=new TagAction({rules:{enabled:{type:"BOOLEAN",required:!0}},action:function(e){return o2.clickSkipEnabled=e.enabled,0}}),Tag.actions.eval=new TagAction({rules:{o2_exp:{type:"RUNNABLE"},func:{type:"FUNCTION"}},action:function(e){if(e.o2_exp)try{e.o2_exp()}catch(e){}if(e.func)try{e.func()}catch(e){}return 0}}),Tag.actions.o2_iscript=new TagAction({rules:{o2_exp:{type:"RUNNABLE",required:!0}},action:function(e){try{e.o2_exp()}catch(e){}return 0}}),$(function(){var n=void 0;$(o2).on("rclick",function(){if(-1!=["p","l","s"].indexOf(currentConductor.currentTag.tagName)&&o2.rclickSettings.enabled&&!n)if(o2.rclickSettings.call){extraConductor.setFile(conductor.file),currentConductor=extraConductor;var e=new Tag("jump",{target:o2.rclickSettings.target,storage:o2.rclickSettings.storage});extraConductor.queue.push(e)}else if(o2.rclickSettings.jump){var t=new Tag("jump",{target:o2.rclickSettings.target,storage:o2.rclickSettings.storage});currentConductor.queue.push(t)}else Tag.actions.rclick.hideMessageLayer()});var r=function e(t){t.stopImmediatePropagation(),function(){if(!n)return;for(var e=o2.autoHideLayers(),t=0;t<e.length;t++){var r=e[t];r.visible=n[t]}renderer.animator.requestFrame(),n=void 0,"p"==conductor.currentTag.tagName?o2.showGlyph("page"):"l"==conductor.currentTag.tagName&&o2.showGlyph("line")}(),$(o2).off("click",e),$(o2).off("rclick",e)};function i(){n=[];for(var e=o2.autoHideLayers(),t=0;t<e.length;t++){var r=e[t];n.push(r.visible),r.visible=!1}renderer.animator.requestFrame()}Tag.actions.rclick=new TagAction({rules:{call:{type:"BOOLEAN"},jump:{type:"BOOLEAN"},target:{type:"STRING"},storage:{type:"SCENARIO"},enabled:{type:"BOOLEAN"}},action:function(e){if("call"in e&&!0===e.call&&"jump"in e&&!0===e.jump)return this.error("call属性とjump属性の両方にtrueを指定することはできません"),0;for(var t in e)e.hasOwnProperty(t)&&(o2.rclickSettings[t]=e[t]);return 0},hideMessageLayer:function(){i(),$(o2).bindFirst("click",r),$(o2).bindFirst("rclick",r)}}),Tag.actions.hidemessage=new TagAction({action:function(e){i();var t=this;return $(o2).bindFirst("click",r),$(o2).bindFirst("click",function e(){setTimeout(function(){t.done()}),$(o2).off("click",e)}),1}})}),function(){var i=void 0;Tag.actions.o2_request=new TagAction({rules:{method:{type:/get|post/i,required:!0},url:{type:"STRING",required:!0},req:{type:"STRING",required:!0},return:{type:"STRING",defaultValue:"req"}},action:function(n){return i=$.ajax({url:n.url,type:n.method,data:n.req}).done(function(e,t,r){ev[n.return]={stat:r.status+" "+r.statusText,head:r.getAllResponseHeaders(),body:e},i=void 0}),0}}),Tag.actions.o2_wr=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1},timeout:{type:"INT"}},action:function(e){if(!i)return 0;var t=this,r=!1;function n(){r||(t.done(),r=!0)}return i.done(function(){setTimeout(n)}),"timeout"in e&&setTimeout(n,e.timeout),e.canskip&&o2.clickSkipEnabled&&this.conductor.wait("click",function(){r=!0}),1}})}(),Tag.actions.title=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(e){return config.title=e.name,document.title=config.title,0}}),Tag.actions.history=new TagAction({rules:{output:{type:"BOOLEAN"},enabled:{type:"BOOLEAN"}},action:function(e){return"output"in e&&(o2.historyLayer.recorder.options.output=e.output),"enabled"in e&&(o2.historyLayer.recorder.options.enabled=e.enabled),0}}),Tag.actions.hr=new TagAction({rules:{repage:{type:"BOOLEAN",defaultValue:!1}},action:function(e){return o2.historyLayer.recorder.options.repage&&e.repage?o2.historyLayer.recorder.addPage():o2.historyLayer.recorder.addCell(!0),0}}),Tag.actions.showhistory=new TagAction({action:function(e){var t=this;if(!o2.historyLayer.visible){var r=o2.historyLayer.recorder.options.enabled;o2.historyLayer.recorder.options.enabled=!0,o2.historyLayer.resetAndShow().done(function(){o2.historyLayer.recorder.options.enabled=r}).fail(function(){return t.warn("ヒストリーレイヤを開けなかった。")}).always(function(){return t.done()})}return 1}}),Tag.actions.o2_historytext=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(e){var t=new HistoryRecord.String(e.text);return o2.historyLayer.recorder.add(t),0}}),function(){var o=-1,a={};HistoryRecord.LinkStart=function(e){this.args=e},HistoryRecord.LinkStart.prototype=Object.create(HistoryRecord.prototype),HistoryRecord.LinkStart.prototype.initializer="HistoryRecord.LinkStart",HistoryRecord.LinkStart.prototype.toDrawable=function(e,t){o=t.length,a=this.args},HistoryRecord.LinkEnd=function(){},HistoryRecord.LinkEnd.prototype=Object.create(HistoryRecord.prototype),HistoryRecord.LinkEnd.prototype.initializer="HistoryRecord.LinkEnd",HistoryRecord.LinkEnd.prototype.toDrawable=function(e,t){if(0<=o){var r=t.slice(o);o=-1;var n=new Link;return n.color="#ff0000",n.vertical=e.layer.vertical,n.addTextProperties(r),i=a,n.click=function(){(0,eval)(i.o2_exp)},n}var i},Tag.actions.hact=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(e){var t=new HistoryRecord.LinkStart(e);return o2.historyLayer.recorder.add(t),0}}),Tag.actions.endhact=new TagAction({action:function(){var e=new HistoryRecord.LinkEnd;return o2.historyLayer.recorder.add(e),0}})}();var Video=function(e){function m(){_classCallCheck(this,m);var e=_possibleConstructorReturn(this,(m.__proto__||Object.getPrototypeOf(m)).call(this,new Rect(0,0,320,240)));return e.element=document.createElement("video"),e.element.setAttribute("webkit-playsinline",!0),e.filepath,e.loop=!1,e.volume=1,e.isVisible=!1,e.mode=m.MODE_OVERLAY,e.outputs=[],e.loadDefer=null,e}return _inherits(m,Drawable),_createClass(m,[{key:"toJSON",value:function(){return{rect:this.rect,loop:this.loop,outputs:this.outputs.map(function(e){var t=o2.foreLayers.imageLayers.indexOf(e);return-1!==t?{page:"fore",layer:t}:-1!==(t=o2.backLayers.imageLayers.indexOf(e))?{page:"back",layer:t}:null}),volume:this.volume,mode:this.mode,currentTime:this.element.currentTime,paused:this.paused(),filepath:this.filepath,isVisible:this.isVisible}}},{key:"importFromSaveData",value:function(e){var t=this;return"outputs"in e&&(this.outputs=e.outputs.map(function(e){if(!e)return null;var t=e.page,r=e.layer;return o2["back"===t?"backLayers":"foreLayers"].imageLayers[r]}),delete e.outputs),e.filepath&&(this.setFile(e.filepath),delete e.filepath),"paused"in e&&(e.paused?this.pause():this.play()),"currentTime"in e&&this.setTime(1e3*e.currentTime),this.mode=e.mode,this.setVolume(e.volume),this.setLoop(e.loop),this.setVisible(e.isVisible),$.when(e.rect.restore()).then(function(e){return t.setRect(e)})}},{key:"setFile",value:function(e){var t=this;return this.filepath=e,this.loadDefer=ResourceLoader.loadVideo(e,!0,this.element).done(function(e){t.setLoop(),t.setRect(),t.setVolume(),$(e).on("ended",function(){$(t).trigger("ended")})}),this.loadDefer}},{key:"setVisible",value:function(e){if(e!==this.isVisible){var t=this.paused();if(this.mode===m.MODE_OVERLAY){var r=document.getElementsByClassName("video-wrapper")[0],n=!!this.element.parentNode;n&&!e?r.removeChild(this.element):!n&&e&&r.appendChild(this.element)}else if(this.mode===m.MODE_LAYER)if(e){var i=!0,o=!1,a=void 0;try{for(var s,c=this.outputs[Symbol.iterator]();!(i=(s=c.next()).done);i=!0){var u=s.value;u&&(-1===u.videos.indexOf(this)&&u.videos.push(this))}}catch(e){o=!0,a=e}finally{try{!i&&c.return&&c.return()}finally{if(o)throw a}}this.paused()||this.rendererLoop()}else{var l=!0,h=!1,f=void 0;try{for(var d,p=this.outputs[Symbol.iterator]();!(l=(d=p.next()).done);l=!0){var g=d.value;if(g){var y=g.videos.indexOf(this);-1!==y&&g.videos.splice(y,1)}}}catch(e){h=!0,f=e}finally{try{!l&&p.return&&p.return()}finally{if(h)throw f}}}t?this.paused():this.play(),this.isVisible=e}}},{key:"setRect",value:function(e){var t=this;e&&(this.rect=e),this.loadDefer&&this.loadDefer.done(function(e){e.style.marginLeft=t.rect.x+"px",e.style.marginTop=t.rect.y+"px",e.width=t.rect.width,e.height=t.rect.height})}},{key:"setLoop",value:function(e){var t=this;void 0!==e&&(this.loop=e),this.loadDefer&&this.loadDefer.done(function(e){e.loop=t.loop})}},{key:"setPlaybackRate",value:function(t){this.loadDefer&&this.loadDefer.done(function(e){e.playbackRate=t})}},{key:"setVolume",value:function(e){var t=this;void 0!==e&&(this.volume=e),this.loadDefer&&this.loadDefer.done(function(e){e.volume=t.volume})}},{key:"setMode",value:function(e){var t=this.isVisible;t&&this.setVisible(!1),this.mode=e,t&&this.setVisible(!0)}},{key:"rendererLoop",value:function(){var e=this;this.notifyOutputs(),this.paused()||renderer.animator.requestFrame(function(){return e.rendererLoop()})}},{key:"play",value:function(e){var t=this;if(e&&this.setFile(e),this.loadDefer)return this.loadDefer=this.loadDefer.then(function(t){return $.when(t.play()).then(function(e){return t})}).done(function(){t.mode===m.MODE_LAYER&&t.rendererLoop()})}},{key:"pause",value:function(){if(this.loadDefer)return this.loadDefer=this.loadDefer.then(function(t){return $.when(t.pause()).then(function(e){return t})})}},{key:"paused",value:function(){return!this.element||(!this.loadDefer||this.element.paused)}},{key:"stop",value:function(){this.pause(),this.setTime(0)}},{key:"setTime",value:function(r){this.loadDefer&&this.loadDefer.done(function(t){try{t.currentTime=r/1e3}catch(e){$(t).one("loadedmetadata",function(){t.currentTime=r/1e3})}})}},{key:"notifyOutputs",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this.outputs[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var o=n.value;o&&o.redrawRect(this.rect)}}catch(e){t=!0,r=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw r}}}},{key:"dummyLoad",value:function(){this.element.src="x",this.element.load()}},{key:"canDrawPartial",value:function(){return!0}},{key:"canPlayInline",value:function(){var e=null!=navigator.userAgent.match(/iPad/i);return!browser.isIOs||e}},{key:"drawOnContext",value:function(e,t){if(t){var r=t.intersect(this.rect);e.drawImage(this.element,r.x-this.rect.x,r.y-this.rect.y,r.width,r.height,r.x,r.y,r.width,r.height)}else e.drawImage(this.element,this.rect.x,this.rect.y,this.rect.width,this.rect.height)}}]),m}();Video.MODE_OVERLAY=0,Video.MODE_LAYER=1;var loadSystemStateFromServer,saveCurrentSystemState,saveCurrentState,AnimationLoopVideo=function(e){function r(){_classCallCheck(this,r);var e=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return e.audio=new Audio,e.redrawLoopStarted=!1,e}return _inherits(r,Video),_createClass(r,[{key:"startRedrawLoop",value:function(){var e=this;if(!this.redrawLoopStarted){this.redrawLoopStarted=!0;var t=function e(){r(),requestAnimationFrame(e)},r=function(){try{e.element.currentTime=e.audio.currentTime}catch(e){console.log("Cannot sync time",e)}e.notifyOutputs()};this.stopRedrawLoop=function(){e.redrawLoopStarted=!1,delete e.stopRedrawLoop,$(e.audio).off("timeupdate",r),$(e.audio).off("ended",e.stopRedrawLoop),cancelAnimationFrame(t)},$(this.audio).on("timeupdate",r),$(this.audio).on("ended",this.stopRedrawLoop),requestAnimationFrame(t)}}},{key:"stopRedrawLoop",value:function(){}},{key:"play",value:function(e){var r=this;if(e&&this.setFile(e),this.loadDefer)return this.loadDefer=this.loadDefer.then(function(t){return $.when(r.audio.play()).then(function(e){return t})}).done(function(){return r.startRedrawLoop()})}},{key:"pause",value:function(){var e=this;if(this.loadDefer)return this.loadDefer=this.loadDefer.then(function(t){return $.when(e.audio.pause()).then(function(e){return t})}).done(function(){return e.stopRedrawLoop()})}},{key:"paused",value:function(){return this.audio.paused}},{key:"setFile",value:function(e){var t=ResourceLoader.loadVideo(e,!0,this.audio);return this.loadDefer=$.when(_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"setFile",this).call(this,e),t),this.loadDefer}},{key:"dummyLoad",value:function(){_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"dummyLoad",this).call(this),this.audio.src="x",this.audio.load()}},{key:"setTime",value:function(e){var t=this;this.loadDefer&&this.loadDefer.done(function(){try{t.audio.currentTime=e/1e3}catch(e){}})}},{key:"setLoop",value:function(e){var t=this;void 0!==e&&(this.loop=e),this.loadDefer&&this.loadDefer.done(function(){t.audio.loop=t.loop})}},{key:"setPlaybackRate",value:function(e){var t=this;this.loadDefer&&this.loadDefer.done(function(){t.audio.playbackRate=e})}},{key:"setVolume",value:function(e){var t=this;void 0!==e&&(this.volume=e),this.loadDefer&&this.loadDefer.done(function(){t.audio.volume=t.volume})}},{key:"canPlayInline",value:function(){return!0}}]),r}();Tag.actions.video=new TagAction({rules:{slot:{type:"INT",defaultValue:0},visible:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"},width:{type:"INT"},height:{type:"INT"},loop:{type:"BOOLEAN"},position:{type:"INT"},frame:{type:"INT"},mode:{type:/overlay|layer/i},playrate:{type:"FLOAT"},volume:{type:"FLOAT"}},action:function(e){var t=o2.videos[e.slot];if(!t)return this.error("ビデオスロット "+e.slot+" が存在しません"),0;"visible"in e&&t.setVisible(e.visible);var r=!1;return"left"in e&&(t.rect.x=e.left,r=!0),"top"in e&&(t.rect.y=e.top,r=!0),"width"in e&&(t.rect.width=e.width,r=!0),"height"in e&&(t.rect.height=e.height,r=!0),r&&t.setRect(),"loop"in e&&t.setLoop(e.loop),"position"in e&&t.setTime(e.position),"mode"in e&&("layer"==e.mode?t.setMode(Video.MODE_LAYER):t.setMode(Video.MODE_OVERLAY)),"playrate"in e&&t.setPlaybackRate(e.playrate),"volume"in e&&t.setVolume(e.volume/100),0}}),Tag.actions.videolayer=new TagAction({rules:{slot:{type:"INT",defaultValue:0},channel:{type:/1|2/,required:!0},page:{type:/fore|back/,required:!0},layer:{type:"IMAGE_LAYER",required:!0}},action:function(e){var t=o2.videos[e.slot];return t?t.outputs[e.channel]=e.layer[e.page]:this.error("ビデオスロット "+e.slot+" が存在しません"),0}}),Tag.actions.openvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0},storage:{type:"VIDEO",required:!0}},action:function(e){var t=o2.videos[e.slot];if(!t)return this.error("ビデオスロット "+e.slot+" が存在しません"),0;try{t.setFile(e.storage)}catch(e){this.error(e)}return 0}}),Tag.actions.preparevideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(e){var t=this;return renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){t.done()})}),1}}),Tag.actions.playvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0},storage:{type:"VIDEO"}},action:function(e){var t=this,r=o2.videos[e.slot];if(!r)return this.error("ビデオスロット "+e.slot+" が存在しません"),0;try{return r.play(e.storage).then(function(){return t.done()}),1}catch(e){this.error(e)}return 0}}),Tag.actions.pausevideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(e){var t=o2.videos[e.slot];return t?t.pause():this.error("ビデオスロット "+e.slot+" が存在しません"),0}}),Tag.actions.resumevideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(e){var t=o2.videos[e.slot];return t?t.play():this.error("ビデオスロット "+e.slot+" が存在しません"),0}}),Tag.actions.stopvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(e){var t=o2.videos[e.slot];return t?t.stop():this.error("ビデオスロット "+e.slot+" が存在しません"),0}}),Tag.actions.rewindvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(e){var t=o2.videos[e.slot];return t?t.setTime(0):this.error("ビデオスロット "+e.slot+" が存在しません"),0}}),Tag.actions.wv=new TagAction({rules:{slot:{type:"INT",defaultValue:0},canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(e){var t=o2.videos[e.slot];if(!t)return this.error("ビデオスロット "+e.slot+" が存在しません"),0;if(t.paused())return 0;if(e.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return t.stop(),0;this.conductor.wait("click",function(){t.stop()})}var r=this;return $(t).on("ended",function(){r.done()}),1}}),Object.defineProperty(Object.prototype,"objectToBeSerialized",{enumerable:!1,writable:!0,value:function(e){return this[e]}}),Object.defineProperty(Object.prototype,"toJSON",{enumerable:!1,writable:!0,value:function(){var e=this instanceof Array?[]:{};for(var t in this){var r=this.objectToBeSerialized(t);void 0!==r&&"function"!=typeof r&&(e[t]=r)}return e}}),function(){var s=[],c=[];Object.defineProperty(Object.prototype,"importFromSaveData",{enumerable:!1,writable:!0,value:function(i){var o=[],a=this;for(var e in i)!function(t){var e=a[t],r=i[t];if(s.push(t),"object"==(void 0===e?"undefined":_typeof(e))&&null!==e){var n=e.importFromSaveData(r);n&&(n.stackName=s.join(">"),o.push(n),c.push(n),n.done(function(){c.splice(c.indexOf(n,1))}))}else null!=r&&o.push($.when(r.restore()).done(function(e){a[t]=e}));s.pop()}(e);return $.when.apply($,o).then(function(){return a})}})}(),Object.defineProperty(Object.prototype,"restore",{enumerable:!1,writable:!0,value:function(){var e=this.initializer;if(e||(Array.isArray(this)?e="Array":this instanceof Object&&(e="Object")),e){var t=e.split("."),r=window;if(t.forEach(function(e){r=r[e]}),"function"==typeof r)return r.restore!==Object.prototype.restore?r.restore(this):(new r).importFromSaveData(this)}return this}}),function(){var t,r=0;$(function(){$(o2).on("init",function(){$([conductor,extraConductor]).on("ran",function(e,t){0!=t&&saveCurrentSystemState()}),o2.serverStat.mode==o2.SERVER_MODE_O2SERVER&&$(o2).on("systeminit.loggedin",function(){loadSystemStateFromServer()})})});var e=function(){};e.prototype={setItem:function(e,t){try{return localStorage[e]=t,$.Deferred().resolve()}catch(e){return $.Deferred().reject("localStorageの容量を超えました。"+e)}},getItem:function(e){return $.Deferred().resolve(localStorage[e])},deleteItem:function(e){return $.Deferred().resolve(delete localStorage[e])},setGlobalSaveData:function(e){var t=config.gameID+"_sf";return this.setItem(t,e)},getGlobalSaveData:function(){var s=$.Deferred(),e=config.gameID+"_sf";return this.getItem(e).then(function(e){var t;try{t=JSON.parse(e)}catch(e){return $.Deferred().reject(e)}for(var r=Object.keys(localStorage),n=new RegExp(config.gameID+"_([0-9]+)"),i={},o=0;o<r.length;o++){var a=r[o].match(n);a&&r[o]+"_date"in localStorage&&r[o]+"_caption"in localStorage&&(i[a[1]]={date:new Date(1e3*localStorage.getItem(r[o]+"_date")),caption:localStorage.getItem(r[o]+"_caption"),snapshot:localStorage.getItem(r[o]+"_screen")})}return s.resolve(t,i)})},setSaveData:function(e,t){var r=(e=config.gameID+"_"+e)+"_caption",n=e+"_date",i=e+"_screen";return $.when(this.setItem(e,t.data),this.setItem(r,t.caption),this.setItem(n,t.date),t.snapshot?this.setItem(i,t.snapshot):null)},getSaveData:function(e){return e=config.gameID+"_"+e,this.getItem(e)},deleteSaveData:function(e){var t=(e=config.gameID+"_"+e)+"_caption",r=e+"_date",n=e+"_screen";return $.when(this.deleteItem(e),this.deleteItem(t),this.deleteItem(r),this.deleteItem(n))}};var n,i=function(){this.lastSentSystemStringTime=0,this.timerDefer,this.scheduledTimer,this.minimumRequestInterval=1e4};function o(e){var t=document.createElement("canvas"),r=Math.min(config.scWidth,e),n=r/config.scWidth*config.scHeight;return t.width=r,t.height=n,t.getContext("2d").drawImage(renderer.foreCanvas,0,0,config.scWidth,config.scHeight,0,0,r,n),t.toDataURL()}i.prototype=Object.create(e.prototype),$.extend(i.prototype,{setGlobalSaveData:function(e){if(-1==o2.serverStat.uid||this.waitingForSystemString)return $.Deferred().reject();function t(){return $.post(o2.serverStat.saveServer+"/api/1.2/globaldata/save.php",{sysvars:n,novel:config.gameID,key:o2.serverStat.skey,uid:o2.serverStat.uid})}if(Date.now()-this.lastSentSystemStringTime>this.minimumRequestInterval)return this.lastSentSystemStringTime=Date.now(),t();var r=this;return this.scheduledTimer||(this.timerDefer=$.Deferred().resolve().then(function(){return function(e){var t=$.Deferred();return setTimeout(function(){t.resolve()},e),t.promise()}(r.lastSentSystemStringTime+r.minimumRequestInterval-Date.now())}).then(function(){return t()}).done(function(){r.timerDefer=null,r.scheduledTimer=null,r.lastSentSystemStringTime=Date.now()})),this.timerDefer.promise()},getGlobalSaveData:function(e){if(-1==o2.serverStat.uid)return $.Deferred().reject();this.waitingForSystemString=!0;var t=this;return $.post(o2.serverStat.saveServer+"/api/1.2/globaldata/load.php",{novel:config.gameID,key:o2.serverStat.skey,uid:o2.serverStat.uid}).then(function(e){if("string"==typeof e&&(e=JSON.parse(e)),"ok"!==e.result)return $.Deferred().reject(e.reason);if("string"==typeof e.sysvars)try{e.sysvars=JSON.parse(e.sysvars)}catch(e){return $.Deferred().reject(e)}var t={};if("sindex"in e)for(var r=0;r<e.sindex.length;r++){var n=e.sindex[r];t[n.save_id]={date:new Date(1e3*n.updated_at),caption:n.caption,snapshot:n.screen}}return $.Deferred().resolve(e.sysvars,t)}).always(function(){t.waitingForSystemString=!1})},setSaveData:function(e,t){return $.when(Renderer.askForLogin()).then(function(){return $.post(o2.serverStat.saveServer+"/api/1.2/savedata/save.php",{uid:o2.serverStat.uid,novel:config.gameID,sindex:e,data:t.data,key:o2.serverStat.skey,screen:t.snapshot||"1",caption:t.caption})})},getSaveData:function(e){return Renderer.askForLogin().then(function(){return $.post(o2.serverStat.saveServer+"/api/1.2/savedata/load.php",{uid:o2.serverStat.uid,novel:config.gameID,sindex:e,key:o2.serverStat.skey})}).then(function(e){return"ok"!==e.result?$.Deferred().reject(e.reason):("string"==typeof e&&(e=JSON.parse(e)),e.data)})},deleteSaveData:function(e){return $.when(Renderer.askForLogin()).then(function(){return $.post(o2.serverStat.saveServer+"/api/1.2/savedata/erase.php",{uid:o2.serverStat.uid,novel:config.gameID,sindex:e,key:o2.serverStat.skey})})}}),loadSystemStateFromServer=function(){return o2.currentSaveAdapter.getGlobalSaveData().done(function(e,t){if(e){for(var r in window.sf=mergeObj(e,sf),t){var n=t[r];ev.save.date[r]=n.date,ev.save.caption[r]=n.caption,ev.save.snapshot[r]=n.snapshot}o2.setSeGVolume(),o2.setBgmGVolume()}})},saveCurrentSystemState=function(){var e=$.Deferred();try{n=JSON.stringify(window.sf)}catch(e){o2.error("システム変数を保存できない。")}return t==n?e.reject():o2.currentSaveAdapter.setGlobalSaveData(n).done(function(){t=n})},saveCurrentState=function(e){return Tag.actions.save.stateString=JSON.stringify({o2:o2,f:f,mp:mp,conductor:conductor},function(e,t){var r=Object.prototype.toString.apply(t);return/\[object HTML[A-Za-z]*Element\]/.test(r)?void 0:"function"==typeof t?void 0:t}),!r&&config.saveThumbnail&&(Tag.actions.save.stateScreenShot=o(config.thumbnailWidth)),null!=e&&(Tag.actions.save.stateCaption=e),Tag.actions.save.stateString},Tag.actions.save=new TagAction({rules:{place:{type:"INT",defaultValue:0},ask:{type:"BOOLEAN",defaultValue:!1}},action:function(e){if(null==Tag.actions.save.stateString)return config.saveMode==o2.SAVE_MODE_KAG3?o2.warn("一度もセーブ可能なラベルを通過していない状態でセーブを行おうとしました"):config.saveMode==o2.SAVE_MODE_O2KAG&&o2.warn("一度も o2_savestat タグが実行されていない状態でセーブを行おうとしました"),0;if(e.ask&&!confirm("本当にセーブしますか？"))return 0;r||(Tag.actions.save.stateScreenShot=o(config.thumbnailWidth)),ev.save.date[e.place]=new Date,ev.save.caption[e.place]=Tag.actions.save.stateCaption,ev.save.snapshot[e.place]=Tag.actions.save.stateScreenShot;var t=this;return Tag.actions.save.processForSlot(e.place).always(function(){setTimeout(function(){t.done()})}).fail(function(e){o2.warn("書き込みに失敗しました: "+e)}),1},processForSlot:function(e){return o2.currentSaveAdapter.setSaveData(e,{data:Tag.actions.save.stateString,caption:Tag.actions.save.stateCaption,date:Date.now()/1e3,snapshot:Tag.actions.save.stateScreenShot})},adapters:{LocalAdapter:e,O2ServerAdapter:i}}),Tag.actions.save.stateString=void 0,Tag.actions.save.stateCaption="",Tag.actions.save.stateScreenShot=void 0,Tag.actions.o2_savestat=new TagAction({rules:{caption:{type:"STRING"}},action:function(e){if(config.saveMode==o2.SAVE_MODE_KAG3)return this.warn("セーブモードがKAG3モードの時にo2_savestatタグを実行することはできません"),0;if(conductor.stack.length)return this.error("[->]のタグ内はセーブできないです。"),0;var t=this;return renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){saveCurrentState(e.caption),t.done()})}),1}}),Tag.actions.load=new TagAction({rules:{place:{type:"INT",defaultValue:0},ask:{type:"BOOLEAN",defaultValue:!1}},action:function(t){if(t.ask&&!confirm("本当にロードしますか？"))return 0;var e=this;return o2.currentSaveAdapter.getSaveData(t.place).then(Tag.actions.load.processData).done(function(e){Tag.actions.load.applyDeserializedData(e).done(function(){setTimeout(function(){Tag.actions.save.stateString=e,Tag.actions.save.stateCaption=ev.save.caption[t.place],Tag.actions.save.stateScreenShot=ev.save.snapshot[t.place],currentConductor!=conductor&&currentConductor.reset(),currentConductor=conductor,o2.refreshRendererLayers(),conductor.oneShot()})})}).fail(function(){o2.warn("読み込みに失敗しました"),e.done()}),2},processData:function(e){return e},applyDeserializedData:function(e){$("body").css("pointer-events","none"),renderer.animator.pause(),conductor.pause();var t=JSON.parse(e),r=t.conductor;return delete t.conductor,window.f={},window.importFromSaveData(t).then(function(){return conductor.importFromSaveData(r)}).done(function(){o2.allLayers().forEach(function(e){e.redrawRect()}),o2.setSeGVolume(),o2.setBgmGVolume(),$("body").css("pointer-events","auto"),renderer.animator.resume(),conductor.resume()})}}),Tag.actions.locksnapshot=new TagAction({action:function(e){return 0==r&&(Tag.actions.save.stateScreenShot=o(config.thumbnailWidth)),r++,0}}),Tag.actions.unlocksnapshot=new TagAction({action:function(){return--r<0&&this.error("unlocksnapshotの回数はlocksnapshotより多いです。"),0}}),Tag.actions.erasebookmark=new TagAction({rules:{place:{type:"INT",defaultValue:0}},action:function(e){delete ev.save.date[e.place],delete ev.save.caption[e.place],delete ev.save.snapshot[e.place];var t=this;return o2.currentSaveAdapter.deleteSaveData(e.place).always(function(){setTimeout(function(){t.done()})}),1}})}(),Tag.actions.animstart=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},seg:{type:"INT",required:!0},target:{type:"STRING"}},action:function(r){var n=r.layer[r.page];if(!n.images[0]||!n.images[0].image)return this.warn("layerに画像がないです。"),0;var i=n.images[0].image.originalURL,e=KAGFiles(i+".asd"),o=this;return $.when(e).then(function(t){setTimeout(function(){if(!t)return o.error(i+".asdが見つからないです。"),void o.done();var e=new AnimationConductor({file:t,label:r.target});n.addAnimationConductor(e,r.seg),e.run(),o.done()})}),1}}),Tag.actions.animstop=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},seg:{type:"INT"}},action:function(e){var t=e.layer[e.page].animationConductors[e.seg];return t?t.stopUntilHome():this.warn(e.seg+"というアニメーションセグメントが見つかりません。"),0}}),Tag.actions.wa=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},seg:{type:"INT"}},action:function(e){var r=this,t=e.layer[e.page].animationConductors[e.seg];return t?t.isLooping?0:($(t).on("ran",function(e,t){2==t&&r.done()}),1):(this.warn(e.seg+"というアニメーションセグメントが見つかりません。"),0)}}),function(){var t;Tag.actions.o2_geo_watch=new TagAction({action:function(e){return t||(t=navigator.geolocation.watchPosition(function(e){ev.geo=e})),0}}),Tag.actions.o2_geo_endwatch=new TagAction({action:function(e){return navigator.geolocation.clearWatch(t),t=void 0,0}}),Tag.actions.o2_geo_get=new TagAction({action:function(e){var t=this;return navigator.geolocation.getCurrentPosition(function(e){ev.geo=e,t.done()},function(){t.done()}),0}}),Tag.actions.o2_geo_wg=new TagAction({rules:{canskip:{type:"BOOLEAN"}},action:function(e){return e.canskip&&this.conductor.wait("click"),this.conductor.wait("o2_geo_get"),1}})}(),Tag.actions.clearsysvar=new TagAction({action:function(){return o2.resetSf(),0}}),Tag.actions.clearvar=new TagAction({action:function(){window.f={}}}),Tag.actions.glyph=new TagAction({rules:{line:{type:"IMAGE"},page:{type:"IMAGE"},fix:{type:"BOOLEAN"},left:{type:"FLOAT"},top:{type:"FLOAT"}},action:function(e){var t={fix:"fixed",left:"x",top:"y"};for(var r in e){var n=t[r]||r;o2.currentMessageLayer.glyphOptions[n]=e[r]}return 0}}),Tag.actions.o2_loadplugin=new TagAction({rules:{module:{type:"STRING",required:!0}},action:function(e){var t=this,r=document.createElement("script");return r.onload=function(){t.done()},r.onerror=function(){t.error("プラグインファイル "+e.module+" をロードできません")},r.src="./plugin/"+e.module,document.getElementsByTagName("head")[0].appendChild(r),1}}),Tag.actions.o2_sysbutton=new TagAction({rules:{graphic:{type:"IMAGE",required:!0},graphickey:{type:"COLOR",allowString:["adapt"]},storage:{type:"SCENARIO"},target:{type:"STRING"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_exp:{type:"STRING"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"},id:{type:"STRING",required:!0}},action:function(n){var i=this;return ResourceLoader.loadImage(n.graphic).done(function(r){setTimeout(function(){var e=o2.currentMessageLayer.textCursor,t=new RoutineButton(r,e.x,e.y);t.importFromKAGArgs(n),o2.currentMessageLayer.addRoutineButton(t),i.done()})}),1}}),Tag.actions.o2_updatesysbutton=new TagAction({rules:{id:{type:"STRING",required:!0},enabled:{type:"BOOLEAN"}},action:function(e){for(var t=0;t<o2.currentMessageLayer.routineButtons.length;t++){var r=o2.currentMessageLayer.routineButtons[t];if(r.tagArgs.id==e.id){r.enabled=e.enabled;break}}return 0}}),Tag.actions.o2_deletesysbutton=new TagAction({rules:{id:{type:"STRING",required:!0}},action:function(e){for(var t=0;t<o2.currentMessageLayer.routineButtons.length;t++){var r=o2.currentMessageLayer.routineButtons[t];if(r.tagArgs.id==e.id){o2.currentMessageLayer.routineButtons.splice(t,1),o2.currentMessageLayer.redrawRect(r.rect);break}}return 0}});var RoutineLink,RoutineButton=function(e,t,r){Button.call(this,e,t,r),this.rect.width=Math.floor(this.rect.width/4),this.options.clipLeft=0,this.options.clipWidth=this.rect.width,this.tagArgs,this.enabled=!0,this.activated=!0};RoutineButton.prototype=Object.create(Button.prototype),RoutineButton.prototype.initializer="RoutineButton",RoutineButton.prototype.clone=function(){var e=new RoutineButton(this.image);return e.importFrom(this),e},RoutineButton.prototype.drawOnContext=function(e,t){switch(this.state){case Button.STATE_DISABLE:this.options.clipLeft=3*this.rect.width;break;case Button.STATE_HOVER:this.options.clipLeft=2*this.rect.width;break;case Button.STATE_DOWN:this.options.clipLeft=this.rect.width;break;case Button.STATE_NORMAL:default:this.options.clipLeft=0}this.enabled||(this.options.clipLeft=3*this.rect.width),Button.prototype.drawOnContext.apply(this,arguments)},RoutineButton.prototype.importFromKAGArgs=function(i){this.tagArgs=clone(i),this.click=function(e,t,r){if(Button.prototype.click.apply(this,arguments),this.activated&&this.enabled&&(i.o2_exp&&(0,eval)(i.o2_exp),i.o2_url&&window.open(i.o2_url,i.o2_urltarget),i.storage||i.target)){extraConductor.setFile(conductor.file),currentConductor=extraConductor;var n=new Tag("jump",{storage:i.storage,target:i.target});extraConductor.queue.push(n)}},i.o2_onenter&&(this.enter=function(){Button.prototype.enter.apply(this,arguments),(0,eval)(i.o2_onenter)}),i.o2_onleave&&(this.leave=function(){Button.prototype.leave.apply(this,arguments),(0,eval)(i.o2_onleave)})},RoutineButton.prototype.importFrom=function(e){Button.prototype.importFrom.call(this,e),e.tagArgs&&this.importFromKAGArgs(e.tagArgs)},RoutineButton.prototype.importFromSaveData=function(e){Button.prototype.importFromSaveData.call(this,e),e.tagArgs&&this.importFromKAGArgs(e.tagArgs)},RoutineButton.prototype.toJSON=function(){var e=Button.prototype.toJSON.call(this);return e.tagArgs=this.tagArgs,e},RoutineButton.restore=function(r){return $.when(ResourceLoader.loadImage(r.image,!0)).then(function(e){var t=new RoutineButton(e);return t.importFromSaveData(r),t})},function(){(RoutineLink=function(){Link.call(this),this.tagArgs}).prototype=Object.create(Link.prototype),RoutineLink.prototype.initializer="RoutineLink",RoutineLink.restore=function(e){var t=new RoutineLink;return t.importFromKAGArgs(e.tagArgs),delete e.tagArgs,Link.prototype.importFromSaveData(e),t},RoutineLink.prototype.importFrom=function(e){Link.prototype.importFrom.call(this,e),this.importFromKAGArgs(e.tagArgs)},RoutineLink.prototype.importFromKAGArgs=function(i){this.tagArgs=i,this.click=function(e,t,r){if(Link.prototype.click.apply(this,arguments),"o2_exp"in i&&(0,eval)(i.o2_exp),"o2_url"in i&&window.open(i.o2_url,i.o2_urltarget),i.storage||i.target){extraConductor.setFile(conductor.file),currentConductor=extraConductor;var n=new Tag("jump",{storage:i.storage,target:i.target});extraConductor.queue.push(n)}},"o2_onenter"in i&&(this.enter=function(){Link.prototype.enter.apply(this,arguments),(0,eval)(i.o2_onenter)}),"o2_onleave"in i&&(this.leave=function(){Link.prototype.leave.apply(this,arguments),(0,eval)(i.o2_onleave)})};var o=0,a={};Tag.actions.o2_syslink=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"},color:{type:"COLOR"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"},o2_exp:{type:"STRING"}},action:function(e){return o=o2.currentMessageLayer.textsProperties.length,a=e,0}}),Tag.actions.o2_endsyslink=new TagAction({action:function(e){var t=new RoutineLink;t.importFromKAGArgs(a),t.vertical=o2.currentMessageLayer.vertical;for(var r=o;r<o2.currentMessageLayer.textsProperties.length;r++)t.addTextProperties(o2.currentMessageLayer.textsProperties[r]);if(o2.currentMessageLayer.addLink(t),o2.currentMessageLayerWithBack){var n=o2.currentMessageLayer.getCorrespondingLayer();(t=new RoutineLink).importFromKAGArgs(a),t.vertical=n.vertical;for(var i=o;i<n.textsProperties.length;i++)t.addTextProperties(n.textsProperties[i]);n.addLink(t)}return 0}})}(),Tag.actions.o2_enterskip=new TagAction({action:function(){return o2.skipToStop(),0}}),Tag.actions.o2_forcibleskip=new TagAction({action:function(){return o2.skipToStopForcibly(),0}}),Tag.actions.o2_enterautomode=new TagAction({action:function(){return o2.enterAutoMode(),0}}),Tag.actions.cancelskip=new TagAction({action:function(e){return o2.skipMode=o2.SKIP_MODE_NONE,0}}),Tag.actions.cancelautomode=new TagAction({action:function(e){return o2.cancelAutoMode(),0}}),function(){var i={};Tag.actions.listengesture=new TagAction({rules:{id:{type:"STRING",required:!0},mode:{type:/delta|accumulate|absolute|longtap/,defaultValue:"accumulate"},mutualexclusive:{type:"BOOLEAN",defaultValue:!0},minx:{type:"INT"},maxx:{type:"INT"},miny:{type:"INT"},maxy:{type:"INT"},duration:{type:"INT",defaultValue:1e3},maxmove:{type:"INT",defaultValue:10}},action:function(e){if(this.isOpen()){if(!(e.id in i)){var n=this,t=function(){for(var e=new Conductor({file:n.getCallbackFile()}),t=[],r=0;r<arguments.length;r++)t.push(arguments[r]);t=n.makeScopeVars(t),e.callbackVarsStack.push(t),e.run()},r=function(){switch(e.mode){case"accumulate":return GestureRecognizer.accumulateRecognizer(e.minx,e.maxx,e.miny,e.maxy,t);case"delta":return GestureRecognizer.basicRecognizer("delta",t);case"absolute":return GestureRecognizer.basicRecognizer("absolute",t);case"longtap":return GestureRecognizer.longTapRecognizer(e.duration,e.maxmove,t)}}();return r.mutualExclusive=e.mutualexclusive,GestureManager.addRecognizer(r),i[e.id]=r,0}this.error(e.id+"はすでに定義されてる")}else this.error("openタグじゃないとダメです")},closeAction:function(e){return 0}}),Tag.actions.unlistengesture=new TagAction({rules:{id:{type:"STRING",required:!0}},action:function(e){var t=i[e.id];return GestureManager.removeRecognizer(t),delete i[e.id],0}})}();var renderer,conductor,currentConductor,extraConductor,defaultConfig={title:["string","untitled"],gameID:["string","mygame"],scWidth:["number",800],scHeight:["number",600],numMessageLayers:["number",2],numImageLayers:["number",2],backgroundColor:["color","0xeeeeee"],chSpeeds:["number",40],userCh2ndSpeed:["number",-1],numSEBuffers:["number",2],numMovies:["number",1],scPositionX_left:["number",0],scPositionX_left_center:["number",0],scPositionX_center:["number",0],scPositionX_right_center:["number",0],scPositionX_right:["number",0],initialMessageLayerVisible:["boolean",!1],messageLayerColor:["color","0x000000"],messageLayerOpacity:["opacity",190],messageLayerMarginT:["number",6],messageLayerMarginL:["number",6],messageLayerMarginR:["number",6],messageLayerMarginB:["number",6],messageLayerCurrentPositionX:["number",10],messageLayerCurrentPositionY:["number",60],messageLayerCurrentWidth:["number",480],messageLayerCurrentHeight:["number",35],messageLayerDefaultAutoReturn:["boolean",!0],messageLayerDefaultFontSize:["number",12],messageLayerDefaultFontFace:["string","ＭＳ Ｐゴシック"],messageLayerDefaultFontColor:["color","0xFFFFFF"],messageLayerDefaultFontBold:["boolean",!1],messageLayerDefaultFontItalic:["boolean",!1],messageLayerDefaultStyleLineSpacing:["number",6],messageLayerDefaultStylePitch:["number",0],messageLayerDefaultGlyphLine:["string","linebreak"],messageLayerDefaultGlyphPage:["string","pagebreak"],messageLayerDefaultGlyphFixed:["boolean",!1],messageLayerDefaultGlyphX:["number",0],messageLayerDefaultGlyphY:["number",0],messageLayerDefaultLinkColor:["color","0x0000ff"],messageLayerDefaultLinkOpacity:["opacity",64],messageLayerVertical:["boolean",!1],messageLayerDefaultRubySize:["number",10],messageLayerDefaultRubyOffset:["number",-2],messageLayerDefaultShadow:["boolean",!0],messageLayerDefaultShadowBlur:["number",3],messageLayerDefaultShadowOffsetX:["number",0],messageLayerDefaultShadowOffsetY:["number",0],messageLayerDefaultShadowColor:["color","0x000000"],messageLayerDefaultEdge:["boolean",!1],messageLayerDefaultEdgeColor:["color","0x000000"],historyLayerFontFace:["string","ＭＳ Ｐゴシック"],historyLayerFontColor:["color","0xFFFFFF"],historyLayerFontBold:["boolean",!1],historyLayerFontHeight:["number",24],historyLayerLineHeight:["number",26],historyLayerEverypage:["boolean",!1],historyLayerMaxPages:["number",30],historyLayerMaxLines:["number",20],historyLayerStoreState:["boolean",!1],historyLayerColor:["color","0x000000"],historyLayerOpacity:["opacity",255],historyLayerFrame:["string",""],historyLayerMarginT:["number",30],historyLayerMarginL:["number",30],historyLayerMarginR:["number",30],historyLayerMarginB:["number",30],historyLayerCurrentPositionX:["number",10],historyLayerCurrentPositionY:["number",10],historyLayerCurrentWidth:["number",300],historyLayerCurrentHeight:["number",300],historyLayerVertical:["string","auto"],historyLayerShadow:["boolean",!0],historyLayerShadowColor:["color","0x000000"],historyLayerShadowBlur:["number",3],historyLayerShadowOffsetX:["number",0],historyLayerShadowOffsetY:["number",0],historyLayerEdge:["boolean",!1],historyLayerEdgeColor:["color","0x000000"],historyLayerFrameFixed:["boolean",!1],cursorDefault:["string","auto"],cursorPointed:["string","pointer"],cursorWaitingClick:["string","auto"],cursorDraggable:["string","auto"],saveMode:["string","o2kag"],priorityAudioChannel:["string","bgm"],saveThumbnail:["boolean",!1],thumbnailWidth:["number",128],autoModePageWait:["number",350],autoModeLineWait:["number",50],chNonStopToPageBreak:["boolean",!1],ch2ndNonStopToPageBreak:["boolean",!1],numImageCache:["number",-1],numScriptCache:["number",5]},config={},mp={},tf={},sf={},f={},ev={query:function(){for(var e,t={},r=window.location.search.substring(1).split("&"),n=0;n<r.length;n++){var i=r[n].split("=");!i.length||1==i.length&&""==i[0]||(2==i.length?t[i[0]]=(e=i[0],decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(location.search)||["",""])[1].replace(/\+/g,"%20"))||null):t[i[0]]=!0)}return t}(),save:{date:{},caption:{},snapshot:{}},cursorLocation:{x:0,y:0},ua:navigator.userAgent,lang:navigator.language?navigator.language:navigator.userLanguage,hostname:location.hostname,lastimage:{},enginever:"2.3.0",enginebuild:"71733ff"},o2={foreLayers:{baseLayer:void 0,imageLayers:[],messageLayers:[]},backLayers:{baseLayer:void 0,imageLayers:[],messageLayers:[]},currentMessageLayer:void 0,currentMessageLayerWithBack:!1,allForeLayers:function(){return[this.foreLayers.baseLayer].concat(this.foreLayers.imageLayers).concat(this.foreLayers.messageLayers)},allBackLayers:function(){return[this.backLayers.baseLayer].concat(this.backLayers.imageLayers).concat(this.backLayers.messageLayers)},allLayers:function(){return this.allBackLayers().concat(this.allForeLayers())},autoHideLayers:function(){return this.foreLayers.messageLayers.concat(this.backLayers.messageLayers).concat(this.extraAutoHideLayers)},refreshRendererLayers:function(){function e(e,t){return e.index-t.index}renderer.foreLayers=this.allForeLayers().sort(e),renderer.backLayers=this.allBackLayers().sort(e)},resetLayersIndex:function(){for(var e=0;e<o2.foreLayers.imageLayers.length;e++)o2.foreLayers.imageLayers[e].index=1e3*(e+1),o2.backLayers.imageLayers[e].index=1e3*(e+1);for(var t=0;t<o2.foreLayers.messageLayers.length;t++)o2.foreLayers.messageLayers[t].index=1e6+1e3*(t+1),o2.backLayers.messageLayers[t].index=1e6+1e3*(t+1)},extraAutoHideLayers:[],imageList:[],soundList:[],videoList:[],fontList:[],config:{scriptTagNameKey:"name",scriptTagArgsKey:"args",scriptTagLineKey:"line",scriptTagCharKey:"char"},resetSf:function(){sf={__system:{seGVolume:1,bgmGVolume:1,chSpeed:config.chSpeeds,useUserChSpeed:!0,userChSpeed:40,userCh2ndSpeed:config.userCh2ndSpeed,autoModeLineWait:config.autoModeLineWait,autoModePageWait:config.autoModePageWait}}},se:[],setSeGVolume:function(e){void 0!==e&&(sf.__system.seGVolume=e),this.se.forEach(function(e){e.volumePercentage=sf.__system.seGVolume,e.setVolume(e.volume)})},setBgmGVolume:function(e){void 0!==e&&(sf.__system.bgmGVolume=e),o2.bgm.volumePercentage=sf.__system.bgmGVolume,o2.bgm.setVolume(o2.bgm.volume)},bgm:browser.usesWebAudio?new WebAudioSound:new Sound,prioritySound:void 0,videos:[],currentSaveAdapter:new Tag.actions.save.adapters.LocalAdapter,skipMode:0,clickSkipEnabled:!0,skipWithMode:function(e){o2.skipMode=e,currentConductor.trigger("click")||currentConductor.status===Conductor.STATUS_WAIT&&0==Object.keys(currentConductor.waitTag).length&&currentConductor.oneShot()},skipToClick:function(){this.skipWithMode(o2.SKIP_MODE_CLICK)},skipToPage:function(){this.skipWithMode(o2.SKIP_MODE_PAGE)},skipToStop:function(){currentConductor.isCurrentRead()&&this.skipWithMode(o2.SKIP_MODE_UNREAD)},skipToStopForcibly:function(){this.skipWithMode(o2.SKIP_MODE_STOP)},autoMode:!1,enterAutoMode:function(){this.autoMode=!0,currentConductor.trigger("click")||currentConductor.status!=Conductor.STATUS_STOP&&0==Object.keys(currentConductor.waitTag).length&&currentConductor.oneShot()},cancelAutoMode:function(){this.autoMode=!1},reloadDelaySpeed:function(){var e=sf.__system.chSpeed;sf.__system.useUserChSpeed&&(currentConductor.isCurrentRead()&&"userCh2ndSpeed"in sf.__system&&-1!=sf.__system.userCh2ndSpeed?e=sf.__system.userCh2ndSpeed:"userChSpeed"in sf.__system&&(e=sf.__system.userChSpeed));for(var t=o2.foreLayers.messageLayers.concat(o2.backLayers.messageLayers),r=t.length-1;0<=r;r--)t[r].delaySpeed=e},historyLayer:void 0,glyphLayer:void 0,showGlyph:function(e){e=e||"line",this.currentMessageLayer.showGlyphLayer(this.glyphLayer,e)},hideGlyph:function(){this.currentMessageLayer.hideGlyphLayer()},debugLevel:1,serverStat:{mode:0,key:ev.query.key||null,uid:ev.query.uid||-1,userServer:"https://novelsphere.jp",saveServer:"/",skey:ev.query.skey||null},setServerStat:function(e){o2.serverStat.key=e.key,o2.serverStat.uid=e.uid,o2.serverStat.userServer=e.userServer,o2.serverStat.skey=e.skey,e.saveServer&&(o2.serverStat.saveServer=e.saveServer)},printLog:function(e){if(null==e&&(e=o2.DEBUG_LEVEL_LOG),e>o2.debugLevel)return function(){};switch(e){case o2.DEBUG_LEVEL_ERROR:return console.error;case o2.DEBUG_LEVEL_CAUTION:return console.warn;case o2.DEBUG_LEVEL_LOG:return console.log}return function(){}},log:function(){return o2.printLog(o2.DEBUG_LEVEL_LOG).apply(console,arguments)},warn:function(){return o2.printLog(o2.DEBUG_LEVEL_CAUTION).apply(console,arguments)},error:function(){return o2.printLog(o2.DEBUG_LEVEL_ERROR).apply(console,arguments)},setCursorStyle:function(e){var t;switch(e){case"pointer":t=config.cursorPointed;break;case"waitClick":t=config.cursorWaitingClick;break;case"draggable":t=config.cursorDraggable;break;case"default":default:t=config.cursorDefault}$("body").css("cursor",t)},rclickSettings:{call:!1,jump:!1,target:void 0,storage:void 0,enabled:!0},entryPoint:window.o2EntryPoint||"first.ks"};function initialize(e){function t(e,t){var r,n=defaultConfig[e];switch(n&&(r=n[0]),r){case"number":config[e]=Number(t);break;case"opacity":config[e]=Number(t)/255;break;case"boolean":"boolean"==typeof t?config[e]=t:"true"==t.toLowerCase()?config[e]=!0:"false"==t.toLowerCase()?config[e]=!1:config[e]=Boolean(t);break;case"color":config[e]=t.replace("0x","#");break;default:config[e]=t}}for(var r in defaultConfig)t(r,defaultConfig[r][1]);for(var n in e.config)t(n,e.config[n]);document.title=config.title,o2.resetSf();var i={videolist:"videoList",imagelist:"imageList",soundlist:"soundList",fontlist:"fontList"};for(var o in i)i.hasOwnProperty(o)&&"object"===_typeof(e[o])&&(o2[i[o]]=e[o]);for(var a=0;a<config.numSEBuffers;a++)browser.usesWebAudio?o2.se.push(new WebAudioSound):o2.se.push(new Sound);for(var s=0;s<config.numMovies;s++)browser.usesAnimationLoopVideo?o2.videos.push(new AnimationLoopVideo):o2.videos.push(new Video);if("bgm"==config.priorityAudioChannel)o2.prioritySound=o2.bgm;else{var c=config.priorityAudioChannel.match(/se([0-9]+)/);null==c&&o2.error("config.jsonのpriorityAudioChannelはbgmか、se[0-9]+じゃなければいけないです");var u=parseFloat(c[1]);o2.prioritySound=o2.se[u],o2.prioritySound||o2.error("config.jsonで指定されたpriorityAudioChannelは無効です。")}o2.foreLayers.baseLayer=new BaseLayer,o2.backLayers.baseLayer=new BaseLayer;for(var l=0;l<config.numImageLayers;l++){var h=new ImageLayer;o2.foreLayers.imageLayers.push(h),h=new ImageLayer,o2.backLayers.imageLayers.push(h)}for(var f=0;f<config.numMessageLayers;f++){var d=new MessageLayer;o2.foreLayers.messageLayers.push(d),d=new MessageLayer,o2.backLayers.messageLayers.push(d)}for(var p in o2.currentMessageLayer=o2.foreLayers.messageLayers[0],o2.foreLayers.messageLayers[0].visible=o2.backLayers.messageLayers[0].visible=config.initialMessageLayerVisible,o2.historyLayer=new HistoryLayer,o2.glyphLayer=new GlyphLayer,renderer=new Renderer,o2.resetLayersIndex(),o2.refreshRendererLayers(),$("#main-wrapper").append(renderer.foreCanvas),$("#main-wrapper").css({width:config.scWidth+"px",height:config.scHeight+"px"}),e.manifest&&KAGFiles.setupManifest(e.manifest),e.scripts){var g=e.scripts[p];KAGFile.create(p,g)}$("body").css("background-color",config.backgroundColor),scaleToFitPage(),$(window).on("resize",scaleToFitPage)}function getScripts(e,t){o2.serverStat.mode=o2.SERVER_MODE_O2SERVER,$.ajax({url:e,data:t,type:t?"POST":"GET",success:function(e){"string"==typeof e&&(e=JSON.parse(e)),initScripts(e)}})}function initScripts(e){initialize(e),e=null,extraConductor=new SubRoutineConductor;var t=$.Deferred();o2.serverStat.mode===o2.SERVER_MODE_O2SERVER?(o2.currentSaveAdapter=new Tag.actions.save.adapters.O2ServerAdapter,t.resolve()):o2.serverStat.mode==o2.SERVER_MODE_STANDALONE&&loadSystemStateFromServer().always(function(){t.resolve()});var r=KAGFiles(o2.entryPoint);$.when(r,t).then(function(e){currentConductor=conductor=new Conductor({file:e}),conductor.run(),setupEventHandlers(),$(o2).trigger("init"),window.parent!=window.self&&window.parent.postMessage("scriptLoaded","*")}),(browser.isIOs||browser.isAndroid)&&$("body").one("touchstart",function(e){o2.bgm.dummyLoad();for(var t=o2.se.length-1;0<=t;t--)o2.se[t].dummyLoad();for(var r=o2.videos.length-1;0<=r;r--)o2.videos[r].dummyLoad()}),"undefined"!=typeof FPSMeter&&(window.meter=new FPSMeter({smoothing:2,position:"fixed",top:"auto",left:"auto",bottom:"0px",right:"0px",graph:1,heat:1}))}o2.SKIP_MODE_NONE=0,o2.SKIP_MODE_CLICK=1,o2.SKIP_MODE_PAGE=2,o2.SKIP_MODE_UNREAD=3,o2.SKIP_MODE_STOP=4,o2.SKIP_MODE_FAST_FORWARD=5,o2.DEBUG_LEVEL_OFF=0,o2.DEBUG_LEVEL_ERROR=1,o2.DEBUG_LEVEL_CAUTION=2,o2.DEBUG_LEVEL_LOG=3,o2.SERVER_MODE_STANDALONE=0,o2.SERVER_MODE_O2SERVER=1,o2.SAVE_MODE_O2KAG="o2kag",o2.SAVE_MODE_KAG3="kag3",o2.objectToBeSerialized=function(e){function t(e){var t=void 0;for(t=0;t<o2.foreLayers.messageLayers.length;t++){if(e==o2.foreLayers.messageLayers[t])return{page:"fore",layer:t}}for(t=0;t<o2.backLayers.messageLayers.length;t++){if(e==o2.backLayers.messageLayers[t])return{page:"back",layer:t}}}if("function"!=typeof this[e]){switch(e){case"imageList":case"soundList":case"videoList":case"config":case"serverStat":case"prioritySound":case"debugLevel":case"skipMode":case"autoMode":case"SKIP_MODE_NONE":case"SKIP_MODE_CLICK":case"SKIP_MODE_PAGE":case"SKIP_MODE_STOP":case"SKIP_MODE_UNREAD":case"SKIP_MODE_FAST_FORWARD":case"DEBUG_LEVEL_OFF":case"DEBUG_LEVEL_ERROR":case"DEBUG_LEVEL_CAUTION":case"DEBUG_LEVEL_LOG":case"SERVER_MODE_STANDALONE":case"SERVER_MODE_O2SERVER":case"SAVE_MODE_O2KAG":case"SAVE_MODE_KAG3":return;case"currentMessageLayer":return t(this.currentMessageLayer);case"autoHideLayers":return this.autoHideLayers.map(function(e){return t(e)})}return this[e]}},o2.importFromSaveData=function(n){var i=this,o=[];["foreLayers","backLayers"].forEach(function(r){["imageLayers","messageLayers"].forEach(function(e){i[r][e]=[];var t=[];o.push(t.importFromSaveData(n[r][e]).done(function(){i[r][e]=t})),delete n[r][e]})});var e=n.currentMessageLayer;return delete n.currentMessageLayer,o=o.concat(Object.prototype.importFromSaveData.call(this,n)),$.when.apply($,o).done(function(){i.currentMessageLayer=i["back"==e.page?"backLayers":"foreLayers"].messageLayers[e.layer],delete n.currentMessageLayer,i.refreshRendererLayers()})},function(){var e={scriptTagNameKey:0,scriptTagArgsKey:1,scriptTagCallbackArgsKey:2,scriptTagLineKey:3,scriptTagCharKey:4},t=!1;try{-1<navigator.userAgent.toLowerCase().indexOf(" electron/")&&(t=!0)}catch(e){}"undefined"!=typeof module&&module.exports&&!t?module.exports.config=e:window&&window.o2&&(window.o2.config=e)}();